<!DOCTYPE html>
<html lang="vi" class="light-style layout-menu-fixed" dir="ltr" data-theme="theme-default" data-assets-path="../assets/" data-template="vertical-menu-template-free">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
  <title>L·ªãch s·ª≠ Thanh to√°n - Resort Management</title>
  <link rel="icon" type="image/x-icon" href="../assets/img/favicon/favicon.ico" />
  <link rel="stylesheet" href="../assets/vendor/fonts/boxicons.css" />
  <link rel="stylesheet" href="../assets/vendor/css/core.css" class="template-customizer-core-css" />
  <link rel="stylesheet" href="../assets/vendor/css/theme-default.css" class="template-customizer-theme-css" />
  <link rel="stylesheet" href="../assets/css/demo.css" />
  <link rel="stylesheet" href="../assets/css/fix-scrollbar.css" />
  <link rel="stylesheet" href="../assets/css/admin-custom-theme.css" />
  <link rel="stylesheet" href="../assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" />
</head>
<body>
  <div class="layout-wrapper layout-content-navbar">
    <div class="layout-container">
      
      <!-- Menu -->
      <div id="common-menu"></div>
      <script>
        (function() {
          const menuVersion = Date.now();
          fetch('layout-menu.html?v=' + menuVersion)
            .then(response => response.text())
            .then(html => {
              const menuContainer = document.getElementById('common-menu');
              if (menuContainer) menuContainer.innerHTML = html;
            })
            .catch(error => console.error('Error loading menu:', error));
        })();
      </script>

      <!-- Layout container -->
      <div class="layout-page">
        
        <!-- Navbar -->
        <nav class="layout-navbar container-xxl navbar navbar-expand-xl navbar-detached align-items-center bg-navbar-theme" id="layout-navbar">
          <div class="layout-menu-toggle navbar-nav align-items-xl-center me-3 me-xl-0 d-xl-none">
            <a class="nav-item nav-link px-0 me-xl-4" href="javascript:void(0)">
              <i class="bx bx-menu bx-sm"></i>
            </a>
          </div>

          <div class="navbar-nav-right d-flex align-items-center" id="navbar-collapse">
            <div class="navbar-nav align-items-center">
              <div class="nav-item d-flex align-items-center">
                <h4 class="mb-0" id="pageTitle">üí∞ L·ªãch s·ª≠ Thanh to√°n</h4>
              </div>
            </div>

            <ul class="navbar-nav flex-row align-items-center ms-auto">
              <li class="nav-item navbar-dropdown dropdown-user dropdown">
                <a class="nav-link dropdown-toggle hide-arrow" href="javascript:void(0);" data-bs-toggle="dropdown">
                  <div class="avatar avatar-online">
                    <img src="../assets/img/avatars/1.png" alt class="w-px-40 h-auto rounded-circle" />
                  </div>
                </a>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li>
                    <a class="dropdown-item" href="javascript:void(0);" id="logoutBtn">
                      <i class="bx bx-power-off me-2"></i>
                      <span class="align-middle">ƒêƒÉng xu·∫•t</span>
                    </a>
                  </li>
                </ul>
              </li>
            </ul>
          </div>
        </nav>

        <!-- Content wrapper -->
        <div class="content-wrapper">
          <div class="container-xxl flex-grow-1 container-p-y">
            
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
              <div>
                <h4 class="fw-bold py-3 mb-2">
                  <span class="text-muted fw-light">Qu·∫£n l√Ω /</span> L·ªãch s·ª≠ Thanh to√°n
                </h4>
              </div>
              <div class="d-flex gap-2">
                <button type="button" class="btn btn-outline-secondary" onclick="loadPayments()">
                  <i class="bx bx-refresh me-1"></i> L√†m m·ªõi
                </button>
              </div>
            </div>

            <!-- Statistics Cards -->
            <div class="row mb-4">
              <div class="col-md-3 col-6 mb-4">
                <div class="card">
                  <div class="card-body">
                    <div class="card-title d-flex align-items-start justify-content-between">
                      <div class="avatar flex-shrink-0">
                        <span class="avatar-initial rounded bg-label-primary"><i class="bx bx-receipt"></i></span>
                      </div>
                    </div>
                    <span class="fw-semibold d-block mb-1">T·ªïng h√≥a ƒë∆°n</span>
                    <h3 class="card-title mb-2" id="totalInvoices">0</h3>
                  </div>
                </div>
              </div>
              <div class="col-md-3 col-6 mb-4">
                <div class="card">
                  <div class="card-body">
                    <div class="card-title d-flex align-items-start justify-content-between">
                      <div class="avatar flex-shrink-0">
                        <span class="avatar-initial rounded bg-label-success"><i class="bx bx-check-circle"></i></span>
                      </div>
                    </div>
                    <span class="fw-semibold d-block mb-1">ƒê√£ thanh to√°n</span>
                    <h3 class="card-title mb-2" id="paidInvoices">0</h3>
                  </div>
                </div>
              </div>
              <div class="col-md-3 col-6 mb-4">
                <div class="card">
                  <div class="card-body">
                    <div class="card-title d-flex align-items-start justify-content-between">
                      <div class="avatar flex-shrink-0">
                        <span class="avatar-initial rounded bg-label-warning"><i class="bx bx-time-five"></i></span>
                      </div>
                    </div>
                    <span class="fw-semibold d-block mb-1">Ch∆∞a thanh to√°n</span>
                    <h3 class="card-title mb-2" id="pendingInvoices">0</h3>
                  </div>
                </div>
              </div>
              <div class="col-md-3 col-6 mb-4">
                <div class="card">
                  <div class="card-body">
                    <div class="card-title d-flex align-items-start justify-content-between">
                      <div class="avatar flex-shrink-0">
                        <span class="avatar-initial rounded bg-label-info"><i class="bx bx-dollar"></i></span>
                      </div>
                    </div>
                    <span class="fw-semibold d-block mb-1">T·ªïng doanh thu</span>
                    <h3 class="card-title mb-2" id="totalRevenue">0ƒë</h3>
                  </div>
                </div>
              </div>
            </div>

            <!-- Filters -->
            <div class="card mb-4">
              <div class="card-body">
                <div class="row g-3">
                  <div class="col-md-3">
                    <label class="form-label">T√¨m ki·∫øm</label>
                    <input type="text" class="form-control" id="filterSearch" placeholder="S·ªë h√≥a ƒë∆°n, kh√°ch h√†ng..." onkeyup="debounce(loadPayments, 300)()">
                  </div>
                  <div class="col-md-2">
                    <label class="form-label">Tr·∫°ng th√°i</label>
                    <select class="form-select" id="filterStatus" onchange="loadPayments()">
                      <option value="">T·∫•t c·∫£</option>
                      <option value="Issued">ƒê√£ ph√°t h√†nh</option>
                      <option value="PartiallyPaid">Thanh to√°n m·ªôt ph·∫ßn</option>
                      <option value="Paid">ƒê√£ thanh to√°n</option>
                      <option value="Cancelled">ƒê√£ h·ªßy</option>
                    </select>
                  </div>
                  <div class="col-md-2">
                    <label class="form-label">T·ª´ ng√†y</label>
                    <input type="date" class="form-control" id="filterFromDate" onchange="loadPayments()">
                  </div>
                  <div class="col-md-2">
                    <label class="form-label">ƒê·∫øn ng√†y</label>
                    <input type="date" class="form-control" id="filterToDate" onchange="loadPayments()">
                  </div>
                </div>
              </div>
            </div>

            <!-- Payments Table -->
            <div class="card">
              <div class="card-body">
                <div class="table-responsive">
                  <table id="paymentsTable" class="table table-striped table-hover">
                    <thead>
                      <tr>
                        <th>S·ªë Hƒê</th>
                        <th>Kh√°ch h√†ng</th>
                        <th>Ng√†y ph√°t h√†nh</th>
                        <th>T·ªïng ti·ªÅn</th>
                        <th>ƒê√£ thanh to√°n</th>
                        <th>C√≤n l·∫°i</th>
                        <th>Ph∆∞∆°ng th·ª©c</th>
                        <th>Ng√†y thanh to√°n</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>Thao t√°c</th>
                      </tr>
                    </thead>
                    <tbody id="paymentsTableBody">
                      <tr>
                        <td colspan="10" class="text-center">ƒêang t·∫£i...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Invoice Detail Modal -->
  <div class="modal fade" id="invoiceDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Chi ti·∫øt H√≥a ƒë∆°n</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="invoiceDetailContent">
          <!-- Content will be loaded here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="../assets/vendor/libs/jquery/jquery.js"></script>
  <script src="../assets/vendor/libs/popper/popper.js"></script>
  <script src="../assets/vendor/js/bootstrap.js"></script>
  <script src="../assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.js"></script>
  <script src="../assets/vendor/js/menu.js"></script>
  <script src="../assets/js/main.js"></script>
  <script src="../js/api.js"></script>
  <script src="../js/common-navbar.js"></script>
  <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
  <script src="../../js/toast-notification.js"></script>

  <script>
    let paymentsTable;
    const API_BASE = (typeof API_BASE_URL !== 'undefined' ? API_BASE_URL : `${window.location.origin}/api`);

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Use formatCurrency and formatDate from api.js if available, otherwise define fallback
    // Check if already defined (from api.js) before declaring
    if (typeof formatCurrency === 'undefined') {
      window.formatCurrency = function(amount) {
        if (!amount) return '0 ‚Ç´';
        return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
      };
    }
    
    if (typeof formatDate === 'undefined') {
      window.formatDate = function(dateString) {
        if (!dateString) return '-';
        const date = new Date(dateString);
        return date.toLocaleDateString('vi-VN', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        });
      };
    }
    
    // Use the functions (from api.js or our fallback)
    const formatCurrency = window.formatCurrency || (typeof formatCurrency !== 'undefined' ? formatCurrency : window.formatCurrency);
    const formatDate = window.formatDate || (typeof formatDate !== 'undefined' ? formatDate : window.formatDate);

    async function loadStatistics() {
      const logPrefix = 'üí∞ [PaymentHistory-Statistics]';
      const timestamp = new Date().toISOString();
      console.log(`${logPrefix} [${timestamp}] ========== START loadStatistics ==========`);
      
      try {
        const token = localStorage.getItem('adminToken') || localStorage.getItem('token');
        console.log(`${logPrefix} [${timestamp}] Token exists:`, !!token);
        
        const url = `${API_BASE}/invoices/statistics`;
        console.log(`${logPrefix} [${timestamp}] Request URL:`, url);
        console.log(`${logPrefix} [${timestamp}] API_BASE:`, API_BASE);
        
        const response = await fetch(url, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        console.log(`${logPrefix} [${timestamp}] Response status:`, response.status, response.statusText);

        if (response.status === 401) {
          const errorText = await response.text().catch(() => 'Cannot read error');
          console.error(`${logPrefix} [${timestamp}] ‚ùå Unauthorized:`, errorText);
          window.location.href = 'login.html';
          return;
        }

        if (!response.ok) {
          const errorText = await response.text().catch(() => 'Cannot read error');
          console.error(`${logPrefix} [${timestamp}] ‚ùå Response error:`, {
            status: response.status,
            statusText: response.statusText,
            body: errorText
          });
          throw new Error(`HTTP ${response.status}: ${response.statusText}. ${errorText}`);
        }

        const data = await response.json();
        console.log(`${logPrefix} [${timestamp}] ‚úÖ Response data:`, data);
        
        document.getElementById('totalInvoices').textContent = data.totalInvoices || 0;
        document.getElementById('paidInvoices').textContent = data.paidInvoices || 0;
        document.getElementById('pendingInvoices').textContent = data.pendingInvoices || 0;
        document.getElementById('totalRevenue').textContent = formatCurrency(data.totalRevenue || 0);
        
        console.log(`${logPrefix} [${timestamp}] ========== END loadStatistics (SUCCESS) ==========`);
      } catch (error) {
        console.error(`${logPrefix} [${timestamp}] ‚ùå ========== ERROR in loadStatistics ==========`);
        console.error(`${logPrefix} [${timestamp}] ‚ùå Error:`, error);
        console.error(`${logPrefix} [${timestamp}] ========== END loadStatistics (ERROR) ==========`);
      }
    }

    async function loadPayments() {
      const logPrefix = 'üí∞ [PaymentHistory]';
      const timestamp = new Date().toISOString();
      console.log(`${logPrefix} [${timestamp}] ========== START loadPayments ==========`);
      
      try {
        const token = localStorage.getItem('adminToken') || localStorage.getItem('token');
        console.log(`${logPrefix} [${timestamp}] Token exists:`, !!token);
        console.log(`${logPrefix} [${timestamp}] Token length:`, token ? token.length : 0);
        console.log(`${logPrefix} [${timestamp}] Token preview:`, token ? token.substring(0, 20) + '...' : 'null');
        
        if (!token) {
          console.error(`${logPrefix} [${timestamp}] ‚ùå No token found, redirecting to login`);
          window.location.href = 'login.html';
          return;
        }

        const search = document.getElementById('filterSearch').value;
        const status = document.getElementById('filterStatus').value;
        const fromDate = document.getElementById('filterFromDate').value;
        const toDate = document.getElementById('filterToDate').value;

        console.log(`${logPrefix} [${timestamp}] Filters:`, { search, status, fromDate, toDate });

        let url = `${API_BASE}/invoices?`;
        if (search) url += `search=${encodeURIComponent(search)}&`;
        if (status) url += `status=${encodeURIComponent(status)}&`;
        if (fromDate) url += `fromDate=${fromDate}&`;
        if (toDate) url += `toDate=${toDate}&`;

        console.log(`${logPrefix} [${timestamp}] Request URL:`, url);
        console.log(`${logPrefix} [${timestamp}] API_BASE:`, API_BASE);
        
        const requestHeaders = {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        };
        console.log(`${logPrefix} [${timestamp}] Request headers:`, { ...requestHeaders, 'Authorization': 'Bearer ***' });

        const response = await fetch(url, {
          headers: requestHeaders
        });

        console.log(`${logPrefix} [${timestamp}] Response status:`, response.status, response.statusText);
        console.log(`${logPrefix} [${timestamp}] Response ok:`, response.ok);
        console.log(`${logPrefix} [${timestamp}] Response headers:`, Object.fromEntries(response.headers.entries()));

        if (response.status === 401) {
          const errorText = await response.text().catch(() => 'Cannot read error');
          console.error(`${logPrefix} [${timestamp}] ‚ùå Unauthorized:`, errorText);
          window.location.href = 'login.html';
          return;
        }

        if (!response.ok) {
          const errorText = await response.text().catch(() => 'Cannot read error');
          console.error(`${logPrefix} [${timestamp}] ‚ùå Response error:`, {
            status: response.status,
            statusText: response.statusText,
            body: errorText
          });
          throw new Error(`HTTP ${response.status}: ${response.statusText}. ${errorText}`);
        }

        const invoices = await response.json();
        console.log(`${logPrefix} [${timestamp}] ‚úÖ Response data type:`, Array.isArray(invoices) ? 'Array' : typeof invoices);
        console.log(`${logPrefix} [${timestamp}] ‚úÖ Invoices count:`, Array.isArray(invoices) ? invoices.length : 'N/A');
        console.log(`${logPrefix} [${timestamp}] ‚úÖ Response data preview:`, JSON.stringify(invoices).substring(0, 300));
        
        renderPayments(Array.isArray(invoices) ? invoices : []);
        console.log(`${logPrefix} [${timestamp}] ========== END loadPayments (SUCCESS) ==========`);
      } catch (error) {
        console.error(`${logPrefix} [${timestamp}] ‚ùå ========== ERROR in loadPayments ==========`);
        console.error(`${logPrefix} [${timestamp}] ‚ùå Error name:`, error.name);
        console.error(`${logPrefix} [${timestamp}] ‚ùå Error message:`, error.message);
        console.error(`${logPrefix} [${timestamp}] ‚ùå Error stack:`, error.stack);
        console.error(`${logPrefix} [${timestamp}] ‚ùå Full error:`, error);
        console.error(`${logPrefix} [${timestamp}] ========== END loadPayments (ERROR) ==========`);
        
        if (typeof showToast === 'function') {
          showToast('L·ªói khi t·∫£i l·ªãch s·ª≠ thanh to√°n: ' + error.message, 'error');
        } else {
          alert('L·ªói khi t·∫£i l·ªãch s·ª≠ thanh to√°n: ' + error.message);
        }
      }
    }

    function renderPayments(invoices) {
      const tbody = document.getElementById('paymentsTableBody');
      if (!tbody) return;

      if (invoices.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="text-center">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
        if (paymentsTable) {
          paymentsTable.destroy();
          paymentsTable = null;
        }
        return;
      }

      tbody.innerHTML = invoices.map(invoice => {
        const statusBadge = getStatusBadge(invoice.status);
        const paymentMethod = invoice.paymentMethod || '-';
        const paidDate = invoice.paidDate ? formatDate(invoice.paidDate) : '-';

        return `
          <tr>
            <td><strong>${invoice.invoiceNumber || '-'}</strong></td>
            <td>${invoice.customer?.fullName || 'N/A'}</td>
            <td>${formatDate(invoice.issueDate)}</td>
            <td><strong>${formatCurrency(invoice.totalAmount)}</strong></td>
            <td>${formatCurrency(invoice.paidAmount)}</td>
            <td><strong>${formatCurrency(invoice.balanceDue)}</strong></td>
            <td>${paymentMethod}</td>
            <td>${paidDate}</td>
            <td>${statusBadge}</td>
            <td>
              <button class="btn btn-sm btn-info" onclick="viewInvoice(${invoice.invoiceId})">
                <i class="bx bx-show"></i>
              </button>
            </td>
          </tr>
        `;
      }).join('');

      if (!paymentsTable) {
        paymentsTable = $('#paymentsTable').DataTable({
          order: [[2, 'desc']],
          pageLength: 25,
          language: {
            url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/vi.json'
          }
        });
      } else {
        paymentsTable.clear();
        paymentsTable.rows.add($(tbody).find('tr'));
        paymentsTable.draw();
      }
    }

    function getStatusBadge(status) {
      const badges = {
        'Issued': '<span class="badge bg-warning">ƒê√£ ph√°t h√†nh</span>',
        'PartiallyPaid': '<span class="badge bg-info">Thanh to√°n m·ªôt ph·∫ßn</span>',
        'Paid': '<span class="badge bg-success">ƒê√£ thanh to√°n</span>',
        'Cancelled': '<span class="badge bg-danger">ƒê√£ h·ªßy</span>'
      };
      return badges[status] || `<span class="badge bg-secondary">${status}</span>`;
    }

    async function viewInvoice(invoiceId) {
      try {
        const token = localStorage.getItem('adminToken') || localStorage.getItem('token');
        const response = await fetch(`${API_BASE}/invoices/${invoiceId}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) throw new Error('Failed to load invoice');

        const invoice = await response.json();
        const modalContent = document.getElementById('invoiceDetailContent');
        
        const booking = invoice.booking || {};
        const roomInfo = booking.room 
          ? `${booking.room.roomNumber} (${booking.room.roomTypeNavigation?.typeName || booking.room.roomType || 'N/A'})`
          : (booking.requestedRoomType || 'Ch∆∞a g√°n ph√≤ng');

        modalContent.innerHTML = `
          <div class="row mb-3">
            <div class="col-md-6">
              <strong>S·ªë h√≥a ƒë∆°n:</strong> ${invoice.invoiceNumber || '-'}<br>
              <strong>Kh√°ch h√†ng:</strong> ${invoice.customer?.fullName || 'N/A'}<br>
              <strong>Email:</strong> ${invoice.customer?.email || '-'}<br>
              <strong>ƒêi·ªán tho·∫°i:</strong> ${invoice.customer?.phoneNumber || '-'}
            </div>
            <div class="col-md-6">
              <strong>Ph√≤ng:</strong> ${roomInfo}<br>
              <strong>Ng√†y ph√°t h√†nh:</strong> ${formatDate(invoice.issueDate)}<br>
              <strong>Ng√†y thanh to√°n:</strong> ${invoice.paidDate ? formatDate(invoice.paidDate) : '-'}<br>
              <strong>Tr·∫°ng th√°i:</strong> ${getStatusBadge(invoice.status)}
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-12">
              <table class="table table-bordered">
                <tr>
                  <th>T·ªïng ti·ªÅn</th>
                  <td><strong>${formatCurrency(invoice.totalAmount)}</strong></td>
                </tr>
                <tr>
                  <th>ƒê√£ thanh to√°n</th>
                  <td>${formatCurrency(invoice.paidAmount)}</td>
                </tr>
                <tr>
                  <th>C√≤n l·∫°i</th>
                  <td><strong>${formatCurrency(invoice.balanceDue)}</strong></td>
                </tr>
                <tr>
                  <th>Ph∆∞∆°ng th·ª©c thanh to√°n</th>
                  <td>${invoice.paymentMethod || '-'}</td>
                </tr>
                ${invoice.paymentReference ? `
                <tr>
                  <th>M√£ tham chi·∫øu</th>
                  <td>${invoice.paymentReference}</td>
                </tr>
                ` : ''}
              </table>
            </div>
          </div>
        `;

        const modal = new bootstrap.Modal(document.getElementById('invoiceDetailModal'));
        modal.show();
      } catch (error) {
        console.error('[Payments] Error viewing invoice:', error);
        if (typeof showToast === 'function') {
          showToast('L·ªói khi t·∫£i chi ti·∫øt h√≥a ƒë∆°n', 'error');
        }
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      loadStatistics();
      loadPayments();
    });
  </script>
</body>
</html>

