<!DOCTYPE html>
<html lang="vi" class="light-style layout-menu-fixed" dir="ltr" data-theme="theme-default" data-assets-path="../assets/" data-template="vertical-menu-template-free">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
  <title>Qu·∫£n l√Ω ƒê∆°n ƒë·∫∑t m√≥n - Resort Management</title>
  
  <!-- NO CACHE -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  
  <link rel="icon" type="image/x-icon" href="../assets/img/favicon/favicon.ico" />
  <link rel="stylesheet" href="../assets/vendor/fonts/boxicons.css" />
  <link rel="stylesheet" href="../assets/vendor/css/core.css" class="template-customizer-core-css" />
  <link rel="stylesheet" href="../assets/vendor/css/theme-default.css" class="template-customizer-theme-css" />
  <link rel="stylesheet" href="../assets/css/demo.css" />
  <link rel="stylesheet" href="../assets/css/fix-scrollbar.css" />
  <link rel="stylesheet" href="../assets/css/admin-custom-theme.css" />
  <link rel="stylesheet" href="../assets/css/nalika-style.css?v=20250127" />
  <link rel="stylesheet" href="../assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" />
</head>
<body>
  <div class="layout-wrapper layout-content-navbar">
    <div class="layout-container">

      <!-- Menu - Load from common component -->
      <div id="common-menu"></div>

      <!-- Layout container -->
      <div class="layout-page">
        
        <!-- Navbar -->
        <nav class="layout-navbar container-xxl navbar navbar-expand-xl navbar-detached align-items-center bg-navbar-theme" id="layout-navbar">
          <div class="layout-menu-toggle navbar-nav align-items-xl-center me-3 me-xl-0 d-xl-none">
            <a class="nav-item nav-link px-0 me-xl-4" href="javascript:void(0)">
              <i class="bx bx-menu bx-sm"></i>
            </a>
          </div>

          <div class="navbar-nav-right d-flex align-items-center" id="navbar-collapse">
            <div class="navbar-nav align-items-center">
              <div class="nav-item d-flex align-items-center">
                <h4 class="mb-0">üçΩÔ∏è Qu·∫£n l√Ω ƒê∆°n ƒë·∫∑t m√≥n</h4>
              </div>
            </div>

            <ul class="navbar-nav flex-row align-items-center ms-auto">
              <li class="nav-item navbar-dropdown dropdown-user dropdown">
                <a class="nav-link dropdown-toggle hide-arrow" href="javascript:void(0);" data-bs-toggle="dropdown">
                  <div class="avatar avatar-online">
                    <img src="../assets/img/avatars/1.png" alt class="w-px-40 h-auto rounded-circle" />
                  </div>
                </a>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li>
                    <a class="dropdown-item" href="#">
                      <div class="d-flex">
                        <div class="flex-shrink-0 me-3">
                          <div class="avatar avatar-online">
                            <img src="../assets/img/avatars/1.png" alt class="w-px-40 h-auto rounded-circle" />
                          </div>
                        </div>
                        <div class="flex-grow-1">
                          <span class="fw-semibold d-block" id="userFullName">Admin</span>
                          <small class="text-muted" id="userRole">Administrator</small>
                        </div>
                      </div>
                    </a>
                  </li>
                  <li><div class="dropdown-divider"></div></li>
                  <li>
                    <a class="dropdown-item" href="../html/index.html">
                      <i class="bx bx-home-circle me-2"></i>
                      <span class="align-middle">Dashboard</span>
                    </a>
                  </li>
                  <li><div class="dropdown-divider"></div></li>
                  <li>
                    <a class="dropdown-item" href="javascript:void(0);" id="logoutBtn">
                      <i class="bx bx-power-off me-2"></i>
                      <span class="align-middle">ƒêƒÉng xu·∫•t</span>
                    </a>
                  </li>
                </ul>
              </li>
            </ul>
          </div>
        </nav>

        <!-- Content wrapper -->
        <div class="content-wrapper">
          <!-- Content -->
          <div class="container-xxl flex-grow-1 container-p-y">
            
            <!-- Filters -->
            <div class="card mb-4">
              <div class="card-body">
                <div class="row g-3">
                  <div class="col-md-3">
                    <label class="form-label">Tr·∫°ng th√°i</label>
                    <select id="filterStatus" class="form-select">
                      <option value="">T·∫•t c·∫£</option>
                      <option value="Pending">Ch·ªù x·ª≠ l√Ω</option>
                      <option value="Confirmed">ƒê√£ x√°c nh·∫≠n</option>
                      <option value="Preparing">ƒêang chu·∫©n b·ªã</option>
                      <option value="Ready">S·∫µn s√†ng</option>
                      <option value="Delivered">ƒê√£ giao</option>
                      <option value="Cancelled">ƒê√£ h·ªßy</option>
                    </select>
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">T·ª´ ng√†y</label>
                    <input type="date" id="filterFromDate" class="form-control">
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">ƒê·∫øn ng√†y</label>
                    <input type="date" id="filterToDate" class="form-control">
                  </div>
                  <div class="col-md-3 d-flex align-items-end">
                    <button type="button" class="btn btn-primary w-100" onclick="applyFilters()">
                      <i class="bx bx-filter me-1"></i> L·ªçc
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Orders Table -->
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Danh s√°ch ƒë∆°n ƒë·∫∑t m√≥n</h5>
                <button type="button" class="btn btn-sm btn-primary" onclick="refreshOrders()">
                  <i class="bx bx-refresh me-1"></i> L√†m m·ªõi
                </button>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table id="ordersTable" class="table table-striped table-bordered" style="width:100%">
                    <thead>
                      <tr>
                        <th>M√£ ƒë∆°n</th>
                        <th>Kh√°ch h√†ng</th>
                        <th>S·ªë m√≥n</th>
                        <th>T·ªïng ti·ªÅn</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>Thanh to√°n</th>
                        <th>Ng√†y ƒë·∫∑t</th>
                        <th>Thao t√°c</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>

          </div>
          <!-- / Content -->

          <!-- Footer -->
          <footer class="content-footer footer bg-footer-theme">
            <div class="container-xxl d-flex flex-wrap justify-content-between py-2 flex-md-row flex-column">
              <div class="mb-2 mb-md-0">
                ¬© <script>document.write(new Date().getFullYear())</script> Resort Management System
              </div>
            </div>
          </footer>

          <div class="content-backdrop fade"></div>
        </div>
        <!-- Content wrapper -->
      </div>
    </div>
  </div>

  <div class="layout-overlay layout-menu-toggle"></div>
  </div>

  <!-- Order Details Modal -->
  <div class="modal fade" id="orderDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Chi ti·∫øt ƒë∆°n ƒë·∫∑t m√≥n</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="orderDetailsContent">
          <!-- Content will be loaded here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Update Status Modal -->
  <div class="modal fade" id="updateStatusModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">C·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="updateStatusOrderId">
          <div class="mb-3">
            <label class="form-label">Tr·∫°ng th√°i m·ªõi</label>
            <select id="newStatus" class="form-select">
              <option value="Pending">Ch·ªù x·ª≠ l√Ω</option>
              <option value="Confirmed">ƒê√£ x√°c nh·∫≠n</option>
              <option value="Preparing">ƒêang chu·∫©n b·ªã</option>
              <option value="Ready">S·∫µn s√†ng</option>
              <option value="Delivered">ƒê√£ giao</option>
              <option value="Cancelled">ƒê√£ h·ªßy</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
          <button type="button" class="btn btn-primary" onclick="saveStatusUpdate()">L∆∞u</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Update Payment Status Modal -->
  <div class="modal fade" id="updatePaymentStatusModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">C·∫≠p nh·∫≠t tr·∫°ng th√°i thanh to√°n</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="updatePaymentOrderId">
          <div class="mb-3">
            <label class="form-label">Tr·∫°ng th√°i thanh to√°n</label>
            <select id="newPaymentStatus" class="form-select" onchange="handlePaymentStatusChange()">
              <option value="Unpaid">Ch∆∞a thanh to√°n</option>
              <option value="AwaitingConfirmation">Ch·ªù x√°c nh·∫≠n ti·ªÅn m·∫∑t</option>
              <option value="Paid">ƒê√£ thanh to√°n</option>
              <option value="Refunded">ƒê√£ ho√†n ti·ªÅn</option>
            </select>
          </div>
          <div class="mb-3" id="paymentMethodGroup" style="display: none;">
            <label class="form-label">Ph∆∞∆°ng th·ª©c thanh to√°n</label>
            <select id="newPaymentMethod" class="form-select">
              <option value="">-- Ch·ªçn ph∆∞∆°ng th·ª©c --</option>
              <option value="Cash">Ti·ªÅn m·∫∑t t·∫°i qu·∫ßy</option>
              <option value="Card">Th·∫ª ng√¢n h√†ng</option>
              <option value="QR">QR/Chuy·ªÉn kho·∫£n</option>
              <option value="RoomCharge">Ghi n·ª£ ph√≤ng</option>
              <option value="BankTransfer">Chuy·ªÉn kho·∫£n ng√¢n h√†ng</option>
            </select>
            <small class="text-muted d-block mt-1">B·∫Øt bu·ªôc khi ƒë√°nh d·∫•u ƒë∆°n ƒë√£ thanh to√°n.</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
          <button type="button" class="btn btn-success" onclick="savePaymentStatusUpdate()">L∆∞u</button>
        </div>
      </div>
    </div>
  </div>

  <script src="../assets/vendor/libs/jquery/jquery.js"></script>
  <script src="../assets/vendor/libs/popper/popper.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.js"></script>
  <script src="../assets/vendor/js/helpers.js"></script>
  <script src="../assets/js/config.js"></script>
  <script src="../assets/vendor/js/menu.js"></script>
  <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
  <script src="../../js/api.js"></script>
  <script src="../assets/js/main.js"></script>
  
  <script>
    let ordersTable;

    // Load menu
    fetch('layout-menu.html?v=' + Date.now())
      .then(res => res.text())
      .then(html => {
        document.getElementById('common-menu').innerHTML = html;
        if (typeof initializeMenu === 'function') initializeMenu();
      })
      .catch(err => console.error('Error loading menu:', err));

    // Load user info and handle logout
    document.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '/admin/html/login.html';
        return;
      }

      try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        const userRole = payload.role || payload['http://schemas.microsoft.com/ws/2008/06/identity/claims/role'] || 'Unknown';
        document.getElementById('userFullName').textContent = payload.unique_name || payload.name || 'Admin';
        document.getElementById('userRole').textContent = userRole;
        
        // Check if user has required role (Admin, Manager, or FrontDesk)
        const allowedRoles = ['Admin', 'Manager', 'FrontDesk'];
        if (!allowedRoles.includes(userRole)) {
          alert(`B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y. Y√™u c·∫ßu role: ${allowedRoles.join(', ')}`);
          window.location.href = '/admin/html/dashboard.html';
          return;
        }
        
        console.log('[restaurant-orders] User role:', userRole);
      } catch (e) {
        console.error('Error parsing token:', e);
        alert('Token kh√¥ng h·ª£p l·ªá. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
        localStorage.removeItem('token');
        window.location.href = '/admin/html/login.html';
        return;
      }

      document.getElementById('logoutBtn').addEventListener('click', () => {
        localStorage.removeItem('token');
        window.location.href = '/admin/html/login.html';
      });

      // Load orders first, then initialize DataTable after data is loaded
      loadOrders();
      
      // Auto-refresh every 30 seconds to show new orders
      setInterval(() => {
        console.log('[restaurant-orders] Auto-refreshing orders...');
        loadOrders();
      }, 30000);
    });

    function initDataTable() {
      // Check if table element exists
      const tableEl = document.getElementById('ordersTable');
      if (!tableEl) {
        console.error('[initDataTable] Table element not found!');
        return;
      }
      
      // CRITICAL: Check if table has valid rows (no colspan rows)
      const tbody = tableEl.querySelector('tbody');
      if (!tbody) {
        console.error('[initDataTable] Table tbody not found!');
        return;
      }
      
      const rows = tbody.querySelectorAll('tr');
      let hasValidRows = false;
      let hasColspanRow = false;
      
      rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        // Check if row has colspan (invalid for DataTable)
        if (row.querySelector('td[colspan]')) {
          hasColspanRow = true;
        }
        // Check if row has exactly 8 cells (matching header columns)
        if (cells.length === 8 && !row.querySelector('td[colspan]')) {
          hasValidRows = true;
        }
      });
      
      // Don't initialize DataTable if there are colspan rows
      if (hasColspanRow && !hasValidRows) {
        console.warn('[initDataTable] ‚ö†Ô∏è Table has colspan rows, skipping DataTable initialization');
        return;
      }
      
      // Check if DataTable is already initialized - if so, destroy it first
      if ($.fn.DataTable.isDataTable('#ordersTable')) {
        console.log('[initDataTable] DataTable already initialized, destroying first...');
        try {
          $('#ordersTable').DataTable().destroy();
        } catch (e) {
          console.warn('[initDataTable] ‚ö†Ô∏è Error destroying existing DataTable:', e);
        }
      }
      
      // Load Vietnamese language for DataTables
      $.getJSON('../local-plugins/datatables/i18n/vi.json')
        .done(function(lang) {
          try {
            // Verify table structure before initializing
            const headerCols = tableEl.querySelectorAll('thead tr th').length;
            
            // Find first valid row (no colspan)
            let firstValidRow = null;
            rows.forEach(row => {
              if (!firstValidRow && !row.querySelector('td[colspan]')) {
                const cells = row.querySelectorAll('td');
                if (cells.length === headerCols) {
                  firstValidRow = row;
                }
              }
            });
            
            if (!firstValidRow) {
              console.warn('[initDataTable] ‚ö†Ô∏è No valid rows found, skipping initialization');
              return;
            }
            
            const firstRowCols = firstValidRow.querySelectorAll('td').length;
            
            if (headerCols !== firstRowCols) {
              console.error(`[initDataTable] ‚ùå Column mismatch: Header has ${headerCols} columns, but rows have ${firstRowCols} columns`);
              return;
            }
            
            ordersTable = $('#ordersTable').DataTable({
              language: lang,
              order: [[6, 'desc']], // Sort by date descending
              pageLength: 25,
              responsive: true,
              autoWidth: false,
              destroy: true // Allow re-initialization
            });
            console.log('[initDataTable] ‚úÖ DataTable initialized with Vietnamese language');
          } catch (e) {
            console.error('[initDataTable] ‚ùå Error initializing DataTable:', e);
            console.error('[initDataTable] Error details:', {
              message: e.message,
              stack: e.stack
            });
          }
        })
        .fail(function() {
          // Fallback if language file fails to load
          try {
            // Verify table structure before initializing
            const headerCols = tableEl.querySelectorAll('thead tr th').length;
            
            // Find first valid row (no colspan)
            let firstValidRow = null;
            rows.forEach(row => {
              if (!firstValidRow && !row.querySelector('td[colspan]')) {
                const cells = row.querySelectorAll('td');
                if (cells.length === headerCols) {
                  firstValidRow = row;
                }
              }
            });
            
            if (!firstValidRow) {
              console.warn('[initDataTable] ‚ö†Ô∏è No valid rows found (fallback), skipping initialization');
              return;
            }
            
            const firstRowCols = firstValidRow.querySelectorAll('td').length;
            
            if (headerCols !== firstRowCols) {
              console.error(`[initDataTable] ‚ùå Column mismatch (fallback): Header has ${headerCols} columns, but rows have ${firstRowCols} columns`);
              return;
            }
            
            ordersTable = $('#ordersTable').DataTable({
              order: [[6, 'desc']],
              pageLength: 25,
              responsive: true,
              autoWidth: false,
              destroy: true // Allow re-initialization
            });
            console.log('[initDataTable] ‚úÖ DataTable initialized (fallback)');
          } catch (e) {
            console.error('[initDataTable] ‚ùå Error initializing DataTable (fallback):', e);
            console.error('[initDataTable] Error details:', {
              message: e.message,
              stack: e.stack
            });
          }
        });
    }

    async function loadOrders() {
      try {
        console.log('[loadOrders] Starting to load orders...');
        showPageLoading();
        
        const status = document.getElementById('filterStatus')?.value || '';
        const fromDate = document.getElementById('filterFromDate')?.value || '';
        const toDate = document.getElementById('filterToDate')?.value || '';
        
        let url = `/restaurant-orders`;
        const params = new URLSearchParams();
        if (status) params.append('status', status);
        if (fromDate) params.append('fromDate', fromDate);
        if (toDate) params.append('toDate', toDate);
        if (params.toString()) url += '?' + params.toString();

        console.log('[loadOrders] Request URL:', url);
        console.log('[loadOrders] Full API URL will be:', `${window.API_BASE || window.location.origin + '/api'}${url}`);
        console.log('[loadOrders] Token present:', !!localStorage.getItem('token'));

        // Add cache busting
        const cacheBuster = `?_=${Date.now()}`;
        const finalUrl = url.includes('?') ? `${url}&${cacheBuster.substring(2)}` : `${url}${cacheBuster}`;
        
        console.log('[loadOrders] Final API URL:', finalUrl);
        const orders = await apiGet(finalUrl);
        
        console.log('[loadOrders] ‚úÖ Success! Received orders:', orders?.length || 0, orders);
        
        const tbody = document.querySelector('#ordersTable tbody');
        if (!tbody) {
          console.error('[loadOrders] ‚ùå Table tbody not found!');
          return;
        }
        
        tbody.innerHTML = '';
        
        console.log('[loadOrders] Orders received:', orders?.length || 0);
        console.log('[loadOrders] Orders data:', orders);

        if (orders && orders.length > 0) {
          console.log('[loadOrders] Rendering', orders.length, 'orders');
          orders.forEach(order => {
            const customerName = order.customer ? order.customer.fullName : 'Kh√°ch v√£ng lai';
            const itemCount = order.orderItems ? order.orderItems.length : 0;
            const totalAmount = formatCurrency(order.totalAmount || 0);
            const statusBadge = getStatusBadge(order.status);
            const paymentBadge = getPaymentBadge(order.paymentStatus);
            const orderDate = order.createdAt ? new Date(order.createdAt).toLocaleString('vi-VN') : 'N/A';

            const row = `
              <tr>
                <td><strong>${order.orderNumber}</strong></td>
                <td>${customerName}</td>
                <td>${itemCount} m√≥n</td>
                <td><strong>${totalAmount}</strong></td>
                <td>${statusBadge}</td>
                <td>${paymentBadge}</td>
                <td>${orderDate}</td>
                <td>
                  ${getActionButtons(order)}
                </td>
              </tr>
            `;
            tbody.innerHTML += row;
          });
        }

        console.log('[loadOrders] ‚úÖ Table updated with', orders?.length || 0, 'orders');
        
        // Destroy existing DataTable before re-initializing
        if (ordersTable) {
          try {
            ordersTable.destroy();
            ordersTable = null;
            console.log('[loadOrders] ‚úÖ DataTable destroyed');
          } catch (e) {
            console.warn('[loadOrders] ‚ö†Ô∏è Error destroying DataTable:', e);
          }
        }
        
        // Show empty message if no orders
        if (!orders || orders.length === 0) {
          const emptyRow = `
            <tr>
              <td colspan="8" class="text-center py-5 text-muted">
                <i class="bx bx-info-circle me-2"></i>
                Ch∆∞a c√≥ ƒë∆°n ƒë·∫∑t m√≥n n√†o
              </td>
            </tr>
          `;
          tbody.innerHTML = emptyRow;
          console.log('[loadOrders] ‚ÑπÔ∏è No orders found, showing empty message');
          
          // CRITICAL: Don't initialize DataTable when table is empty (has colspan row)
          // DataTables cannot handle colspan rows during initialization
          if ($.fn.DataTable.isDataTable('#ordersTable')) {
            try {
              $('#ordersTable').DataTable().destroy();
              console.log('[loadOrders] ‚úÖ DataTable destroyed (empty state)');
            } catch (e) {
              console.warn('[loadOrders] ‚ö†Ô∏è Error destroying DataTable:', e);
            }
          }
          return; // Exit early - don't initialize DataTable for empty state
        }
        
        // Re-initialize DataTable AFTER tbody content is set (only if we have data)
        // Use setTimeout to ensure DOM is updated
        setTimeout(() => {
          try {
            // Clear any existing DataTable instance first
            if ($.fn.DataTable.isDataTable('#ordersTable')) {
              $('#ordersTable').DataTable().destroy();
              console.log('[loadOrders] ‚úÖ Existing DataTable destroyed');
            }
            
            // Verify table has valid rows (no colspan) before initializing
            const rows = tbody.querySelectorAll('tr');
            let hasValidRows = false;
            rows.forEach(row => {
              const cells = row.querySelectorAll('td');
              // Check if row has 8 cells (matching header) and no colspan
              if (cells.length === 8 && !row.querySelector('td[colspan]')) {
                hasValidRows = true;
              }
            });
            
            if (hasValidRows) {
              // Re-initialize DataTable only if we have valid rows
              initDataTable();
              
              // Fix dropdown positioning after DataTable initialization
              setTimeout(() => {
                fixDropdownPositioning();
                // Re-initialize Bootstrap dropdowns
                initializeBootstrapDropdowns();
              }, 100);
              
              console.log('[loadOrders] ‚úÖ DataTable re-initialized after data load');
            } else {
              console.warn('[loadOrders] ‚ö†Ô∏è No valid rows found, skipping DataTable initialization');
            }
          } catch (e) {
            console.error('[loadOrders] ‚ùå Error re-initializing DataTable:', e);
            // Don't retry if it failed - might be a structural issue
          }
        }, 150);

      } catch (error) {
        console.error('[loadOrders] ‚ùå Error loading orders:', error);
        console.error('[loadOrders] Error stack:', error.stack);
        console.error('[loadOrders] Error details:', {
          message: error.message,
          name: error.name,
          cause: error.cause
        });
        if (typeof showToast === 'function') {
          showToast('L·ªói khi t·∫£i danh s√°ch ƒë∆°n ƒë·∫∑t m√≥n: ' + error.message, 'danger');
        } else {
          alert('L·ªói khi t·∫£i danh s√°ch ƒë∆°n ƒë·∫∑t m√≥n: ' + error.message);
        }
      } finally {
        hidePageLoading();
      }
    }

    async function viewOrderDetails(orderId) {
      try {
        const order = await apiGet(`/restaurant-orders/${orderId}`);
        
        const itemsHtml = order.orderItems ? order.orderItems.map(item => `
          <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
            <div>
              <strong>${item.service?.serviceName || 'N/A'}</strong>
              <div class="text-muted small">${formatCurrency(item.unitPrice)} √ó ${item.quantity} = ${formatCurrency(item.subTotal)}</div>
              ${item.specialNote ? `<div class="text-info small">Ghi ch√∫: ${item.specialNote}</div>` : ''}
            </div>
          </div>
        `).join('') : '<p class="text-muted">Kh√¥ng c√≥ m√≥n n√†o</p>';

        const content = `
          <div class="row">
            <div class="col-md-6 mb-3">
              <strong>M√£ ƒë∆°n:</strong> ${order.orderNumber}
            </div>
            <div class="col-md-6 mb-3">
              <strong>Ng√†y ƒë·∫∑t:</strong> ${order.createdAt ? new Date(order.createdAt).toLocaleString('vi-VN') : 'N/A'}
            </div>
            <div class="col-md-6 mb-3">
              <strong>Kh√°ch h√†ng:</strong> ${order.customer ? order.customer.fullName : 'Kh√°ch v√£ng lai'}
            </div>
            <div class="col-md-6 mb-3">
              <strong>Email:</strong> ${order.customer ? order.customer.email : 'N/A'}
            </div>
            <div class="col-md-6 mb-3">
              <strong>ƒê·ªãa ch·ªâ giao h√†ng:</strong> ${order.deliveryAddress || 'Ch∆∞a c√≥'}
            </div>
            <div class="col-md-6 mb-3">
              <strong>Th·ªùi gian mong mu·ªën:</strong> ${order.requestedDeliveryTime ? new Date(order.requestedDeliveryTime).toLocaleString('vi-VN') : 'Kh√¥ng ch·ªâ ƒë·ªãnh'}
            </div>
            <div class="col-md-6 mb-3">
              <strong>Tr·∫°ng th√°i:</strong> ${getStatusBadge(order.status)}
            </div>
            <div class="col-md-6 mb-3">
              <strong>Thanh to√°n:</strong> ${getPaymentBadge(order.paymentStatus)}
            </div>
            <div class="col-md-6 mb-3">
              <strong>Ph∆∞∆°ng th·ª©c thanh to√°n:</strong> ${order.paymentMethod || 'Ch∆∞a ch·ªçn'}
            </div>
            <div class="col-md-12 mb-3">
              <strong>Ghi ch√∫ ƒë·∫∑c bi·ªát:</strong> ${order.specialRequests || 'Kh√¥ng c√≥'}
            </div>
            <div class="col-12 mb-3">
              <strong>Danh s√°ch m√≥n:</strong>
              <div class="mt-2">
                ${itemsHtml}
              </div>
            </div>
            <div class="col-12 mb-3 pt-3 border-top">
              <div class="d-flex justify-content-between align-items-center">
                <strong style="font-size: 18px;">T·ªïng ti·ªÅn:</strong>
                <strong style="font-size: 20px; color: var(--color-primary-main, #C8A97E);">${formatCurrency(order.totalAmount || 0)}</strong>
              </div>
            </div>
          </div>
        `;

        document.getElementById('orderDetailsContent').innerHTML = content;
        new bootstrap.Modal(document.getElementById('orderDetailsModal')).show();
      } catch (error) {
        console.error('Error loading order details:', error);
        if (typeof showToast === 'function') {
          showToast('L·ªói khi t·∫£i chi ti·∫øt ƒë∆°n h√†ng: ' + error.message, 'danger');
        } else {
          alert('L·ªói khi t·∫£i chi ti·∫øt ƒë∆°n h√†ng: ' + error.message);
        }
      }
    }

    function updateOrderStatus(orderId, currentStatus) {
      document.getElementById('updateStatusOrderId').value = orderId;
      document.getElementById('newStatus').value = currentStatus;
      new bootstrap.Modal(document.getElementById('updateStatusModal')).show();
    }

    async function saveStatusUpdate() {
      try {
        const orderId = document.getElementById('updateStatusOrderId').value;
        const newStatus = document.getElementById('newStatus').value;

        await apiPatch(`/restaurant-orders/${orderId}/status`, { status: newStatus });
        
        if (typeof showToast === 'function') {
          showToast('C·∫≠p nh·∫≠t tr·∫°ng th√°i th√†nh c√¥ng!', 'success');
        } else {
          alert('C·∫≠p nh·∫≠t tr·∫°ng th√°i th√†nh c√¥ng!');
        }

        bootstrap.Modal.getInstance(document.getElementById('updateStatusModal')).hide();
        loadOrders();
      } catch (error) {
        console.error('Error updating status:', error);
        if (typeof showToast === 'function') {
          showToast('L·ªói khi c·∫≠p nh·∫≠t tr·∫°ng th√°i: ' + error.message, 'danger');
        } else {
          alert('L·ªói khi c·∫≠p nh·∫≠t tr·∫°ng th√°i: ' + error.message);
        }
      }
    }

    function applyFilters() {
      loadOrders();
    }

    function refreshOrders() {
      loadOrders();
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount || 0);
    }

    function getStatusBadge(status) {
      const badges = {
        'Pending': '<span class="badge bg-warning">Ch·ªù x·ª≠ l√Ω</span>',
        'Confirmed': '<span class="badge bg-info">ƒê√£ x√°c nh·∫≠n</span>',
        'Preparing': '<span class="badge bg-primary">ƒêang chu·∫©n b·ªã</span>',
        'Ready': '<span class="badge bg-success">S·∫µn s√†ng</span>',
        'Delivered': '<span class="badge bg-secondary">ƒê√£ giao</span>',
        'Cancelled': '<span class="badge bg-danger">ƒê√£ h·ªßy</span>'
      };
      return badges[status] || `<span class="badge bg-secondary">${status}</span>`;
    }

    function getPaymentBadge(paymentStatus) {
      const badges = {
        'Unpaid': '<span class="badge bg-danger">Ch∆∞a thanh to√°n</span>',
        'Paid': '<span class="badge bg-success">ƒê√£ thanh to√°n</span>',
        'Refunded': '<span class="badge bg-warning">ƒê√£ ho√†n ti·ªÅn</span>',
        'AwaitingConfirmation': '<span class="badge bg-warning text-dark">Ch·ªù x√°c nh·∫≠n</span>'
      };
      return badges[paymentStatus] || `<span class="badge bg-secondary">${paymentStatus}</span>`;
    }

    async function approveCashPayment(orderId) {
      const confirmMessage = 'X√°c nh·∫≠n ƒë∆°n n√†y ƒë√£ thanh to√°n t·∫°i nh√† h√†ng?';
      if (!confirm(confirmMessage)) return;

      const approveBtn = document.querySelector(`[data-approve-order="${orderId}"]`);
      if (approveBtn) {
        approveBtn.disabled = true;
        approveBtn.classList.add('disabled');
      }

      try {
        await apiPost(`/restaurant-orders/${orderId}/approve-cash-payment`, {});

        if (typeof showToast === 'function') {
          showToast('ƒê√£ x√°c nh·∫≠n thanh to√°n ti·ªÅn m·∫∑t th√†nh c√¥ng!', 'success');
        } else {
          alert('ƒê√£ x√°c nh·∫≠n thanh to√°n ti·ªÅn m·∫∑t th√†nh c√¥ng!');
        }

        loadOrders();
      } catch (error) {
        console.error('[approveCashPayment] Error:', error);
        if (typeof showToast === 'function') {
          showToast('Kh√¥ng th·ªÉ x√°c nh·∫≠n thanh to√°n: ' + (error.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'), 'danger');
        } else {
          alert('Kh√¥ng th·ªÉ x√°c nh·∫≠n thanh to√°n: ' + (error.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'));
        }
      } finally {
        if (approveBtn) {
          approveBtn.disabled = false;
          approveBtn.classList.remove('disabled');
        }
      }
    }

    function openPaymentStatusModal(orderId, paymentStatus, paymentMethod) {
      document.getElementById('updatePaymentOrderId').value = orderId;
      document.getElementById('newPaymentStatus').value = paymentStatus || 'Unpaid';
      document.getElementById('newPaymentMethod').value = paymentMethod || '';
      handlePaymentStatusChange();
      new bootstrap.Modal(document.getElementById('updatePaymentStatusModal')).show();
    }

    function handlePaymentStatusChange() {
      const paymentStatus = document.getElementById('newPaymentStatus').value;
      const methodGroup = document.getElementById('paymentMethodGroup');
      if (!methodGroup) return;
      if (paymentStatus === 'Paid') {
        methodGroup.style.display = 'block';
      } else {
        methodGroup.style.display = 'none';
        document.getElementById('newPaymentMethod').value = '';
      }
    }

    async function savePaymentStatusUpdate() {
      try {
        const orderId = document.getElementById('updatePaymentOrderId').value;
        const paymentStatus = document.getElementById('newPaymentStatus').value;
        const paymentMethod = document.getElementById('newPaymentMethod').value;

        if (paymentStatus === 'Paid' && !paymentMethod) {
          if (typeof showToast === 'function') {
            showToast('Vui l√≤ng ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n.', 'warning');
          } else {
            alert('Vui l√≤ng ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n.');
          }
          return;
        }

        const payload = {
          paymentStatus
        };

        if (paymentStatus === 'Paid') {
          payload.paymentMethod = paymentMethod;
        }

        await apiPatch(`/restaurant-orders/${orderId}/payment-status`, payload);

        if (typeof showToast === 'function') {
          showToast('C·∫≠p nh·∫≠t tr·∫°ng th√°i thanh to√°n th√†nh c√¥ng!', 'success');
        } else {
          alert('C·∫≠p nh·∫≠t tr·∫°ng th√°i thanh to√°n th√†nh c√¥ng!');
        }

        bootstrap.Modal.getInstance(document.getElementById('updatePaymentStatusModal')).hide();
        loadOrders();
      } catch (error) {
        console.error('Error updating payment status:', error);
        if (typeof showToast === 'function') {
          showToast('L·ªói khi c·∫≠p nh·∫≠t tr·∫°ng th√°i thanh to√°n: ' + error.message, 'danger');
        } else {
          alert('L·ªói khi c·∫≠p nh·∫≠t tr·∫°ng th√°i thanh to√°n: ' + error.message);
        }
      }
    }

    function escapeAttribute(value) {
      if (!value) return '';
      return String(value).replace(/'/g, "\\'").replace(/"/g, '&quot;');
    }

    function getActionButtons(order) {
      const viewBtn = `
        <button class="action-btn action-btn-view" onclick="viewOrderDetails(${order.orderId})" title="Xem chi ti·∫øt">
          <i class="bx bx-show"></i>
        </button>`;

      const statusBtn = `
        <button class="action-btn action-btn-edit" onclick="updateOrderStatus(${order.orderId}, '${order.status}')" title="C·∫≠p nh·∫≠t tr·∫°ng th√°i">
          <i class="bx bx-edit"></i>
        </button>`;

      const paymentBtn = `
        <button class="action-btn action-btn-pay" onclick="openPaymentStatusModal(${order.orderId}, '${escapeAttribute(order.paymentStatus)}', '${escapeAttribute(order.paymentMethod || '')}')" title="C·∫≠p nh·∫≠t tr·∫°ng th√°i thanh to√°n">
          <i class="bx bx-credit-card"></i>
        </button>`;

      const cashBtn = (order.paymentStatus === 'AwaitingConfirmation')
        ? `
          <button class="action-btn action-btn-approve" data-approve-order="${order.orderId}" onclick="approveCashPayment(${order.orderId})" title="X√°c nh·∫≠n thanh to√°n t·∫°i nh√† h√†ng">
            <i class="bx bx-check-shield"></i>
          </button>`
        : '';

      return `<div class="action-buttons">${viewBtn}${statusBtn}${paymentBtn}${cashBtn}</div>`;
    }
    
    // Fix dropdown positioning for DataTables - CRITICAL FIX
    function fixDropdownPositioning() {
      const dropdowns = document.querySelectorAll('#ordersTable .dropdown');
      dropdowns.forEach(dropdown => {
        const button = dropdown.querySelector('.dropdown-toggle');
        const menu = dropdown.querySelector('.dropdown-menu');
        
        if (button && menu) {
          // Remove any transform from parent elements that create stacking context
          let parent = dropdown.parentElement;
          while (parent && parent !== document.body) {
            const style = window.getComputedStyle(parent);
            if (style.transform && style.transform !== 'none') {
              console.warn('Found transform on parent:', parent);
            }
            parent = parent.parentElement;
          }
          
          // Ensure dropdown container doesn't create stacking context
          dropdown.style.position = 'static';
          dropdown.style.transform = 'none';
          dropdown.style.filter = 'none';
          dropdown.style.opacity = '1';
          dropdown.style.perspective = 'none';
          
          // Calculate position when dropdown opens
          const calculatePosition = () => {
            const rect = button.getBoundingClientRect();
            const scrollX = window.pageXOffset || document.documentElement.scrollLeft;
            const scrollY = window.pageYOffset || document.documentElement.scrollTop;
            
            // Use fixed positioning to escape all stacking contexts
            menu.style.position = 'fixed';
            menu.style.top = (rect.bottom + scrollY + 5) + 'px';
            menu.style.right = (window.innerWidth - rect.right) + 'px';
            menu.style.left = 'auto';
            menu.style.zIndex = '99999';
            menu.style.isolation = 'isolate';
            
            // Ensure menu is visible
            menu.style.visibility = 'visible';
            menu.style.opacity = '1';
            menu.style.display = 'block';
          };
          
          // Fix positioning when dropdown opens
          button.addEventListener('show.bs.dropdown', function(e) {
            e.preventDefault();
            e.stopPropagation();
            calculatePosition();
          });
          
          // Also handle click event
          button.addEventListener('click', function(e) {
            // Small delay to ensure Bootstrap has processed the click
            setTimeout(() => {
              if (menu.classList.contains('show')) {
                calculatePosition();
              }
            }, 10);
          });
          
          // Reset when dropdown closes
          button.addEventListener('hidden.bs.dropdown', function() {
            menu.style.position = 'fixed'; // Keep fixed even when closed
            menu.style.visibility = 'hidden';
          });
          
          // Handle window resize/scroll
          let resizeTimer;
          const handleResize = () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
              if (menu.classList.contains('show')) {
                calculatePosition();
              }
            }, 100);
          };
          
          window.addEventListener('resize', handleResize);
          window.addEventListener('scroll', handleResize, true);
        }
      });
    }
    
    // Initialize Bootstrap dropdowns with proper configuration
    function initializeBootstrapDropdowns() {
      if (typeof bootstrap !== 'undefined' && bootstrap.Dropdown) {
        const dropdownToggles = document.querySelectorAll('#ordersTable .dropdown-toggle');
        dropdownToggles.forEach(toggle => {
          try {
            // Destroy existing instance if any
            const existing = bootstrap.Dropdown.getInstance(toggle);
            if (existing) {
              existing.dispose();
            }
            
            // Initialize with custom popper config to escape stacking contexts
            new bootstrap.Dropdown(toggle, {
              boundary: document.body, // Use body as boundary
              popperConfig: {
                strategy: 'fixed', // Use fixed positioning
                placement: 'bottom-end',
                modifiers: [
                  {
                    name: 'preventOverflow',
                    options: {
                      boundary: document.body,
                      padding: 8
                    }
                  },
                  {
                    name: 'flip',
                    options: {
                      boundary: document.body,
                      padding: 8
                    }
                  },
                  {
                    name: 'offset',
                    options: {
                      offset: [0, 5]
                    }
                  }
                ]
              }
            });
          } catch (e) {
            console.warn('Error initializing dropdown:', e);
          }
        });
      }
    }
  </script>

</body>
</html>

