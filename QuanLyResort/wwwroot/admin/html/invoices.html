<!DOCTYPE html>
<html lang="vi" class="light-style layout-menu-fixed" dir="ltr" data-theme="theme-default" data-assets-path="../assets/" data-template="vertical-menu-template-free">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
  <title>Qu·∫£n l√Ω H√≥a ƒë∆°n ƒë·∫∑t ph√≤ng - Resort Management</title>
  
  <!-- NO CACHE -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  
  <link rel="icon" type="image/x-icon" href="../assets/img/favicon/favicon.ico" />
  <link rel="stylesheet" href="../assets/vendor/fonts/boxicons.css" />
  <link rel="stylesheet" href="../assets/vendor/css/core.css" class="template-customizer-core-css" />
  <link rel="stylesheet" href="../assets/vendor/css/theme-default.css" class="template-customizer-theme-css" />
  <link rel="stylesheet" href="../assets/css/demo.css" />
  <link rel="stylesheet" href="../assets/css/fix-scrollbar.css" />
  <link rel="stylesheet" href="../assets/css/admin-custom-theme.css" />
  <link rel="stylesheet" href="../assets/css/nalika-style.css?v=20250127" />
  <link rel="stylesheet" href="../assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" />
</head>
<body>
  <div class="layout-wrapper layout-content-navbar">
    <div class="layout-container">

      <!-- Menu - Load from common component -->
      <div id="common-menu"></div>

      <!-- Layout container -->
      <div class="layout-page">
        
        <!-- Navbar -->
        <nav class="layout-navbar container-xxl navbar navbar-expand-xl navbar-detached align-items-center bg-navbar-theme" id="layout-navbar">
          <div class="layout-menu-toggle navbar-nav align-items-xl-center me-3 me-xl-0 d-xl-none">
            <a class="nav-item nav-link px-0 me-xl-4" href="javascript:void(0)">
              <i class="bx bx-menu bx-sm"></i>
            </a>
          </div>

          <div class="navbar-nav-right d-flex align-items-center" id="navbar-collapse">
            <div class="navbar-nav align-items-center">
              <div class="nav-item d-flex align-items-center">
                <h4 class="mb-0">üßæ Qu·∫£n l√Ω H√≥a ƒë∆°n ƒë·∫∑t ph√≤ng</h4>
              </div>
            </div>

            <ul class="navbar-nav flex-row align-items-center ms-auto">
              <li class="nav-item navbar-dropdown dropdown-user dropdown">
                <a class="nav-link dropdown-toggle hide-arrow" href="javascript:void(0);" data-bs-toggle="dropdown">
                  <div class="avatar avatar-online">
                    <img src="../assets/img/avatars/1.png" alt class="w-px-40 h-auto rounded-circle" />
                  </div>
                </a>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li>
                    <a class="dropdown-item" href="#">
                      <div class="d-flex">
                        <div class="flex-shrink-0 me-3">
                          <div class="avatar avatar-online">
                            <img src="../assets/img/avatars/1.png" alt class="w-px-40 h-auto rounded-circle" />
                          </div>
                        </div>
                        <div class="flex-grow-1">
                          <span class="fw-semibold d-block" id="userFullName">Admin</span>
                          <small class="text-muted" id="userRole">Administrator</small>
                        </div>
                      </div>
                    </a>
                  </li>
                  <li><div class="dropdown-divider"></div></li>
                  <li>
                    <a class="dropdown-item" href="../html/index.html">
                      <i class="bx bx-home-circle me-2"></i>
                      <span class="align-middle">Dashboard</span>
                    </a>
                  </li>
                  <li><div class="dropdown-divider"></div></li>
                  <li>
                    <a class="dropdown-item" href="javascript:void(0);" id="logoutBtn">
                      <i class="bx bx-power-off me-2"></i>
                      <span class="align-middle">ƒêƒÉng xu·∫•t</span>
                    </a>
                  </li>
                </ul>
              </li>
            </ul>
          </div>
        </nav>
        <!-- / Navbar -->

        <!-- Content wrapper -->
        <div class="content-wrapper">
          <div class="container-xxl flex-grow-1 container-p-y">
            
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
              <div>
                <h4 class="fw-bold mb-0">üßæ Danh s√°ch H√≥a ƒë∆°n ƒë·∫∑t ph√≤ng</h4>
                <p class="text-muted mb-0">Qu·∫£n l√Ω h√≥a ƒë∆°n ƒë·∫∑t ph√≤ng v√† thanh to√°n</p>
              </div>
              <button type="button" class="btn btn-primary" onclick="exportToPDF()">
                <i class="bx bx-printer me-1"></i> Xu·∫•t b√°o c√°o
              </button>
            </div>

            <!-- Statistics Cards -->
            <div class="row mb-4">
              <div class="col-md-3 col-6 mb-4">
                <div class="card">
                  <div class="card-body">
                    <div class="card-title d-flex align-items-start justify-content-between">
                      <div class="avatar flex-shrink-0">
                        <span class="avatar-initial rounded bg-label-primary"><i class="bx bx-file"></i></span>
                      </div>
                    </div>
                    <span class="fw-semibold d-block mb-1">T·ªïng h√≥a ƒë∆°n ƒë·∫∑t ph√≤ng</span>
                    <h3 class="card-title mb-2" id="totalInvoices">0</h3>
                  </div>
                </div>
              </div>
              <div class="col-md-3 col-6 mb-4">
                <div class="card">
                  <div class="card-body">
                    <div class="card-title d-flex align-items-start justify-content-between">
                      <div class="avatar flex-shrink-0">
                        <span class="avatar-initial rounded bg-label-success"><i class="bx bx-check-circle"></i></span>
                      </div>
                    </div>
                    <span class="fw-semibold d-block mb-1">ƒê√£ thanh to√°n</span>
                    <h3 class="card-title mb-2" id="paidInvoices">0</h3>
                  </div>
                </div>
              </div>
              <div class="col-md-3 col-6 mb-4">
                <div class="card">
                  <div class="card-body">
                    <div class="card-title d-flex align-items-start justify-content-between">
                      <div class="avatar flex-shrink-0">
                        <span class="avatar-initial rounded bg-label-warning"><i class="bx bx-time-five"></i></span>
                      </div>
                    </div>
                    <span class="fw-semibold d-block mb-1">Ch∆∞a thanh to√°n</span>
                    <h3 class="card-title mb-2" id="pendingInvoices">0</h3>
                  </div>
                </div>
              </div>
              <div class="col-md-3 col-6 mb-4">
                <div class="card">
                  <div class="card-body">
                    <div class="card-title d-flex align-items-start justify-content-between">
                      <div class="avatar flex-shrink-0">
                        <span class="avatar-initial rounded bg-label-info"><i class="bx bx-dollar"></i></span>
                      </div>
                    </div>
                    <span class="fw-semibold d-block mb-1">T·ªïng doanh thu</span>
                    <h3 class="card-title mb-2" id="totalRevenue">0ƒë</h3>
                  </div>
                </div>
              </div>
            </div>

            <!-- Filters -->
            <div class="card mb-4">
              <div class="card-body">
                <div class="row g-3">
                  <div class="col-md-3">
                    <label class="form-label">T√¨m ki·∫øm</label>
                    <input type="text" id="searchInput" class="form-control" placeholder="S·ªë h√≥a ƒë∆°n, kh√°ch h√†ng...">
                  </div>
                  <div class="col-md-2">
                    <label class="form-label">Tr·∫°ng th√°i</label>
                    <select id="filterStatus" class="form-select">
                      <option value="">T·∫•t c·∫£</option>
                      <option value="Issued">ƒê√£ ph√°t h√†nh</option>
                      <option value="PartiallyPaid">Thanh to√°n m·ªôt ph·∫ßn</option>
                      <option value="Paid">ƒê√£ thanh to√°n</option>
                      <option value="Cancelled">ƒê√£ h·ªßy</option>
                    </select>
                  </div>
                  <div class="col-md-2">
                    <label class="form-label">T·ª´ ng√†y</label>
                    <input type="date" id="fromDate" class="form-control">
                  </div>
                  <div class="col-md-2">
                    <label class="form-label">ƒê·∫øn ng√†y</label>
                    <input type="date" id="toDate" class="form-control">
                  </div>
                  <div class="col-md-3 d-flex align-items-end">
                    <button type="button" class="btn btn-primary w-100" id="btnFilter">
                      <i class="bx bx-search me-1"></i> L·ªçc
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Invoices Table -->
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">Danh s√°ch h√≥a ƒë∆°n ƒë·∫∑t ph√≤ng</h5>
              </div>
              <div class="card-body">
                <div class="table-responsive text-nowrap">
                  <table id="invoicesTable" class="table table-hover">
                    <thead>
                      <tr>
                        <th>S·ªë Hƒê</th>
                        <th>Kh√°ch h√†ng</th>
                        <th>Ng√†y ph√°t h√†nh</th>
                        <th>T·ªïng ti·ªÅn</th>
                        <th>ƒê√£ thanh to√°n</th>
                        <th>C√≤n l·∫°i</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>Thao t√°c</th>
                      </tr>
                    </thead>
                    <tbody>
                      <!-- Data loaded here -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

          </div>
        </div>

      </div>
    </div>
    <!-- / Layout container -->
  </div>

  <div class="layout-overlay layout-menu-toggle"></div>
  </div>

  <!-- Toast container -->
  <div class="position-fixed top-0 end-0 p-3" style="z-index:1080">
    <div id="toastContainer"></div>
  </div>

  <!-- View Details Modal -->
  <div class="modal fade" id="viewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Chi ti·∫øt H√≥a ƒë∆°n ƒë·∫∑t ph√≤ng</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="invoiceDetails">
          <!-- Details loaded here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
          <button type="button" class="btn btn-primary" id="btnExportInvoicePDF">
            <i class="bx bx-file me-1"></i> Xu·∫•t PDF
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Payment Modal -->
  <div class="modal fade" id="paymentModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Thanh to√°n H√≥a ƒë∆°n ƒë·∫∑t ph√≤ng</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="paymentForm">
            <input type="hidden" id="paymentInvoiceId" />
            <div class="mb-3">
              <label for="paymentAmount" class="form-label">S·ªë ti·ªÅn <span class="text-danger">*</span></label>
              <input type="number" class="form-control" id="paymentAmount" step="0.01" min="0" required>
              <small class="text-muted">S·ªë ti·ªÅn c√≤n l·∫°i: <strong id="remainingAmount">0ƒë</strong></small>
            </div>
            <div class="mb-3">
              <label for="paymentMethod" class="form-label">Ph∆∞∆°ng th·ª©c thanh to√°n <span class="text-danger">*</span></label>
              <select class="form-select" id="paymentMethod" required>
                <option value="">Ch·ªçn ph∆∞∆°ng th·ª©c</option>
                <option value="Cash">Ti·ªÅn m·∫∑t</option>
                <option value="CreditCard">Th·∫ª t√≠n d·ª•ng</option>
                <option value="BankTransfer">Chuy·ªÉn kho·∫£n</option>
                <option value="Momo">MoMo</option>
                <option value="ZaloPay">ZaloPay</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="paymentReference" class="form-label">S·ªë tham chi·∫øu</label>
              <input type="text" class="form-control" id="paymentReference" placeholder="M√£ giao d·ªãch, tham chi·∫øu...">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
          <button type="button" class="btn btn-primary" id="btnProcessPayment">X√°c nh·∫≠n thanh to√°n</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Core JS -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/perfect-scrollbar@1.5.3/dist/perfect-scrollbar.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- Template helpers & config (required for Menu/Helpers) -->
  <script src="../assets/vendor/js/helpers.js"></script>
  <script src="../assets/js/config.js"></script>
  <script src="../assets/vendor/js/menu.js"></script>
  <script src="../assets/js/main.js"></script>
  <script src="../../js/api.js"></script>
  

  <script>
    function showToast(message, type = 'success') {
      const container = document.getElementById('toastContainer');
      const wrapper = document.createElement('div');
      wrapper.className = `toast align-items-center text-bg-${type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'danger'} border-0`;
      wrapper.setAttribute('role', 'alert');
      wrapper.setAttribute('aria-live', 'assertive');
      wrapper.setAttribute('aria-atomic', 'true');
      wrapper.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>`;
      container.appendChild(wrapper);
      const toast = new bootstrap.Toast(wrapper, { delay: 2500 });
      toast.show();
      wrapper.addEventListener('hidden.bs.toast', () => wrapper.remove());
    }

    let invoicesTable;
    let currentInvoice = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('üöÄ Invoices page loaded');
      
      // Load menu
      try {
        const menuResponse = await fetch('layout-menu.html?v=' + Date.now());
        const menuHtml = await menuResponse.text();
        document.getElementById('common-menu').innerHTML = menuHtml;
      } catch (error) {
        console.error('Error loading menu:', error);
      }
      
      // Check auth
      const token = localStorage.getItem('token');
      const userStr = localStorage.getItem('user');
      

      const user = JSON.parse(userStr);
      document.getElementById('userFullName').textContent = user.fullName || 'Admin';
      document.getElementById('userRole').textContent = user.role || 'Administrator';
      
      await loadAllData();
      setupEventListeners();
      
      // Auto-refresh every 30 seconds
      setInterval(async () => {
        try {
          await Promise.all([
            loadStatistics(),
            loadInvoices()
          ]);
        } catch (error) {
          console.error('Error auto-refreshing invoices:', error);
        }
      }, 30000); // 30 seconds
    });

    // Load all data
    async function loadAllData() {
      try {
        await Promise.all([
          loadStatistics(),
          loadInvoices()
        ]);
      } catch (error) {
        console.error('Error loading data:', error);
        showToast('L·ªói t·∫£i d·ªØ li·ªáu: ' + error.message, 'danger');
      }
    }

    // Load statistics
    async function loadStatistics() {
      try {
        const data = await apiGet('/invoices/statistics');
        document.getElementById('totalInvoices').textContent = data.totalInvoices;
        document.getElementById('paidInvoices').textContent = data.paidInvoices;
        document.getElementById('pendingInvoices').textContent = data.pendingInvoices;
        document.getElementById('totalRevenue').textContent = formatCurrency(data.totalRevenue);
      } catch (error) {
        console.error('Error loading statistics:', error);
      }
    }

    // Load invoices
    async function loadInvoices() {
      try {
        const search = document.getElementById('searchInput').value;
        const status = document.getElementById('filterStatus').value;
        const fromDate = document.getElementById('fromDate').value;
        const toDate = document.getElementById('toDate').value;

        let url = '/invoices?';
        if (search) url += `search=${encodeURIComponent(search)}&`;
        if (status) url += `status=${encodeURIComponent(status)}&`;
        if (fromDate) url += `fromDate=${fromDate}&`;
        if (toDate) url += `toDate=${toDate}&`;

        const invoices = await apiGet(url);

        // Clear existing table
        if (invoicesTable) {
          invoicesTable.destroy();
        }

        const tbody = document.querySelector('#invoicesTable tbody');
        tbody.innerHTML = '';

        if (invoices && invoices.length > 0) {
          invoices.forEach(invoice => {
            const statusBadge = getStatusBadge(invoice.status);
            const issueDate = new Date(invoice.issueDate).toLocaleDateString('vi-VN');

            const bookingInfo = invoice.booking 
              ? `${invoice.booking.requestedRoomType || 'N/A'} - #${invoice.bookingId}`
              : `#${invoice.bookingId}`;
            
            const row = `
              <tr>
                <td><strong>${invoice.invoiceNumber}</strong></td>
                <td>${invoice.customer?.fullName || 'N/A'}<br><small class="text-muted">${bookingInfo}</small></td>
                <td>${issueDate}</td>
                <td><strong>${formatCurrency(invoice.totalAmount)}</strong></td>
                <td>${formatCurrency(invoice.paidAmount)}</td>
                <td><strong>${formatCurrency(invoice.balanceDue)}</strong></td>
                <td>${statusBadge}</td>
                <td>
                  <div class="action-buttons">
                    <button class="action-btn action-btn-view" onclick="handleViewInvoice(${invoice.invoiceId})" title="Xem chi ti·∫øt">
                      <i class="bx bx-show"></i>
                    </button>
                    ${invoice.balanceDue > 0 ? `
                    <button class="action-btn action-btn-add" onclick="handleOpenPaymentModal(${invoice.invoiceId})" title="Thanh to√°n">
                      <i class="bx bx-credit-card"></i>
                    </button>
                    ` : ''}
                    ${invoice.status !== 'Paid' && invoice.status !== 'Cancelled' ? `
                    <button class="action-btn action-btn-delete" onclick="handleCancelInvoice(${invoice.invoiceId})" title="H·ªßy h√≥a ƒë∆°n">
                      <i class="bx bx-x"></i>
                    </button>
                    ` : ''}
                  </div>
                </td>
              </tr>
            `;
            tbody.innerHTML += row;
          });
        }

        invoicesTable = $('#invoicesTable').DataTable({
          pageLength: 10,
          order: [[2, 'desc']]
        });
      } catch (error) {
        console.error('Error loading invoices:', error);
        showToast('L·ªói t·∫£i danh s√°ch h√≥a ƒë∆°n ƒë·∫∑t ph√≤ng: ' + error.message, 'danger');
      }
    }

    // Get status badge
    function getStatusBadge(status) {
      const badges = {
        'Issued': '<span class="badge bg-warning">ƒê√£ ph√°t h√†nh</span>',
        'PartiallyPaid': '<span class="badge bg-info">Thanh to√°n m·ªôt ph·∫ßn</span>',
        'Paid': '<span class="badge bg-success">ƒê√£ thanh to√°n</span>',
        'Cancelled': '<span class="badge bg-danger">ƒê√£ h·ªßy</span>'
      };
      return badges[status] || '<span class="badge bg-secondary">' + status + '</span>';
    }

    // View invoice details
    async function handleViewInvoice(id) {
      try {
        const invoice = await apiGet(`/invoices/${id}`);
        currentInvoice = invoice;
        
        // Format booking info
        const booking = invoice.booking || {};
        const roomInfo = booking.room 
          ? `${booking.room.roomNumber} (${booking.room.roomTypeNavigation?.typeName || booking.room.roomType || 'N/A'})`
          : (booking.requestedRoomType || 'Ch∆∞a g√°n ph√≤ng');
        const checkInDate = booking.checkInDate ? new Date(booking.checkInDate).toLocaleDateString('vi-VN') : 'N/A';
        const checkOutDate = booking.checkOutDate ? new Date(booking.checkOutDate).toLocaleDateString('vi-VN') : 'N/A';
        
        const detailsHtml = `
          <div class="row">
            <div class="col-md-6 mb-3">
              <strong>S·ªë h√≥a ƒë∆°n:</strong> ${invoice.invoiceNumber}
            </div>
            <div class="col-md-6 mb-3">
              <strong>Ng√†y ph√°t h√†nh:</strong> ${new Date(invoice.issueDate).toLocaleDateString('vi-VN')}
            </div>
            <div class="col-md-6 mb-3">
              <strong>Kh√°ch h√†ng:</strong> ${invoice.customer?.fullName || 'N/A'}
            </div>
            <div class="col-md-6 mb-3">
              <strong>Booking ID:</strong> #${invoice.bookingId}
            </div>
            ${booking.requestedRoomType ? `
            <div class="col-md-6 mb-3">
              <strong>Lo·∫°i ph√≤ng:</strong> ${booking.requestedRoomType}
            </div>
            ` : ''}
            ${roomInfo && roomInfo !== booking.requestedRoomType ? `
            <div class="col-md-6 mb-3">
              <strong>Ph√≤ng ƒë√£ g√°n:</strong> ${roomInfo}
            </div>
            ` : ''}
            ${booking.checkInDate ? `
            <div class="col-md-6 mb-3">
              <strong>Check-in:</strong> ${checkInDate}
            </div>
            ` : ''}
            ${booking.checkOutDate ? `
            <div class="col-md-6 mb-3">
              <strong>Check-out:</strong> ${checkOutDate}
            </div>
            ` : ''}
            ${booking.numberOfGuests ? `
            <div class="col-md-6 mb-3">
              <strong>S·ªë kh√°ch:</strong> ${booking.numberOfGuests}
            </div>
            ` : ''}
            <div class="col-12 mb-3">
              <hr>
              <h6>Th√¥ng tin thanh to√°n</h6>
              <div class="row">
                <div class="col-md-4">T·ªïng ti·ªÅn:</div>
                <div class="col-md-8"><strong>${formatCurrency(invoice.subTotal)}</strong></div>
                <div class="col-md-4">Thu·∫ø (${invoice.taxRate || 10}%):</div>
                <div class="col-md-8"><strong>${formatCurrency(invoice.taxAmount)}</strong></div>
                <div class="col-md-4">Gi·∫£m gi√°:</div>
                <div class="col-md-8"><strong>${formatCurrency(invoice.discountAmount || 0)}</strong></div>
                <div class="col-md-4">T·ªïng c·ªông:</div>
                <div class="col-md-8"><strong>${formatCurrency(invoice.totalAmount)}</strong></div>
                <div class="col-md-4">ƒê√£ thanh to√°n:</div>
                <div class="col-md-8"><strong class="text-success">${formatCurrency(invoice.paidAmount)}</strong></div>
                <div class="col-md-4">C√≤n l·∫°i:</div>
                <div class="col-md-8"><strong class="text-danger">${formatCurrency(invoice.balanceDue)}</strong></div>
              </div>
            </div>
            ${invoice.paymentMethod ? `
            <div class="col-12 mb-3">
              <hr>
              <strong>Ph∆∞∆°ng th·ª©c thanh to√°n:</strong> ${invoice.paymentMethod}
              ${invoice.paymentReference ? `<br><strong>S·ªë tham chi·∫øu:</strong> ${invoice.paymentReference}` : ''}
              ${invoice.paidDate ? `<br><strong>Ng√†y thanh to√°n:</strong> ${new Date(invoice.paidDate).toLocaleDateString('vi-VN')}` : ''}
            </div>
            ` : ''}
            <div class="col-12">
              <strong>Tr·∫°ng th√°i:</strong> ${getStatusBadge(invoice.status)}
            </div>
          </div>
        `;
        
        document.getElementById('invoiceDetails').innerHTML = detailsHtml;
        new bootstrap.Modal(document.getElementById('viewModal')).show();
      } catch (error) {
        showToast('L·ªói t·∫£i chi ti·∫øt h√≥a ƒë∆°n ƒë·∫∑t ph√≤ng: ' + error.message, 'danger');
      }
    }

    // Open payment modal
    async function handleOpenPaymentModal(id) {
      try {
        const invoice = await apiGet(`/invoices/${id}`);
        currentInvoice = invoice;
        
        document.getElementById('paymentInvoiceId').value = id;
        document.getElementById('paymentAmount').value = invoice.balanceDue;
        document.getElementById('remainingAmount').textContent = formatCurrency(invoice.balanceDue);
        
        new bootstrap.Modal(document.getElementById('paymentModal')).show();
      } catch (error) {
        showToast('L·ªói t·∫£i th√¥ng tin thanh to√°n: ' + error.message, 'danger');
      }
    }

    // Process payment
    async function handleProcessPayment() {
      try {
        const invoiceId = document.getElementById('paymentInvoiceId').value;
        const amount = parseFloat(document.getElementById('paymentAmount').value);
        const paymentMethod = document.getElementById('paymentMethod').value;
        const paymentReference = document.getElementById('paymentReference').value;

        if (!paymentMethod) {
          showToast('Vui l√≤ng ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n!', 'warning');
          return;
        }

        const btn = document.getElementById('btnProcessPayment');
        btn.disabled = true; btn.textContent = 'ƒêang x·ª≠ l√Ω...';
        await apiPost(`/invoices/${invoiceId}/pay`, {
          amount: amount,
          paymentMethod: paymentMethod,
          paymentReference: paymentReference
        });
        showToast('Thanh to√°n th√†nh c√¥ng!', 'success');
        bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
        await loadAllData();
      } catch (error) {
        showToast('L·ªói thanh to√°n: ' + error.message, 'danger');
      } finally {
        const btn = document.getElementById('btnProcessPayment');
        btn.disabled = false; btn.textContent = 'X√°c nh·∫≠n thanh to√°n';
      }
    }

    // Cancel invoice
    async function handleCancelInvoice(id) {
      if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy h√≥a ƒë∆°n ƒë·∫∑t ph√≤ng n√†y?')) {
        return;
      }
      
      try {
        await apiDelete(`/invoices/${id}`);
        showToast('H·ªßy h√≥a ƒë∆°n ƒë·∫∑t ph√≤ng th√†nh c√¥ng!', 'success');
        await loadAllData();
      } catch (error) {
        showToast('L·ªói h·ªßy h√≥a ƒë∆°n ƒë·∫∑t ph√≤ng: ' + error.message, 'danger');
      }
    }

    // Export to PDF
    async function exportToPDF() {
      try {
        const invoices = await apiGet('/invoices');
        if (!invoices || invoices.length === 0) {
          showToast('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!', 'warning');
          return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        
        doc.setFontSize(16);
        doc.text('B√ÅO C√ÅO H√ìA ƒê∆†N ƒê·∫∂T PH√íNG', 105, 20, { align: 'center' });
        
        doc.setFontSize(10);
        let yPos = 30;
        
        invoices.forEach((invoice, index) => {
          if (yPos > 270) {
            doc.addPage();
            yPos = 20;
          }
          
          doc.setFont(undefined, 'bold');
          doc.text(`${index + 1}. ${invoice.invoiceNumber}`, 14, yPos);
          doc.setFont(undefined, 'normal');
          yPos += 6;
          
          doc.text(`Kh√°ch h√†ng: ${invoice.customer?.fullName || 'N/A'}`, 20, yPos);
          yPos += 5;
          doc.text(`Ng√†y: ${new Date(invoice.issueDate).toLocaleDateString('vi-VN')}`, 20, yPos);
          yPos += 5;
          doc.text(`T·ªïng ti·ªÅn: ${formatCurrency(invoice.totalAmount)}`, 20, yPos);
          yPos += 5;
          doc.text(`Tr·∫°ng th√°i: ${invoice.status}`, 20, yPos);
          yPos += 8;
        });
        
        doc.save('bao-cao-hoa-don.pdf');
      } catch (error) {
        showToast('L·ªói xu·∫•t PDF: ' + error.message, 'danger');
      }
    }

    // Export single invoice to PDF
    async function handleExportInvoicePDF() {
      if (!currentInvoice) return;
      
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        
        doc.setFontSize(18);
        doc.text('H√ìA ƒê∆†N ƒê·∫∂T PH√íNG', 105, 20, { align: 'center' });
        
        doc.setFontSize(10);
        doc.text(`S·ªë Hƒê: ${currentInvoice.invoiceNumber}`, 14, 35);
        doc.text(`Ng√†y: ${new Date(currentInvoice.issueDate).toLocaleDateString('vi-VN')}`, 14, 40);
        doc.text(`Kh√°ch h√†ng: ${currentInvoice.customer?.fullName || 'N/A'}`, 14, 45);
        
        let yPos = 55;
        doc.setFontSize(12);
        doc.text('Chi ti·∫øt:', 14, yPos);
        yPos += 8;
        doc.setFontSize(10);
        
        doc.text(`T·ªïng ti·ªÅn: ${formatCurrency(currentInvoice.subTotal)}`, 20, yPos);
        yPos += 6;
        doc.text(`Thu·∫ø (${currentInvoice.taxRate}%): ${formatCurrency(currentInvoice.taxAmount)}`, 20, yPos);
        yPos += 6;
        doc.text(`Gi·∫£m gi√°: ${formatCurrency(currentInvoice.discountAmount)}`, 20, yPos);
        yPos += 6;
        doc.setFont(undefined, 'bold');
        doc.text(`T·ªïng c·ªông: ${formatCurrency(currentInvoice.totalAmount)}`, 20, yPos);
        yPos += 6;
        doc.setFont(undefined, 'normal');
        doc.text(`ƒê√£ thanh to√°n: ${formatCurrency(currentInvoice.paidAmount)}`, 20, yPos);
        yPos += 6;
        doc.text(`C√≤n l·∫°i: ${formatCurrency(currentInvoice.balanceDue)}`, 20, yPos);
        
        doc.save(`hoa-don-${currentInvoice.invoiceNumber}.pdf`);
      } catch (error) {
        showToast('L·ªói xu·∫•t PDF: ' + error.message, 'danger');
      }
    }

    // Setup event listeners
    function setupEventListeners() {
      document.getElementById('logoutBtn').addEventListener('click', logout);
      document.getElementById('btnFilter').addEventListener('click', loadInvoices);
      document.getElementById('btnProcessPayment').addEventListener('click', handleProcessPayment);
      document.getElementById('btnExportInvoicePDF').addEventListener('click', handleExportInvoicePDF);
      // Debounce search input
      const searchEl = document.getElementById('searchInput');
      let debounceTimer;
      searchEl.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => loadInvoices(), 300);
      });
      searchEl.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') { e.preventDefault(); loadInvoices(); }
      });
    }
  </script>
</body>
</html>

