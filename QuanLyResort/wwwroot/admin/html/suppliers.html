<!DOCTYPE html>
<html lang="vi" class="light-style layout-menu-fixed" dir="ltr" data-theme="theme-default" data-assets-path="../assets/" data-template="vertical-menu-template-free">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Qu·∫£n l√Ω Nh√† cung c·∫•p</title>
  <link rel="icon" type="image/x-icon" href="../assets/img/favicon/favicon.ico" />
  <link rel="stylesheet" href="../assets/vendor/fonts/boxicons.css" />
  <link rel="stylesheet" href="../assets/vendor/css/core.css" />
  <link rel="stylesheet" href="../assets/vendor/css/theme-default.css" />
  <link rel="stylesheet" href="../assets/css/demo.css" />
  <link rel="stylesheet" href="../assets/css/fix-scrollbar.css" />
  <link rel="stylesheet" href="../assets/css/admin-custom-theme.css" />
  <link rel="stylesheet" href="../assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" />
</head>
<body>
  <div class="layout-wrapper layout-content-navbar">
    <div class="layout-container">
      <div id="common-menu"></div>
      <script src="../js/load-menu.js"></script>
      <script>
        document.addEventListener('DOMContentLoaded', function() { loadCommonMenu(); });
      </script>
      <div class="layout-page">
        <nav class="layout-navbar container-xxl navbar navbar-expand-xl navbar-detached align-items-center bg-navbar-theme" id="layout-navbar"></nav>
        <div class="content-wrapper">
          <div class="container-xxl flex-grow-1 container-p-y">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <div class="d-flex align-items-center gap-3">
                <div>
                  <h4 class="fw-bold mb-0">üè≠ Nh√† cung c·∫•p</h4>
                  <p class="text-muted mb-0">Qu·∫£n l√Ω danh s√°ch nh√† cung c·∫•p</p>
                </div>
                <div class="form-check form-switch ms-3">
                  <input class="form-check-input" type="checkbox" id="showInactiveSwitch">
                  <label class="form-check-label" for="showInactiveSwitch">Hi·ªÉn th·ªã ƒë√£ ·∫©n</label>
                </div>
              </div>
              <button class="btn btn-primary" onclick="openCreateModal()"><i class="bx bx-plus me-1"></i> Th√™m</button>
            </div>

            <div class="card">
              <div class="card-body">
                <div class="table-responsive">
                  <table id="suppliersTable" class="table table-striped">
                    <thead>
                      <tr>
                        <th>ID</th>
                        <th>T√™n NCC</th>
                        <th>Li√™n h·ªá</th>
                        <th>ƒêi·ªán tho·∫°i</th>
                        <th>Email</th>
                        <th>ƒê·ªãa ch·ªâ</th>
                        <th>SP ƒëang cung c·∫•p</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>H√†nh ƒë·ªông</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast container -->
  <div class="position-fixed top-0 end-0 p-3" style="z-index:1080">
    <div id="toastContainer"></div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="supplierModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Th√™m nh√† cung c·∫•p</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="supplierForm">
            <input type="hidden" id="supplierId" />
            <div class="mb-3">
              <label class="form-label" for="supplierName">T√™n nh√† cung c·∫•p *</label>
              <input type="text" class="form-control" id="supplierName" required />
            </div>
            <div class="mb-3">
              <label class="form-label" for="contactPerson">Ng∆∞·ªùi li√™n h·ªá</label>
              <input type="text" class="form-control" id="contactPerson" />
            </div>
            <div class="mb-3">
              <label class="form-label" for="phone">ƒêi·ªán tho·∫°i</label>
              <input type="text" class="form-control" id="phone" />
            </div>
            <div class="mb-3">
              <label class="form-label" for="email">Email</label>
              <input type="email" class="form-control" id="email" />
            </div>
            <div class="mb-3">
              <label class="form-label" for="address">ƒê·ªãa ch·ªâ</label>
              <textarea class="form-control" id="address"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
          <button type="button" class="btn btn-primary" onclick="saveSupplier()">L∆∞u</button>
        </div>
      </div>
    </div>
  </div>

  <script src="../assets/vendor/libs/jquery/jquery.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
  <script src="../assets/vendor/js/menu.js"></script>
  <script src="../assets/vendor/js/helpers.js"></script>
  <script src="../assets/js/config.js"></script>
  <script src="../assets/js/main.js"></script>
  <script src="../../js/api.js"></script>
  <script>
    // API_BASE ƒë·∫øn t·ª´ ../js/api.js ƒë·ªÉ ƒë·ªìng b·ªô v·ªõi trang kh√°c
    let table;
    let editingId = null;

    // D√πng toast to√†n c·ª•c t·ª´ api.js

    document.addEventListener('DOMContentLoaded', () => {
      const sw = document.getElementById('showInactiveSwitch');
      sw?.addEventListener('change', () => loadSuppliers());
      loadSuppliers();

      // A11y: focus v√†o input ƒë·∫ßu ti√™n khi m·ªü modal, tr·∫£ focus v·ªÅ n√∫t Th√™m khi ƒë√≥ng
      document.getElementById('supplierModal')?.addEventListener('shown.bs.modal', () => {
        document.getElementById('supplierName')?.focus();
      });
      document.getElementById('supplierModal')?.addEventListener('hidden.bs.modal', () => {
        const addBtn = Array.from(document.querySelectorAll('button')).find(b => b.textContent?.includes('Th√™m'));
        (addBtn || document.body).focus();
      });
    });

    async function loadSuppliers() {
      try {
        const token = localStorage.getItem('token');
        showPageLoading('ƒêang t·∫£i nh√† cung c·∫•p...');
        const includeInactive = document.getElementById('showInactiveSwitch')?.checked ? 'true' : 'false';
        const url = `${API_BASE}/suppliers?includeInactive=${includeInactive}&_=${Date.now()}`;
        const resp = await fetch(url, { headers: token? { 'Authorization': `Bearer ${token}` } : {}, cache: 'no-store' });
        if (!resp.ok) throw new Error('Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch NCC');
        const data = await resp.json();
        const tbody = document.querySelector('#suppliersTable tbody');
        tbody.innerHTML = data.map(s => `
          <tr>
            <td>${s.supplierId}</td>
            <td><strong>${s.supplierName}</strong></td>
            <td>${s.contactPerson || '-'}</td>
            <td>${s.phone || '-'}</td>
            <td>${s.email || '-'}</td>
            <td>${s.address || '-'}</td>
            <td>${s.itemCount}</td>
            <td>${s.isActive ? '<span class="badge bg-success">Ho·∫°t ƒë·ªông</span>' : '<span class="badge bg-secondary">·∫®n</span>'}</td>
            <td>
              <div class="btn-group">
                <button class="btn btn-sm btn-warning" aria-label="S·ª≠a nh√† cung c·∫•p" onclick="openEditModal(${s.supplierId})"><i class="bx bx-edit" aria-hidden="true"></i></button>
                <button class="btn btn-sm btn-outline-secondary" aria-label="B·∫≠t/T·∫Øt nh√† cung c·∫•p" onclick="toggleSupplier(${s.supplierId})"><i class="bx bx-refresh" aria-hidden="true"></i></button>
                <button class="btn btn-sm btn-outline-danger" aria-label="X√≥a (·∫©n) nh√† cung c·∫•p" onclick="deleteSupplier(${s.supplierId})"><i class="bx bx-trash" aria-hidden="true"></i></button>
              </div>
            </td>
          </tr>`).join('');
        if (table) table.destroy();
        table = $('#suppliersTable').DataTable({
          order: [[1,'asc']],
          language: { url: '../local-plugins/datatables/i18n/vi.json' },
          responsive: true
        });
      } catch (e) {
        console.error(e);
        showToast('L·ªói t·∫£i danh s√°ch NCC', 'danger');
      } finally { hidePageLoading(); }
    }

    function renderSupplierRow(s) {
      return `
        <tr data-id="${s.supplierId}">
          <td>${s.supplierId}</td>
          <td><strong>${s.supplierName}</strong></td>
          <td>${s.contactPerson || '-'}</td>
          <td>${s.phone || '-'}</td>
          <td>${s.email || '-'}</td>
          <td>${s.address || '-'}</td>
          <td>${s.itemCount ?? '-'}</td>
          <td>${s.isActive ? '<span class="badge bg-success">Ho·∫°t ƒë·ªông</span>' : '<span class="badge bg-secondary">·∫®n</span>'}</td>
          <td>
            <div class="btn-group">
              <button class="btn btn-sm btn-warning" onclick="openEditModal(${s.supplierId})"><i class="bx bx-edit"></i></button>
              <button class="btn btn-sm btn-outline-secondary" onclick="toggleSupplier(${s.supplierId})"><i class="bx bx-refresh"></i></button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteSupplier(${s.supplierId})"><i class="bx bx-trash"></i></button>
            </div>
          </td>
        </tr>`;
    }

    function getRowById(id) {
      const rows = document.querySelectorAll('#suppliersTable tbody tr');
      for (const r of rows) {
        const cell = r.querySelector('td');
        if (cell && Number(cell.textContent) === Number(id)) return r;
      }
      return null;
    }

    async function refreshRow(id) {
      try {
        const token = localStorage.getItem('token');
        const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
        const resp = await fetch(`${API_BASE}/suppliers/${id}?_=${Date.now()}`, { headers, cache: 'no-store' });
        if (!resp.ok) return;
        const s = await resp.json();
        const existing = getRowById(id);
        if (existing) {
          existing.outerHTML = renderSupplierRow(s);
          if (table) table.rows().invalidate().draw(false);
        } else {
          const tbody = document.querySelector('#suppliersTable tbody');
          const tmp = document.createElement('tbody');
          tmp.innerHTML = renderSupplierRow(s);
          const newRow = tmp.firstElementChild;
          if (table) {
            table.row.add(newRow).draw(false);
          } else {
            tbody.insertBefore(newRow, tbody.firstChild);
          }
        }
      } catch (_) { /* ignore */ }
    }

    function openCreateModal() {
      editingId = null;
      document.getElementById('modalTitle').textContent = 'Th√™m nh√† cung c·∫•p';
      document.getElementById('supplierForm').reset();
      new bootstrap.Modal(document.getElementById('supplierModal')).show();
    }

    async function openEditModal(id) {
      try {
        const token = localStorage.getItem('token');
        const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
        const resp = await fetch(`${API_BASE}/suppliers/${id}?_=${Date.now()}`, { headers, cache: 'no-store' });
        if (!resp.ok) throw new Error('Kh√¥ng t·∫£i ƒë∆∞·ª£c NCC');
        const s = await resp.json();
        editingId = s.supplierId;
        document.getElementById('modalTitle').textContent = 'S·ª≠a nh√† cung c·∫•p';
        document.getElementById('supplierId').value = s.supplierId;
        document.getElementById('supplierName').value = s.supplierName || '';
        document.getElementById('contactPerson').value = s.contactPerson || '';
        document.getElementById('phone').value = s.phone || '';
        document.getElementById('email').value = s.email || '';
        document.getElementById('address').value = s.address || '';
        new bootstrap.Modal(document.getElementById('supplierModal')).show();
      } catch (e) {
        showToast('L·ªói t·∫£i NCC', 'danger');
      }
    }

    async function saveSupplier() {
      try {
        const token = localStorage.getItem('token');
        const dto = {
          supplierName: document.getElementById('supplierName').value.trim(),
          contactPerson: document.getElementById('contactPerson').value.trim() || null,
          phone: document.getElementById('phone').value.trim() || null,
          email: document.getElementById('email').value.trim() || null,
          address: document.getElementById('address').value.trim() || null
        };
        if (!dto.supplierName) { showToast('T√™n nh√† cung c·∫•p b·∫Øt bu·ªôc', 'warning'); return; }
        const url = editingId ? `${API_BASE}/suppliers/${editingId}` : `${API_BASE}/suppliers`;
        const method = editingId ? 'PUT' : 'POST';
        const headers = { 'Content-Type': 'application/json' };
        if (token) headers['Authorization'] = `Bearer ${token}`;
        const saveBtn = document.querySelector('#supplierModal .btn.btn-primary');
        setButtonLoading(saveBtn, true, 'ƒêang l∆∞u...');
        const resp = await fetch(url, { method, headers, body: JSON.stringify(dto) });
        if (!resp.ok) { const err = await resp.json().catch(()=>({})); throw new Error(err.message || 'L∆∞u th·∫•t b·∫°i'); }
        bootstrap.Modal.getInstance(document.getElementById('supplierModal')).hide();
        showToast(editingId ? 'C·∫≠p nh·∫≠t th√†nh c√¥ng' : 'T·∫°o th√†nh c√¥ng', 'success');
        if (editingId) {
          await refreshRow(editingId);
        } else {
          const resJson = await resp.json().catch(()=>null);
          const newId = resJson?.supplierId;
          if (newId) await refreshRow(newId); else await loadSuppliers();
        }
      } catch (e) { showToast('L·ªói: ' + e.message, 'danger'); }
      finally {
        const saveBtn = document.querySelector('#supplierModal .btn.btn-primary');
        setButtonLoading(saveBtn, false);
      }
    }

    async function deleteSupplier(id) {
      const ok = await showConfirm('X√≥a nh√† cung c·∫•p', 'B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a (·∫©n) nh√† cung c·∫•p n√†y?','X√≥a','H·ªßy');
      if (!ok) return;
      try {
        const token = localStorage.getItem('token');
        const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
        const resp = await fetch(`${API_BASE}/suppliers/${id}`, { method: 'DELETE', headers });
        if (!resp.ok) { const err = await resp.json().catch(()=>({})); throw new Error(err.message || 'X√≥a th·∫•t b·∫°i'); }
        showToast('ƒê√£ ·∫©n nh√† cung c·∫•p', 'success');
        const showInactive = document.getElementById('showInactiveSwitch')?.checked;
        if (showInactive) {
          await refreshRow(id);
        } else {
          const row = getRowById(id);
          if (table && row) { table.row(row).remove().draw(false); }
        }
      } catch (e) { showToast('L·ªói: ' + e.message, 'danger'); }
    }

    async function toggleSupplier(id) {
      try {
        const token = localStorage.getItem('token');
        const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
        const resp = await fetch(`${API_BASE}/suppliers/${id}/toggle-active`, { method: 'PATCH', headers });
        if (!resp.ok) { const err = await resp.json().catch(()=>({})); throw new Error(err.message || 'C·∫≠p nh·∫≠t tr·∫°ng th√°i th·∫•t b·∫°i'); }
        showToast('ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i', 'success');
        await refreshRow(id);
      } catch (e) { showToast('L·ªói: ' + e.message, 'danger'); }
    }
  </script>
</body>
</html>


