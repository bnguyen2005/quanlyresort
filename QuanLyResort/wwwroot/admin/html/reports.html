<!DOCTYPE html>
<html lang="vi" class="light-style layout-menu-fixed" dir="ltr" data-theme="theme-default" data-assets-path="../assets/" data-template="vertical-menu-template-free">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
  <title>üìä B√°o c√°o & Th·ªëng k√™ - Resort Management</title>
  
  <!-- NO CACHE -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  
  <link rel="icon" type="image/x-icon" href="../assets/img/favicon/favicon.ico" />
  <link rel="stylesheet" href="../assets/vendor/fonts/boxicons.css" />
  <link rel="stylesheet" href="../assets/vendor/css/core.css" class="template-customizer-core-css" />
  <link rel="stylesheet" href="../assets/vendor/css/theme-default.css" class="template-customizer-theme-css" />
  <link rel="stylesheet" href="../assets/css/demo.css" />
  <link rel="stylesheet" href="../assets/css/fix-scrollbar.css" />
  <link rel="stylesheet" href="../assets/css/admin-custom-theme.css" />
  <!-- Removed perfect-scrollbar.css to prevent duplicate scrollbar -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" />
  
  <style>
    /* Stats cards s·∫Ω ƒë∆∞·ª£c override b·ªüi admin-custom-theme.css */
    /* Gi·ªØ l·∫°i c√°c style ri√™ng cho trang reports */
    .stats-card h3 {
      color: white;
      margin-bottom: 0.5rem;
    }
    .chart-container {
      background: white;
      border-radius: 10px;
      padding: 1.5rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 1.5rem;
      height: 400px;
      max-height: 400px;
      position: relative;
    }
    
    .chart-container canvas {
      max-width: 100% !important;
      max-height: 350px !important;
      width: auto !important;
      height: auto !important;
    }
    .date-filter {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 10px;
      margin-bottom: 1.5rem;
    }
    .report-section {
      margin-bottom: 2rem;
    }
    .metric-card {
      text-align: center;
      padding: 1rem;
      border-radius: 8px;
      background: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .metric-value {
      font-size: 2rem;
      font-weight: bold;
      color: #5a67d8;
    }
    .metric-label {
      color: #666;
      font-size: 0.9rem;
    }
    .growth-positive {
      color: #28a745;
    }
    .growth-negative {
      color: #dc3545;
    }
    /* Tr√°nh duplicate scrollbar trong trang reports */
    .content-wrapper {
      overflow-y: auto !important;
      overflow-x: hidden !important;
    }
    .table-responsive {
      overflow-x: auto !important;
      overflow-y: visible !important;
    }
    /* T·∫Øt PerfectScrollbar n·∫øu c√≥ */
    .ps,
    .ps__rail-y,
    .ps__thumb-y {
      display: none !important;
    }
  </style>
</head>
<body>
  <div class="layout-wrapper layout-content-navbar">
    <div class="layout-container">

      <!-- Menu -->
      <div id="common-menu"></div>

      <!-- Layout container -->
      <div class="layout-page">
        
        <!-- Navbar -->
        <nav class="layout-navbar container-xxl navbar navbar-expand-xl navbar-detached align-items-center bg-navbar-theme" id="layout-navbar">
          <div class="layout-menu-toggle navbar-nav align-items-xl-center me-3 me-xl-0 d-xl-none">
            <a class="nav-item nav-link px-0 me-xl-4" href="javascript:void(0)">
              <i class="bx bx-menu bx-sm"></i>
            </a>
          </div>

          <div class="navbar-nav-right d-flex align-items-center" id="navbar-collapse">
            <div class="navbar-nav align-items-center">
              <div class="nav-item d-flex align-items-center">
                <h4 class="mb-0">üìä B√°o c√°o & Th·ªëng k√™</h4>
              </div>
            </div>

            <ul class="navbar-nav flex-row align-items-center ms-auto">
              <li class="nav-item navbar-dropdown dropdown-user dropdown">
                <a class="nav-link dropdown-toggle hide-arrow" href="javascript:void(0);" data-bs-toggle="dropdown">
                  <div class="avatar avatar-online">
                    <img src="../assets/img/avatars/1.png" alt class="w-px-40 h-auto rounded-circle" />
                  </div>
                </a>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li>
                    <a class="dropdown-item" href="#">
                      <div class="d-flex">
                        <div class="flex-shrink-0 me-3">
                          <div class="avatar avatar-online">
                            <img src="../assets/img/avatars/1.png" alt class="w-px-40 h-auto rounded-circle" />
                          </div>
                        </div>
                        <div class="flex-grow-1">
                          <span class="fw-semibold d-block" id="userDisplayName">Admin</span>
                          <small class="text-muted" id="userRole">Qu·∫£n tr·ªã vi√™n</small>
                        </div>
                      </div>
                    </a>
                  </li>
                  <li><div class="dropdown-divider"></div></li>
                  <li>
                    <a class="dropdown-item" href="javascript:void(0);" id="logoutBtn">
                      <i class="bx bx-power-off me-2"></i>
                      <span class="align-middle">ƒêƒÉng xu·∫•t</span>
                    </a>
                  </li>
                </ul>
              </li>
            </ul>
          </div>
        </nav>

        <!-- Content wrapper -->
        <div class="content-wrapper">
          <div class="container-xxl flex-grow-1 container-p-y">

            <!-- Date Filter -->
            <div class="date-filter">
              <div class="row">
                <div class="col-md-3">
                  <label class="form-label">T·ª´ ng√†y:</label>
                  <input type="date" id="startDate" class="form-control" />
                </div>
                <div class="col-md-3">
                  <label class="form-label">ƒê·∫øn ng√†y:</label>
                  <input type="date" id="endDate" class="form-control" />
                </div>
                <div class="col-md-3">
                  <label class="form-label">B√°o c√°o nhanh:</label>
                  <select id="quickFilter" class="form-select">
                    <option value="today">H√¥m nay</option>
                    <option value="yesterday">H√¥m qua</option>
                    <option value="this-week">Tu·∫ßn n√†y</option>
                    <option value="last-week">Tu·∫ßn tr∆∞·ªõc</option>
                    <option value="this-month" selected>Th√°ng n√†y</option>
                    <option value="last-month">Th√°ng tr∆∞·ªõc</option>
                    <option value="this-year">NƒÉm n√†y</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label class="form-label">&nbsp;</label>
                  <button type="button" class="btn btn-primary d-block" onclick="loadAllReports()">
                    <i class="bx bx-search"></i> T·∫°o b√°o c√°o
                  </button>
                </div>
              </div>
            </div>

            <!-- Dashboard Stats -->
            <div class="report-section">
              <h5>üìà T·ªïng quan h√¥m nay</h5>
              <div class="row" id="dashboardStats">
                <div class="col-md-3">
                  <div class="metric-card">
                    <div class="metric-value" id="todayRevenue">0 ‚Ç´</div>
                    <div class="metric-label">Doanh thu h√¥m nay</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="metric-card">
                    <div class="metric-value" id="todayOccupancy">0%</div>
                    <div class="metric-label">T·ª∑ l·ªá l·∫•p ƒë·∫ßy</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="metric-card">
                    <div class="metric-value" id="activeBookings">0</div>
                    <div class="metric-label">ƒê·∫∑t ph√≤ng ƒëang ho·∫°t ƒë·ªông</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="metric-card">
                    <div class="metric-value" id="revenueGrowth">0%</div>
                    <div class="metric-label">TƒÉng tr∆∞·ªüng th√°ng n√†y</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Revenue Charts -->
            <div class="report-section">
              <h5>üí∞ B√°o c√°o doanh thu</h5>
              <div class="row">
                <div class="col-md-8">
                  <div class="chart-container">
                    <h6>Bi·ªÉu ƒë·ªì doanh thu theo ng√†y</h6>
                    <canvas id="revenueChart" height="100"></canvas>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="chart-container">
                    <h6>Doanh thu theo lo·∫°i</h6>
                    <canvas id="revenueTypeChart" height="200"></canvas>
                  </div>
                </div>
              </div>
            </div>

            <!-- Occupancy Charts -->
            <div class="report-section">
              <h5>üè® B√°o c√°o t·ª∑ l·ªá l·∫•p ƒë·∫ßy</h5>
              <div class="chart-container">
                <h6>T·ª∑ l·ªá l·∫•p ƒë·∫ßy theo ng√†y</h6>
                <canvas id="occupancyChart" height="100"></canvas>
              </div>
            </div>

            <!-- Customer Analytics -->
            <div class="report-section">
              <h5>üë• Ph√¢n t√≠ch kh√°ch h√†ng</h5>
              <div class="row">
                <div class="col-md-8">
                  <div class="chart-container">
                    <h6>Top 10 kh√°ch h√†ng chi ti√™u nhi·ªÅu nh·∫•t</h6>
                    <div class="table-responsive">
                      <table class="table table-striped" id="topCustomersTable">
                        <thead>
                          <tr>
                            <th>Kh√°ch h√†ng</th>
                            <th>T·ªïng chi ti√™u</th>
                            <th>S·ªë l·∫ßn ƒë·∫∑t</th>
                            <th>L·∫ßn cu·ªëi</th>
                          </tr>
                        </thead>
                        <tbody></tbody>
                      </table>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="chart-container">
                    <h6>Ph√¢n lo·∫°i kh√°ch h√†ng</h6>
                    <canvas id="customerTypeChart" height="200"></canvas>
                  </div>
                </div>
              </div>
            </div>

            <!-- Service Usage -->
            <div class="report-section">
              <h5>üõéÔ∏è S·ª≠ d·ª•ng d·ªãch v·ª•</h5>
              <div class="chart-container">
                <h6>Doanh thu theo d·ªãch v·ª•</h6>
                <canvas id="serviceChart" height="100"></canvas>
              </div>
            </div>

            <!-- Export Options -->
            <div class="report-section">
              <h5>üì§ Xu·∫•t b√°o c√°o</h5>
              <div class="row">
                <div class="col-md-12">
                  <button type="button" class="btn btn-success me-2" onclick="exportToPDF()">
                    <i class="bx bx-file-pdf"></i> Xu·∫•t PDF
                  </button>
                  <button type="button" class="btn btn-info me-2" onclick="exportToExcel()">
                    <i class="bx bx-file-excel"></i> Xu·∫•t Excel
                  </button>
                  <button type="button" class="btn btn-secondary" onclick="printReport()">
                    <i class="bx bx-printer"></i> In b√°o c√°o
                  </button>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Core JS -->
  <script src="../assets/vendor/libs/jquery/jquery.js"></script>
  <script src="../assets/vendor/libs/popper/popper.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Removed perfect-scrollbar.js to prevent duplicate scrollbar -->
  <script src="../assets/vendor/js/menu.js"></script>
  <script src="../assets/js/main.js?v=20251027"></script>
  <script src="../js/api.js"></script>
  <script src="../js/common-navbar.js"></script>

  <!-- Charts - Load before page script -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- DataTables -->
  <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>

  <!-- PDF Export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Menu Loader -->
  <script>
    // Load menu directly without load-menu.js dependency
    document.addEventListener('DOMContentLoaded', function() {
      const menuVersion = Date.now();
      fetch('layout-menu.html?v=' + menuVersion)
        .then(response => {
          if (!response.ok) throw new Error('Failed to load menu: ' + response.status);
          return response.text();
        })
        .then(html => {
          const menuContainer = document.getElementById('common-menu');
          if (menuContainer) {
            menuContainer.innerHTML = html;
            console.log('‚úÖ Menu loaded for reports page');
          }
        })
        .catch(error => {
          console.error('‚ùå Error loading menu:', error);
        });
    });
  </script>

  <script>
    // API base URL - s·ª≠ d·ª•ng endpoint t·ª´ ReportsController
    const API_BASE = (typeof API_BASE_URL !== 'undefined' ? API_BASE_URL : `${window.location.origin}/api`) + '/reports';
    let revenueChart, occupancyChart, revenueTypeChart, customerTypeChart, serviceChart;

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üîµ Reports page loaded');
      console.log('üîç Chart.js available:', typeof Chart !== 'undefined');
      console.log('üîç jQuery available:', typeof $ !== 'undefined');
      
      // ƒê·ª£i Chart.js load xong n·∫øu ch∆∞a c√≥
      if (typeof Chart === 'undefined') {
        console.warn('‚ö†Ô∏è Chart.js not loaded yet, waiting...');
        let retryCount = 0;
        const maxRetries = 10;
        const checkChart = setInterval(() => {
          retryCount++;
          if (typeof Chart !== 'undefined') {
            console.log('‚úÖ Chart.js loaded, initializing reports...');
            clearInterval(checkChart);
            initializeReports();
          } else if (retryCount >= maxRetries) {
            console.error('‚ùå Chart.js failed to load after', maxRetries, 'retries');
            clearInterval(checkChart);
            // V·∫´n kh·ªüi t·∫°o c√°c ph·∫ßn kh√¥ng c·∫ßn Chart.js
            initializeReports();
          }
        }, 200);
      } else {
        initializeReports();
      }
    });

    function initializeReports() {
      try {
        initializeDateFilters();
        setupEventListeners();
        
        // Load data v·ªõi delay nh·ªè ƒë·ªÉ ƒë·∫£m b·∫£o DOM s·∫µn s√†ng
        setTimeout(() => {
          loadDashboardStats();
          loadAllReports();
        }, 100);
      } catch (error) {
        console.error('‚ùå Error initializing reports:', error);
      }
    }

    function initializeDateFilters() {
      const today = new Date();
      const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
      
      document.getElementById('startDate').value = firstDayOfMonth.toISOString().split('T')[0];
      document.getElementById('endDate').value = today.toISOString().split('T')[0];
    }

    function setupEventListeners() {
      // Quick filter change
      document.getElementById('quickFilter').addEventListener('change', function() {
        const value = this.value;
        const today = new Date();
        let startDate, endDate;

        switch(value) {
          case 'today':
            startDate = endDate = today;
            break;
          case 'yesterday':
            startDate = endDate = new Date(today.getTime() - 24 * 60 * 60 * 1000);
            break;
          case 'this-week':
            startDate = new Date(today.setDate(today.getDate() - today.getDay()));
            endDate = new Date();
            break;
          case 'last-week':
            const lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            startDate = new Date(lastWeek.setDate(lastWeek.getDate() - lastWeek.getDay()));
            endDate = new Date(startDate.getTime() + 6 * 24 * 60 * 60 * 1000);
            break;
          case 'this-month':
            startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            endDate = new Date();
            break;
          case 'last-month':
            startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            endDate = new Date(today.getFullYear(), today.getMonth(), 0);
            break;
          case 'this-year':
            startDate = new Date(today.getFullYear(), 0, 1);
            endDate = new Date();
            break;
        }

        document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
        document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
      });

      // Logout button
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', function(e) {
          e.preventDefault();
          logout();
        });
      }
    }

    async function loadDashboardStats() {
      try {
        console.log('üìä Loading dashboard stats...');
        // Try both token and adminToken for compatibility
        const token = localStorage.getItem('token') || localStorage.getItem('adminToken');
        console.log('üîë Token exists:', !!token);
        
        if (!token) {
          console.warn('‚ö†Ô∏è No token found, cannot load dashboard stats');
          // Show empty/zero values instead of sample data
          document.getElementById('todayRevenue').textContent = formatCurrency(0);
          document.getElementById('todayOccupancy').textContent = '0%';
          document.getElementById('activeBookings').textContent = '0';
          const growthElement = document.getElementById('revenueGrowth');
          growthElement.textContent = '0%';
          growthElement.className = 'metric-value';
          return;
        }
        
        // Use reports dashboard-stats endpoint
        const apiBase = (typeof API_BASE_URL !== 'undefined' ? API_BASE_URL : `${window.location.origin}/api`);
        const response = await fetch(`${apiBase}/reports/dashboard-stats`, {
          headers: { 
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        console.log('üì° Dashboard API response:', response.status);
        
        if (response.ok) {
          const data = await response.json();
          console.log('üìà Dashboard data:', data);
          
          document.getElementById('todayRevenue').textContent = formatCurrency(data.todayRevenue || 0);
          document.getElementById('todayOccupancy').textContent = (data.todayOccupancy || 0) + '%';
          document.getElementById('activeBookings').textContent = data.activeBookings || 0;
          
          const growthElement = document.getElementById('revenueGrowth');
          const growth = data.revenueGrowth || 0;
          growthElement.textContent = growth + '%';
          growthElement.className = 'metric-value ' + (growth >= 0 ? 'growth-positive' : 'growth-negative');
        } else {
          const errorText = await response.text();
          console.error('‚ùå Dashboard API error:', response.status, errorText);
          
          // Show zero values when API fails (no sample data)
          console.warn('‚ö†Ô∏è Cannot load dashboard stats, showing zero values');
          document.getElementById('todayRevenue').textContent = formatCurrency(0);
          document.getElementById('todayOccupancy').textContent = '0%';
          document.getElementById('activeBookings').textContent = '0';
          
          const growthElement = document.getElementById('revenueGrowth');
          growthElement.textContent = '0%';
          growthElement.className = 'metric-value';
        }
      } catch (error) {
        console.error('‚ùå Error loading dashboard stats:', error);
      }
    }

    async function loadAllReports() {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;

      await Promise.all([
        loadRevenueReport(startDate, endDate),
        loadOccupancyReport(startDate, endDate),
        loadCustomerAnalytics(startDate, endDate),
        loadServiceUsage(startDate, endDate)
      ]);
    }

    async function loadRevenueReport(startDate, endDate) {
      try {
        console.log('üìä Loading revenue report...', startDate, endDate);
        // Try both token and adminToken for compatibility
        const token = localStorage.getItem('token') || localStorage.getItem('adminToken');
        console.log('üîë Token exists:', !!token);
        
        if (!token) {
          console.warn('‚ö†Ô∏è No token for revenue report, cannot load data');
          // Show empty charts instead of sample data
          createRevenueChart([]);
          createRevenueTypeChart([]);
          return;
        }
        
        const response = await fetch(`${API_BASE}/revenue-summary?startDate=${startDate}&endDate=${endDate}`, {
          headers: { 
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        console.log('üì° Revenue API response:', response.status);
        
        if (response.ok) {
          const data = await response.json();
          console.log('üìà Revenue data:', data);
          console.log('üìÖ Daily revenue count:', data.dailyRevenue?.length);
          console.log('üè∑Ô∏è Revenue types count:', data.revenueByType?.length);
          
          createRevenueChart(data.dailyRevenue);
          createRevenueTypeChart(data.revenueByType);
        } else {
          const errorText = await response.text();
          console.error('‚ùå Revenue API error:', response.status, errorText);
          
          // Show empty charts when API fails (no sample data)
          console.warn('‚ö†Ô∏è Cannot load revenue data, showing empty charts');
          createRevenueChart([]);
          createRevenueTypeChart([]);
        }
      } catch (error) {
        console.error('‚ùå Error loading revenue report:', error);
      }
    }

    async function loadOccupancyReport(startDate, endDate) {
      try {
        // Try both token and adminToken for compatibility
        const token = localStorage.getItem('token') || localStorage.getItem('adminToken');
        console.log('üìä Loading occupancy report...', startDate, endDate);
        console.log('üîë Token exists:', !!token);
        
        if (!token) {
          console.warn('‚ö†Ô∏è No token for occupancy report, cannot load data');
          // Show empty chart instead of sample data
          createOccupancyChart([]);
          return;
        }
        
        const response = await fetch(`${API_BASE}/occupancy-report?startDate=${startDate}&endDate=${endDate}`, {
          headers: { 
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const data = await response.json();
          createOccupancyChart(data.dailyOccupancy);
        } else {
          const errorText = await response.text();
          console.error('‚ùå Occupancy API error:', response.status, errorText);
          // Show empty chart when API fails (no sample data)
          console.warn('‚ö†Ô∏è Cannot load occupancy data, showing empty chart');
          createOccupancyChart([]);
        }
      } catch (error) {
        console.error('‚ùå Error loading occupancy report:', error);
        // Show empty chart on error (no sample data)
        console.warn('‚ö†Ô∏è Error loading occupancy data, showing empty chart');
        createOccupancyChart([]);
      }
    }

    async function loadCustomerAnalytics(startDate, endDate) {
      try {
        // Try both token and adminToken for compatibility
        const token = localStorage.getItem('token') || localStorage.getItem('adminToken');
        console.log('üìä Loading customer analytics...', startDate, endDate);
        console.log('üîë Token exists:', !!token);
        
        if (!token) {
          console.warn('‚ö†Ô∏è No token for customer analytics, cannot load data');
          // Show empty data instead of sample data
          updateTopCustomersTable([]);
          createCustomerTypeChart([]);
          return;
        }
        
        const response = await fetch(`${API_BASE}/customer-analytics?startDate=${startDate}&endDate=${endDate}`, {
          headers: { 
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const data = await response.json();
          updateTopCustomersTable(data.topCustomers);
          createCustomerTypeChart(data.customerTypes);
        } else {
          const errorText = await response.text();
          console.error('‚ùå Customer analytics API error:', response.status, errorText);
          // Show empty data when API fails (no sample data)
          console.warn('‚ö†Ô∏è Cannot load customer analytics, showing empty data');
          updateTopCustomersTable([]);
          createCustomerTypeChart([]);
        }
      } catch (error) {
        console.error('Error loading customer analytics:', error);
      }
    }

    async function loadServiceUsage(startDate, endDate) {
      try {
        // Try both token and adminToken for compatibility
        const token = localStorage.getItem('token') || localStorage.getItem('adminToken');
        console.log('üìä Loading service usage...', startDate, endDate);
        console.log('üîë Token exists:', !!token);
        
        if (!token) {
          console.warn('‚ö†Ô∏è No token for service usage, cannot load data');
          // Show empty chart instead of sample data
          createServiceChart([]);
          return;
        }
        
        const response = await fetch(`${API_BASE}/service-usage?startDate=${startDate}&endDate=${endDate}`, {
          headers: { 
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const data = await response.json();
          createServiceChart(data.services);
        } else {
          const errorText = await response.text();
          console.error('‚ùå Service usage API error:', response.status, errorText);
          // Show empty chart when API fails (no sample data)
          console.warn('‚ö†Ô∏è Cannot load service usage data, showing empty chart');
          createServiceChart([]);
        }
      } catch (error) {
        console.error('‚ùå Error loading service usage:', error);
        // Show empty chart on error (no sample data)
        console.warn('‚ö†Ô∏è Error loading service usage data, showing empty chart');
        createServiceChart([]);
      }
    }

    // Chart creation functions
    function createRevenueChart(dailyRevenue) {
      console.log('üìä Creating revenue chart with data:', dailyRevenue);
      
      // Ki·ªÉm tra Chart.js
      if (typeof Chart === 'undefined') {
        console.error('‚ùå Chart.js not available!');
        return;
      }
      
      const canvas = document.getElementById('revenueChart');
      console.log('üéØ Revenue canvas element:', canvas);
      
      if (!canvas) {
        console.error('‚ùå Revenue chart canvas not found!');
        return;
      }
      
      const ctx = canvas.getContext('2d');
      console.log('üñºÔ∏è Canvas context:', ctx);
      
      if (revenueChart) {
        console.log('üóëÔ∏è Destroying existing revenue chart');
        try {
          revenueChart.destroy();
        } catch (e) {
          console.warn('‚ö†Ô∏è Error destroying chart:', e);
        }
      }

      if (!dailyRevenue || dailyRevenue.length === 0) {
        console.warn('‚ö†Ô∏è No daily revenue data to display');
        const container = canvas.parentElement;
        if (container) {
          container.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666;">
              <div style="text-align: center;">
                <i class="bx bx-info-circle" style="font-size: 3rem; margin-bottom: 1rem; color: #999;"></i>
                <p style="font-size: 1.1rem; margin: 0;">Kh√¥ng c√≥ d·ªØ li·ªáu doanh thu trong kho·∫£ng th·ªùi gian ƒë√£ ch·ªçn</p>
              </div>
            </div>
          `;
        }
        return;
      }

      console.log('üèóÔ∏è Building revenue chart...');
      try {
        revenueChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: dailyRevenue.map(d => new Date(d.date).toLocaleDateString('vi-VN')),
          datasets: [{
            label: 'Doanh thu (‚Ç´)',
            data: dailyRevenue.map(d => d.amount),
            borderColor: '#5a67d8',
            backgroundColor: 'rgba(90, 103, 216, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return formatCurrency(value);
                }
              }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  return 'Doanh thu: ' + formatCurrency(context.parsed.y);
                }
              }
            }
          }
        }
      });
      
      console.log('‚úÖ Revenue chart created successfully');
      } catch (error) {
        console.error('‚ùå Error creating revenue chart:', error);
        const container = canvas.parentElement;
        if (container) {
          container.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #dc3545;">
              <div style="text-align: center;">
                <i class="bx bx-error-circle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                <p style="font-size: 1.1rem; margin: 0;">L·ªói khi t·∫°o bi·ªÉu ƒë·ªì: ${error.message}</p>
              </div>
            </div>
          `;
        }
      }
    }

    function createRevenueTypeChart(revenueByType) {
      if (typeof Chart === 'undefined') {
        console.error('‚ùå Chart.js not available!');
        return;
      }
      
      const canvas = document.getElementById('revenueTypeChart');
      if (!canvas) {
        console.error('‚ùå Revenue type chart canvas not found!');
        return;
      }
      
      const ctx = canvas.getContext('2d');
      
      if (revenueTypeChart) {
        try {
          revenueTypeChart.destroy();
        } catch (e) {
          console.warn('‚ö†Ô∏è Error destroying chart:', e);
        }
      }
      
      if (!revenueByType || revenueByType.length === 0) {
        console.warn('‚ö†Ô∏è No revenue by type data to display');
        const container = document.getElementById('revenueTypeChart').parentElement;
        container.innerHTML = `
          <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666;">
            <div style="text-align: center;">
              <i class="bx bx-info-circle" style="font-size: 3rem; margin-bottom: 1rem; color: #999;"></i>
              <p style="font-size: 1.1rem; margin: 0;">Kh√¥ng c√≥ d·ªØ li·ªáu doanh thu theo lo·∫°i</p>
            </div>
          </div>
        `;
        return;
      }
      
      revenueTypeChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: revenueByType.map(r => r.type),
          datasets: [{
            data: revenueByType.map(r => r.amount),
            backgroundColor: ['#5a67d8', '#48bb78', '#ed8936', '#9f7aea', '#38b2ac']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.label + ': ' + formatCurrency(context.parsed);
                }
              }
            }
          }
        }
      });
    }

    function createOccupancyChart(dailyOccupancy) {
      if (typeof Chart === 'undefined') {
        console.error('‚ùå Chart.js not available!');
        return;
      }
      
      const canvas = document.getElementById('occupancyChart');
      if (!canvas) {
        console.error('‚ùå Occupancy chart canvas not found!');
        return;
      }
      
      const ctx = canvas.getContext('2d');
      
      if (occupancyChart) {
        try {
          occupancyChart.destroy();
        } catch (e) {
          console.warn('‚ö†Ô∏è Error destroying chart:', e);
        }
      }
      
      if (!dailyOccupancy || dailyOccupancy.length === 0) {
        console.warn('‚ö†Ô∏è No occupancy data to display');
        const container = document.getElementById('occupancyChart').parentElement;
        container.innerHTML = `
          <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666;">
            <div style="text-align: center;">
              <i class="bx bx-info-circle" style="font-size: 3rem; margin-bottom: 1rem; color: #999;"></i>
              <p style="font-size: 1.1rem; margin: 0;">Kh√¥ng c√≥ d·ªØ li·ªáu t·ª∑ l·ªá l·∫•p ƒë·∫ßy trong kho·∫£ng th·ªùi gian ƒë√£ ch·ªçn</p>
            </div>
          </div>
        `;
        return;
      }
      
      occupancyChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: dailyOccupancy.map(d => new Date(d.date).toLocaleDateString('vi-VN')),
          datasets: [{
            label: 'T·ª∑ l·ªá l·∫•p ƒë·∫ßy (%)',
            data: dailyOccupancy.map(d => d.occupancyRate),
            backgroundColor: '#48bb78',
            borderColor: '#38a169',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              ticks: {
                callback: function(value) {
                  return value + '%';
                }
              }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  return 'T·ª∑ l·ªá l·∫•p ƒë·∫ßy: ' + context.parsed.y + '%';
                }
              }
            }
          }
        }
      });
    }

    function createCustomerTypeChart(customerTypes) {
      const canvas = document.getElementById('customerTypeChart');
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      
      if (customerTypeChart) customerTypeChart.destroy();
      
      if (!customerTypes || customerTypes.length === 0) {
        console.warn('‚ö†Ô∏è No customer type data to display');
        const container = canvas.parentElement;
        container.innerHTML = `
          <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666;">
            <div style="text-align: center;">
              <i class="bx bx-info-circle" style="font-size: 3rem; margin-bottom: 1rem; color: #999;"></i>
              <p style="font-size: 1.1rem; margin: 0;">Kh√¥ng c√≥ d·ªØ li·ªáu ph√¢n lo·∫°i kh√°ch h√†ng</p>
            </div>
          </div>
        `;
        return;
      }
      
      customerTypeChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: customerTypes.map(c => c.type),
          datasets: [{
            data: customerTypes.map(c => c.count),
            backgroundColor: ['#5a67d8', '#48bb78', '#ed8936', '#9f7aea']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false
        }
      });
    }

    function createServiceChart(services) {
      if (typeof Chart === 'undefined') {
        console.error('‚ùå Chart.js not available!');
        return;
      }
      
      const canvas = document.getElementById('serviceChart');
      if (!canvas) {
        console.error('‚ùå Service chart canvas not found!');
        return;
      }
      
      const ctx = canvas.getContext('2d');
      
      if (serviceChart) {
        try {
          serviceChart.destroy();
        } catch (e) {
          console.warn('‚ö†Ô∏è Error destroying chart:', e);
        }
      }
      
      if (!services || services.length === 0) {
        console.warn('‚ö†Ô∏è No service usage data to display');
        const container = document.getElementById('serviceChart').parentElement;
        container.innerHTML = `
          <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666;">
            <div style="text-align: center;">
              <i class="bx bx-info-circle" style="font-size: 3rem; margin-bottom: 1rem; color: #999;"></i>
              <p style="font-size: 1.1rem; margin: 0;">Kh√¥ng c√≥ d·ªØ li·ªáu s·ª≠ d·ª•ng d·ªãch v·ª• trong kho·∫£ng th·ªùi gian ƒë√£ ch·ªçn</p>
            </div>
          </div>
        `;
        return;
      }
      
      serviceChart = new Chart(ctx, {
        type: 'bar',
        indexAxis: 'y',
        data: {
          labels: services.map(s => s.serviceName),
          datasets: [{
            label: 'Doanh thu (‚Ç´)',
            data: services.map(s => s.totalRevenue),
            backgroundColor: '#ed8936',
            borderColor: '#dd6b20',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return formatCurrency(value);
                }
              }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  return 'Doanh thu: ' + formatCurrency(context.parsed.x);
                }
              }
            }
          }
        }
      });
    }

    function updateTopCustomersTable(topCustomers) {
      const tbody = document.querySelector('#topCustomersTable tbody');
      if (!topCustomers || topCustomers.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="4" style="text-align: center; padding: 2rem; color: #666;">
              <i class="bx bx-info-circle" style="font-size: 2rem; margin-bottom: 0.5rem; display: block; color: #999;"></i>
              Kh√¥ng c√≥ d·ªØ li·ªáu kh√°ch h√†ng trong kho·∫£ng th·ªùi gian ƒë√£ ch·ªçn
            </td>
          </tr>
        `;
        return;
      }
      tbody.innerHTML = topCustomers.map(customer => `
        <tr>
          <td><strong>${customer.customerName}</strong></td>
          <td>${formatCurrency(customer.totalSpent)}</td>
          <td>${customer.bookingCount}</td>
          <td>${new Date(customer.lastBooking).toLocaleDateString('vi-VN')}</td>
        </tr>
      `).join('');
    }

    // Export functions
    function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF();
      
      pdf.text('B√°o c√°o Resort Management', 20, 20);
      pdf.text(`T·ª´ ng√†y: ${document.getElementById('startDate').value}`, 20, 30);
      pdf.text(`ƒê·∫øn ng√†y: ${document.getElementById('endDate').value}`, 20, 40);
      
      pdf.save('bao-cao-resort.pdf');
    }

    function exportToExcel() {
      alert('T√≠nh nƒÉng xu·∫•t Excel ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn');
    }

    function printReport() {
      window.print();
    }

    // Utility functions
    function formatCurrency(amount) {
      return new Intl.NumberFormat('vi-VN', {
        style: 'currency',
        currency: 'VND'
      }).format(amount);
    }

    function logout() {
      console.log('üö™ Logging out from reports...');
      
      localStorage.removeItem('adminToken');
      localStorage.removeItem('token');
      localStorage.removeItem('authToken');
      localStorage.removeItem('user');
      localStorage.removeItem('userRole');
      
      window.location.href = '/customer/login.html';
    }
  </script>
</body>
</html>
