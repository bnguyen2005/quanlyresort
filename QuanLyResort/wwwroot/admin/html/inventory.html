<!DOCTYPE html>
<html lang="vi" class="light-style layout-menu-fixed" dir="ltr" data-theme="theme-default" data-assets-path="../assets/" data-template="vertical-menu-template-free">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
  <title>Qu·∫£n l√Ω Kho h√†ng - Resort Admin</title>
  <meta name="description" content="" />

  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="../assets/img/favicon/favicon.ico" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&display=swap" rel="stylesheet" />

  <!-- Icons -->
  <link rel="stylesheet" href="../assets/vendor/fonts/boxicons.css" />

  <!-- Core CSS -->
  <link rel="stylesheet" href="../assets/vendor/css/core.css" class="template-customizer-core-css" />
  <link rel="stylesheet" href="../assets/vendor/css/theme-default.css" class="template-customizer-theme-css" />
  <link rel="stylesheet" href="../assets/css/demo.css" />
  <link rel="stylesheet" href="../assets/css/fix-scrollbar.css" />
  <link rel="stylesheet" href="../assets/css/admin-custom-theme.css" />

  <!-- Vendors CSS -->
  <link rel="stylesheet" href="../assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">

  <!-- Page CSS -->
  <style>
    .stats-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 15px;
      padding: 1.5rem;
      color: white;
      margin-bottom: 1.5rem;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .stats-card.danger {
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
    }
    
    .stats-card.success {
      background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
    }
    
    .stats-card.warning {
      background: linear-gradient(135deg, #feca57 0%, #ff9ff3 100%);
    }
    
    .stats-card h3 {
      color: white;
      margin-bottom: 0.5rem;
    }
    
    .inventory-filters {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 10px;
      margin-bottom: 1.5rem;
    }
    
    .stock-status {
      padding: 0.25rem 0.75rem;
      border-radius: 15px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .stock-status.normal {
      background: #d4edda;
      color: #155724;
    }
    
    .stock-status.low {
      background: #fff3cd;
      color: #856404;
    }
    
    .stock-status.critical {
      background: #f8d7da;
      color: #721c24;
    }
    
    .stock-status.overstock {
      background: #cce5ff;
      color: #004085;
    }
    
    .action-buttons .btn {
      margin: 0 0.25rem;
      padding: 0.25rem 0.5rem;
    }
    
    .modal-lg {
      max-width: 800px;
    }
    
    .form-floating {
      margin-bottom: 1rem;
    }
    
    .alert-item {
      border-left: 4px solid #dc3545;
      background: #f8f9fa;
      padding: 1rem;
      margin-bottom: 0.5rem;
      border-radius: 0 8px 8px 0;
    }
    
    .movement-history {
      max-height: 300px;
      overflow-y: auto;
    }
    
    .movement-item {
      border-bottom: 1px solid #eee;
      padding: 0.75rem 0;
    }
    
    .movement-item:last-child {
      border-bottom: none;
    }
  </style>

  <!-- Helpers -->
  <script src="../assets/vendor/js/helpers.js"></script>
  <script src="../assets/js/config.js"></script>
</head>

<body>
  <!-- Layout wrapper -->
  <div class="layout-wrapper layout-content-navbar">
    <div class="layout-container">
      <!-- Menu -->
      <div id="common-menu"></div>

      <!-- Layout container -->
      <div class="layout-page">
        <!-- Navbar -->
        <nav class="layout-navbar container-xxl navbar navbar-expand-xl navbar-detached align-items-center bg-navbar-theme" id="layout-navbar">
          <div class="layout-menu-toggle navbar-nav align-items-xl-center me-3 me-xl-0 d-xl-none">
            <a class="nav-item nav-link px-0 me-xl-4" href="javascript:void(0)">
              <i class="bx bx-menu bx-sm"></i>
            </a>
          </div>

          <div class="navbar-nav-right d-flex align-items-center" id="navbar-collapse">
            <ul class="navbar-nav flex-row align-items-center ms-auto">
              <!-- User -->
              <li class="nav-item navbar-dropdown dropdown-user dropdown">
                <a class="nav-link dropdown-toggle hide-arrow" href="javascript:void(0);" data-bs-toggle="dropdown">
                  <div class="avatar avatar-online">
                    <img src="../assets/img/avatars/1.png" alt class="w-px-40 h-auto rounded-circle" />
                  </div>
                </a>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li>
                    <a class="dropdown-item" href="#">
                      <div class="d-flex">
                        <div class="flex-shrink-0 me-3">
                          <div class="avatar avatar-online">
                            <img src="../assets/img/avatars/1.png" alt class="w-px-40 h-auto rounded-circle" />
                          </div>
                        </div>
                        <div class="flex-grow-1">
                          <span class="fw-semibold d-block">Admin</span>
                          <small class="text-muted">Administrator</small>
                        </div>
                      </div>
                    </a>
                  </li>
                  <li>
                    <div class="dropdown-divider"></div>
                  </li>
                  <li>
                    <a class="dropdown-item" href="#" id="logoutBtn">
                      <i class="bx bx-power-off me-2"></i>
                      <span class="align-middle">ƒêƒÉng xu·∫•t</span>
                    </a>
                  </li>
                </ul>
              </li>
            </ul>
          </div>
        </nav>

        <!-- Content wrapper -->
        <div class="content-wrapper">
          <!-- Content -->
          <div class="container-xxl flex-grow-1 container-p-y">
            <h4 class="fw-bold py-3 mb-4">
              <span class="text-muted fw-light">Qu·∫£n l√Ω /</span> Kho h√†ng
            </h4>

            <!-- Stats Cards -->
            <div class="row">
              <div class="col-lg-3 col-md-6 col-12 mb-4">
                <div class="stats-card">
                  <div class="d-flex justify-content-between">
                    <div>
                      <h3 class="card-title mb-2" id="totalItems">0</h3>
                      <small class="text-white">T·ªïng s·∫£n ph·∫©m</small>
                    </div>
                    <div class="avatar flex-shrink-0">
                      <i class="bx bx-package text-white" style="font-size: 2rem;"></i>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-lg-3 col-md-6 col-12 mb-4">
                <div class="stats-card danger">
                  <div class="d-flex justify-content-between">
                    <div>
                      <h3 class="card-title mb-2" id="lowStockItems">0</h3>
                      <small class="text-white">S·∫Øp h·∫øt h√†ng</small>
                    </div>
                    <div class="avatar flex-shrink-0">
                      <i class="bx bx-error text-white" style="font-size: 2rem;"></i>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-lg-3 col-md-6 col-12 mb-4">
                <div class="stats-card success">
                  <div class="d-flex justify-content-between">
                    <div>
                      <h3 class="card-title mb-2" id="totalValue">0‚Ç´</h3>
                      <small class="text-white">Gi√° tr·ªã t·ªìn kho</small>
                    </div>
                    <div class="avatar flex-shrink-0">
                      <i class="bx bx-dollar text-white" style="font-size: 2rem;"></i>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-lg-3 col-md-6 col-12 mb-4">
                <div class="stats-card warning">
                  <div class="d-flex justify-content-between">
                    <div>
                      <h3 class="card-title mb-2" id="totalSuppliers">0</h3>
                      <small class="text-white">Nh√† cung c·∫•p</small>
                    </div>
                    <div class="avatar flex-shrink-0">
                      <i class="bx bx-store text-white" style="font-size: 2rem;"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Low Stock Alerts -->
            <div class="row mb-4" id="lowStockAlerts" style="display: none;">
              <div class="col-12">
                <div class="card">
                  <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">üö® C·∫£nh b√°o t·ªìn kho th·∫•p</h5>
                    <button class="btn btn-sm btn-outline-secondary" onclick="toggleAlerts()">
                      <i class="bx bx-x"></i> ·∫®n
                    </button>
                  </div>
                  <div class="card-body" id="alertsContainer">
                    <!-- Alerts will be loaded here -->
                  </div>
                </div>
              </div>
            </div>

            <!-- Filters -->
            <div class="card mb-4">
              <div class="card-body">
                <div class="inventory-filters">
                  <div class="row">
                    <div class="col-md-3">
                      <div class="form-floating">
                        <input type="text" class="form-control" id="searchInput" placeholder="T√¨m ki·∫øm...">
                        <label for="searchInput">T√¨m ki·∫øm s·∫£n ph·∫©m</label>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="form-floating">
                        <select class="form-select" id="categoryFilter">
                          <option value="">T·∫•t c·∫£ danh m·ª•c</option>
                        </select>
                        <label for="categoryFilter">Danh m·ª•c</label>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="form-floating">
                        <select class="form-select" id="stockFilter">
                          <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                          <option value="low">S·∫Øp h·∫øt h√†ng</option>
                          <option value="normal">B√¨nh th∆∞·ªùng</option>
                          <option value="overstock">D∆∞ th·ª´a</option>
                        </select>
                        <label for="stockFilter">Tr·∫°ng th√°i t·ªìn kho</label>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <button class="btn btn-primary w-100 h-100" onclick="applyFilters()">
                        <i class="bx bx-search"></i> T√¨m ki·∫øm
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Inventory Table -->
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Danh s√°ch h√†ng t·ªìn kho</h5>
                <div>
                  <button class="btn btn-success me-2" onclick="openCreateModal()">
                    <i class="bx bx-plus"></i> Th√™m s·∫£n ph·∫©m
                  </button>
                  <button class="btn btn-info" onclick="loadInventoryItems()">
                    <i class="bx bx-refresh"></i> L√†m m·ªõi
                  </button>
                </div>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table id="inventoryTable" class="table table-striped table-hover">
                    <thead>
                      <tr>
                        <th>M√£ SP</th>
                        <th>T√™n s·∫£n ph·∫©m</th>
                        <th>Danh m·ª•c</th>
                        <th>T·ªìn kho</th>
                        <th>ƒê∆°n v·ªã</th>
                        <th>Gi√°</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>Thao t√°c</th>
                      </tr>
                    </thead>
                    <tbody>
                      <!-- Data will be loaded here -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Create/Edit Item Modal -->
  <div class="modal fade" id="itemModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="itemModalTitle">Th√™m s·∫£n ph·∫©m m·ªõi</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="itemForm">
            <input type="hidden" id="itemId">
            <div class="row">
              <div class="col-md-6">
                <div class="form-floating mb-3">
                  <input type="text" class="form-control" id="itemCode" required>
                  <label for="itemCode">M√£ s·∫£n ph·∫©m *</label>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-floating mb-3">
                  <input type="text" class="form-control" id="itemName" required>
                  <label for="itemName">T√™n s·∫£n ph·∫©m *</label>
                </div>
              </div>
            </div>
            <div class="form-floating mb-3">
              <textarea class="form-control" id="description" style="height: 80px"></textarea>
              <label for="description">M√¥ t·∫£</label>
            </div>
            <div class="row">
              <div class="col-md-6">
                <div class="form-floating mb-3">
                  <select class="form-select" id="categoryId">
                    <option value="">Ch·ªçn danh m·ª•c</option>
                  </select>
                  <label for="categoryId">Danh m·ª•c</label>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-floating mb-3">
                  <select class="form-select" id="supplierId">
                    <option value="">Ch·ªçn nh√† cung c·∫•p</option>
                  </select>
                  <label for="supplierId">Nh√† cung c·∫•p</label>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-4">
                <div class="form-floating mb-3">
                  <input type="number" class="form-control" id="initialStock" min="0" value="0">
                  <label for="initialStock">T·ªìn kho ban ƒë·∫ßu</label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-floating mb-3">
                  <input type="number" class="form-control" id="minimumStock" min="0" value="0" required>
                  <label for="minimumStock">T·ªìn kho t·ªëi thi·ªÉu *</label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-floating mb-3">
                  <input type="number" class="form-control" id="maximumStock" min="1" value="1000" required>
                  <label for="maximumStock">T·ªìn kho t·ªëi ƒëa *</label>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-4">
                <div class="form-floating mb-3">
                  <input type="number" class="form-control" id="unitPrice" min="0" step="0.01" required>
                  <label for="unitPrice">Gi√° ƒë∆°n v·ªã *</label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-floating mb-3">
                  <select class="form-select" id="unit" required>
                    <option value="pcs">C√°i (pcs)</option>
                    <option value="kg">Kilogram (kg)</option>
                    <option value="liter">L√≠t (liter)</option>
                    <option value="box">H·ªôp (box)</option>
                    <option value="bottle">Chai (bottle)</option>
                    <option value="pack">G√≥i (pack)</option>
                  </select>
                  <label for="unit">ƒê∆°n v·ªã *</label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-floating mb-3">
                  <input type="text" class="form-control" id="location">
                  <label for="location">V·ªã tr√≠ trong kho</label>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
          <button type="button" class="btn btn-primary" onclick="saveItem()">L∆∞u</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Stock Movement Modal -->
  <div class="modal fade" id="stockModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">C·∫≠p nh·∫≠t t·ªìn kho</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="stockForm">
            <input type="hidden" id="stockItemId">
            <div class="mb-3">
              <strong id="stockItemName"></strong>
              <br><small class="text-muted">T·ªìn kho hi·ªán t·∫°i: <span id="currentStock"></span></small>
            </div>
            <div class="form-floating mb-3">
              <select class="form-select" id="movementType" required>
                <option value="in">Nh·∫≠p kho</option>
                <option value="out">Xu·∫•t kho</option>
                <option value="adjustment_in">ƒêi·ªÅu ch·ªânh tƒÉng</option>
                <option value="adjustment_out">ƒêi·ªÅu ch·ªânh gi·∫£m</option>
              </select>
              <label for="movementType">Lo·∫°i giao d·ªãch *</label>
            </div>
            <div class="form-floating mb-3">
              <input type="number" class="form-control" id="quantity" min="1" required>
              <label for="quantity">S·ªë l∆∞·ª£ng *</label>
            </div>
            <div class="form-floating mb-3">
              <input type="text" class="form-control" id="reference">
              <label for="reference">S·ªë ch·ª©ng t·ª´</label>
            </div>
            <div class="form-floating mb-3">
              <textarea class="form-control" id="notes" style="height: 80px"></textarea>
              <label for="notes">Ghi ch√∫</label>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
          <button type="button" class="btn btn-primary" onclick="saveStockMovement()">C·∫≠p nh·∫≠t</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Item Details Modal -->
  <div class="modal fade" id="detailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Chi ti·∫øt s·∫£n ph·∫©m</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="detailsContent">
          <!-- Details will be loaded here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Core JS -->
  <script src="../assets/vendor/libs/jquery/jquery.js"></script>
  <script src="../assets/vendor/libs/popper/popper.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.js"></script>
  <script src="../assets/vendor/js/menu.js"></script>

  <!-- Toast container -->
  <div class="position-fixed top-0 end-0 p-3" style="z-index: 1080">
    <div id="toastContainer"></div>
  </div>

  <!-- DataTables -->
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>

  <!-- Menu loader -->
  <script src="../js/load-menu.js"></script>
  <script src="../assets/js/main.js"></script>

  <script>
    const API_BASE = `${window.location.origin}/api/inventory`;
    let inventoryTable;
    let loadItemsVersion = 0; // prevent race conditions when reloading items
    let categories = [];
    let suppliers = [];

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üîµ Inventory page loaded');
      
      loadCommonMenu();
      setupEventListeners();
      loadDashboardStats();
      loadCategories();
      loadSuppliers();
      loadInventoryItems();
      loadLowStockAlerts();
    });

    function setupEventListeners() {
      // Logout button
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', function(e) {
          e.preventDefault();
          logout();
        });
      }

      // Search input with debounce
      const searchEl = document.getElementById('searchInput');
      let debounceTimer;
      searchEl.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => applyFilters(), 300);
      });
      searchEl.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') { e.preventDefault(); applyFilters(); }
      });
    }
    function showToast(message, type = 'success') {
      const container = document.getElementById('toastContainer');
      const wrapper = document.createElement('div');
      wrapper.className = `toast align-items-center text-bg-${type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'danger'} border-0`;
      wrapper.setAttribute('role', 'alert');
      wrapper.setAttribute('aria-live', 'assertive');
      wrapper.setAttribute('aria-atomic', 'true');
      wrapper.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>`;
      container.appendChild(wrapper);
      const toast = new bootstrap.Toast(wrapper, { delay: 2500 });
      toast.show();
      wrapper.addEventListener('hidden.bs.toast', () => wrapper.remove());
    }


    function logout() {
      localStorage.removeItem('adminToken');
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      localStorage.removeItem('userRole');
      
      // Skip auth check
    }

    async function loadDashboardStats() {
      try {
        console.log('üìä Loading dashboard stats...');
        const token = localStorage.getItem('token');
        
        const response = await fetch(`${API_BASE}/dashboard-stats?_=${Date.now()}`, {
          headers: { 'Authorization': `Bearer ${token}` },
          cache: 'no-store'
        });

        if (response.ok) {
          const data = await response.json();
          console.log('üìà Dashboard data:', data);
          
          document.getElementById('totalItems').textContent = data.totalItems || 0;
          document.getElementById('lowStockItems').textContent = data.lowStockItems || 0;
          document.getElementById('totalValue').textContent = formatCurrency(data.totalValue || 0);
          document.getElementById('totalSuppliers').textContent = data.totalSuppliers || 0;
        } else {
          console.log('üìä Loading sample dashboard stats...');
          document.getElementById('totalItems').textContent = '156';
          document.getElementById('lowStockItems').textContent = '8';
          document.getElementById('totalValue').textContent = formatCurrency(45000000);
          document.getElementById('totalSuppliers').textContent = '12';
        }
      } catch (error) {
        console.error('‚ùå Error loading dashboard stats:', error);
      }
    }

    async function loadCategories() {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${API_BASE}/categories?_=${Date.now()}`, {
          headers: { 'Authorization': `Bearer ${token}` },
          cache: 'no-store'
        });

        if (response.ok) {
          categories = await response.json();
          updateCategorySelects();
        } else {
          // Sample categories
          categories = [
            { categoryId: 1, categoryName: 'ƒê·ªì u·ªëng' },
            { categoryId: 2, categoryName: 'Th·ª±c ph·∫©m' },
            { categoryId: 3, categoryName: 'V·ªá sinh' },
            { categoryId: 4, categoryName: 'Thi·∫øt b·ªã' }
          ];
          updateCategorySelects();
        }
      } catch (error) {
        console.error('Error loading categories:', error);
      }
    }

    async function loadSuppliers() {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${API_BASE}/suppliers?_=${Date.now()}`, {
          headers: { 'Authorization': `Bearer ${token}` },
          cache: 'no-store'
        });

        if (response.ok) {
          suppliers = await response.json();
          updateSupplierSelects();
        } else {
          // Sample suppliers
          suppliers = [
            { supplierId: 1, supplierName: 'C√¥ng ty TNHH ABC' },
            { supplierId: 2, supplierName: 'Nh√† cung c·∫•p XYZ' },
            { supplierId: 3, supplierName: 'Si√™u th·ªã Metro' }
          ];
          updateSupplierSelects();
        }
      } catch (error) {
        console.error('Error loading suppliers:', error);
      }
    }

    function updateCategorySelects() {
      const selects = ['categoryFilter', 'categoryId'];
      selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (select) {
          // Keep first option
          const firstOption = select.children[0];
          select.innerHTML = '';
          select.appendChild(firstOption);
          
          categories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat.categoryId;
            option.textContent = cat.categoryName;
            select.appendChild(option);
          });
        }
      });
    }

    function updateSupplierSelects() {
      const select = document.getElementById('supplierId');
      if (select) {
        // Keep first option
        const firstOption = select.children[0];
        select.innerHTML = '';
        select.appendChild(firstOption);
        
        suppliers.forEach(supplier => {
          const option = document.createElement('option');
          option.value = supplier.supplierId;
          option.textContent = supplier.supplierName;
          select.appendChild(option);
        });
      }
    }

    async function loadInventoryItems() {
      try {
        console.log('üì¶ Loading inventory items...');
        const token = localStorage.getItem('token');
        
        const search = document.getElementById('searchInput').value;
        const category = document.getElementById('categoryFilter').value;
        const stockFilter = document.getElementById('stockFilter').value;
        console.log('üîé Filters', { search, category, stockFilter });
        
        const currentVersion = ++loadItemsVersion;
        let url = `${API_BASE}/items?`;
        if (search) url += `search=${encodeURIComponent(search)}&`;
        if (category) url += `category=${encodeURIComponent(category)}&`;
        if (stockFilter === 'low') url += `lowStock=true&`;
        url += `_=${Date.now()}`;
        
        console.log('üåê GET items URL:', url);
        const response = await fetch(url, {
          headers: { 'Authorization': `Bearer ${token}` },
          cache: 'no-store'
        });
        console.log('üåê GET items status:', response.status);

        if (response.ok) {
          const data = await response.json();
          console.log('üì¶ Inventory meta:', { totalItems: data.totalItems, currentPage: data.currentPage, pageSize: data.pageSize });
          console.log('üì¶ Items length:', Array.isArray(data.items) ? data.items.length : 'N/A');
          if (currentVersion !== loadItemsVersion) {
            console.log('‚è≠Ô∏è Stale response ignored (version mismatch)');
            return;
          }
          updateInventoryTable(data.items);
        } else {
          console.log('üì¶ Loading sample inventory data...');
          const sampleItems = [
            {
              itemId: 1,
              itemCode: 'DU001',
              itemName: 'N∆∞·ªõc su·ªëi Aquafina 500ml',
              category: { categoryName: 'ƒê·ªì u·ªëng' },
              currentStock: 150,
              minimumStock: 50,
              unit: 'chai',
              unitPrice: 8000,
              stockStatus: 'Normal',
              stockValue: 1200000
            },
            {
              itemId: 2,
              itemCode: 'TP001',
              itemName: 'B√°nh m√¨ sandwich',
              category: { categoryName: 'Th·ª±c ph·∫©m' },
              currentStock: 5,
              minimumStock: 20,
              unit: 'c√°i',
              unitPrice: 25000,
              stockStatus: 'Low Stock',
              stockValue: 125000
            }
          ];
          updateInventoryTable(sampleItems);
        }
      } catch (error) {
        console.error('‚ùå Error loading inventory items:', error);
      }
    }

    function updateInventoryTable(items) {
      console.log('üß± Render table with items:', Array.isArray(items) ? items.length : 'N/A');
      const tbody = document.querySelector('#inventoryTable tbody');
      if (!tbody) {
        console.warn('‚ö†Ô∏è Table body not found');
        return;
      }
      if (inventoryTable) {
        inventoryTable.destroy();
      }
      tbody.innerHTML = '';
      if (!Array.isArray(items)) {
        console.warn('‚ö†Ô∏è items is not array', items);
        return;
      }

      items.forEach(item => {
        const row = document.createElement('tr');
        
        const stockStatusClass = item.stockStatus === 'Low Stock' ? 'critical' : 
                               item.stockStatus === 'Overstock' ? 'overstock' : 'normal';
        
        row.innerHTML = `
          <td><strong>${item.itemCode}</strong></td>
          <td>${item.itemName}</td>
          <td>${item.category?.categoryName || 'N/A'}</td>
          <td>
            <strong>${item.currentStock}</strong>
            <small class="text-muted">/ ${item.minimumStock} min</small>
          </td>
          <td>${item.unit}</td>
          <td>${formatCurrency(item.unitPrice)}</td>
          <td>
            <span class="stock-status ${stockStatusClass}">
              ${item.stockStatus}
            </span>
          </td>
          <td class="action-buttons">
            <button class="btn btn-sm btn-info" onclick="viewDetails(${item.itemId})" title="Xem chi ti·∫øt">
              <i class="bx bx-show"></i>
            </button>
            <button class="btn btn-sm btn-warning" onclick="openEditModal(${item.itemId})" title="S·ª≠a">
              <i class="bx bx-edit"></i>
            </button>
            <button class="btn btn-sm btn-success" onclick="openStockModal(${item.itemId}, '${item.itemName}', ${item.currentStock})" title="C·∫≠p nh·∫≠t t·ªìn kho">
              <i class="bx bx-transfer"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteItem(${item.itemId})" title="X√≥a (·∫©n)">
              <i class="bx bx-trash"></i>
            </button>
          </td>
        `;
        
        tbody.appendChild(row);
      });

      // Initialize DataTable
      console.log('üß© Init DataTable');
      inventoryTable = $('#inventoryTable').DataTable({
        responsive: true,
        language: {
          url: '../local-plugins/datatables/i18n/vi.json'
        },
        // keep server order (newest-first by ItemId)
        order: [],
        columnDefs: [
          { targets: -1, orderable: false }
        ]
      });
      console.log('‚úÖ Table updated');
    }

    async function loadLowStockAlerts() {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${API_BASE}/low-stock-alerts?_=${Date.now()}`, {
          headers: { 'Authorization': `Bearer ${token}` },
          cache: 'no-store'
        });

        if (response.ok) {
          const alerts = await response.json();
          if (alerts.length > 0) {
            displayLowStockAlerts(alerts);
          }
        }
      } catch (error) {
        console.error('Error loading low stock alerts:', error);
      }
    }

    function displayLowStockAlerts(alerts) {
      const alertsSection = document.getElementById('lowStockAlerts');
      const container = document.getElementById('alertsContainer');
      
      container.innerHTML = '';
      
      alerts.forEach(alert => {
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert-item';
        alertDiv.innerHTML = `
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong>${alert.itemName}</strong> (${alert.itemCode})
              <br>
              <small class="text-muted">
                T·ªìn kho: ${alert.currentStock} ${alert.unit} / T·ªëi thi·ªÉu: ${alert.minimumStock} ${alert.unit}
              </small>
            </div>
            <div>
              <span class="badge bg-${alert.alertLevel === 'Critical' ? 'danger' : alert.alertLevel === 'High' ? 'warning' : 'info'}">
                ${alert.alertLevel}
              </span>
            </div>
          </div>
        `;
        container.appendChild(alertDiv);
      });
      
      alertsSection.style.display = 'block';
    }

    function toggleAlerts() {
      document.getElementById('lowStockAlerts').style.display = 'none';
    }

    function applyFilters() {
      loadInventoryItems();
    }

    function closeAllModals() {
      try {
        const active = document.activeElement;
        if (active && typeof active.blur === 'function') active.blur();
      } catch(_) {}
      [ 'itemModal', 'stockModal', 'detailsModal' ].forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        const inst = bootstrap.Modal.getInstance(el);
        if (inst) inst.hide();
      });
    }

    function openCreateModal() {
      closeAllModals();
      document.getElementById('itemModalTitle').textContent = 'Th√™m s·∫£n ph·∫©m m·ªõi';
      document.getElementById('itemForm').reset();
      document.getElementById('itemId').value = '';
      
      const modal = new bootstrap.Modal(document.getElementById('itemModal'));
      modal.show();
    }

    async function openEditModal(itemId) {
      try {
        closeAllModals();
        document.getElementById('itemModalTitle').textContent = 'Ch·ªânh s·ª≠a s·∫£n ph·∫©m';
        document.getElementById('itemForm').reset();
        document.getElementById('itemId').value = String(itemId);
        const token = localStorage.getItem('token');
        const resp = await fetch(`${API_BASE}/items/${itemId}`, {
          headers: token ? { 'Authorization': `Bearer ${token}` } : {}
        });
        if (!resp.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin s·∫£n ph·∫©m');
        const data = await resp.json();
        document.getElementById('itemCode').value = data.itemCode || '';
        document.getElementById('itemName').value = data.itemName || '';
        document.getElementById('description').value = data.description || '';
        document.getElementById('categoryId').value = data.category?.categoryId || '';
        document.getElementById('supplierId').value = data.supplier?.supplierId || '';
        document.getElementById('minimumStock').value = data.minimumStock ?? 0;
        document.getElementById('maximumStock').value = data.maximumStock ?? 0;
        document.getElementById('unitPrice').value = data.unitPrice ?? 0;
        document.getElementById('unit').value = data.unit || 'pcs';
        document.getElementById('location').value = data.location || '';
        const modal = new bootstrap.Modal(document.getElementById('itemModal'));
        modal.show();
      } catch (e) {
        console.error('‚ùå Error loading item:', e);
        alert('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin s·∫£n ph·∫©m');
      }
    }

    function openStockModal(itemId, itemName, currentStock) {
      closeAllModals();
      document.getElementById('stockItemId').value = itemId;
      document.getElementById('stockItemName').textContent = itemName;
      document.getElementById('currentStock').textContent = currentStock;
      document.getElementById('stockForm').reset();
      
      const modal = new bootstrap.Modal(document.getElementById('stockModal'));
      modal.show();
    }

    async function viewDetails(itemId) {
      try {
        closeAllModals();
        const token = localStorage.getItem('token');
        const resp = await fetch(`${API_BASE}/items/${itemId}?_=${Date.now()}`, {
          headers: token ? { 'Authorization': `Bearer ${token}` } : {},
          cache: 'no-store'
        });
        if (!resp.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt s·∫£n ph·∫©m');
        const d = await resp.json();
        const html = `
          <div class="row">
            <div class="col-md-6">
              <p><strong>M√£ SP:</strong> ${d.itemCode}</p>
              <p><strong>T√™n:</strong> ${d.itemName}</p>
              <p><strong>Danh m·ª•c:</strong> ${d.category?.categoryName || 'N/A'}</p>
              <p><strong>Nh√† cung c·∫•p:</strong> ${d.supplier?.supplierName || 'N/A'}</p>
            </div>
            <div class="col-md-6">
              <p><strong>T·ªìn kho:</strong> ${d.currentStock}</p>
              <p><strong>T·ªëi thi·ªÉu:</strong> ${d.minimumStock}</p>
              <p><strong>Gi√°:</strong> ${formatCurrency(d.unitPrice)}</p>
              <p><strong>ƒê∆°n v·ªã:</strong> ${d.unit}</p>
            </div>
          </div>
          <hr>
          <div class="movement-history">
            ${(d.stockMovements && d.stockMovements.length)
              ? d.stockMovements.map(sm => `
                  <div class="movement-item">
                    <div><strong>${sm.movementType}</strong> (${sm.quantity})</div>
                    <small class="text-muted">${new Date(sm.movementDate).toLocaleString()} ‚Äî ${sm.reference || ''}</small>
                    ${sm.notes ? `<div>${sm.notes}</div>` : ''}
                  </div>
                `).join('')
              : '<em>Ch∆∞a c√≥ l·ªãch s·ª≠ giao d·ªãch</em>'}
          </div>
        `;
        document.getElementById('detailsContent').innerHTML = html;
        const modal = new bootstrap.Modal(document.getElementById('detailsModal'));
        modal.show();
      } catch (e) {
        console.error('‚ùå Error loading details:', e);
        alert('Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt s·∫£n ph·∫©m');
      }
    }

    // Accessibility: manage focus for modals to avoid aria-hidden focus warnings
    document.addEventListener('shown.bs.modal', function (e) {
      try {
        if (e.target && e.target.id === 'itemModal') {
          document.getElementById('itemCode')?.focus();
        } else if (e.target && e.target.id === 'stockModal') {
          document.getElementById('quantity')?.focus();
        } else if (e.target && e.target.id === 'detailsModal') {
          document.getElementById('detailsModal')?.focus();
        }
      } catch(_) {}
    });

    document.addEventListener('hidden.bs.modal', function (e) {
      try {
        if (!e.target) return;
        // After closing any inventory modal, return focus to a safe control
        const refreshBtn = Array.from(document.querySelectorAll('button')).find(btn => btn.textContent?.trim().includes('L√†m m·ªõi'));
        const addBtn = Array.from(document.querySelectorAll('button')).find(btn => btn.textContent?.trim().includes('Th√™m s·∫£n ph·∫©m'));
        (refreshBtn || addBtn || document.body).focus();
      } catch(_) {}
    });

    async function saveItem() {
      try {
        const token = localStorage.getItem('token');
        if (!token) { showToast('Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.', 'danger'); return; }
        const id = document.getElementById('itemId').value;
        const dto = {
          itemCode: document.getElementById('itemCode').value.trim(),
          itemName: document.getElementById('itemName').value.trim(),
          description: document.getElementById('description').value.trim() || null,
          categoryId: parseInt(document.getElementById('categoryId').value) || null,
          supplierId: parseInt(document.getElementById('supplierId').value) || null,
          initialStock: parseInt(document.getElementById('initialStock').value) || 0,
          minimumStock: parseInt(document.getElementById('minimumStock').value) || 0,
          maximumStock: parseInt(document.getElementById('maximumStock').value) || 0,
          unitPrice: parseFloat(document.getElementById('unitPrice').value) || 0,
          unit: document.getElementById('unit').value,
          location: document.getElementById('location').value.trim() || null
        };
        if (!dto.itemCode || !dto.itemName) { alert('M√£ v√† T√™n s·∫£n ph·∫©m l√† b·∫Øt bu·ªôc'); return; }
        const isEdit = !!id;
        const url = isEdit ? `${API_BASE}/items/${id}` : `${API_BASE}/items`;
        const method = isEdit ? 'PUT' : 'POST';
        const saveBtn = Array.from(document.querySelectorAll('#itemModal .btn-primary'))[0];
        if (saveBtn) { saveBtn.disabled = true; saveBtn.textContent = 'ƒêang l∆∞u...'; }

        const resp = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify(dto)
        });
        console.log('üåê saveItem', method, url, dto);
        console.log('üåê saveItem token present:', !!token);
        if (!resp.ok) {
          const err = await resp.json().catch(() => ({}));
          throw new Error(err.message || 'L∆∞u s·∫£n ph·∫©m th·∫•t b·∫°i');
        }
        console.log('üåê saveItem response OK');
        showToast(isEdit ? 'C·∫≠p nh·∫≠t s·∫£n ph·∫©m th√†nh c√¥ng!' : 'T·∫°o s·∫£n ph·∫©m th√†nh c√¥ng!', 'success');
        bootstrap.Modal.getInstance(document.getElementById('itemModal'))?.hide();
        try {
          await loadInventoryItems();
        } catch (reloadErr) {
          console.warn('‚ö†Ô∏è Reload items after save failed:', reloadErr);
        }
      } catch (e) {
        console.error('‚ùå Error saving item:', e);
        showToast('L·ªói: ' + e.message, 'danger');
      }
      finally {
        const saveBtn = Array.from(document.querySelectorAll('#itemModal .btn-primary'))[0];
        if (saveBtn) { saveBtn.disabled = false; saveBtn.textContent = 'L∆∞u'; }
      }
    }

    async function saveStockMovement() {
      try {
        const token = localStorage.getItem('token');
        const id = document.getElementById('stockItemId').value;
        const dto = {
          movementType: document.getElementById('movementType').value,
          quantity: parseInt(document.getElementById('quantity').value) || 0,
          reference: document.getElementById('reference').value.trim() || null,
          notes: document.getElementById('notes').value.trim() || null
        };
        const smUrl = `${API_BASE}/items/${id}/stock-movement`;
        console.log('üåê saveStockMovement POST', smUrl, dto);
        const saveBtn = Array.from(document.querySelectorAll('#stockModal .btn-primary'))[0];
        if (saveBtn) { saveBtn.disabled = true; saveBtn.textContent = 'ƒêang c·∫≠p nh·∫≠t...'; }

        const resp = await fetch(smUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify(dto)
        });
        console.log('üåê saveStockMovement status:', resp.status);
        if (!resp.ok) {
          const err = await resp.json().catch(() => ({}));
          throw new Error(err.message || 'C·∫≠p nh·∫≠t t·ªìn kho th·∫•t b·∫°i');
        }
        bootstrap.Modal.getInstance(document.getElementById('stockModal'))?.hide();
        await loadInventoryItems();
        showToast('C·∫≠p nh·∫≠t t·ªìn kho th√†nh c√¥ng!', 'success');
      } catch (e) {
        console.error('‚ùå Error saving stock movement:', e);
        showToast('L·ªói: ' + e.message, 'danger');
      }
      finally {
        const saveBtn = Array.from(document.querySelectorAll('#stockModal .btn-primary'))[0];
        if (saveBtn) { saveBtn.disabled = false; saveBtn.textContent = 'C·∫≠p nh·∫≠t'; }
      }
    }

    async function deleteItem(itemId) {
      if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a (·∫©n) s·∫£n ph·∫©m n√†y?')) return;
      try {
        const token = localStorage.getItem('token');
        const url = `${API_BASE}/items/${itemId}`;
        const resp = await fetch(url, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
        if (!resp.ok) {
          const err = await resp.json().catch(() => ({}));
          throw new Error(err.message || 'X√≥a s·∫£n ph·∫©m th·∫•t b·∫°i');
        }
        showToast('ƒê√£ x√≥a (·∫©n) s·∫£n ph·∫©m', 'success');
        await loadInventoryItems();
      } catch (e) {
        console.error('‚ùå Error deleting item:', e);
        showToast('L·ªói: ' + e.message, 'danger');
      }
    }

    

    function formatCurrency(amount) {
      return new Intl.NumberFormat('vi-VN', {
        style: 'currency',
        currency: 'VND'
      }).format(amount);
    }
  </script>
</body>
</html>
