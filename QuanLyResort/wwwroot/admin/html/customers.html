<!DOCTYPE html>
<html lang="vi" class="light-style layout-menu-fixed" dir="ltr" data-theme="theme-default" data-assets-path="../assets/" data-template="vertical-menu-template-free">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
  <title>Qu·∫£n l√Ω Kh√°ch h√†ng - Resort Management</title>
  
  <!-- NO CACHE -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  
  <link rel="icon" type="image/x-icon" href="../assets/img/favicon/favicon.ico" />
  <link rel="stylesheet" href="../assets/vendor/fonts/boxicons.css" />
  <link rel="stylesheet" href="../assets/vendor/css/core.css" class="template-customizer-core-css" />
  <link rel="stylesheet" href="../assets/vendor/css/theme-default.css" class="template-customizer-theme-css" />
  <link rel="stylesheet" href="../assets/css/demo.css" />
  <link rel="stylesheet" href="../assets/css/fix-scrollbar.css" />
  <link rel="stylesheet" href="../assets/css/admin-custom-theme.css" />
  <link rel="stylesheet" href="../assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" />
  <script src="../assets/vendor/js/helpers.js"></script>
</head>

<body>
  <div class="layout-wrapper layout-content-navbar">
    <div class="layout-container">
      
      <!-- Menu - Load from common component -->
      <div id="common-menu"></div>
      <script>
        // Load common menu with cache busting
        (function() {
          const menuVersion = Date.now();
          fetch('layout-menu.html?v=' + menuVersion)
            .then(response => {
              if (!response.ok) {
                throw new Error('Failed to load menu: ' + response.status);
              }
              return response.text();
            })
            .then(html => {
              const menuContainer = document.getElementById('common-menu');
              if (menuContainer) {
                menuContainer.innerHTML = html;
                console.log('‚úÖ Menu loaded successfully');
              } else {
                console.error('‚ùå Menu container not found');
              }
            })
            .catch(error => {
              console.error('‚ùå Error loading menu:', error);
            });
        })();
      </script>
      <!-- / Menu -->

      <!-- Layout container -->
      <div class="layout-page">
        
        <!-- Navbar -->
        <nav class="layout-navbar container-xxl navbar navbar-expand-xl navbar-detached align-items-center bg-navbar-theme" id="layout-navbar">
          <div class="layout-menu-toggle navbar-nav align-items-xl-center me-3 me-xl-0 d-xl-none">
            <a class="nav-item nav-link px-0 me-xl-4" href="javascript:void(0)">
              <i class="bx bx-menu bx-sm"></i>
            </a>
          </div>

          <div class="navbar-nav-right d-flex align-items-center" id="navbar-collapse">
            <div class="navbar-nav align-items-center">
              <div class="nav-item d-flex align-items-center">
                <h4 class="mb-0" id="pageTitle">üë• Qu·∫£n l√Ω Kh√°ch h√†ng</h4>
              </div>
            </div>

            <ul class="navbar-nav flex-row align-items-center ms-auto">
              <li class="nav-item navbar-dropdown dropdown-user dropdown">
                <a class="nav-link dropdown-toggle hide-arrow" href="javascript:void(0);" data-bs-toggle="dropdown">
                  <div class="avatar avatar-online">
                    <img src="../assets/img/avatars/1.png" alt class="w-px-40 h-auto rounded-circle" />
                  </div>
                </a>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li>
                    <a class="dropdown-item" href="#">
                      <div class="d-flex">
                        <div class="flex-shrink-0 me-3">
                          <div class="avatar avatar-online">
                            <img src="../assets/img/avatars/1.png" alt class="w-px-40 h-auto rounded-circle" />
                          </div>
                        </div>
                        <div class="flex-grow-1">
                          <span class="fw-semibold d-block" id="userFullName">Admin</span>
                          <small class="text-muted" id="userRole">Admin</small>
                        </div>
                      </div>
                    </a>
                  </li>
                  <li><div class="dropdown-divider"></div></li>
                  <li><a class="dropdown-item" href="#" onclick="commonLogout()"><i class="bx bx-power-off me-2"></i><span class="align-middle">ƒêƒÉng xu·∫•t</span></a></li>
                </ul>
              </li>
            </ul>
          </div>
        </nav>
        <!-- / Navbar -->

        <!-- Content wrapper -->
        <div class="content-wrapper">
          <div class="container-xxl flex-grow-1 container-p-y">
            
            <!-- Statistics Cards -->
            <div class="row mb-4">
              <div class="col-lg-3 col-md-6 col-6 mb-4">
                <div class="card">
                  <div class="card-body">
                    <div class="card-title d-flex align-items-start justify-content-between">
                      <div class="avatar flex-shrink-0">
                        <i class="bx bx-user text-primary" style="font-size: 2rem;"></i>
                      </div>
                    </div>
                    <span class="fw-semibold d-block mb-1">T·ªïng kh√°ch h√†ng</span>
                    <h3 class="card-title mb-2" id="totalCustomers">-</h3>
                  </div>
                </div>
              </div>
              <div class="col-lg-3 col-md-6 col-6 mb-4">
                <div class="card">
                  <div class="card-body">
                    <div class="card-title d-flex align-items-start justify-content-between">
                      <div class="avatar flex-shrink-0">
                        <i class="bx bx-user-check text-success" style="font-size: 2rem;"></i>
                      </div>
                    </div>
                    <span class="fw-semibold d-block mb-1">Kh√°ch VIP</span>
                    <h3 class="card-title mb-2" id="vipCustomers">-</h3>
                  </div>
                </div>
              </div>
              <div class="col-lg-3 col-md-6 col-6 mb-4">
                <div class="card">
                  <div class="card-body">
                    <div class="card-title d-flex align-items-start justify-content-between">
                      <div class="avatar flex-shrink-0">
                        <i class="bx bx-calendar text-info" style="font-size: 2rem;"></i>
                      </div>
                    </div>
                    <span class="fw-semibold d-block mb-1">Kh√°ch m·ªõi th√°ng n√†y</span>
                    <h3 class="card-title mb-2" id="newCustomers">-</h3>
                  </div>
                </div>
              </div>
              <div class="col-lg-3 col-md-6 col-6 mb-4">
                <div class="card">
                  <div class="card-body">
                    <div class="card-title d-flex align-items-start justify-content-between">
                      <div class="avatar flex-shrink-0">
                        <i class="bx bx-star text-warning" style="font-size: 2rem;"></i>
                      </div>
                    </div>
                    <span class="fw-semibold d-block mb-1">ƒêi·ªÉm trung b√¨nh</span>
                    <h3 class="card-title mb-2" id="avgLoyaltyPoints">-</h3>
                  </div>
                </div>
              </div>
            </div>

            <!-- Filters & Actions -->
            <div class="card mb-4">
              <div class="card-body">
                <div class="row">
                  <div class="col-md-3">
                    <label class="form-label">Lo·∫°i kh√°ch h√†ng</label>
                    <select id="filterCustomerType" class="form-select">
                      <option value="">T·∫•t c·∫£</option>
                      <option value="Individual">C√° nh√¢n</option>
                      <option value="Corporate">Doanh nghi·ªáp</option>
                      <option value="Group">Nh√≥m</option>
                    </select>
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">Qu·ªëc t·ªãch</label>
                    <select id="filterNationality" class="form-select">
                      <option value="">T·∫•t c·∫£</option>
                      <option value="Vietnam">Vi·ªát Nam</option>
                      <option value="USA">M·ªπ</option>
                      <option value="China">Trung Qu·ªëc</option>
                      <option value="Japan">Nh·∫≠t B·∫£n</option>
                      <option value="Korea">H√†n Qu·ªëc</option>
                      <option value="Thailand">Th√°i Lan</option>
                      <option value="Singapore">Singapore</option>
                    </select>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">T√¨m ki·∫øm</label>
                    <input type="text" id="searchInput" class="form-control" placeholder="T√™n, email, SƒêT, CMND/Passport...">
                  </div>
                  <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <div>
                      <button class="btn btn-primary" onclick="loadCustomers()">
                        <i class="bx bx-search me-1"></i> T√¨m ki·∫øm
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Customers Table -->
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Danh s√°ch Kh√°ch h√†ng</h5>
                <button class="btn btn-success" onclick="openCreateModal()">
                  <i class="bx bx-plus me-1"></i> Th√™m kh√°ch h√†ng
                </button>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table id="customersTable" class="table table-striped">
                    <thead>
                      <tr>
                        <th>ID</th>
                        <th>H·ªç t√™n</th>
                        <th>Email</th>
                        <th>SƒêT</th>
                        <th>Lo·∫°i</th>
                        <th>Qu·ªëc t·ªãch</th>
                        <th>ƒêi·ªÉm t√≠ch l≈©y</th>
                        <th>Ng√†y t·∫°o</th>
                        <th>Thao t√°c</th>
                      </tr>
                    </thead>
                    <tbody>
                      <!-- Data will be loaded here -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

          </div>
        </div>
        <!-- / Content wrapper -->

      </div>
      <!-- / Layout page -->
    </div>
    <!-- Overlay -->
    <div class="layout-overlay layout-menu-toggle"></div>
  </div>
  <!-- Toast container -->
  <div class="position-fixed top-0 end-0 p-3" style="z-index:1080">
    <div id="toastContainer"></div>
  </div>
  <!-- / Layout wrapper -->

  <!-- Create/Edit Customer Modal -->
  <div class="modal fade" id="customerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Th√™m kh√°ch h√†ng m·ªõi</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="customerForm">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label" for="fullName">H·ªç t√™n *</label>
                <input type="text" id="fullName" name="fullName" class="form-control" required autocomplete="name">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label" for="email">Email *</label>
                <input type="email" id="email" name="email" class="form-control" required autocomplete="email">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label" for="phoneNumber">S·ªë ƒëi·ªán tho·∫°i</label>
                <input type="tel" id="phoneNumber" name="phoneNumber" class="form-control" autocomplete="tel">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label" for="dateOfBirth">Ng√†y sinh</label>
                <input type="date" id="dateOfBirth" name="dateOfBirth" class="form-control" autocomplete="bday">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label" for="gender">Gi·ªõi t√≠nh</label>
                <select id="gender" name="gender" class="form-select" autocomplete="sex">
                  <option value="">Ch·ªçn gi·ªõi t√≠nh</option>
                  <option value="Male">Nam</option>
                  <option value="Female">N·ªØ</option>
                  <option value="Other">Kh√°c</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label" for="nationality">Qu·ªëc t·ªãch</label>
                <select id="nationality" name="nationality" class="form-select" autocomplete="country">
                  <option value="Vietnam">Vi·ªát Nam</option>
                  <option value="USA">M·ªπ</option>
                  <option value="China">Trung Qu·ªëc</option>
                  <option value="Japan">Nh·∫≠t B·∫£n</option>
                  <option value="Korea">H√†n Qu·ªëc</option>
                  <option value="Thailand">Th√°i Lan</option>
                  <option value="Singapore">Singapore</option>
                </select>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label" for="customerType">Lo·∫°i kh√°ch h√†ng</label>
                <select id="customerType" name="customerType" class="form-select">
                  <option value="Individual">C√° nh√¢n</option>
                  <option value="Corporate">Doanh nghi·ªáp</option>
                  <option value="Group">Nh√≥m</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label" for="address">ƒê·ªãa ch·ªâ</label>
                <input type="text" id="address" name="address" class="form-control" autocomplete="street-address">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label" for="idCardNumber">CMND/CCCD</label>
                <input type="text" id="idCardNumber" name="idCardNumber" class="form-control" autocomplete="off">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label" for="passportNumber">Passport</label>
                <input type="text" id="passportNumber" name="passportNumber" class="form-control" autocomplete="off">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label" for="loyaltyPoints">ƒêi·ªÉm t√≠ch l≈©y</label>
                <input type="number" id="loyaltyPoints" name="loyaltyPoints" class="form-control" value="0" min="0" autocomplete="off">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label" for="vipLevel">C·∫•p ƒë·ªô VIP</label>
                <select id="vipLevel" name="vipLevel" class="form-select">
                  <option value="Bronze">Bronze</option>
                  <option value="Silver">Silver</option>
                  <option value="Gold">Gold</option>
                  <option value="Platinum">Platinum</option>
                </select>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label" for="notes">Ghi ch√∫</label>
              <textarea id="notes" name="notes" class="form-control" rows="3" autocomplete="off"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
          <button type="button" class="btn btn-primary" onclick="handleSaveCustomer()">L∆∞u</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Change Type Modal -->
  <div class="modal fade" id="changeTypeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">ƒê·ªïi lo·∫°i kh√°ch h√†ng</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="changeTypeCustomerId" />
          <label class="form-label">Lo·∫°i m·ªõi</label>
          <select id="newCustomerType" class="form-select">
            <option value="Regular">Th∆∞·ªùng</option>
            <option value="VIP">VIP</option>
            <option value="Corporate">Doanh nghi·ªáp</option>
            <option value="Member">Th√†nh vi√™n</option>
          </select>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
          <button type="button" class="btn btn-primary" onclick="confirmChangeType()">C·∫≠p nh·∫≠t</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Points Modal -->
  <div class="modal fade" id="addPointsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">C·ªông ƒëi·ªÉm kh√°ch h√†ng</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="addPointsCustomerId" />
          <div class="mb-3">
            <label class="form-label">S·ªë ƒëi·ªÉm</label>
            <input type="number" id="pointsAmount" class="form-control" min="1" value="1" />
          </div>
          <div class="mb-3">
            <label class="form-label">L√Ω do</label>
            <input type="text" id="pointsReason" class="form-control" />
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
          <button type="button" class="btn btn-primary" onclick="confirmAddPoints()">C·∫≠p nh·∫≠t</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Core JS -->
  <script src="../assets/vendor/libs/jquery/jquery.js"></script>
  <script src="../assets/vendor/libs/popper/popper.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.js"></script>
  <script src="../assets/vendor/js/menu.js"></script>
  <script src="../../js/api.js"></script>
  <script src="../assets/js/main.js"></script>
  
  <!-- DataTables -->
  <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>

  <script>
    function showToast(message, type = 'success') {
      const container = document.getElementById('toastContainer');
      const wrapper = document.createElement('div');
      wrapper.className = `toast align-items-center text-bg-${type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'danger'} border-0`;
      wrapper.setAttribute('role', 'alert');
      wrapper.setAttribute('aria-live', 'assertive');
      wrapper.setAttribute('aria-atomic', 'true');
      wrapper.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>`;
      container.appendChild(wrapper);
      const toast = new bootstrap.Toast(wrapper, { delay: 2500 });
      toast.show();
      wrapper.addEventListener('hidden.bs.toast', () => wrapper.remove());
    }
    // ƒê·∫£m b·∫£o Bootstrap ƒë∆∞·ª£c load tr∆∞·ªõc khi s·ª≠ d·ª•ng
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üîµ DOM loaded, checking Bootstrap...');
      console.log('üîç Bootstrap available:', typeof bootstrap !== 'undefined');
      
      if (typeof bootstrap === 'undefined') {
        console.error('‚ùå Bootstrap not loaded!');
        // Th·ª≠ load l·∫°i Bootstrap
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js';
        script.onload = function() {
          console.log('‚úÖ Bootstrap loaded successfully');
        };
        script.onerror = function() {
          console.error('‚ùå Failed to load Bootstrap');
        };
        document.head.appendChild(script);
      }
    });
    
    // S·ª≠ d·ª•ng API_BASE t·ª´ api.js thay v√¨ khai b√°o l·∫°i
    // const API_BASE = 'http://localhost:5130/api'; // ƒê√£ x√≥a ƒë·ªÉ tr√°nh duplicate
    
    async function apiGet(url) {
      const token = localStorage.getItem('token');
      const headers = { 'Content-Type': 'application/json' };
      if (token) headers['Authorization'] = `Bearer ${token}`;
      return fetch(`${API_BASE}${url}`, { method: 'GET', headers });
    }

    async function apiPost(url, data) {
      const token = localStorage.getItem('token');
      const headers = { 'Content-Type': 'application/json' };
      if (token) headers['Authorization'] = `Bearer ${token}`;
      return fetch(`${API_BASE}${url}`, { method: 'POST', headers, body: JSON.stringify(data) });
    }

    async function apiPut(url, data) {
      const token = localStorage.getItem('token');
      const headers = { 'Content-Type': 'application/json' };
      if (token) headers['Authorization'] = `Bearer ${token}`;
      return fetch(`${API_BASE}${url}`, { method: 'PUT', headers, body: JSON.stringify(data) });
    }

    async function apiDelete(url) {
      const token = localStorage.getItem('token');
      const headers = { 'Content-Type': 'application/json' };
      if (token) headers['Authorization'] = `Bearer ${token}`;
      return fetch(`${API_BASE}${url}`, { method: 'DELETE', headers });
    }

    let customersTable;
    let editingCustomerId = null;


    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ Customers page loaded');
      loadStatistics();
      loadCustomers();
      
      // Debounce search input
      const searchEl = document.getElementById('searchInput');
      let debounceTimer;
      searchEl.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => loadCustomers(), 300);
      });
      
      // Event listeners cho b·ªô l·ªçc
      document.getElementById('filterCustomerType').addEventListener('change', function() {
        loadCustomers();
      });
      
      document.getElementById('filterNationality').addEventListener('change', function() {
        loadCustomers();
      });
    });

    // Load customer statistics
    async function loadStatistics() {
      try {
        const response = await apiGet('/customermanagement/statistics');
        if (response.ok) {
          const stats = await response.json();
          document.getElementById('totalCustomers').textContent = stats.totalCustomers || 0;
          document.getElementById('vipCustomers').textContent = stats.vipCustomers || 0;
          document.getElementById('newCustomers').textContent = stats.newCustomersThisMonth || 0;
          document.getElementById('avgLoyaltyPoints').textContent = Math.round(stats.averageLoyaltyPoints || 0);
        } else {
          console.error('‚ùå Error loading statistics:', response.status);
          document.getElementById('totalCustomers').textContent = '0';
          document.getElementById('vipCustomers').textContent = '0';
          document.getElementById('newCustomers').textContent = '0';
          document.getElementById('avgLoyaltyPoints').textContent = '0';
          showToast('L·ªói t·∫£i th·ªëng k√™ kh√°ch h√†ng', 'danger');
        }
      } catch (error) {
        console.error('‚ùå Error loading statistics:', error);
        document.getElementById('totalCustomers').textContent = '0';
        document.getElementById('vipCustomers').textContent = '0';
        document.getElementById('newCustomers').textContent = '0';
        document.getElementById('avgLoyaltyPoints').textContent = '0';
        showToast('L·ªói t·∫£i th·ªëng k√™ kh√°ch h√†ng', 'danger');
      }
    }

    // Load customers list
    async function loadCustomers() {
      try {
        const customerType = document.getElementById('filterCustomerType').value;
        const nationality = document.getElementById('filterNationality').value;
        const search = document.getElementById('searchInput').value;

        let url = '/customermanagement?';
        const params = new URLSearchParams();
        
        if (customerType) params.append('customerType', customerType);
        if (nationality) params.append('nationality', nationality);
        if (search) params.append('search', search);
        
        url += params.toString();

        const response = await apiGet(url);
        if (response.ok) {
          const customers = await response.json();
          updateCustomersTable(customers);
        } else {
          console.error('‚ùå Error loading customers:', response.status);
          showToast('L·ªói t·∫£i danh s√°ch kh√°ch h√†ng', 'danger');
        }
      } catch (error) {
        console.error('‚ùå Error loading customers:', error);
        showToast('L·ªói t·∫£i danh s√°ch kh√°ch h√†ng', 'danger');
      }
    }

    // Update customers table
    function updateCustomersTable(customers) {
      const tbody = document.querySelector('#customersTable tbody');
      tbody.innerHTML = '';

      customers.forEach(customer => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${customer.customerId}</td>
          <td>${customer.fullName}</td>
          <td>${customer.email}</td>
          <td>${customer.phoneNumber || '-'}</td>
          <td>
            <span class="badge bg-${getCustomerTypeColor(customer.customerType)}">
              ${getCustomerTypeText(customer.customerType)}
            </span>
          </td>
          <td>${customer.nationality || '-'}</td>
          <td>
            <span class="badge bg-${getVipLevelColor(customer.vipLevel)}">
              ${customer.loyaltyPoints || 0} pts
            </span>
          </td>
          <td>${formatDate(customer.createdAt)}</td>
          <td>
            <div class="action-buttons">
              <button class="action-btn action-btn-view" onclick="viewCustomerDetails(${customer.customerId})" title="Xem chi ti·∫øt">
                <i class="bx bx-show"></i>
              </button>
              <button class="action-btn action-btn-edit" onclick="openEditModal(${customer.customerId})" title="Ch·ªânh s·ª≠a">
                <i class="bx bx-edit"></i>
              </button>
              <button class="action-btn action-btn-change" onclick="openChangeTypeModal(${customer.customerId})" title="ƒê·ªïi lo·∫°i kh√°ch">
                <i class="bx bx-transfer-alt"></i>
              </button>
              <button class="action-btn action-btn-delete" onclick="deleteCustomer(${customer.customerId})" title="X√≥a">
                <i class="bx bx-trash"></i>
              </button>
            </div>
          </td>
        `;
        tbody.appendChild(row);
      });

      // Initialize DataTable if not already done
      const dataTableConfig = {
        language: {
          url: '../local-plugins/datatables/i18n/vi.json'
        },
        pageLength: 10,
        order: [[0, 'desc']],
        columnDefs: [
          { targets: [0], visible: true }, // ID column
          { targets: [1], visible: true }, // Name column
          { targets: [2], visible: true }, // Email column
          { targets: [3], visible: true }, // Phone column
          { targets: [4], visible: true }, // Type column
          { targets: [5], visible: true }, // Nationality column
          { targets: [6], visible: true }, // Points column
          { targets: [7], visible: true }, // Created date column
          { targets: [8], visible: true, orderable: false } // Actions column
        ],
        drawCallback: function() {
          // Kh·ªüi t·∫°o l·∫°i dropdown sau khi DataTable render
          if (window.initializeDropdowns) {
            window.initializeDropdowns();
          }
        }
      };

      if (!customersTable) {
        customersTable = $('#customersTable').DataTable(dataTableConfig);
      } else {
        // Destroy and recreate DataTable to avoid column mismatch
        customersTable.destroy();
        customersTable = $('#customersTable').DataTable(dataTableConfig);
      }
      
      // Kh·ªüi t·∫°o dropdown sau khi DataTable ƒë√£ render
      setTimeout(() => {
        if (window.initializeDropdowns) {
          window.initializeDropdowns();
        }
      }, 200);
    }

    // Open create modal - Global function
    window.openCreateModal = function() {
      console.log('üîµ openCreateModal called');
      console.log('üîç Bootstrap available:', typeof bootstrap !== 'undefined');
      
      editingCustomerId = null;
      document.getElementById('modalTitle').textContent = 'Th√™m kh√°ch h√†ng m·ªõi';
      document.getElementById('customerForm').reset();
      document.getElementById('loyaltyPoints').value = 0;
      
      try {
        const modalElement = document.getElementById('customerModal');
        console.log('üîç Modal element found:', !!modalElement);
        
        if (typeof bootstrap !== 'undefined') {
          const modal = new bootstrap.Modal(modalElement);
          console.log('‚úÖ Modal instance created');
          modal.show();
          console.log('‚úÖ Modal show() called');
        } else {
          console.error('‚ùå Bootstrap not available');
        }
      } catch (error) {
        console.error('‚ùå Error opening modal:', error);
      }
    };

    // Open edit modal - Global function
    window.openEditModal = async function(customerId) {
      try {
        const response = await apiGet(`/customermanagement/${customerId}`);
        if (response.ok) {
          const customer = await response.json();
          
          editingCustomerId = customerId;
          document.getElementById('modalTitle').textContent = 'Ch·ªânh s·ª≠a kh√°ch h√†ng';
          
          // Fill form with customer data
          document.getElementById('fullName').value = customer.fullName || '';
          document.getElementById('email').value = customer.email || '';
          document.getElementById('phoneNumber').value = customer.phoneNumber || '';
          document.getElementById('dateOfBirth').value = customer.dateOfBirth ? customer.dateOfBirth.split('T')[0] : '';
          document.getElementById('gender').value = customer.gender || '';
          document.getElementById('nationality').value = customer.nationality || 'Vietnam';
          document.getElementById('customerType').value = customer.customerType || 'Individual';
          document.getElementById('address').value = customer.address || '';
          document.getElementById('idCardNumber').value = customer.idCardNumber || '';
          document.getElementById('passportNumber').value = customer.passportNumber || '';
          document.getElementById('loyaltyPoints').value = customer.loyaltyPoints || 0;
          document.getElementById('vipLevel').value = customer.vipLevel || 'Bronze';
          document.getElementById('notes').value = customer.notes || '';
          
          const modal = new bootstrap.Modal(document.getElementById('customerModal'));
          modal.show();
        }
      } catch (error) {
        console.error('‚ùå Error loading customer:', error);
        alert('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin kh√°ch h√†ng');
      }
    }

    // Handle save customer - Global function
    window.handleSaveCustomer = async function() {
      const formData = {
        fullName: document.getElementById('fullName').value,
        email: document.getElementById('email').value,
        phoneNumber: document.getElementById('phoneNumber').value,
        dateOfBirth: document.getElementById('dateOfBirth').value || null,
        gender: document.getElementById('gender').value || null,
        nationality: document.getElementById('nationality').value,
        customerType: document.getElementById('customerType').value,
        address: document.getElementById('address').value || null,
        idCardNumber: document.getElementById('idCardNumber').value || null,
        passportNumber: document.getElementById('passportNumber').value || null,
        loyaltyPoints: parseInt(document.getElementById('loyaltyPoints').value) || 0,
        vipLevel: document.getElementById('vipLevel').value,
        notes: document.getElementById('notes').value || null
      };

      try {
        let response;
        if (editingCustomerId) {
          // Update existing customer
          response = await apiPut(`/customermanagement/${editingCustomerId}`, formData);
        } else {
          // Create new customer
          response = await apiPost('/customermanagement', formData);
        }

        if (response.ok) {
          const modal = bootstrap.Modal.getInstance(document.getElementById('customerModal'));
          modal.hide();
          loadCustomers();
          loadStatistics();
          showToast(editingCustomerId ? 'C·∫≠p nh·∫≠t kh√°ch h√†ng th√†nh c√¥ng!' : 'T·∫°o kh√°ch h√†ng th√†nh c√¥ng!', 'success');
        } else {
          const error = await response.json();
          showToast('L·ªói: ' + (error.message || 'Kh√¥ng th·ªÉ l∆∞u kh√°ch h√†ng'), 'danger');
        }
      } catch (error) {
        console.error('‚ùå Error saving customer:', error);
        showToast('C√≥ l·ªói x·∫£y ra khi l∆∞u kh√°ch h√†ng', 'danger');
      }
    }

    // View customer details - Global function
    window.viewCustomerDetails = function(customerId) {
      // Chuy·ªÉn sang trang chi ti·∫øt thay v√¨ popup
      window.location.href = `customer-details.html?id=${customerId}`;
    };

    // Delete customer - Global function
    window.deleteCustomer = async function(customerId) {
      if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a kh√°ch h√†ng n√†y?')) {
        return;
      }

      try {
        const response = await apiDelete(`/customermanagement/${customerId}`);
        if (response.ok) {
          loadCustomers();
          loadStatistics();
          showToast('X√≥a kh√°ch h√†ng th√†nh c√¥ng!', 'success');
        } else {
          showToast('Kh√¥ng th·ªÉ x√≥a kh√°ch h√†ng', 'danger');
        }
      } catch (error) {
        console.error('‚ùå Error deleting customer:', error);
        showToast('C√≥ l·ªói x·∫£y ra khi x√≥a kh√°ch h√†ng', 'danger');
      }
    }


    // Helper functions
    function getCustomerTypeColor(type) {
      switch (type) {
        case 'Individual': return 'primary';
        case 'Corporate': return 'success';
        case 'Group': return 'info';
        default: return 'secondary';
      }
    }

    function getCustomerTypeText(type) {
      switch (type) {
        case 'Individual': return 'C√° nh√¢n';
        case 'Corporate': return 'Doanh nghi·ªáp';
        case 'Group': return 'Nh√≥m';
        default: return type;
      }
    }

    function getVipLevelColor(level) {
      switch (level) {
        case 'Bronze': return 'warning';
        case 'Silver': return 'secondary';
        case 'Gold': return 'warning';
        case 'Platinum': return 'info';
        default: return 'secondary';
      }
    }

    function formatDate(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      return date.toLocaleDateString('vi-VN');
    }

    // Change Type flow
    window.openChangeTypeModal = function(customerId) {
      document.getElementById('changeTypeCustomerId').value = customerId;
      new bootstrap.Modal(document.getElementById('changeTypeModal')).show();
    }

    window.confirmChangeType = async function() {
      try {
        const id = document.getElementById('changeTypeCustomerId').value;
        const newType = document.getElementById('newCustomerType').value;
        const response = await apiPost(`/customermanagement/${id}/change-type`, { newType });
        if (!response.ok) {
          const err = await response.json().catch(()=>({}));
          throw new Error(err.message || 'ƒê·ªïi lo·∫°i th·∫•t b·∫°i');
        }
        bootstrap.Modal.getInstance(document.getElementById('changeTypeModal')).hide();
        showToast('ƒê√£ ƒë·ªïi lo·∫°i kh√°ch h√†ng', 'success');
        loadCustomers();
        loadStatistics();
      } catch (e) {
        showToast('L·ªói: ' + e.message, 'danger');
      }
    }

    // Add Points flow
    window.openAddPointsModal = function(customerId) {
      document.getElementById('addPointsCustomerId').value = customerId;
      document.getElementById('pointsAmount').value = 1;
      document.getElementById('pointsReason').value = '';
      new bootstrap.Modal(document.getElementById('addPointsModal')).show();
    }

    window.confirmAddPoints = async function() {
      try {
        const id = document.getElementById('addPointsCustomerId').value;
        const points = parseInt(document.getElementById('pointsAmount').value) || 0;
        const reason = document.getElementById('pointsReason').value || null;
        if (points <= 0) { showToast('ƒêi·ªÉm ph·∫£i > 0', 'warning'); return; }
        const response = await apiPost(`/customermanagement/${id}/add-points`, { points, reason });
        if (!response.ok) {
          const err = await response.json().catch(()=>({}));
          throw new Error(err.message || 'C·ªông ƒëi·ªÉm th·∫•t b·∫°i');
        }
        bootstrap.Modal.getInstance(document.getElementById('addPointsModal')).hide();
        showToast('ƒê√£ c·ªông ƒëi·ªÉm', 'success');
        loadCustomers();
        loadStatistics();
      } catch (e) { showToast('L·ªói: ' + e.message, 'danger'); }
    }
  </script>
</body>
</html>
