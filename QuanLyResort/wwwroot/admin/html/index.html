<!DOCTYPE html>
<html lang="vi" class="light-style layout-menu-fixed" dir="ltr" data-theme="theme-default" data-assets-path="../assets/" data-template="vertical-menu-template-free">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
  
  <!-- NO CACHE - Always fetch fresh -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  
  <title>Dashboard - H·ªá Th·ªëng Qu·∫£n L√Ω Resort</title>
  
  <meta name="description" content="Admin Dashboard" />
  
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="../assets/img/favicon/favicon.ico" />
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&display=swap" rel="stylesheet" />
  
  <!-- Icons -->
  <link rel="stylesheet" href="../assets/vendor/fonts/boxicons.css" />
  
  <!-- Core CSS -->
  <link rel="stylesheet" href="../assets/vendor/css/core.css" class="template-customizer-core-css" />
  <link rel="stylesheet" href="../assets/vendor/css/theme-default.css" class="template-customizer-theme-css" />
  <link rel="stylesheet" href="../assets/css/demo.css" />
  <link rel="stylesheet" href="../assets/css/fix-scrollbar.css" />
  <link rel="stylesheet" href="../assets/css/admin-custom-theme.css" />
  
  <!-- Vendors CSS -->
  <link rel="stylesheet" href="../assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.css" />
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Page CSS -->
  <style>
    /* Modern Stats Cards - Inspired by Nalika Template */
    .stats-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 20px;
      padding: 2rem;
      color: white;
      margin-bottom: 1.5rem;
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      position: relative;
      overflow: hidden;
      border: none;
    }
    
    .stats-card::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      transition: all 0.5s ease;
    }
    
    .stats-card:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 12px 35px rgba(102, 126, 234, 0.4);
    }
    
    .stats-card:hover::before {
      transform: rotate(45deg);
    }
    
    .stats-card .card-title {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      text-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    
    .stats-card small {
      font-size: 0.95rem;
      opacity: 0.95;
      font-weight: 500;
      letter-spacing: 0.5px;
    }
    
    .stats-card .avatar {
      width: 70px;
      height: 70px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.3);
    }
    
    .stats-card .avatar i {
      font-size: 2.5rem;
    }
    
    .stats-card.success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
    }
    
    .stats-card.success:hover {
      box-shadow: 0 12px 35px rgba(16, 185, 129, 0.4);
    }
    
    .stats-card.warning {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);
    }
    
    .stats-card.warning:hover {
      box-shadow: 0 12px 35px rgba(245, 158, 11, 0.4);
    }
    
    .stats-card.danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
    }
    
    .stats-card.danger:hover {
      box-shadow: 0 12px 35px rgba(239, 68, 68, 0.4);
    }
    
    .stats-card.info {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
    }
    
    .stats-card.info:hover {
      box-shadow: 0 12px 35px rgba(59, 130, 246, 0.4);
    }
    
    /* Percentage indicator */
    .stats-card .percentage {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: rgba(255, 255, 255, 0.25);
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      backdrop-filter: blur(10px);
    }
    
    /* Modern Chart Container */
    .chart-container {
      background: rgba(255, 255, 255, 0.98);
      border-radius: 20px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      height: 400px;
      position: relative;
      border: 1px solid rgba(200, 169, 126, 0.15);
      transition: all 0.3s ease;
    }
    
    .chart-container:hover {
      box-shadow: 0 8px 30px rgba(0,0,0,0.12);
      transform: translateY(-2px);
    }
    
    .chart-container h6 {
      font-size: 1.1rem;
      font-weight: 600;
      color: #374151;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid #f3f4f6;
    }
    
    .chart-container canvas {
      max-height: 350px !important;
    }
    
    /* Modern Activity Item */
    .activity-item {
      border-left: 4px solid #667eea;
      background: linear-gradient(90deg, rgba(102, 126, 234, 0.05) 0%, rgba(255, 255, 255, 0.95) 100%);
      padding: 1.25rem;
      margin-bottom: 1rem;
      border-radius: 0 12px 12px 0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .activity-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s ease;
    }
    
    .activity-item:hover {
      background: linear-gradient(90deg, rgba(102, 126, 234, 0.1) 0%, rgba(255, 255, 255, 1) 100%);
      transform: translateX(8px);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.15);
    }
    
    .activity-item:hover::before {
      width: 6px;
    }
    
    /* Modern Customer Item */
    .customer-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.25rem;
      border: 1px solid rgba(200, 169, 126, 0.2);
      border-radius: 12px;
      margin-bottom: 1rem;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(250, 248, 245, 0.95) 100%);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .customer-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }
    
    .customer-item:hover {
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      transform: translateY(-4px);
      border-color: rgba(102, 126, 234, 0.4);
    }
    
    .customer-item:hover::before {
      transform: scaleX(1);
    }
    
    /* Growth Indicators */
    .growth-positive {
      color: #10b981;
      font-weight: 700;
      font-size: 2.5rem;
    }
    
    .growth-negative {
      color: #ef4444;
      font-weight: 700;
      font-size: 2.5rem;
    }
    
    /* Modern Refresh Button */
    .refresh-btn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      z-index: 1000;
      border-radius: 50%;
      width: 65px;
      height: 65px;
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      color: white;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .refresh-btn:hover {
      transform: scale(1.1) rotate(180deg);
      box-shadow: 0 12px 35px rgba(102, 126, 234, 0.5);
    }
    
    /* Modern Card Styles */
    .card {
      border-radius: 20px;
      border: 1px solid rgba(200, 169, 126, 0.15);
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      transition: all 0.3s ease;
      overflow: hidden;
    }
    
    .card:hover {
      box-shadow: 0 8px 30px rgba(0,0,0,0.12);
      transform: translateY(-2px);
    }
    
    .card-header {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(250, 248, 245, 0.95) 100%);
      border-bottom: 2px solid rgba(200, 169, 126, 0.2);
      padding: 1.5rem;
      font-weight: 600;
      font-size: 1.1rem;
    }
    
    .card-body {
      padding: 1.5rem;
    }
    
    /* Better Typography */
    h4, h5, h6 {
      font-weight: 600;
      color: #1f2937;
    }
    
    /* Modern Section Headers */
    .section-header {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 1.5rem;
      padding-bottom: 0.75rem;
      border-bottom: 3px solid #667eea;
      display: inline-block;
    }
    
    /* Order Statistics - Nalika Style */
    .stat-box {
      padding: 1.5rem;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(250, 248, 245, 0.95) 100%);
      border-radius: 15px;
      text-align: center;
      transition: all 0.3s ease;
      border: 1px solid rgba(200, 169, 126, 0.15);
    }
    
    .stat-box:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    
    .stat-icon {
      width: 60px;
      height: 60px;
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1rem;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    .stat-icon i {
      font-size: 1.8rem;
    }
    
    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 0.5rem;
    }
    
    .stat-label {
      color: #6b7280;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }
    
    .stat-percentage {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      background: rgba(16, 185, 129, 0.1);
      color: #10b981;
    }
    
    .progress-container {
      padding: 1rem;
      background: rgba(243, 244, 246, 0.5);
      border-radius: 12px;
    }
    
    .progress-item {
      margin-bottom: 0.5rem;
    }
    
    .progress {
      border-radius: 10px;
      overflow: hidden;
    }
    
    .progress-bar {
      transition: width 1s ease;
    }
    
    /* Growth Items */
    .growth-item {
      padding: 1rem;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(250, 248, 245, 0.95) 100%);
      border-radius: 12px;
      border-left: 4px solid #667eea;
      transition: all 0.3s ease;
    }
    
    .growth-item:hover {
      transform: translateX(5px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    }
    
    .growth-label {
      font-weight: 600;
      color: #374151;
    }
    
    .growth-value {
      font-size: 1.5rem;
      font-weight: 700;
    }
    
    /* Quick Stats */
    .quick-stat {
      padding: 1rem;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(250, 248, 245, 0.95) 100%);
      border-radius: 10px;
      border-left: 3px solid #667eea;
      transition: all 0.3s ease;
    }
    
    .quick-stat:hover {
      transform: translateX(5px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    }
    
    .quick-stat i {
      font-size: 1.2rem;
    }
    
    /* Activities Count */
    #activitiesCount {
      font-size: 0.85rem;
      font-weight: 500;
    }
    
    /* Chart Controls */
    .chart-controls {
      display: flex;
      gap: 0.5rem;
    }
  </style>
  
  <!-- Helpers -->
  <script src="../assets/vendor/js/helpers.js"></script>
  <script src="../assets/js/config.js"></script>
</head>

<body>
  <!-- Layout wrapper -->
  <div class="layout-wrapper layout-content-navbar">
    <div class="layout-container">
      <!-- Menu - Load from common component -->
      <div id="common-menu"></div>
      <!-- standardized menu loader -->
      <script src="../js/load-menu.js"></script>
      <script>
        // Define setupLogoutButton and dashboardLogout before menu loads
        function dashboardLogout() {
          console.log('üö™ Logging out from dashboard...');
          
          // Clear all tokens
          localStorage.removeItem('adminToken');
          localStorage.removeItem('token');
          localStorage.removeItem('authToken');
          
          // Clear user data
          localStorage.removeItem('user');
          localStorage.removeItem('userRole');
          
          console.log('‚úÖ Tokens and user data cleared');
          
          // Redirect to login
          window.location.href = 'login.html';
        }

        function setupLogoutButton() {
          const logoutBtn = document.getElementById('logoutBtn');
          
          if (logoutBtn) {
            console.log('‚úÖ Dashboard logout button found and configured');
            
            // Remove any existing listeners first
            const newBtn = logoutBtn.cloneNode(true);
            logoutBtn.parentNode.replaceChild(newBtn, logoutBtn);
            
            // Add click listener
            newBtn.addEventListener('click', function(e) {
              e.preventDefault();
              e.stopPropagation();
              dashboardLogout();
            });
            
            return true;
          } else {
            console.log('‚ùå Dashboard logout button not found');
            return false;
          }
        }

        document.addEventListener('DOMContentLoaded', function() {
          // load menu; helper will try sensible relative paths
          window.loadCommonMenu('common-menu').then(() => {
            console.log('üîÑ Menu loaded, setting up logout button...');
            
            // Try multiple times to ensure button is found
            let attempts = 0;
            const maxAttempts = 5;
            
            function trySetupLogout() {
              attempts++;
              console.log(`üîÑ Logout setup attempt ${attempts}/${maxAttempts}`);
              
              if (setupLogoutButton()) {
                console.log('‚úÖ Logout button setup successful!');
                return;
              }
              
              if (attempts < maxAttempts) {
                setTimeout(trySetupLogout, 200);
              } else {
                console.error('‚ùå Failed to setup logout button after', maxAttempts, 'attempts');
                // Try to find any logout button and setup manually
                const anyLogoutBtn = document.querySelector('[id*="logout"], [onclick*="logout"], .dropdown-item[href*="logout"]');
                if (anyLogoutBtn) {
                  console.log('üîß Found alternative logout button, setting up manually');
                  anyLogoutBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    dashboardLogout();
                  });
                }
              }
            }
            
            trySetupLogout();
          }).catch(error => {
            console.error('‚ùå Menu loading failed:', error);
          });
        });
      </script>
      <!-- / Menu -->

      <!-- Layout container -->
      <div class="layout-page">
        <!-- Navbar -->
        <nav class="layout-navbar container-xxl navbar navbar-expand-xl navbar-detached align-items-center bg-navbar-theme" id="layout-navbar">
          <div class="layout-menu-toggle navbar-nav align-items-xl-center me-3 me-xl-0 d-xl-none">
            <a class="nav-item nav-link px-0 me-xl-4" href="javascript:void(0)">
              <i class="bx bx-menu bx-sm"></i>
            </a>
          </div>

          <div class="navbar-nav-right d-flex align-items-center" id="navbar-collapse">
            <!-- Search -->
            <div class="navbar-nav align-items-center">
              <div class="nav-item d-flex align-items-center">
                <h4 class="mb-0">Dashboard</h4>
              </div>
            </div>
            <!-- /Search -->

            <ul class="navbar-nav flex-row align-items-center ms-auto">
              <!-- User -->
              <li class="nav-item navbar-dropdown dropdown-user dropdown">
                <a class="nav-link dropdown-toggle hide-arrow" href="javascript:void(0);" data-bs-toggle="dropdown">
                  <div class="avatar avatar-online">
                    <img src="../assets/img/avatars/1.png" alt class="w-px-40 h-auto rounded-circle" />
                  </div>
                </a>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li>
                    <a class="dropdown-item" href="#">
                      <div class="d-flex">
                        <div class="flex-shrink-0 me-3">
                          <div class="avatar avatar-online">
                            <img src="../assets/img/avatars/1.png" alt class="w-px-40 h-auto rounded-circle" />
                          </div>
                        </div>
                        <div class="flex-grow-1">
                          <span class="fw-semibold d-block" id="userDisplayName">Admin</span>
                          <small class="text-muted" id="userRole">Qu·∫£n tr·ªã vi√™n</small>
                        </div>
                      </div>
                    </a>
                  </li>
                  <li>
                    <div class="dropdown-divider"></div>
                  </li>
                  <li>
                    <a class="dropdown-item" href="#">
                      <i class="bx bx-user me-2"></i>
                      <span class="align-middle">H·ªì s∆° c·ªßa t√¥i</span>
                    </a>
                  </li>
                  <li>
                    <a class="dropdown-item" href="#">
                      <i class="bx bx-cog me-2"></i>
                      <span class="align-middle">C√†i ƒë·∫∑t</span>
                    </a>
                  </li>
                  <li>
                    <div class="dropdown-divider"></div>
                  </li>
                  <li>
                    <a class="dropdown-item" href="javascript:void(0);" id="logoutBtn" onclick="commonLogout(); return false;" style="pointer-events: auto !important; cursor: pointer !important; z-index: 10003 !important; position: relative;">
                      <i class="bx bx-power-off me-2"></i>
                      <span class="align-middle">ƒêƒÉng xu·∫•t</span>
                    </a>
                  </li>
                </ul>
              </li>
              <!--/ User -->
            </ul>
          </div>
        </nav>
        <!-- / Navbar -->

        <!-- Content wrapper -->
        <div class="content-wrapper">
          <!-- Content -->
          <div class="container-xxl flex-grow-1 container-p-y" style="padding-bottom: 3rem;">
            <h4 class="fw-bold py-3 mb-4">
              <span class="text-muted fw-light">Resort /</span> Dashboard
            </h4>

            <!-- Stats Cards Row -->
            <div class="row mb-4">
              <div class="col-lg-3 col-md-6 col-12 mb-4">
                <a href="bookings.html" style="text-decoration: none; color: inherit;">
                  <div class="stats-card" style="cursor: pointer;">
                    <div class="percentage" id="bookingPercentage">+0%</div>
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        <h3 class="card-title mb-2" id="todayBookings">0</h3>
                        <small class="text-white">ƒê·∫∑t ph√≤ng h√¥m nay</small>
                      </div>
                      <div class="avatar flex-shrink-0">
                        <i class="bx bx-calendar text-white" style="font-size: 2.5rem;"></i>
                      </div>
                    </div>
                  </div>
                </a>
              </div>
              <div class="col-lg-3 col-md-6 col-12 mb-4">
                <a href="reports.html" style="text-decoration: none; color: inherit;">
                  <div class="stats-card success" style="cursor: pointer;">
                    <div class="percentage" id="revenuePercentage">+0%</div>
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        <h3 class="card-title mb-2" id="todayRevenue">0‚Ç´</h3>
                        <small class="text-white">Doanh thu h√¥m nay</small>
                      </div>
                      <div class="avatar flex-shrink-0">
                        <i class="bx bx-dollar text-white" style="font-size: 2.5rem;"></i>
                      </div>
                    </div>
                  </div>
                </a>
              </div>
              <div class="col-lg-3 col-md-6 col-12 mb-4">
                <a href="rooms.html" style="text-decoration: none; color: inherit;">
                  <div class="stats-card warning" style="cursor: pointer;">
                    <div class="percentage" id="occupancyPercentage">0%</div>
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        <h3 class="card-title mb-2" id="occupancyRate">0%</h3>
                        <small class="text-white">T·ª∑ l·ªá l·∫•p ƒë·∫ßy</small>
                      </div>
                      <div class="avatar flex-shrink-0">
                        <i class="bx bx-home text-white" style="font-size: 2.5rem;"></i>
                      </div>
                    </div>
                  </div>
                </a>
              </div>
              <div class="col-lg-3 col-md-6 col-12 mb-4">
                <a href="bookings.html?filter=checkin" style="text-decoration: none; color: inherit;">
                  <div class="stats-card info" style="cursor: pointer;">
                    <div class="percentage" id="checkinPercentage">+0%</div>
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        <h3 class="card-title mb-2" id="todayCheckIns">0</h3>
                        <small class="text-white">Check-in h√¥m nay</small>
                      </div>
                      <div class="avatar flex-shrink-0">
                        <i class="bx bx-log-in text-white" style="font-size: 2.5rem;"></i>
                      </div>
                    </div>
                  </div>
                </a>
              </div>
            </div>

            <!-- Order Statistics - Nalika Style -->
            <div class="row mb-4">
              <div class="col-lg-8 mb-4">
                <div class="card">
                  <div class="card-header">
                    <h5 class="mb-0">üìä Th·ªëng k√™ ƒë·∫∑t ph√≤ng</h5>
                  </div>
                  <div class="card-body">
                    <div class="row text-center">
                      <div class="col-md-3 mb-3">
                        <div class="stat-box">
                          <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <i class="bx bx-calendar-check text-white"></i>
                          </div>
                          <h3 class="stat-value" id="totalBookings">0</h3>
                          <p class="stat-label">T·ªïng ƒë·∫∑t ph√≤ng</p>
                          <span class="stat-percentage" id="totalBookingsPct">+0%</span>
                        </div>
                      </div>
                      <div class="col-md-3 mb-3">
                        <div class="stat-box">
                          <div class="stat-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                            <i class="bx bx-check-circle text-white"></i>
                          </div>
                          <h3 class="stat-value" id="confirmedBookings">0</h3>
                          <p class="stat-label">ƒê√£ x√°c nh·∫≠n</p>
                          <span class="stat-percentage text-success" id="confirmedPct">0%</span>
                        </div>
                      </div>
                      <div class="col-md-3 mb-3">
                        <div class="stat-box">
                          <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                            <i class="bx bx-time text-white"></i>
                          </div>
                          <h3 class="stat-value" id="pendingBookings">0</h3>
                          <p class="stat-label">ƒêang ch·ªù</p>
                          <span class="stat-percentage text-warning" id="pendingPct">0%</span>
                        </div>
                      </div>
                      <div class="col-md-3 mb-3">
                        <div class="stat-box">
                          <div class="stat-icon" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                            <i class="bx bx-x-circle text-white"></i>
                          </div>
                          <h3 class="stat-value" id="cancelledBookings">0</h3>
                          <p class="stat-label">ƒê√£ h·ªßy</p>
                          <span class="stat-percentage text-danger" id="cancelledPct">0%</span>
                        </div>
                      </div>
                    </div>
                    <!-- Percentage Distribution -->
                    <div class="mt-4">
                      <h6 class="mb-3">Ph√¢n b·ªï t·ª∑ l·ªá</h6>
                      <div class="progress-container">
                        <div class="progress-item">
                          <div class="d-flex justify-content-between mb-1">
                            <span>ƒê√£ x√°c nh·∫≠n</span>
                            <span id="confirmedPercent">0%</span>
                          </div>
                          <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-success" id="confirmedProgress" style="width: 0%"></div>
                          </div>
                        </div>
                        <div class="progress-item mt-3">
                          <div class="d-flex justify-content-between mb-1">
                            <span>ƒêang ch·ªù</span>
                            <span id="pendingPercent">0%</span>
                          </div>
                          <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-warning" id="pendingProgress" style="width: 0%"></div>
                          </div>
                        </div>
                        <div class="progress-item mt-3">
                          <div class="d-flex justify-content-between mb-1">
                            <span>ƒê√£ h·ªßy</span>
                            <span id="cancelledPercent">0%</span>
                          </div>
                          <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-danger" id="cancelledProgress" style="width: 0%"></div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-lg-4 mb-4">
                <div class="card h-100">
                  <div class="card-header">
                    <h5 class="mb-0">üìà TƒÉng tr∆∞·ªüng</h5>
                  </div>
                  <div class="card-body">
                    <div class="growth-item mb-4">
                      <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="growth-label">Doanh thu</span>
                        <span id="revenueGrowth" class="growth-value growth-positive">+0%</span>
                      </div>
                      <small class="text-muted">So v·ªõi th√°ng tr∆∞·ªõc</small>
                    </div>
                    <div class="growth-item mb-4">
                      <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="growth-label">ƒê·∫∑t ph√≤ng</span>
                        <span id="bookingGrowth" class="growth-value growth-positive">+0%</span>
                      </div>
                      <small class="text-muted">So v·ªõi th√°ng tr∆∞·ªõc</small>
                    </div>
                    <div class="growth-item">
                      <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="growth-label">Kh√°ch h√†ng</span>
                        <span id="customerGrowth" class="growth-value growth-positive">+0%</span>
                      </div>
                      <small class="text-muted">So v·ªõi th√°ng tr∆∞·ªõc</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Charts Row -->
            <div class="row">
              <div class="col-lg-8 mb-4">
                <div class="chart-container">
                  <h5 class="mb-3">üìà Xu h∆∞·ªõng doanh thu (30 ng√†y)</h5>
                  <canvas id="revenueChart"></canvas>
                </div>
              </div>
              <div class="col-lg-4 mb-4">
                <div class="chart-container">
                  <h5 class="mb-3">üè† T·ª∑ l·ªá l·∫•p ƒë·∫ßy</h5>
                  <canvas id="occupancyChart"></canvas>
                </div>
              </div>
            </div>

            <!-- Second Charts Row -->
            <div class="row">
              <div class="col-lg-6 mb-4">
                <div class="chart-container">
                  <h5 class="mb-3">üí∞ Doanh thu d·ªãch v·ª•</h5>
                  <canvas id="serviceChart"></canvas>
                </div>
              </div>
              <div class="col-lg-6 mb-4">
                <div class="card h-100">
                  <div class="card-header d-flex justify-content-between">
                    <h5 class="mb-0">üèÜ Top kh√°ch h√†ng th√°ng n√†y</h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="loadTopCustomers()">
                      <i class="bx bx-refresh"></i>
                    </button>
                  </div>
                  <div class="card-body" style="max-height: 350px; overflow-y: auto;">
                    <div id="topCustomersContainer">
                      <!-- Top customers will be loaded here -->
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Activities Feed - Nalika Style -->
            <div class="row">
              <div class="col-lg-8 mb-4">
                <div class="card">
                  <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                      <h5 class="mb-0">üîî Ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y</h5>
                      <small class="text-muted" id="activitiesCount">B·∫°n c√≥ 0 ho·∫°t ƒë·ªông m·ªõi</small>
                    </div>
                    <button class="btn btn-sm btn-outline-primary" onclick="loadRecentActivities()">
                      <i class="bx bx-refresh"></i>
                    </button>
                  </div>
                  <div class="card-body" style="max-height: 500px; overflow-y: auto; min-height: 200px;">
                    <div id="activitiesContainer">
                      <!-- Recent activities will be loaded here -->
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-lg-4 mb-4">
                <div class="card h-100">
                  <div class="card-header">
                    <h5 class="mb-0">üìä T·ªïng quan nhanh</h5>
                  </div>
                  <div class="card-body">
                    <div class="quick-stat mb-3">
                      <div class="d-flex justify-content-between align-items-center">
                        <div>
                          <i class="bx bx-user text-primary me-2"></i>
                          <span>T·ªïng kh√°ch h√†ng</span>
                        </div>
                        <strong id="totalCustomers">0</strong>
                      </div>
                    </div>
                    <div class="quick-stat mb-3">
                      <div class="d-flex justify-content-between align-items-center">
                        <div>
                          <i class="bx bx-home text-success me-2"></i>
                          <span>Ph√≤ng s·∫µn s√†ng</span>
                        </div>
                        <strong id="availableRooms">0</strong>
                      </div>
                    </div>
                    <div class="quick-stat mb-3">
                      <div class="d-flex justify-content-between align-items-center">
                        <div>
                          <i class="bx bx-food-menu text-warning me-2"></i>
                          <span>D·ªãch v·ª• ƒëang d√πng</span>
                        </div>
                        <strong id="activeServices">0</strong>
                      </div>
                    </div>
                    <div class="quick-stat">
                      <div class="d-flex justify-content-between align-items-center">
                        <div>
                          <i class="bx bx-receipt text-info me-2"></i>
                          <span>H√≥a ƒë∆°n th√°ng n√†y</span>
                        </div>
                        <strong id="monthlyInvoices">0</strong>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- / Content -->

          <!-- Floating Refresh Button -->
          <button class="btn btn-primary refresh-btn" onclick="refreshAllData()" title="L√†m m·ªõi d·ªØ li·ªáu">
            <i class="bx bx-refresh" style="font-size: 1.5rem;"></i>
          </button>

          <!-- Footer -->
          <footer class="content-footer footer bg-footer-theme">
            <div class="container-xxl d-flex flex-wrap justify-content-between py-2 flex-md-row flex-column">
              <div class="mb-2 mb-md-0">
                ¬© 2025 Resort Management System
              </div>
            </div>
          </footer>
          <!-- / Footer -->

          <div class="content-backdrop fade"></div>
        </div>
        <!-- Content wrapper -->
      </div>
      <!-- / Layout page -->
    </div>

    <!-- Overlay -->
    <div class="layout-overlay layout-menu-toggle"></div>
  </div>
  <!-- / Layout wrapper -->

  <!-- Core JS -->
  <script src="../assets/vendor/libs/jquery/jquery.js"></script>
  <!-- Use bootstrap bundle (includes Popper) to ensure dropdowns/tooltips initialize reliably -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.js"></script>
  <script src="../assets/vendor/js/menu.js"></script>
  
  <!-- Fix Overlay Blocking -->
  <script src="../js/fix-overlay-blocking.js"></script>
  
  <!-- Main JS -->
  <script src="../assets/js/main.js"></script>

  <!-- API Helper -->
  <script src="../js/api.js"></script>

  <!-- Common Navbar -->
  <script src="../js/common-navbar.js"></script>
  <script>
    // Ensure any .dropdown-toggle elements are initialized with Bootstrap's Dropdown
    // This is defensive: if bootstrap isn't present immediately, poll briefly.
    (function() {
      function initDropdowns() {
        if (window.bootstrap && typeof bootstrap.Dropdown === 'function') {
          Array.from(document.querySelectorAll('.dropdown-toggle')).forEach(function(el){
            try { new bootstrap.Dropdown(el); } catch (e) { console.warn('dropdown init error', e); }
          });
          return true;
        }
        return false;
      }

      document.addEventListener('DOMContentLoaded', function() {
        if (!initDropdowns()) {
          var waited = 0;
          var iv = setInterval(function() {
            waited += 100;
            if (initDropdowns() || waited > 3000) clearInterval(iv);
          }, 100);
        }
      });
    })();
  </script>
  <script>
    const API_BASE = `${window.location.origin}/api/dashboard`;
    
    // Ensure stats cards are clickable
    document.addEventListener('DOMContentLoaded', function() {
      // Add click handlers to stats cards if not already wrapped in <a>
      const statsCards = document.querySelectorAll('.stats-card');
      statsCards.forEach(card => {
        if (!card.closest('a')) {
          card.style.cursor = 'pointer';
        }
      });
    });
    let revenueChart, occupancyChart, serviceChart;
    let refreshInterval;

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üîµ Dashboard loaded');
      
      // Wait a bit for DOM to be fully ready
      setTimeout(() => {
        console.log('üöÄ Starting dashboard initialization...');
        
        // Try to load real data first
        refreshAllData();
        
        // Create charts with delay - ƒë·∫£m b·∫£o Chart.js ƒë√£ load
        setTimeout(() => {
          console.log('üìä Creating charts...');
          console.log('üîç Chart.js available:', typeof Chart !== 'undefined');
          
          if (typeof Chart === 'undefined') {
            console.error('‚ùå Chart.js not loaded yet, retrying...');
            let retryCount = 0;
            const maxRetries = 10;
            const checkChart = setInterval(() => {
              retryCount++;
              if (typeof Chart !== 'undefined') {
                console.log('‚úÖ Chart.js loaded, creating charts...');
                clearInterval(checkChart);
                loadRevenueTrends();
                loadOccupancyTrends();
                loadServiceRevenue();
              } else if (retryCount >= maxRetries) {
                console.error('‚ùå Chart.js failed to load after', maxRetries, 'retries');
                clearInterval(checkChart);
              }
            }, 200);
          } else {
            // Chart.js ƒë√£ s·∫µn s√†ng, load data ngay
            loadRevenueTrends();
            loadOccupancyTrends();
            loadServiceRevenue();
          }
        }, 300);
        
        // Start auto refresh
        startAutoRefresh();
      }, 100);
    });

    // Load dashboard statistics
    async function loadDashboardStats() {
      // Try both token and adminToken for compatibility
      const token = localStorage.getItem('token') || localStorage.getItem('adminToken');
      console.log('üìä Loading dashboard stats with token:', !!token);

      if (!token) {
        console.warn('‚ö†Ô∏è No token found, showing zero values');
        updateStatsCards({
          today: { bookings: 0, revenue: 0, checkIns: 0, checkOuts: 0 },
          occupancy: { rate: 0, occupied: 0, total: 0, available: 0 },
          growth: { revenue: 0, bookings: 0 }
        });
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/stats`, {
          headers: { 
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        console.log('üì° Dashboard API response status:', response.status);

        if (response.ok) {
          const data = await response.json();
          console.log('‚úÖ Dashboard data loaded:', data);
          updateStatsCards(data);
        } else {
          const errorText = await response.text();
          console.error('‚ùå Dashboard API error:', response.status, errorText);
          console.log('üìä Showing zero values instead of sample data');
          updateStatsCards({
            today: { bookings: 0, revenue: 0, checkIns: 0, checkOuts: 0 },
            occupancy: { rate: 0, occupied: 0, total: 0, available: 0 },
            growth: { revenue: 0, bookings: 0 }
          });
        }
      } catch (error) {
        console.error('‚ùå Error loading dashboard stats:', error);
        updateStatsCards({
          today: { bookings: 0, revenue: 0, checkIns: 0, checkOuts: 0 },
          occupancy: { rate: 0, occupied: 0, total: 0, available: 0 },
          growth: { revenue: 0, bookings: 0 }
        });
      }
    }

    function updateStatsCards(data) {
      const formatCurrencyFn = window.formatCurrency || formatCurrency;
      document.getElementById('todayBookings').textContent = data.today.bookings;
      document.getElementById('todayRevenue').textContent = formatCurrencyFn(data.today.revenue);
      document.getElementById('occupancyRate').textContent = data.occupancy.rate + '%';
      document.getElementById('todayCheckIns').textContent = data.today.checkIns;
      
      // Update percentage indicators on stats cards
      const bookingPercentage = document.getElementById('bookingPercentage');
      const revenuePercentage = document.getElementById('revenuePercentage');
      const occupancyPercentage = document.getElementById('occupancyPercentage');
      const checkinPercentage = document.getElementById('checkinPercentage');
      
      if (bookingPercentage) {
        const bookingGrowth = data.growth.bookings || 0;
        bookingPercentage.textContent = (bookingGrowth >= 0 ? '+' : '') + bookingGrowth + '%';
      }
      
      if (revenuePercentage) {
        const revenueGrowth = data.growth.revenue || 0;
        revenuePercentage.textContent = (revenueGrowth >= 0 ? '+' : '') + revenueGrowth + '%';
      }
      
      if (occupancyPercentage) {
        occupancyPercentage.textContent = data.occupancy.rate + '%';
      }
      
      if (checkinPercentage) {
        // Calculate check-in growth (simplified - can be improved with actual data)
        const checkinGrowth = data.growth.checkIns || 0;
        checkinPercentage.textContent = (checkinGrowth >= 0 ? '+' : '') + checkinGrowth + '%';
      }
      
      // Update growth indicators
      const revenueGrowthEl = document.getElementById('revenueGrowth');
      const bookingGrowthEl = document.getElementById('bookingGrowth');
      
      revenueGrowthEl.textContent = (data.growth.revenue >= 0 ? '+' : '') + data.growth.revenue + '%';
      revenueGrowthEl.className = data.growth.revenue >= 0 ? 'growth-positive' : 'growth-negative';
      
      bookingGrowthEl.textContent = (data.growth.bookings >= 0 ? '+' : '') + data.growth.bookings + '%';
      bookingGrowthEl.className = data.growth.bookings >= 0 ? 'growth-positive' : 'growth-negative';
    }

    async function loadRevenueTrends() {
      try {
        const token = localStorage.getItem('token') || localStorage.getItem('adminToken');
        if (!token) {
          console.warn('‚ö†Ô∏è No token for revenue trends, showing empty chart');
          createRevenueChart([]);
          return;
        }
        
        const response = await fetch(`${API_BASE}/revenue-trends?days=30`, {
          headers: { 
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        console.log('üì° Revenue trends API response status:', response.status);

        if (response.ok) {
          const data = await response.json();
          console.log('‚úÖ Revenue trends data loaded:', data);
          createRevenueChart(data || []);
        } else {
          const errorText = await response.text();
          console.error('‚ùå Revenue trends API error:', response.status, errorText);
          console.log('üìä Showing empty chart instead of sample data');
          createRevenueChart([]);
        }
      } catch (error) {
        console.error('‚ùå Error loading revenue trends:', error);
        createRevenueChart([]);
      }
    }

    function createRevenueChart(data) {
      console.log('üìä Creating revenue chart with data:', data);
      
      const canvas = document.getElementById('revenueChart');
      if (!canvas) {
        console.error('‚ùå Revenue chart canvas not found!');
        return;
      }
      
      const ctx = canvas.getContext('2d');
      console.log('üñºÔ∏è Canvas context:', ctx);
      
      if (revenueChart) {
        console.log('üóëÔ∏è Destroying existing revenue chart');
        revenueChart.destroy();
      }

      // Hi·ªÉn th·ªã chart ngay c·∫£ khi kh√¥ng c√≥ d·ªØ li·ªáu
      if (!data || data.length === 0) {
        console.warn('‚ö†Ô∏è No revenue data to display, showing empty chart');
        // T·∫°o chart v·ªõi d·ªØ li·ªáu m·∫∑c ƒë·ªãnh (30 ng√†y v·ªõi gi√° tr·ªã 0)
        const defaultLabels = [];
        const defaultData = [];
        const today = new Date();
        for (let i = 29; i >= 0; i--) {
          const date = new Date(today);
          date.setDate(date.getDate() - i);
          defaultLabels.push(date.toLocaleDateString('vi-VN'));
          defaultData.push(0);
        }
        
        revenueChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: defaultLabels,
            datasets: [{
              label: 'Doanh thu (‚Ç´)',
              data: defaultData,
              borderColor: '#667eea',
              backgroundColor: 'rgba(102, 126, 234, 0.1)',
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const fmt = window.formatCurrency || formatCurrency;
                    return 'Doanh thu: ' + fmt(context.parsed.y);
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    const fmt = window.formatCurrency || formatCurrency;
                    return fmt(value);
                  }
                }
              }
            }
          }
        });
        return;
      }

      console.log('üèóÔ∏è Building revenue chart...');
      revenueChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.map(d => new Date(d.date).toLocaleDateString('vi-VN')),
          datasets: [{
            label: 'Doanh thu (‚Ç´)',
            data: data.map(d => d.revenue),
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  const fmt = window.formatCurrency || formatCurrency;
                  return 'Doanh thu: ' + fmt(context.parsed.y);
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  const fmt = window.formatCurrency || formatCurrency;
                  return fmt(value);
                }
              }
            }
          }
        }
      });
      
      console.log('‚úÖ Revenue chart created successfully');
    }

    // Removed createSampleRevenueChart - using empty chart instead

    async function loadOccupancyTrends() {
      try {
        const token = localStorage.getItem('token') || localStorage.getItem('adminToken');
        if (!token) {
          console.warn('‚ö†Ô∏è No token for occupancy trends, showing empty chart');
          createOccupancyChart([]);
          return;
        }
        
        const response = await fetch(`${API_BASE}/occupancy-trends?days=7`, {
          headers: { 
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const data = await response.json();
          createOccupancyChart(data || []);
        } else {
          console.warn('‚ö†Ô∏è Cannot load occupancy trends, showing empty chart');
          createOccupancyChart([]);
        }
      } catch (error) {
        console.error('Error loading occupancy trends:', error);
        createOccupancyChart([]);
      }
    }

    function createOccupancyChart(data) {
      console.log('üè† Creating occupancy chart with data:', data);
      
      const canvas = document.getElementById('occupancyChart');
      if (!canvas) {
        console.error('‚ùå Occupancy chart canvas not found!');
        return;
      }
      
      const ctx = canvas.getContext('2d');
      console.log('üñºÔ∏è Occupancy canvas context:', ctx);
      
      if (occupancyChart) {
        console.log('üóëÔ∏è Destroying existing occupancy chart');
        occupancyChart.destroy();
      }

      // L·∫•y occupancy rate t·ª´ d·ªØ li·ªáu ho·∫∑c m·∫∑c ƒë·ªãnh l√† 0
      const occupancyRate = (data && data.length > 0 && data[data.length - 1]?.occupancyRate) ? data[data.length - 1].occupancyRate : 0;
      const availableRate = 100 - occupancyRate;

      console.log('üèóÔ∏è Building occupancy chart...');
      occupancyChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['ƒê√£ ƒë·∫∑t', 'C√≤n tr·ªëng'],
          datasets: [{
            data: [occupancyRate, availableRate],
            backgroundColor: ['#4ecdc4', '#f8f9fa'],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.label + ': ' + context.parsed + '%';
                }
              }
            }
          }
        }
      });
      
      console.log('‚úÖ Occupancy chart created successfully');
    }

    // Removed createSampleOccupancyChart - using empty chart instead

    async function loadServiceRevenue() {
      try {
        const token = localStorage.getItem('token') || localStorage.getItem('adminToken');
        if (!token) {
          console.warn('‚ö†Ô∏è No token for service revenue, showing empty chart');
          createServiceChart([]);
          return;
        }
        
        const response = await fetch(`${API_BASE}/service-revenue?days=30`, {
          headers: { 
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const data = await response.json();
          createServiceChart(data || []);
        } else {
          console.warn('‚ö†Ô∏è Cannot load service revenue, showing empty chart');
          createServiceChart([]);
        }
      } catch (error) {
        console.error('Error loading service revenue:', error);
        createServiceChart([]);
      }
    }

    function createServiceChart(data) {
      console.log('üí∞ Creating service chart with data:', data);
      
      const canvas = document.getElementById('serviceChart');
      if (!canvas) {
        console.error('‚ùå Service chart canvas not found!');
        return;
      }
      
      const ctx = canvas.getContext('2d');
      console.log('üñºÔ∏è Service canvas context:', ctx);
      
      if (serviceChart) {
        console.log('üóëÔ∏è Destroying existing service chart');
        serviceChart.destroy();
      }

      // Hi·ªÉn th·ªã chart ngay c·∫£ khi kh√¥ng c√≥ d·ªØ li·ªáu
      if (!data || data.length === 0) {
        console.warn('‚ö†Ô∏è No service data to display, showing empty chart');
        serviceChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['Ch∆∞a c√≥ d·ªØ li·ªáu'],
            datasets: [{
              label: 'Doanh thu (‚Ç´)',
              data: [0],
              backgroundColor: ['#e0e0e0']
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const fmt = window.formatCurrency || formatCurrency;
                    return 'Doanh thu: ' + fmt(context.parsed.y);
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    const fmt = window.formatCurrency || formatCurrency;
                    return fmt(value);
                  }
                }
              }
            }
          }
        });
        return;
      }

      console.log('üèóÔ∏è Building service chart...');
      serviceChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.map(d => d.serviceName),
          datasets: [{
            label: 'Doanh thu (‚Ç´)',
            data: data.map(d => d.totalRevenue),
            backgroundColor: [
              '#667eea', '#4ecdc4', '#feca57', '#ff6b6b', '#74b9ff'
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  const fmt = window.formatCurrency || formatCurrency;
                  return 'Doanh thu: ' + fmt(context.parsed.y);
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  const fmt = window.formatCurrency || formatCurrency;
                  return fmt(value);
                }
              }
            }
          }
        }
      });
      
      console.log('‚úÖ Service chart created successfully');
    }

    // Removed createSampleServiceChart - using empty chart instead

    async function loadTopCustomers() {
      try {
        const token = localStorage.getItem('token') || localStorage.getItem('adminToken');
        if (!token) {
          console.warn('‚ö†Ô∏è No token for top customers, showing empty list');
          updateTopCustomers([]);
          return;
        }
        
        const response = await fetch(`${API_BASE}/top-customers?limit=10`, {
          headers: { 
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const data = await response.json();
          updateTopCustomers(data || []);
        } else {
          console.warn('‚ö†Ô∏è Cannot load top customers, showing empty list');
          updateTopCustomers([]);
        }
      } catch (error) {
        console.error('Error loading top customers:', error);
        updateTopCustomers([]);
      }
    }

    function updateTopCustomers(customers) {
      const container = document.getElementById('topCustomersContainer');
      container.innerHTML = '';

      if (!customers || customers.length === 0) {
        container.innerHTML = '<div class="text-center text-muted py-4">Ch∆∞a c√≥ d·ªØ li·ªáu kh√°ch h√†ng</div>';
        return;
      }

      customers.forEach((customer, index) => {
        const customerDiv = document.createElement('div');
        customerDiv.className = 'customer-item';
        const customerName = customer.customerName || customer.fullName || 'Kh√°ch h√†ng';
        const totalSpent = customer.totalSpent || 0;
        const bookingCount = customer.bookingCount || 0;
        customerDiv.innerHTML = `
          <div>
            <strong>#${index + 1} ${customerName}</strong>
            <br>
            <small class="text-muted">${bookingCount} ƒë·∫∑t ph√≤ng</small>
          </div>
          <div class="text-end">
            <strong class="text-success">${(window.formatCurrency || formatCurrency)(totalSpent)}</strong>
          </div>
        `;
        container.appendChild(customerDiv);
      });
    }

    async function loadRecentActivities() {
      try {
        const token = localStorage.getItem('token') || localStorage.getItem('adminToken');
        if (!token) {
          console.warn('‚ö†Ô∏è No token for recent activities, showing empty list');
          updateRecentActivities([]);
          return;
        }
        
        const response = await fetch(`${API_BASE}/recent-activities?limit=15`, {
          headers: { 
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const data = await response.json();
          updateRecentActivities(data || []);
        } else {
          console.warn('‚ö†Ô∏è Cannot load recent activities, showing empty list');
          updateRecentActivities([]);
        }
      } catch (error) {
        console.error('Error loading recent activities:', error);
        updateRecentActivities([]);
      }
    }

    function updateRecentActivities(activities) {
      const container = document.getElementById('activitiesContainer');
      const activitiesCountEl = document.getElementById('activitiesCount');
      container.innerHTML = '';

      if (!activities || activities.length === 0) {
        container.innerHTML = '<div class="text-center text-muted py-4"><i class="bx bx-info-circle"></i> Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o g·∫ßn ƒë√¢y</div>';
        if (activitiesCountEl) {
          activitiesCountEl.textContent = 'B·∫°n c√≥ 0 ho·∫°t ƒë·ªông m·ªõi';
        }
        return;
      }

      // Update activities count
      if (activitiesCountEl) {
        activitiesCountEl.textContent = `B·∫°n c√≥ ${activities.length} ho·∫°t ƒë·ªông m·ªõi`;
      }

      activities.forEach(activity => {
        const activityDiv = document.createElement('div');
        activityDiv.className = 'activity-item';
        activityDiv.innerHTML = `
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong>${activity.description || 'Ho·∫°t ƒë·ªông kh√¥ng c√≥ m√¥ t·∫£'}</strong>
              <br>
              <small class="text-muted">B·ªüi: ${activity.performedBy || 'H·ªá th·ªëng'}</small>
            </div>
            <div>
              <small class="text-muted">${formatDateTime(activity.timestamp || new Date())}</small>
            </div>
          </div>
        `;
        container.appendChild(activityDiv);
      });
    }

    function refreshAllData() {
      console.log('üîÑ Refreshing all dashboard data...');
      loadDashboardStats();
      
      // ƒê·∫£m b·∫£o Chart.js ƒë√£ load tr∆∞·ªõc khi t·∫°o charts
      if (typeof Chart !== 'undefined') {
        loadRevenueTrends();
        loadOccupancyTrends();
        loadServiceRevenue();
      } else {
        console.warn('‚ö†Ô∏è Chart.js not loaded yet, waiting...');
        setTimeout(() => {
          if (typeof Chart !== 'undefined') {
            loadRevenueTrends();
            loadOccupancyTrends();
            loadServiceRevenue();
          } else {
            console.error('‚ùå Chart.js still not loaded after timeout');
          }
        }, 500);
      }
      
      loadTopCustomers();
      loadRecentActivities();
    }

    // formatCurrency is already defined in api.js, so we don't need to redefine it
    // If api.js is not loaded, use window.formatCurrency as fallback
    if (typeof window.formatCurrency === 'undefined') {
      window.formatCurrency = function(amount) {
        return new Intl.NumberFormat('vi-VN', {
          style: 'currency',
          currency: 'VND'
        }).format(amount);
      };
    }

    function formatDateTime(dateString) {
      return new Date(dateString).toLocaleString('vi-VN');
    }

    // Auto refresh every 5 minutes
    function startAutoRefresh() {
      refreshInterval = setInterval(refreshAllData, 300000); // 5 minutes
    }

    function stopAutoRefresh() {
      if (refreshInterval) {
        clearInterval(refreshInterval);
      }
    }

    // dashboardLogout and setupLogoutButton are already defined earlier in the file
  </script>
</body>

</html>
