<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Audit Logs</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button { margin: 5px; padding: 10px 15px; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîç Test Audit Logs System</h1>
    
    <div class="test-section">
        <h3>1. Login Admin</h3>
        <button onclick="loginAdmin()">üîë Login Admin</button>
        <div id="loginResult"></div>
    </div>

    <div class="test-section">
        <h3>2. Test Audit API</h3>
        <button onclick="testAuditAPI()">üìä Get Audit Logs</button>
        <div id="auditResult"></div>
    </div>

    <div class="test-section">
        <h3>3. Create Test Action (Room Type)</h3>
        <button onclick="createTestRoomType()">‚ûï Create Room Type</button>
        <div id="createResult"></div>
    </div>

    <div class="test-section">
        <h3>4. Check Recent Audit Logs</h3>
        <button onclick="checkRecentLogs()">üîÑ Check Recent Logs</button>
        <div id="recentResult"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5130';
        
        async function loginAdmin() {
            const resultDiv = document.getElementById('loginResult');
            try {
                const response = await fetch(`${API_BASE}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        emailOrUsername: 'admin@resort.test',
                        password: 'P@ssw0rd123'
                    })
                });

                const responseText = await response.text();
                console.log('Login response text:', responseText);
                
                if (response.ok) {
                    try {
                        const result = JSON.parse(responseText);
                        localStorage.setItem('adminToken', result.token);
                        resultDiv.innerHTML = `<div class="success">‚úÖ Login successful! Token saved.</div>`;
                        console.log('Admin token:', result.token);
                    } catch (e) {
                        resultDiv.innerHTML = `<div class="error">‚ùå JSON Parse Error: ${e.message}<br>Response: ${responseText}</div>`;
                    }
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå Login failed (${response.status}): ${responseText}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function testAuditAPI() {
            const resultDiv = document.getElementById('auditResult');
            const token = localStorage.getItem('adminToken');
            
            if (!token) {
                resultDiv.innerHTML = `<div class="error">‚ùå No admin token! Please login first.</div>`;
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/audit-log?pageSize=10`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const responseText = await response.text();
                console.log('Audit API response:', responseText);
                
                if (response.ok) {
                    try {
                        const data = JSON.parse(responseText);
                        resultDiv.innerHTML = `
                            <div class="success">‚úÖ API works! Found ${data.logs?.length || 0} logs</div>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        `;
                    } catch (e) {
                        resultDiv.innerHTML = `<div class="error">‚ùå JSON Parse Error: ${e.message}<br>Response: ${responseText}</div>`;
                    }
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå API Error (${response.status}): ${responseText}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function createTestRoomType() {
            const resultDiv = document.getElementById('createResult');
            const token = localStorage.getItem('adminToken');
            
            if (!token) {
                resultDiv.innerHTML = `<div class="error">‚ùå No admin token! Please login first.</div>`;
                return;
            }

            const testData = {
                typeName: `Test Room ${Date.now()}`,
                typeCode: `TEST${Date.now()}`,
                description: 'Test room type for audit logging',
                basePrice: 1000000,
                maxOccupancy: 2,
                standardOccupancy: 2,
                roomSize: 30,
                bedType: '1 Double Bed',
                amenities: 'WiFi, TV, AC'
            };

            try {
                const response = await fetch(`${API_BASE}/api/room-types`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` 
                    },
                    body: JSON.stringify(testData)
                });

                if (response.ok) {
                    const result = await response.json();
                    resultDiv.innerHTML = `
                        <div class="success">‚úÖ Room type created! ID: ${result.roomTypeId}</div>
                        <div class="info">This should create an audit log entry.</div>
                    `;
                } else {
                    const error = await response.text();
                    resultDiv.innerHTML = `<div class="error">‚ùå Create Error (${response.status}): ${error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function checkRecentLogs() {
            const resultDiv = document.getElementById('recentResult');
            const token = localStorage.getItem('adminToken');
            
            if (!token) {
                resultDiv.innerHTML = `<div class="error">‚ùå No admin token! Please login first.</div>`;
                return;
            }

            try {
                // Get logs from last 1 hour
                const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000).toISOString().split('T')[0];
                const response = await fetch(`${API_BASE}/api/audit-log?startDate=${oneHourAgo}&pageSize=20`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const recentLogs = data.logs?.filter(log => {
                        const logTime = new Date(log.timestamp);
                        const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000);
                        return logTime > oneHourAgo;
                    }) || [];

                    resultDiv.innerHTML = `
                        <div class="success">‚úÖ Found ${recentLogs.length} recent logs (last hour)</div>
                        <pre>${JSON.stringify(recentLogs, null, 2)}</pre>
                    `;
                } else {
                    const error = await response.text();
                    resultDiv.innerHTML = `<div class="error">‚ùå Error (${response.status}): ${error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        // Auto-login on page load
        window.onload = function() {
            console.log('üîç Test Audit Logs page loaded');
            console.log('Current admin token:', localStorage.getItem('adminToken'));
        };
    </script>
</body>
</html>
