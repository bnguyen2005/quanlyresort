<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>C√°c m√≥n ƒÉn ƒë√£ ƒë·∫∑t | Resort</title>
  <link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="/css/tokens.css">
  <link rel="stylesheet" href="/css/globals.css">
  <link rel="stylesheet" href="/css/grid.css">
  <link rel="stylesheet" href="/css/components/navbar.css">
  <link rel="stylesheet" href="css/navbar-auth.css">
  <link rel="stylesheet" href="css/open-iconic-bootstrap.min.css">
  <!-- QRCode.js for generating QR codes from EMV data -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <style>
    body{font-family:'Poppins',sans-serif;padding-top:0;overflow-x:hidden;background-image:url('images/menu-2.jpg');background-size:cover;background-position:center;background-attachment:fixed;background-repeat:no-repeat;position:relative;min-height:100vh}
    body::before{content:'';position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.85);z-index:-1}
    .ftco-navbar{position:sticky!important;top:0!important;z-index:1030!important;background-color:#1a1a1a!important;width:100%!important;margin:0!important}
    
    /* Modern Hero Section */
    .rooms-hero {
      background-image: url('images/bg_1.jpg');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      background-repeat: no-repeat;
      padding: 140px 0 100px;
      color: #fff;
      text-align: center;
      position: relative;
      overflow: hidden;
      margin-bottom: 60px;
      min-height: 500px;
      display: flex;
      align-items: center;
    }
    .rooms-hero::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: linear-gradient(135deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.5) 100%);
      z-index: 0;
    }
    .rooms-hero::after {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: url('data:image/svg+xml,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="grid" width="50" height="50" patternUnits="userSpaceOnUse"><path d="M 50 0 L 0 0 0 50" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="1"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
      opacity: 0.3;
      z-index: 1;
    }
    .rooms-hero-content {
      position: relative;
      z-index: 2;
      animation: slideUp 0.8s ease;
      width: 100%;
    }
    .rooms-hero h1 {
      font-size: 48px;
      font-weight: 700;
      margin-bottom: 20px;
      color: #ffffff !important;
      text-shadow: 0 2px 10px rgba(0,0,0,0.3);
      animation: fadeInDown 1s ease;
    }
    .rooms-hero p {
      font-size: 20px;
      color: #ffffff !important;
      opacity: 0.95;
      text-shadow: 0 2px 8px rgba(0,0,0,0.2);
      animation: fadeInUp 1.2s ease;
    }
    
    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @media (max-width: 768px) {
      .rooms-hero {
        padding: 100px 0 60px;
        min-height: 400px;
      }
      .rooms-hero h1 {
        font-size: 32px;
      }
      .rooms-hero p {
        font-size: 16px;
      }
    }
    
    .order-card{background:#fff;padding:30px;border-radius:20px;box-shadow:0 10px 40px rgba(0,0,0,0.1);margin-bottom:25px;transition:all 0.3s;animation:slideUp 0.6s ease forwards;opacity:0}
    .order-card:nth-child(1){animation-delay:0.1s}
    .order-card:nth-child(2){animation-delay:0.2s}
    .order-card:nth-child(3){animation-delay:0.3s}
    .order-card:hover{transform:translateY(-5px);box-shadow:0 15px 50px rgba(0,0,0,0.15)}
    
    .order-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:20px;border-bottom:2px solid #e9ecef}
    .order-number{font-size:24px;font-weight:700;color:#c8a97e}
    .order-status{display:inline-block;padding:8px 20px;border-radius:20px;font-weight:600;font-size:14px}
    
    .order-details{display:grid;grid-template-columns:repeat(auto-fit,min-max(200px,1fr));gap:20px;margin:20px 0}
    .detail-item{padding:15px;background:#f8f9fa;border-radius:10px}
    .detail-label{font-size:12px;color:#666;text-transform:uppercase;margin-bottom:5px}
    .detail-value{font-size:18px;font-weight:600;color:#1a1a1a}
    
    .status-pending{background:#fff3cd;color:#856404}
    .status-confirmed{background:#d1ecf1;color:#0c5460}
    .status-preparing{background:#cfe2ff;color:#084298}
    .status-ready{background:#d1e7dd;color:#0f5132}
    .status-delivered{background:#d4edda;color:#155724}
    .status-cancelled{background:#f8d7da;color:#842029}
    
    .payment-status-unpaid{background:#fff3cd;color:#856404}
    .payment-status-paid{background:#d4edda;color:#155724;border:2px solid #c3e6cb}
    
    .order-actions{display:flex;gap:10px;margin-top:20px;flex-wrap:wrap}
    .order-actions .btn{
      min-width:140px;
      padding:12px 20px;
      font-size:14px;
      font-weight:600;
      border-radius:10px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      transition:all 0.3s;
      text-decoration:none;
      border:2px solid transparent
    }
    .order-actions .btn:hover{
      transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(0,0,0,0.15)
    }
    .order-actions .btn-outline-primary{
      background:#fff;
      color:#c8a97e;
      border-color:#c8a97e
    }
    .order-actions .btn-outline-primary:hover{
      background:#c8a97e;
      color:#fff;
      border-color:#c8a97e
    }
    .order-actions .btn-primary{
      background:linear-gradient(135deg,#c8a97e 0%,#b89968 100%);
      color:#fff;
      border:none
    }
    .order-actions .btn-primary:hover{
      background:linear-gradient(135deg,#b89968 0%,#c8a97e 100%);
      color:#fff
    }
    
    @keyframes slideUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
  </style>
</head>
<body>
  <!-- Header placeholder - will be loaded by load-header.js -->
  <div id="header-placeholder"></div>
  
  <!-- Load header component -->
  <script src="js/load-header.js"></script>

  <!-- Hero Section -->
  <section class="rooms-hero">
    <div class="container">
      <div class="rooms-hero-content">
        <h1>üçΩÔ∏è C√°c m√≥n ƒÉn ƒë√£ ƒë·∫∑t</h1>
        <p>Xem v√† qu·∫£n l√Ω c√°c ƒë∆°n ƒë·∫∑t m√≥n c·ªßa b·∫°n</p>
      </div>
    </div>
  </section>

  <div class="container mb-5 mt-4">
    <div id="ordersList">
      <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="sr-only">Loading...</span>
        </div>
        <p class="mt-3 text-muted">ƒêang t·∫£i danh s√°ch ƒë∆°n h√†ng...</p>
      </div>
    </div>
  </div>

  <!-- Restaurant Payment Modal (PayOs) -->
  <div class="modal fade" id="restaurantPaymentModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content" style="border-radius: 20px;">
        <div class="modal-header" style="background: linear-gradient(135deg, #c8a97e 0%, #b89968 100%); color: white;">
          <h5 class="modal-title" style="font-size: 24px; font-weight: 700;">üí≥ Thanh To√°n ƒê∆°n H√†ng</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" style="padding: 30px;">
          <div class="text-center mb-4">
            <h6>M√£ ƒë∆°n h√†ng: <strong id="rpOrderNumber">-</strong></h6>
            <h4 class="text-primary">S·ªë ti·ªÅn: <span id="rpAmount">0 ‚Ç´</span></h4>
          </div>

          <div class="mb-3">
            <label class="form-label" style="font-weight: 600;">Ph∆∞∆°ng th·ª©c thanh to√°n</label>
            <select id="rpPaymentMethod" class="form-select" style="font-size: 16px; padding: 0.75rem;">
              <option value="QR" selected>üí≥ Chuy·ªÉn kho·∫£n QR (VietQR)</option>
              <option value="Cash">üíµ Thanh to√°n t·∫°i nh√† h√†ng</option>
            </select>
          </div>

          <!-- Cash Payment Confirmation Section -->
          <div id="rpCashSection" style="display: none; padding: 20px; background: #f8f9fa; border-radius: 12px; text-align: center;">
            <div style="font-size: 64px; margin-bottom: 20px;">üíµ</div>
            <h4 style="color: #1a1a1a; margin-bottom: 16px;">Thanh to√°n t·∫°i nh√† h√†ng</h4>
            <p style="color: #6b7280; margin-bottom: 30px; font-size: 16px; line-height: 1.6;">
              B·∫°n c√≥ th·ªÉ thanh to√°n b·∫±ng ti·ªÅn m·∫∑t ho·∫∑c th·∫ª t·∫°i qu·∫ßy thanh to√°n c·ªßa nh√† h√†ng khi nh·∫≠n m√≥n.
            </p>
            <div style="background: white; padding: 24px; border-radius: 12px; border: 2px solid #c8a97e; margin-bottom: 24px;">
              <div style="margin-bottom: 12px;">
                <strong style="color: #1a1a1a; font-size: 16px;">M√£ ƒë∆°n h√†ng:</strong>
                <span id="rpCashOrderNumber" style="color: #059669; font-size: 18px; font-weight: 700; margin-left: 8px;">-</span>
              </div>
              <div style="margin-bottom: 12px;">
                <strong style="color: #1a1a1a; font-size: 16px;">S·ªë ti·ªÅn c·∫ßn thanh to√°n:</strong>
                <span id="rpCashAmount" style="color: #c8a97e; font-size: 24px; font-weight: 700; margin-left: 8px;">0 ‚Ç´</span>
              </div>
              <div>
                <strong style="color: #1a1a1a; font-size: 16px;">ƒê·ªãa ch·ªâ:</strong>
                <span style="color: #6b7280; font-size: 15px; margin-left: 8px;">123 ƒê∆∞·ªùng Bi·ªÉn Xanh, Th√†nh ph·ªë Bi·ªÉn, Vi·ªát Nam</span>
              </div>
            </div>
            <div style="background: #f0fdf4; padding: 16px; border-radius: 8px; border: 1px solid #86efac;">
              <p style="margin: 0; color: #059669; font-size: 14px; line-height: 1.6;">
                <strong>üí° L∆∞u √Ω:</strong> Vui l√≤ng thanh to√°n khi nh·∫≠n m√≥n t·∫°i qu·∫ßy thanh to√°n c·ªßa nh√† h√†ng.
              </p>
            </div>
          </div>

          <div id="rpQRSection">
            <p class="text-center mb-3">
              <strong>N·ªôi dung chuy·ªÉn kho·∫£n:</strong><br>
              <code id="rpContent" style="background: #f8f9fa; padding: 8px 12px; border-radius: 8px; font-size: 16px; font-weight: 600;">ORDER-</code>
            </p>
            <div class="text-center mb-4">
              <img id="rpQRImage" alt="QR Code" style="max-width: 300px; border: 4px solid #e9ecef; border-radius: 15px; padding: 15px; display: none;">
            </div>
            <div class="card" style="background: #f8f9fa; padding: 20px; border-radius: 12px;">
              <p class="mb-2"><strong>Ng√¢n h√†ng:</strong> MBBank</p>
              <p class="mb-2"><strong>S·ªë t√†i kho·∫£n:</strong> <span id="rpBankAccount">0901329227</span></p>
              <p class="mb-0"><strong>Ch·ªß t√†i kho·∫£n:</strong> <span id="rpBankName">PHAM THANH LAM</span></p>
            </div>
          </div>

          <div id="rpWaiting" class="text-center mt-4" style="display: block !important; visibility: visible !important; opacity: 1 !important;">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2">ƒêang ch·ªù thanh to√°n...</p>
          </div>

          <div id="rpSuccess" class="text-center mt-4" style="display: none !important; visibility: hidden !important; opacity: 0 !important;">
            <div class="alert alert-success">
              <h5>‚úÖ Thanh to√°n th√†nh c√¥ng!</h5>
              <p>ƒêang c·∫≠p nh·∫≠t th√¥ng tin...</p>
            </div>
          </div>
        </div>
        <div class="modal-footer" style="border-top: 2px solid #f0f0f0; padding: 20px 30px;">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="padding: 12px 28px; font-size: 16px; font-weight: 600; border-radius: 10px;">ƒê√≥ng</button>
          <button type="button" class="btn btn-primary" onclick="confirmRestaurantCashPayment()" id="rpConfirmCashBtn" style="display: none; padding: 12px 28px; font-size: 16px; font-weight: 600; border-radius: 10px; background: #c8a97e; border: none;">
            <i class="icon-check"></i> X√°c nh·∫≠n ƒë√£ thanh to√°n
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="js/jquery.min.js"></script>
  <script src="js/popper.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/aos.js"></script>
  <script src="js/main.js"></script>
  <script src="js/navbar-auth.js"></script>
  <script src="js/restaurant-payment.js"></script>

  <script>
    // Helper functions
    function formatCurrency(amount) {
      return new Intl.NumberFormat('vi-VN', {
        style: 'currency',
        currency: 'VND',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(amount);
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleDateString('vi-VN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function getStatusClass(status) {
      const statusMap = {
        'Pending': 'status-pending',
        'Confirmed': 'status-confirmed',
        'Preparing': 'status-preparing',
        'Ready': 'status-ready',
        'Delivered': 'status-delivered',
        'Cancelled': 'status-cancelled'
      };
      return statusMap[status] || 'status-pending';
    }

    function getStatusText(status) {
      const statusMap = {
        'Pending': 'Ch·ªù x√°c nh·∫≠n',
        'Confirmed': 'ƒê√£ x√°c nh·∫≠n',
        'Preparing': 'ƒêang chu·∫©n b·ªã',
        'Ready': 'S·∫µn s√†ng',
        'Delivered': 'ƒê√£ giao',
        'Cancelled': 'ƒê√£ h·ªßy'
      };
      return statusMap[status] || status;
    }

    function getPaymentStatusClass(paymentStatus) {
      return paymentStatus === 'Paid' ? 'payment-status-paid' : 'payment-status-unpaid';
    }

    function getPaymentStatusText(paymentStatus) {
      return paymentStatus === 'Paid' ? 'ƒê√£ thanh to√°n' : 'Ch∆∞a thanh to√°n';
    }

    function canPayOrder(order) {
      return order.paymentStatus !== 'Paid' && 
             order.status !== 'Cancelled' && 
             order.totalAmount > 0;
    }

    async function loadOrders() {
      try {
        const token = localStorage.getItem('token');
        if (!token) {
          showToast('Vui l√≤ng ƒëƒÉng nh·∫≠p', 'warning');
          setTimeout(() => window.location.href = 'login.html', 2000);
          return;
        }

        document.getElementById('ordersList').innerHTML = `
          <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-3 text-muted">ƒêang t·∫£i danh s√°ch ƒë∆°n h√†ng...</p>
          </div>
        `;

        const apiUrl = `${location.origin}/api/restaurant-orders/my?_=${Date.now()}`;
        console.log('[loadOrders] Fetching:', apiUrl);
        
        const resp = await fetch(apiUrl, {
          cache: 'no-store',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!resp.ok) {
          if (resp.status === 401 || resp.status === 403) {
            throw new Error('B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
          }
          const errorText = await resp.text();
          throw new Error(errorText || 'Kh√¥ng th·ªÉ t·∫£i danh s√°ch ƒë∆°n h√†ng');
        }

        const orders = await resp.json();
        const ordersArray = Array.isArray(orders) ? orders : [];
        
        console.log('[loadOrders] ‚úÖ Loaded', ordersArray.length, 'orders');
        renderOrders(ordersArray);
        
      } catch(e) {
        console.error('Error loading orders:', e);
        showToast('L·ªói: ' + e.message, 'danger');
        document.getElementById('ordersList').innerHTML = `
          <div class="alert alert-warning">
            <h5>Kh√¥ng th·ªÉ t·∫£i danh s√°ch ƒë∆°n h√†ng</h5>
            <p>${e.message}</p>
          </div>
        `;
      }
    }

    function renderOrders(orders) {
      const container = document.getElementById('ordersList');
      
      if (!Array.isArray(orders) || orders.length === 0) {
        container.innerHTML = `
          <div class="text-center py-5">
            <div style="font-size:80px;margin-bottom:20px">üçΩÔ∏è</div>
            <h4>Ch∆∞a c√≥ ƒë∆°n ƒë·∫∑t m√≥n n√†o</h4>
            <p class="text-muted">B·∫Øt ƒë·∫ßu ƒë·∫∑t m√≥n ngay ƒë·ªÉ th∆∞·ªüng th·ª©c nh·ªØng m√≥n ƒÉn tuy·ªát v·ªùi!</p>
            <a href="restaurant.html" class="btn btn-primary mt-3">ƒê·∫∑t m√≥n ngay</a>
          </div>
        `;
        return;
      }

      container.innerHTML = orders.map((order, idx) => {
        const orderDate = formatDate(order.createdAt);
        const deliveryTime = order.requestedDeliveryTime ? formatDate(order.requestedDeliveryTime) : '-';
        const items = order.orderItems || [];
        const itemsList = items.map(item => 
          `${item.service?.serviceName || item.serviceName || 'M√≥n'} x${item.quantity || 1}`
        ).join(', ') || 'Kh√¥ng c√≥ m√≥n n√†o';
        
        const canPay = canPayOrder(order);
        
        return `
          <div class="order-card">
            <div class="order-header">
              <div>
                <span class="order-number">${order.orderNumber || `ORD${order.orderId}`}</span>
                <span class="order-status ${getStatusClass(order.status)} ms-3">
                  ${getStatusText(order.status)}
                </span>
                <span class="order-status ${getPaymentStatusClass(order.paymentStatus)} ms-2">
                  ${getPaymentStatusText(order.paymentStatus)}
                </span>
              </div>
            </div>
            
            <div class="order-details">
              <div class="detail-item">
                <div class="detail-label">Ng√†y ƒë·∫∑t</div>
                <div class="detail-value">${orderDate}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">T·ªïng ti·ªÅn</div>
                <div class="detail-value text-primary">${formatCurrency(order.totalAmount || 0)}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">S·ªë m√≥n</div>
                <div class="detail-value">${items.length}</div>
              </div>
              ${deliveryTime !== '-' ? `
              <div class="detail-item">
                <div class="detail-label">Th·ªùi gian giao</div>
                <div class="detail-value">${deliveryTime}</div>
              </div>
              ` : ''}
            </div>
            
            <div class="mt-3">
              <strong>Danh s√°ch m√≥n:</strong>
              <p class="text-muted mt-2">${itemsList}</p>
            </div>
            
            ${order.deliveryAddress ? `
            <div class="mt-3">
              <strong>ƒê·ªãa ch·ªâ giao:</strong>
              <p class="text-muted mt-2">${order.deliveryAddress}</p>
            </div>
            ` : ''}
            
            <div class="order-actions">
              <a href="order-details.html?orderId=${order.orderId}" class="btn btn-outline-primary">
                <i class="icon-eye me-2"></i>Xem chi ti·∫øt
              </a>
              ${canPay ? `
              <button class="btn btn-primary" onclick="openRestaurantPayment(${order.orderId})">
                <i class="icon-credit-card me-2"></i>Thanh to√°n
              </button>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    function showToast(message, type) {
      // Simple toast implementation
      const toast = document.createElement('div');
      toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
      toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
      toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      document.body.appendChild(toast);
      setTimeout(() => {
        toast.remove();
      }, 5000);
    }

    // Load orders on page load
    document.addEventListener('DOMContentLoaded', () => {
      loadOrders();
    });
    
    // Background polling ƒë·ªÉ check payment status khi admin approve cash payment
    // Ch·∫°y ngay c·∫£ khi modal ƒë√≥ng
    let backgroundPollingInterval = null;
    
    function startBackgroundPolling() {
      // D·ª´ng polling c≈© n·∫øu c√≥
      if (backgroundPollingInterval) {
        clearInterval(backgroundPollingInterval);
      }
      
      console.log('üîÑ [BackgroundPolling] Starting background polling for unpaid orders...');
      
      // Poll m·ªói 10 gi√¢y ƒë·ªÉ check payment status
      backgroundPollingInterval = setInterval(async () => {
        try {
          const token = localStorage.getItem('token');
          if (!token) {
            console.warn('‚ö†Ô∏è [BackgroundPolling] No token found');
            return;
          }
          
          // L·∫•y danh s√°ch orders hi·ªán t·∫°i t·ª´ window._orders ho·∫∑c fetch l·∫°i
          let orders = window._orders || [];
          
          // N·∫øu kh√¥ng c√≥ orders trong cache, fetch l·∫°i
          if (orders.length === 0) {
            try {
              const apiUrl = `${location.origin}/api/restaurant-orders/my`;
              const resp = await fetch(apiUrl, {
                cache: 'no-store',
                headers: { 'Authorization': `Bearer ${token}` }
              });
              if (resp.ok) {
                orders = await resp.json();
                orders = Array.isArray(orders) ? orders : [];
                window._orders = orders; // Cache l·∫°i
              }
            } catch (e) {
              console.warn('‚ö†Ô∏è [BackgroundPolling] Error fetching orders:', e);
            }
          }
          
          // Ch·ªâ check c√°c order c√≥ th·ªÉ thanh to√°n (Pending/Confirmed v√† ch∆∞a Paid)
          const unpaidOrders = orders.filter(o => {
            // Check status (case-insensitive)
            const status = (o.status || o.Status || '').toString().toLowerCase();
            const paymentStatus = (o.paymentStatus || o.PaymentStatus || '').toString().toLowerCase();
            const isUnpaid = paymentStatus !== 'paid';
            const isPendingOrConfirmed = status === 'pending' || status === 'confirmed';
            
            return isUnpaid && isPendingOrConfirmed;
          });
          
          if (unpaidOrders.length === 0) {
            return; // Kh√¥ng c√≥ order n√†o c·∫ßn check
          }
          
          console.log(`üîç [BackgroundPolling] Checking ${unpaidOrders.length} unpaid orders...`);
          
          // Check t·ª´ng order
          for (const order of unpaidOrders) {
            try {
              const orderId = order.orderId || order.OrderId;
              if (!orderId) continue;
              
              const url = `${location.origin}/api/restaurant-orders/${orderId}?_=${Date.now()}`;
              const resp = await fetch(url, {
                headers: { 'Authorization': `Bearer ${token}` },
                cache: 'no-store'
              });
              
              if (resp.ok) {
                const updatedOrder = await resp.json();
                // Check payment status (case-insensitive)
                const newPaymentStatus = (updatedOrder.paymentStatus || updatedOrder.PaymentStatus || '').toString().toLowerCase();
                const oldPaymentStatus = (order.paymentStatus || order.PaymentStatus || '').toString().toLowerCase();
                
                console.log(`üîç [BackgroundPolling] Order ${orderId}: oldPaymentStatus='${oldPaymentStatus}', newPaymentStatus='${newPaymentStatus}'`);
                
                // N·∫øu payment status thay ƒë·ªïi th√†nh "paid", reload trang
                if (newPaymentStatus === 'paid' && oldPaymentStatus !== 'paid') {
                  console.log('‚úÖ [BackgroundPolling] Payment detected for order', orderId);
                  const orderNumber = updatedOrder.orderNumber || updatedOrder.OrderNumber || order.orderNumber || order.OrderNumber || `ORD${orderId}`;
                  showToast(`‚úÖ Thanh to√°n th√†nh c√¥ng cho ƒë∆°n h√†ng ${orderNumber}!`, 'success');
                  
                  // Update cache
                  const index = window._orders.findIndex(o => (o.orderId || o.OrderId) === orderId);
                  if (index >= 0) {
                    window._orders[index] = updatedOrder;
                  }
                  
                  // Reload orders list
                  setTimeout(() => {
                    loadOrders();
                  }, 1000);
                }
              }
            } catch (e) {
              console.warn('‚ö†Ô∏è [BackgroundPolling] Error checking order', order.orderId || order.OrderId, ':', e);
            }
          }
        } catch (e) {
          console.error('‚ùå [BackgroundPolling] Error:', e);
        }
      }, 10000); // Poll m·ªói 10 gi√¢y
    }
    
    // B·∫Øt ƒë·∫ßu background polling sau khi load orders
    setTimeout(() => {
      startBackgroundPolling();
    }, 2000);
    
    // D·ª´ng background polling khi trang ƒë√≥ng
    window.addEventListener('beforeunload', () => {
      if (backgroundPollingInterval) {
        clearInterval(backgroundPollingInterval);
      }
    });
  </script>

  <!-- Footer -->
      <footer class="ftco-footer ftco-bg-dark ftco-section">
      <div class="container">
        <div class="row mb-5">
          <div class="col-md">
            <div class="ftco-footer-widget mb-4">
              <h2 class="ftco-heading-2">RESORT DELUXE</h2>
              <p>Khu ngh·ªâ d∆∞·ª°ng cao c·∫•p v·ªõi kh√¥ng gian sang tr·ªçng, d·ªãch v·ª• chu ƒë√°o v√† ti·ªán nghi hi·ªán ƒë·∫°i, mang ƒë·∫øn cho b·∫°n k·ª≥ ngh·ªâ tr·ªçn v·∫πn.</p>
              <ul class="ftco-footer-social list-unstyled float-md-left float-lft mt-5">
                <li class="ftco-animate fadeInUp ftco-animated"><a href="#"><span class="icon-twitter"></span></a></li>
                <li class="ftco-animate fadeInUp ftco-animated"><a href="#"><span class="icon-facebook"></span></a></li>
                <li class="ftco-animate fadeInUp ftco-animated"><a href="#"><span class="icon-instagram"></span></a></li>
              </ul>
            </div>
          </div>
          <div class="col-md">
            <div class="ftco-footer-widget mb-4 ml-md-5">
              <h2 class="ftco-heading-2">Li√™n k·∫øt h·ªØu √≠ch</h2>
              <ul class="list-unstyled">
                <li><a href="#" class="py-2 d-block">Blog</a></li>
                <li><a href="#" class="py-2 d-block">Ph√≤ng</a></li>
                <li><a href="#" class="py-2 d-block">Ti·ªán √≠ch</a></li>
                <li><a href="#" class="py-2 d-block">Th·∫ª qu√† t·∫∑ng</a></li>
              </ul>
            </div>
          </div>
          <div class="col-md">
             <div class="ftco-footer-widget mb-4">
              <h2 class="ftco-heading-2">Ch√≠nh s√°ch</h2>
              <ul class="list-unstyled">
                <li><a href="#" class="py-2 d-block">Tuy·ªÉn d·ª•ng</a></li>
                <li><a href="#" class="py-2 d-block">V·ªÅ ch√∫ng t√¥i</a></li>
                <li><a href="#" class="py-2 d-block">Li√™n h·ªá</a></li>
                <li><a href="#" class="py-2 d-block">D·ªãch v·ª•</a></li>
              </ul>
            </div>
          </div>
          <div class="col-md">
            <div class="ftco-footer-widget mb-4">
                <h2 class="ftco-heading-2">B·∫°n c·∫ßn h·ªó tr·ª£?</h2>
            	<div class="block-23 mb-3">
	              <ul>
                <li><span class="icon icon-map-marker"></span><span class="text">123 ƒê∆∞·ªùng Bi·ªÉn Xanh, Th√†nh ph·ªë Bi·ªÉn, Vi·ªát Nam</span></li>
                <li><a href="#"><span class="icon icon-phone"></span><span class="text">+84 901 329 227</span></a></li>
                <li><a href="#"><span class="icon icon-envelope"></span><span class="text">support@resortdeluxe.vn</span></a></li>
	              </ul>
	            </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-12 text-center">
            <p><!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
  Copyright ¬©<script>document.write(new Date().getFullYear());</script>2025 All rights reserved | This template is made with <i class="icon-heart color-danger" aria-hidden="true"></i> by <a href="https://colorlib.com" target="_blank">Colorlib</a>
  <!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. --></p>
          </div>
        </div>
      </div>
    </footer>
  
  <!-- AI Chat Widget -->
  <script src="js/ai-chat.js"></script>
</body>
</html>

