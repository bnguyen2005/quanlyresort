<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chi ti·∫øt ƒë·∫∑t ph√≤ng | Resort</title>
  <link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="/css/tokens.css">
  <link rel="stylesheet" href="/css/globals.css">
  <link rel="stylesheet" href="/css/grid.css">
  <link rel="stylesheet" href="css/navbar-auth.css">
  <link rel="stylesheet" href="css/open-iconic-bootstrap.min.css">
  <!-- QRCode.js for generating QR codes from checkoutUrl -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <style>
    body{font-family:'Poppins',sans-serif;padding-top:0;overflow-x:hidden;background:linear-gradient(135deg, #f5ede0 0%, #fff8f0 50%, #ffffff 100%);min-height:100vh}
    .ftco-navbar{position:sticky!important;top:0!important;z-index:1030!important;background-color:#1a1a1a!important;width:100%!important;margin:0!important}
    
    .page-header{
      background-image: url('images/bg_1.jpg');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      background-repeat: no-repeat;
      padding:140px 0 100px;
      color:#fff;
      text-align:center;
      position:relative;
      overflow:hidden;
      margin-bottom:60px;
      min-height:500px;
      display:flex;
      align-items:center
    }
    .page-header::before{
      content:'';
      position:absolute;
      top:0;left:0;right:0;bottom:0;
      background:linear-gradient(135deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.5) 100%);
      z-index:0
    }
    .page-header::after{
      content:'';
      position:absolute;
      top:0;left:0;right:0;bottom:0;
      background:url('data:image/svg+xml,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="grid" width="50" height="50" patternUnits="userSpaceOnUse"><path d="M 50 0 L 0 0 0 50" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="1"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
      opacity:0.3;
      z-index:1
    }
    .page-header .container{position:relative;z-index:2;width:100%}
    .page-header h1{position:relative;z-index:2;font-weight:700;text-shadow:0 2px 10px rgba(0,0,0,0.3);font-size:48px;animation:fadeInDown 1s ease}
    .page-header .subtitle{position:relative;z-index:2;opacity:0.95;font-size:20px;text-shadow:0 2px 8px rgba(0,0,0,0.2);animation:fadeInUp 1.2s ease}
    @keyframes fadeInDown{from{opacity:0;transform:translateY(-30px)}to{opacity:1;transform:translateY(0)}}
    @keyframes fadeInUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
    
    .detail-container{margin-top:-70px;position:relative;z-index:10}
    
    .booking-card-main{
      background:linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      border-radius:24px;
      box-shadow:0 20px 60px rgba(200,169,126,0.15);
      overflow:hidden;
      margin-bottom:30px;
      animation:slideUp 0.6s ease forwards;
      opacity:0;
      border:2px solid rgba(200,169,126,0.1);
      position:relative
    }
    .unpaid-badge{
      position:absolute;
      top:20px;
      right:20px;
      background:#dc3545;
      color:#fff;
      padding:8px 16px;
      border-radius:25px;
      font-size:13px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.5px;
      box-shadow:0 4px 15px rgba(220,53,69,0.4);
      z-index:20;
      animation:pulse 2s infinite;
      display:flex;
      align-items:center;
      gap:8px
    }
    .unpaid-badge::before{
      content:'';
      width:10px;
      height:10px;
      background:#fff;
      border-radius:50%;
      display:inline-block;
      animation:blink 1.5s infinite
    }
    @keyframes pulse{
      0%,100%{transform:scale(1)}
      50%{transform:scale(1.05)}
    }
    @keyframes blink{
      0%,100%{opacity:1}
      50%{opacity:0.3}
    }
    @keyframes slideUp{
      from{opacity:0;transform:translateY(30px)}
      to{opacity:1;transform:translateY(0)}
    }
    
    .booking-header-section{
      background:linear-gradient(135deg,#c8a97e 0%,#b89968 100%);
      padding:40px;
      color:#fff;
      display:flex;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
      gap:20px
    }
    .booking-code{font-size:32px;font-weight:700;letter-spacing:1px}
    .booking-status-badge{
      display:inline-block;
      padding:10px 24px;
      border-radius:50px;
      font-weight:600;
      font-size:14px;
      text-transform:uppercase;
      letter-spacing:0.5px;
      background:rgba(255,255,255,0.2);
      backdrop-filter:blur(10px);
      border:2px solid rgba(255,255,255,0.3)
    }
    
    .booking-body{padding:40px;background:linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,248,240,0.8) 50%, rgba(245,237,224,0.6) 100%)}
    
    .info-section{margin-bottom:35px}
    .info-section-title{
      font-size:18px;
      font-weight:600;
      color:#c8a97e;
      margin-bottom:20px;
      padding-bottom:10px;
      border-bottom:2px solid #f0f0f0;
      display:flex;
      align-items:center;
      gap:10px
    }
    .info-section-title .oi{margin-right:8px}
    
    .info-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
      gap:20px
    }
    .info-item{
      background:linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      padding:20px;
      border-radius:12px;
      border-left:4px solid #c8a97e;
      transition:all 0.3s;
      border:2px solid rgba(200,169,126,0.1);
      box-shadow:0 4px 15px rgba(200,169,126,0.1)
    }
    .info-item:hover{
      transform:translateY(-2px);
      box-shadow:0 8px 20px rgba(200,169,126,0.2);
      border-color:rgba(200,169,126,0.3)
    }
    .info-label{
      font-size:12px;
      color:#666;
      text-transform:uppercase;
      letter-spacing:0.5px;
      margin-bottom:8px;
      font-weight:500
    }
    .info-value{
      font-size:18px;
      font-weight:600;
      color:#1a1a1a
    }
    .info-value.text-primary{color:#c8a97e!important;font-size:24px}
    
    .special-requests-box{
      background:linear-gradient(135deg, #fff8f0 0%, #f5ede0 100%);
      border:2px solid rgba(200,169,126,0.2);
      border-radius:12px;
      padding:20px;
      margin-top:10px;
      box-shadow:0 4px 15px rgba(200,169,126,0.1)
    }
    .special-requests-box .label{color:#856404;font-weight:600;margin-bottom:10px}
    
    .action-buttons{
      display:flex;
      gap:15px;
      margin-top:30px;
      flex-wrap:wrap
    }
    .btn-action{
      padding:14px 28px;
      font-weight:600;
      border-radius:12px;
      transition:all 0.3s;
      display:inline-flex;
      align-items:center;
      gap:8px
    }
    .btn-action:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(0,0,0,0.15)}
    
    .status-paid{background:#d4edda;color:#155724;border-color:#c3e6cb}
    .status-pending{background:#fff3cd;color:#856404;border-color:#ffe69c}
    .status-confirmed{background:#d1ecf1;color:#0c5460;border-color:#bee5eb}
    .status-cancelled{background:#f8d7da;color:#842029;border-color:#f5c6cb}
    
    @media(max-width:768px){
      .booking-header-section{flex-direction:column;text-align:center}
      .info-grid{grid-template-columns:1fr}
      .action-buttons{flex-direction:column}
      .btn-action{width:100%}
    }
  </style>
</head>
<body>
  <!-- Header placeholder - will be loaded by load-header.js -->
  <div id="header-placeholder"></div>
  
  <!-- Load header component -->
  <script src="js/load-header.js"></script>

  <div class="page-header">
    <div class="container">
      <h1 class="display-5 mb-3">üìã Chi ti·∫øt ƒë·∫∑t ph√≤ng</h1>
      <p class="subtitle">Th√¥ng tin chi ti·∫øt v·ªÅ ƒë·∫∑t ph√≤ng c·ªßa b·∫°n</p>
    </div>
  </div>

  <div class="container detail-container mb-5">
    <div class="booking-card-main" id="detailCard">
      <div class="text-center py-5" id="loading">
        <div class="spinner-border text-primary" role="status" style="width:3rem;height:3rem"></div>
        <p class="mt-3 text-muted">ƒêang t·∫£i th√¥ng tin ƒë·∫∑t ph√≤ng...</p>
      </div>
      <div id="content" style="display:none">
        <!-- Header Section -->
        <div class="booking-header-section">
          <div id="unpaidBadgeContainer"></div>
          <div>
            <div class="booking-code" id="code">-</div>
            <small style="opacity:0.9;font-size:14px">ƒê·∫∑t ng√†y: <span id="bookingDate">-</span></small>
          </div>
          <span class="booking-status-badge" id="statusBadge">-</span>
        </div>
        
        <!-- Body Section -->
        <div class="booking-body">
          <!-- Th√¥ng tin c∆° b·∫£n -->
          <div class="info-section">
            <div class="info-section-title">
              <span class="oi oi-info"></span>
              Th√¥ng tin c∆° b·∫£n
            </div>
            <div class="info-grid">
              <div class="info-item">
                <div class="info-label">üìÖ Ng√†y nh·∫≠n ph√≤ng</div>
                <div class="info-value" id="checkin">-</div>
              </div>
              <div class="info-item">
                <div class="info-label">üìÖ Ng√†y tr·∫£ ph√≤ng</div>
                <div class="info-value" id="checkout">-</div>
              </div>
              <div class="info-item">
                <div class="info-label">üåô S·ªë ƒë√™m</div>
                <div class="info-value" id="nights">-</div>
              </div>
              <div class="info-item">
                <div class="info-label">üë• S·ªë kh√°ch</div>
                <div class="info-value" id="guests">-</div>
              </div>
              <div class="info-item">
                <div class="info-label">üè® Ph√≤ng/Lo·∫°i ph√≤ng</div>
                <div class="info-value" id="room">-</div>
              </div>
              <div class="info-item">
                <div class="info-label">üí∞ T·ªïng ti·ªÅn</div>
                <div class="info-value text-primary" id="amount">0 ‚Ç´</div>
              </div>
            </div>
          </div>
          
          <!-- Y√™u c·∫ßu ƒë·∫∑c bi·ªát -->
          <div class="info-section" id="specialRequestsSection" style="display:none">
            <div class="info-section-title">
              <span class="oi oi-star"></span>
              Y√™u c·∫ßu ƒë·∫∑c bi·ªát
            </div>
            <div class="special-requests-box">
              <div class="label">Th√¥ng tin kh√°ch h√†ng v√† y√™u c·∫ßu:</div>
              <div id="specialRequests">-</div>
            </div>
          </div>
          
          <!-- H√≥a ƒë∆°n (n·∫øu c√≥) -->
          <div class="info-section" id="invoiceSection" style="display:none">
            <div class="info-section-title">
              <span class="oi oi-document"></span>
              Th√¥ng tin h√≥a ƒë∆°n
            </div>
            <div class="info-grid">
              <div class="info-item">
                <div class="info-label">M√£ h√≥a ƒë∆°n</div>
                <div class="info-value" id="invoiceNumber">-</div>
              </div>
              <div class="info-item">
                <div class="info-label">Ng√†y ph√°t h√†nh</div>
                <div class="info-value" id="invoiceDate">-</div>
              </div>
              <div class="info-item">
                <div class="info-label">Tr·∫°ng th√°i</div>
                <div class="info-value" id="invoiceStatus">-</div>
              </div>
            </div>
          </div>
          
          <!-- Action Buttons -->
          <div class="action-buttons">
            <button class="btn btn-primary btn-action" id="btnPay" style="display:none">
              <span class="oi oi-credit-card"></span>
              Thanh to√°n
            </button>
            <div id="awaitingConfirmationMsg" class="alert alert-info" style="display:none; margin-bottom: 15px; padding: 15px 20px; border-radius: 12px; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 2px solid #2196f3; color: #1565c0;">
              <div style="display: flex; align-items: center; gap: 10px;">
                <span class="oi oi-clock" style="font-size: 20px;"></span>
                <div>
                  <strong>‚è≥ ƒêang ch·ªù admin x√°c nh·∫≠n thanh to√°n</strong>
                  <p style="margin: 5px 0 0 0; font-size: 14px; opacity: 0.9;">Y√™u c·∫ßu thanh to√°n ti·ªÅn m·∫∑t c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c g·ª≠i. Vui l√≤ng ch·ªù admin x√°c nh·∫≠n.</p>
                </div>
              </div>
            </div>
            <button class="btn btn-outline-secondary btn-action" onclick="window.location.href='my-bookings.html'">
              <span class="oi oi-arrow-left"></span>
              Quay l·∫°i danh s√°ch
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <footer class="ftco-footer ftco-bg-dark ftco-section mt-5">
    <div class="container">
      <div class="row mb-5">
        <div class="col-md">
          <div class="ftco-footer-widget mb-4">
            <h2 class="ftco-heading-2">RESORT DELUXE</h2>
            <p>Khu ngh·ªâ d∆∞·ª°ng cao c·∫•p v·ªõi ƒë·∫ßy ƒë·ªß ti·ªán nghi hi·ªán ƒë·∫°i, ph·ª•c v·ª• chu ƒë√°o v√† kh√¥ng gian tuy·ªát ƒë·∫πp.</p>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-12 text-center">
          <p>Copyright &copy;<script>document.write(new Date().getFullYear());</script> All rights reserved | Resort Deluxe</p>
        </div>
      </div>
    </div>
  </footer>

  <!-- Modal Thanh To√°n ƒê∆°n Gi·∫£n (from simple-payment.js) -->
  <div class="modal fade" id="simplePaymentModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content" style="border-radius: 20px;">
        <div class="modal-header" style="background: linear-gradient(135deg, #c8a97e 0%, #b89968 100%); color: white;">
          <h5 class="modal-title" style="font-size: 24px; font-weight: 700;">üí≥ Thanh To√°n</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" style="padding: 30px;">
          <div class="text-center mb-4">
            <h6>M√£ ƒë·∫∑t ph√≤ng: <strong id="spBookingCode">-</strong></h6>
            <h4 class="text-primary">S·ªë ti·ªÅn: <span id="spAmount">0 ‚Ç´</span></h4>
          </div>

          <div id="spQRSection">
            <p class="text-center mb-3">
              <strong>N·ªôi dung chuy·ªÉn kho·∫£n:</strong><br>
              <code id="spContent" style="background: #f8f9fa; padding: 8px 12px; border-radius: 8px; font-size: 16px; font-weight: 600;">BOOKING-</code>
            </p>
            <div class="text-center mb-4">
              <img id="spQRImage" alt="QR Code" style="max-width: 300px; border: 4px solid #e9ecef; border-radius: 15px; padding: 15px; display: none;">
            </div>
            <div class="card" style="background: #f8f9fa; padding: 20px; border-radius: 12px;">
              <p class="mb-2"><strong>Ng√¢n h√†ng:</strong> MBBank</p>
              <p class="mb-2"><strong>S·ªë t√†i kho·∫£n:</strong> <span id="spBankAccount">0901329227</span></p>
              <p class="mb-0"><strong>Ch·ªß t√†i kho·∫£n:</strong> <span id="spBankName">Resort Deluxe</span></p>
            </div>
          </div>

          <div id="spWaiting" class="text-center mt-4" style="display: block;">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2">ƒêang ch·ªù thanh to√°n...</p>
          </div>

          <div id="spSuccess" class="text-center mt-4" style="display: none;">
            <div class="alert alert-success">
              <h5>‚úÖ Thanh to√°n th√†nh c√¥ng!</h5>
              <p>ƒêang c·∫≠p nh·∫≠t th√¥ng tin...</p>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Thanh to√°n (Old - kept for compatibility) -->
  <div class="modal fade" id="paymentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content" style="border-radius:20px;overflow:hidden">
        <div class="modal-header" style="background:linear-gradient(135deg,#c8a97e 0%,#b89968 100%);color:#fff;border:none">
          <h5 class="modal-title" style="font-weight:600;font-size:20px">
            <span class="oi oi-credit-card mr-2"></span>
            üí≥ Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-4">
          <div id="plBankSection">
            <p class="text-muted mb-3">
              <strong>Chuy·ªÉn kho·∫£n nhanh qua QR.</strong><br>
              N·ªôi dung chuy·ªÉn kho·∫£n: <code class="bg-light px-2 py-1 rounded">BOOKING-<span id="plCode2">#</span></code>
            </p>
            <div class="text-center mb-3">
              <img id="plVqrImg" alt="VietQR" style="max-width:300px;border:2px solid #eee;border-radius:15px;padding:10px;background:#fff" onerror="this.style.display='none'">
            </div>
            <div class="card bg-light p-3" style="border-radius:12px">
              <div class="row small">
                <div class="col-6 mb-2"><strong>Ng√¢n h√†ng:</strong><br><span id="plBankName">MBBank</span></div>
                <div class="col-6 mb-2"><strong>STK:</strong><br><span id="plBankAcc">0901329227</span></div>
                <div class="col-6 mb-2"><strong>CTK:</strong><br><span id="plBankAccName">Resort Deluxe</span></div>
                <div class="col-6 mb-2"><strong>S·ªë ti·ªÅn:</strong><br><span id="plAmount" class="text-primary font-weight-bold">0 ‚Ç´</span></div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer" style="border-top:2px solid #f0f0f0">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
          <div id="plPaymentStatus" style="text-align:center;flex:1;padding:0 20px">
            <div id="plWaitingMessage" style="display:none;color:#0dcaf0;font-weight:600;font-size:15px">
              <span class="spinner-border spinner-border-sm me-2" role="status"></span>
              ƒêang ch·ªù x√°c nh·∫≠n thanh to√°n...
            </div>
            <div id="plPaidMessage" style="display:none;color:#198754;font-weight:600;font-size:15px">
              <span class="oi oi-check me-2"></span>
              Thanh to√°n th√†nh c√¥ng! ƒêang c·∫≠p nh·∫≠t...
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="js/jquery.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/popper.min.js"></script>
  <script src="../js/api.js"></script>
  <script src="js/navbar-auth.js"></script>
  <script src="js/simple-payment.js"></script>
  <script>
    const params = new URLSearchParams(window.location.search);
    const bookingId = params.get('id');
    const btnPay = document.getElementById('btnPay');
    let currentBooking = null;
    if (btnPay) {
      btnPay.disabled = true;
      btnPay.dataset.ready = 'false';
    }
    
    // Validate bookingId
    if (!bookingId) {
      document.getElementById('loading').innerHTML = '<p class="text-danger">Kh√¥ng t√¨m th·∫•y m√£ ƒë·∫∑t ph√≤ng. <a href="my-bookings.html">Quay l·∫°i</a></p>';
      throw new Error('Booking ID is required');
    }
    
    // BANK_CODE, BANK_ACCOUNT, BANK_ACCOUNT_NAME are defined in simple-payment.js
    // Use window.BANK_CODE, window.BANK_ACCOUNT, window.BANK_ACCOUNT_NAME if needed

    function vnd(n){try{return new Intl.NumberFormat('vi-VN',{style:'currency',currency:'VND'}).format(n||0)}catch(_){return (n||0)+' ‚Ç´'}}
    function fdate(s){if(!s)return '-';return new Date(s).toLocaleDateString('vi-VN')}
    
    function getStatusClass(status) {
      const classes = {
        'Pending': 'status-pending',
        'Confirmed': 'status-confirmed',
        'Paid': 'status-paid',
        'Assigned': 'status-assigned',
        'CheckedIn': 'status-checkedin',
        'CheckedOut': 'status-checkedout',
        'Cancelled': 'status-cancelled'
      };
      return classes[status] || 'status-pending';
    }

    function getStatusText(status) {
      const texts = {
        'Pending': 'Ch·ªù x√°c nh·∫≠n',
        'Confirmed': 'ƒê√£ x√°c nh·∫≠n',
        'Paid': 'ƒê√£ thanh to√°n',
        'Assigned': 'ƒê√£ ph√¢n ph√≤ng',
        'CheckedIn': 'ƒê√£ nh·∫≠n ph√≤ng',
        'CheckedOut': 'ƒê√£ tr·∫£ ph√≤ng',
        'Cancelled': 'ƒê√£ h·ªßy'
      };
      return texts[status] || status;
    }
    
    function hasCashPaymentRequest(booking) {
      if (!booking || !booking.specialRequests) return false;
      try {
        const specialRequests = typeof booking.specialRequests === 'string' 
          ? JSON.parse(booking.specialRequests) 
          : booking.specialRequests;
        return specialRequests && typeof specialRequests === 'object' && specialRequests.cashPaymentRequested === true;
      } catch (e) {
        return false;
      }
    }
    
    function canPayBooking(booking) {
      // N·∫øu ƒë√£ request cash payment, kh√¥ng cho ph√©p thanh to√°n n·ªØa (ch·ªù admin approve)
      if (hasCashPaymentRequest(booking)) {
        return false;
      }
      // N·∫øu ph∆∞∆°ng th·ª©c thanh to√°n l√† Cash, kh√¥ng hi·ªÉn th·ªã n√∫t thanh to√°n
      if (booking.paymentMethod === 'Cash' || booking.paymentMethod === 'PayAtHotel') {
        return false;
      }
      return (booking.status === 'Pending' || booking.status === 'Confirmed') && booking.status !== 'Paid';
    }
    
    function renderSpecialRequests(special) {
      if (!special) return null;
      try {
        const parsed = typeof special === 'string' ? JSON.parse(special) : special;
        if (typeof parsed === 'object' && parsed !== null) {
          let html = '<div style="line-height:1.8">';
          for (const [key, value] of Object.entries(parsed)) {
            if (value) {
              const label = {
                guestName: 'T√™n kh√°ch h√†ng',
                guestEmail: 'Email',
                guestPhone: 'S·ªë ƒëi·ªán tho·∫°i',
                nationality: 'Qu·ªëc t·ªãch',
                idCard: 'CMND/CCCD',
                passport: 'H·ªô chi·∫øu',
                address: 'ƒê·ªãa ch·ªâ',
                arrivalTime: 'Gi·ªù ƒë·∫øn d·ª± ki·∫øn',
                flightNumber: 'S·ªë chuy·∫øn bay',
                paymentMethod: 'Ph∆∞∆°ng th·ª©c thanh to√°n',
                note: 'Ghi ch√∫'
              }[key] || key;
              html += `<div><strong>${label}:</strong> ${String(value)}</div>`;
            }
          }
          html += '</div>';
          return html;
        }
      } catch(_) {}
      return String(special).replace(/\n/g, '<br>');
    }

    async function loadBooking(){
      try{
        const token = localStorage.getItem('token');
        if(!token){ 
          showToast('Vui l√≤ng ƒëƒÉng nh·∫≠p','warning'); 
          setTimeout(() => window.location.href='login.html', 1500);
          return;
        }
        document.getElementById('loading').style.display='block';
        document.getElementById('content').style.display='none';
        const url = `${location.origin}/api/bookings/${bookingId}?_=${Date.now()}`;
        const resp = await fetch(url,{cache:'no-store',headers:{'Authorization':`Bearer ${token}`}});
        if(!resp.ok) {
          if (resp.status === 401 || resp.status === 403) {
            showToast('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.', 'warning');
            document.getElementById('loading').innerHTML = `<div class="alert alert-info">Vui l√≤ng <a href="login.html">ƒëƒÉng nh·∫≠p</a> ƒë·ªÉ xem chi ti·∫øt ƒë·∫∑t ph√≤ng.</div>`;
            return;
          }
          throw new Error('Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt');
        }
        const b = await resp.json();
        currentBooking = b;
        
        // Add booking to window._bookings for openSimplePayment to find
        if (!window._bookings) {
          window._bookings = [];
        }
        // Remove existing booking with same ID if exists
        window._bookings = window._bookings.filter(book => String(book.bookingId) !== String(bookingId));
        // Add current booking
        window._bookings.push(b);
        
        // Update header
        document.getElementById('code').textContent = b.bookingCode || `BKG${b.bookingId}`;
        const statusBadge = document.getElementById('statusBadge');
        statusBadge.textContent = getStatusText(b.status);
        statusBadge.className = `booking-status-badge ${getStatusClass(b.status)}`;
        const bookingDate = b.createdAt ? new Date(b.createdAt).toLocaleDateString('vi-VN') : '-';
        document.getElementById('bookingDate').textContent = bookingDate;
        
        // Update info
        document.getElementById('checkin').textContent = fdate(b.checkInDate);
        document.getElementById('checkout').textContent = fdate(b.checkOutDate);
        const nights = b.checkInDate && b.checkOutDate 
          ? Math.ceil((new Date(b.checkOutDate) - new Date(b.checkInDate)) / (1000 * 60 * 60 * 24))
          : '-';
        document.getElementById('nights').textContent = nights !== '-' ? `${nights} ƒë√™m` : '-';
        document.getElementById('guests').textContent = (b.numberOfGuests||'-')+" kh√°ch";
        document.getElementById('room').textContent = b.roomNumber || b.requestedRoomType || '-';
        const computedAmount = Number(b.estimatedTotalAmount ?? b.totalAmount ?? 0);
        document.getElementById('amount').textContent = vnd(computedAmount);
        // Expose computed amount for payment script to use
        window._bookingAmountOverrides = window._bookingAmountOverrides || {};
        window._bookingAmountOverrides[Number(bookingId)] = computedAmount;
        
        // Special requests
        if (b.specialRequests) {
          const specialHtml = renderSpecialRequests(b.specialRequests);
          if (specialHtml) {
            document.getElementById('specialRequests').innerHTML = specialHtml;
            document.getElementById('specialRequestsSection').style.display = 'block';
          }
        }
        
        // Invoice info
        if (b.invoice) {
          document.getElementById('invoiceNumber').textContent = b.invoice.invoiceNumber || '-';
          document.getElementById('invoiceDate').textContent = fdate(b.invoice.issueDate);
          document.getElementById('invoiceStatus').textContent = getStatusText(b.invoice.status);
          document.getElementById('invoiceSection').style.display = 'block';
        }
        
        // Show/hide pay button and unpaid badge
        const unpaidBadgeContainer = document.getElementById('unpaidBadgeContainer');
        const awaitingConfirmationMsg = document.getElementById('awaitingConfirmationMsg');
        
        if (btnPay) {
          const hasCashRequest = hasCashPaymentRequest(b);
          const isCashPayment = b.paymentMethod === 'Cash' || b.paymentMethod === 'PayAtHotel';
          const canPay = canPayBooking(b);
          
          if (hasCashRequest) {
            // ƒê√£ request cash payment - ·∫©n n√∫t thanh to√°n, hi·ªÉn th·ªã message ch·ªù admin
            btnPay.style.display = 'none';
            btnPay.dataset.ready = 'false';
            // Show awaiting confirmation message
            if (awaitingConfirmationMsg) {
              awaitingConfirmationMsg.style.display = 'block';
            }
            // Show unpaid badge
            if (unpaidBadgeContainer) {
              unpaidBadgeContainer.innerHTML = '<div class="unpaid-badge">Ch∆∞a thanh to√°n</div>';
            }
          } else if (isCashPayment && (b.status === 'Pending' || b.status === 'Confirmed') && b.status !== 'Paid') {
            // Ph∆∞∆°ng th·ª©c thanh to√°n l√† Cash - ·∫©n n√∫t thanh to√°n, hi·ªÉn th·ªã message thanh to√°n t·∫°i kh√°ch s·∫°n
            btnPay.style.display = 'none';
            btnPay.dataset.ready = 'false';
            // Show message for cash payment
            if (awaitingConfirmationMsg) {
              awaitingConfirmationMsg.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                  <span class="oi oi-dollar" style="font-size: 20px;"></span>
                  <div>
                    <strong>üíµ Thanh to√°n t·∫°i kh√°ch s·∫°n</strong>
                    <p style="margin: 5px 0 0 0; font-size: 14px; opacity: 0.9;">Vui l√≤ng thanh to√°n khi ƒë·∫øn nh·∫≠n ph√≤ng.</p>
                  </div>
                </div>
              `;
              awaitingConfirmationMsg.style.display = 'block';
              awaitingConfirmationMsg.className = 'alert alert-warning';
              awaitingConfirmationMsg.style.background = 'linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%)';
              awaitingConfirmationMsg.style.border = '2px solid #ffc107';
              awaitingConfirmationMsg.style.color = '#856404';
            }
            // Show unpaid badge
            if (unpaidBadgeContainer) {
              unpaidBadgeContainer.innerHTML = '<div class="unpaid-badge">Ch∆∞a thanh to√°n</div>';
            }
          } else if (canPay) {
            // C√≥ th·ªÉ thanh to√°n - hi·ªÉn th·ªã n√∫t thanh to√°n
            btnPay.style.display = 'inline-flex';
            btnPay.disabled = false;
            btnPay.dataset.ready = 'true';
            // Hide awaiting confirmation message
            if (awaitingConfirmationMsg) {
              awaitingConfirmationMsg.style.display = 'none';
            }
            // Show unpaid badge
            if (unpaidBadgeContainer) {
              unpaidBadgeContainer.innerHTML = '<div class="unpaid-badge">Ch∆∞a thanh to√°n</div>';
            }
          } else {
            // ƒê√£ thanh to√°n ho·∫∑c kh√¥ng th·ªÉ thanh to√°n - ·∫©n t·∫•t c·∫£
            btnPay.style.display = 'none';
            btnPay.dataset.ready = 'false';
            // Hide awaiting confirmation message
            if (awaitingConfirmationMsg) {
              awaitingConfirmationMsg.style.display = 'none';
            }
            // Hide unpaid badge
            if (unpaidBadgeContainer) {
              unpaidBadgeContainer.innerHTML = '';
            }
          }
        }
        
        document.getElementById('loading').style.display='none';
        document.getElementById('content').style.display='block';
      }catch(e){
        showToast('L·ªói: '+e.message,'danger');
        document.getElementById('loading').innerHTML = `<p class="text-danger">Kh√¥ng th·ªÉ t·∫£i th√¥ng tin. <a href="my-bookings.html">Quay l·∫°i</a></p>`;
      }
    }

    // Hi·ªÉn th·ªã modal thanh to√°n
    const payModal = new bootstrap.Modal(document.getElementById('paymentModal'));
    
    document.getElementById('btnPay')?.addEventListener('click', async () => {
      try {
        console.log('üîµ [btnPay click] Button clicked, bookingId:', bookingId);
        console.log('üîµ [btnPay click] currentBooking:', currentBooking);
        
        if (!currentBooking) {
          console.warn('‚ö†Ô∏è [btnPay click] No currentBooking, reloading...');
          await loadBooking();
          if (!currentBooking) {
            showToast('ƒêang t·∫£i chi ti·∫øt ƒë·∫∑t ph√≤ng, vui l√≤ng th·ª≠ l·∫°i.', 'warning');
            return;
          }
        }
        
        if (!canPayBooking(currentBooking)) {
          console.warn('‚ö†Ô∏è [btnPay click] Cannot pay booking:', currentBooking.status);
          showToast('ƒê·∫∑t ph√≤ng n√†y kh√¥ng ƒë·ªß ƒëi·ªÅu ki·ªán thanh to√°n.', 'warning');
          return;
        }
        
        btnPay.disabled = true;
        btnPay.dataset.ready = 'processing';
        
        // Wait for simple-payment.js to load if not ready
        if (typeof openSimplePayment !== 'function') {
          console.warn('‚ö†Ô∏è [booking-details] openSimplePayment not found, waiting for script...');
          // Wait up to 3 seconds for script to load
          let attempts = 0;
          while (typeof openSimplePayment !== 'function' && attempts < 30) {
            await new Promise(resolve => setTimeout(resolve, 100));
            attempts++;
          }
        }
        
        // Use simple-payment.js for consistent payment flow
        if (typeof openSimplePayment === 'function') {
          console.log('‚úÖ [booking-details] Using openSimplePayment from simple-payment.js, bookingId:', bookingId);
          console.log('‚úÖ [booking-details] window._bookings:', window._bookings);
          openSimplePayment(bookingId);
        } else {
          // Fallback to old method if simple-payment.js not loaded
          console.error('‚ùå [booking-details] openSimplePayment not found after waiting, using fallback');
          const token = localStorage.getItem('token');
          const url = `${location.origin}/api/bookings/${bookingId}?_=${Date.now()}`;
          const resp = await fetch(url, {cache:'no-store', headers:{'Authorization':`Bearer ${token}`}});
          if (!resp.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin');
          const b = await resp.json();
          
          const amount = Number(b?.estimatedTotalAmount ?? b?.totalAmount ?? 0);
          const bookingCode = b.bookingCode || `BKG${bookingId}`;
          const info = `BOOKING${bookingId}`;
          // Use global BANK_CODE, BANK_ACCOUNT, BANK_ACCOUNT_NAME from simple-payment.js
          const bankCode = window.BANK_CODE || 'MB';
          const bankAccount = window.BANK_ACCOUNT || '0901329227';
          const bankAccountName = window.BANK_ACCOUNT_NAME || 'Resort Deluxe';
          const imgUrl = `https://img.vietqr.io/image/${encodeURIComponent(bankCode)}-${encodeURIComponent(bankAccount)}-compact.png?amount=${encodeURIComponent(amount)}&addInfo=${encodeURIComponent(info)}&accountName=${encodeURIComponent(bankAccountName)}`;
          
          document.getElementById('plCode2').textContent = bookingCode;
          document.getElementById('plAmount').textContent = vnd(amount);
          document.getElementById('plBankName').textContent = 'MBBank';
          document.getElementById('plBankAcc').textContent = bankAccount;
          document.getElementById('plBankAccName').textContent = bankAccountName;
          const imgEl = document.getElementById('plVqrImg');
          if (imgEl) {
            imgEl.style.display='block';
            imgEl.src = imgUrl;
          }
          payModal.show();
          
          // B·∫Øt ƒë·∫ßu polling ƒë·ªÉ t·ª± ƒë·ªông ki·ªÉm tra thanh to√°n
          startPaymentPolling(bookingId);
        }
      } catch(e) {
        showToast('L·ªói: ' + e.message, 'danger');
      } finally {
        if (btnPay) {
          btnPay.disabled = false;
          btnPay.dataset.ready = 'true';
        }
      }
    });

    // Polling interval - using window.paymentPollingInterval from simple-payment.js
    // let paymentPollingInterval = null; // Removed - using global from simple-payment.js
    
    // H√†m ki·ªÉm tra tr·∫°ng th√°i booking
    async function checkBookingPaymentStatus(bookingId) {
      try {
        const token = localStorage.getItem('token');
        if (!token) return null;
        
        const url = `${location.origin}/api/bookings/${bookingId}?_=${Date.now()}`;
        const resp = await fetch(url, {
          headers: {
            'Authorization': `Bearer ${token}`
          },
          cache: 'no-store'
        });
        
        if (!resp.ok) return null;
        
        const booking = await resp.json();
        return booking.status;
      } catch(e) {
        console.error('‚ùå [checkBookingPaymentStatus] Error:', e);
        return null;
      }
    }
    
    // B·∫Øt ƒë·∫ßu polling khi modal m·ªü
    function startPaymentPolling(bookingId) {
      // D·ª´ng polling c≈© n·∫øu c√≥ (using global from simple-payment.js)
      if (window.paymentPollingInterval) {
        clearInterval(window.paymentPollingInterval);
        window.paymentPollingInterval = null;
      }
      
      console.log('üîÑ [startPaymentPolling] Starting payment polling for booking:', bookingId);
      
      // Hi·ªÉn th·ªã th√¥ng b√°o ƒëang ch·ªù
      const waitingMsg = document.getElementById('plWaitingMessage');
      const paidMsg = document.getElementById('plPaidMessage');
      if (waitingMsg) waitingMsg.style.display = 'block';
      if (paidMsg) paidMsg.style.display = 'none';
      
      // B·∫Øt ƒë·∫ßu polling m·ªói 3 gi√¢y (using global from simple-payment.js)
      window.paymentPollingInterval = setInterval(async () => {
        const status = await checkBookingPaymentStatus(bookingId);
        console.log('üîç [PaymentPolling] Current status:', status);
        
        if (status === 'Paid') {
          console.log('‚úÖ [PaymentPolling] Payment detected! Stopping polling and updating UI...');
          
          // D·ª´ng polling
          if (window.paymentPollingInterval) {
            clearInterval(window.paymentPollingInterval);
            window.paymentPollingInterval = null;
          }
          
          // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
          if (waitingMsg) waitingMsg.style.display = 'none';
          if (paidMsg) paidMsg.style.display = 'block';
          
          // ·∫®n QR code
          const qrImg = document.getElementById('plVqrImg');
          if (qrImg) {
            qrImg.style.display = 'none';
          }
          
          // Hi·ªÉn th·ªã th√¥ng b√°o v√† ƒë√≥ng modal sau 2 gi√¢y
          showToast('‚úÖ Thanh to√°n th√†nh c√¥ng! Tr·∫°ng th√°i ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t.', 'success');
          
          setTimeout(() => {
            payModal.hide();
            // Reload booking ƒë·ªÉ hi·ªÉn th·ªã tr·∫°ng th√°i m·ªõi
            loadBooking();
          }, 2000);
        }
      }, 3000); // Ki·ªÉm tra m·ªói 3 gi√¢y
      
      // D·ª´ng polling sau 5 ph√∫t (300 gi√¢y) ƒë·ªÉ tr√°nh polling v√¥ h·∫°n
      setTimeout(() => {
        if (window.paymentPollingInterval) {
          console.log('‚è∞ [PaymentPolling] Timeout reached, stopping polling');
          clearInterval(window.paymentPollingInterval);
          window.paymentPollingInterval = null;
          if (waitingMsg) waitingMsg.style.display = 'none';
        }
      }, 300000); // 5 ph√∫t
    }
    
    // D·ª´ng polling khi modal ƒë√≥ng
    const payModalElement = document.getElementById('paymentModal');
    if (payModalElement) {
      payModalElement.addEventListener('hidden.bs.modal', () => {
        if (window.paymentPollingInterval) {
          console.log('üõë [PaymentPolling] Modal closed, stopping polling');
          clearInterval(window.paymentPollingInterval);
          window.paymentPollingInterval = null;
        }
        const waitingMsg = document.getElementById('plWaitingMessage');
        const paidMsg = document.getElementById('plPaidMessage');
        if (waitingMsg) waitingMsg.style.display = 'none';
        if (paidMsg) paidMsg.style.display = 'none';
      });
    }
    
    loadBooking();
    
    // Background polling ƒë·ªÉ check payment status khi admin approve cash payment
    // Ch·∫°y ngay c·∫£ khi modal ƒë√≥ng
    let backgroundPollingInterval = null;
    
    function startBackgroundPolling() {
      // D·ª´ng polling c≈© n·∫øu c√≥
      if (backgroundPollingInterval) {
        clearInterval(backgroundPollingInterval);
      }
      
      // L·∫•y booking ID t·ª´ URL
      const urlParams = new URLSearchParams(window.location.search);
      const bookingId = urlParams.get('id');
      
      if (!bookingId) {
        console.warn('‚ö†Ô∏è [BackgroundPolling] No booking ID found in URL');
        return;
      }
      
      console.log('üîÑ [BackgroundPolling] Starting background polling for booking:', bookingId);
      
      // L∆∞u old status ƒë·ªÉ so s√°nh
      let oldStatus = null;
      
      // Poll m·ªói 10 gi√¢y ƒë·ªÉ check payment status
      backgroundPollingInterval = setInterval(async () => {
        try {
          const token = localStorage.getItem('token');
          if (!token) {
            console.warn('‚ö†Ô∏è [BackgroundPolling] No token found');
            return;
          }
          
          // Check booking status
          const url = `${location.origin}/api/bookings/${bookingId}?_=${Date.now()}`;
          const resp = await fetch(url, {
            headers: { 'Authorization': `Bearer ${token}` },
            cache: 'no-store'
          });
          
          if (resp.ok) {
            const booking = await resp.json();
            // Check status (case-insensitive) - Booking model ch·ªâ c√≥ 'status', kh√¥ng c√≥ 'paymentStatus'
            const newStatus = (booking.status || booking.Status || '').toString().toLowerCase();
            
            // Debug: log raw booking object ƒë·ªÉ xem structure
            if (oldStatus === null || newStatus !== oldStatus) {
              console.log(`üîç [BackgroundPolling] Booking ${bookingId} raw data:`, {
                status: booking.status,
                Status: booking.Status,
                bookingCode: booking.bookingCode || booking.BookingCode,
                normalizedStatus: newStatus
              });
            }
            
            // L·∫ßn ƒë·∫ßu ti√™n, l∆∞u old status
            if (oldStatus === null) {
              oldStatus = newStatus;
              console.log(`üîç [BackgroundPolling] Initial status for booking ${bookingId}: '${newStatus}'`);
              return;
            }
            
            console.log(`üîç [BackgroundPolling] Booking ${bookingId}: oldStatus='${oldStatus}', newStatus='${newStatus}'`);
            
            // N·∫øu status thay ƒë·ªïi t·ª´ non-paid sang paid, reload booking
            if (newStatus === 'paid' && oldStatus !== 'paid') {
              console.log('‚úÖ [BackgroundPolling] ‚úÖ‚úÖ‚úÖ PAYMENT DETECTED! Status changed from', oldStatus, 'to', newStatus);
              showToast('‚úÖ Thanh to√°n th√†nh c√¥ng! Tr·∫°ng th√°i ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t.', 'success');
              
              // Reload booking
              setTimeout(() => {
                console.log('üîÑ [BackgroundPolling] Reloading booking...');
                loadBooking();
              }, 1000);
              
              // D·ª´ng polling
              if (backgroundPollingInterval) {
                clearInterval(backgroundPollingInterval);
                backgroundPollingInterval = null;
                console.log('üõë [BackgroundPolling] Stopped polling');
              }
            } else {
              // Update old status ƒë·ªÉ track changes
              if (oldStatus !== newStatus) {
                console.log(`üîÑ [BackgroundPolling] Status changed from '${oldStatus}' to '${newStatus}' (not paid yet)`);
              }
              oldStatus = newStatus;
            }
          } else {
            console.warn(`‚ö†Ô∏è [BackgroundPolling] Failed to fetch booking ${bookingId}:`, resp.status, resp.statusText);
          }
        } catch (e) {
          console.warn('‚ö†Ô∏è [BackgroundPolling] Error:', e);
        }
      }, 10000); // Poll m·ªói 10 gi√¢y
    }
    
    // B·∫Øt ƒë·∫ßu background polling sau khi load booking
    setTimeout(() => {
      startBackgroundPolling();
    }, 2000);
    
    // D·ª´ng background polling khi trang ƒë√≥ng
    window.addEventListener('beforeunload', () => {
      if (backgroundPollingInterval) {
        clearInterval(backgroundPollingInterval);
      }
    });
  </script>
</body>
</html>
