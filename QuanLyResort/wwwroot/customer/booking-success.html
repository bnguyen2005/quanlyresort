<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ƒê·∫∑t ph√≤ng th√†nh c√¥ng | Resort Deluxe</title>
  <link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="/css/tokens.css">
  <link rel="stylesheet" href="/css/globals.css">
  <link rel="stylesheet" href="/css/grid.css">
  <link rel="stylesheet" href="css/navbar-auth.css">
  <link rel="stylesheet" href="css/open-iconic-bootstrap.min.css">
  <link rel="stylesheet" href="/css/components/navbar.css">
  <style>
    body{font-family:'Poppins',sans-serif;padding-top:0;overflow-x:hidden;background:#f8f9fa;font-size:16px;line-height:1.6;color:#1a1a1a}
    h1,h2,h3,h4,h5,h6{font-family:'Poppins',sans-serif;font-weight:700;color:#1a1a1a}
    p,span,div,label{font-family:'Poppins',sans-serif}
    .booking-details-card *{font-family:'Poppins',sans-serif}
    .detail-label{font-family:'Poppins',sans-serif;font-size:15px;font-weight:500}
    .detail-value{font-family:'Poppins',sans-serif;font-size:16px;font-weight:600}
    .ftco-navbar{position:sticky!important;top:0!important;z-index:1030!important;background-color:#1a1a1a!important;transition:all 0.3s ease;width:100%!important;margin:0!important}
    
    /* Modern Hero Section - Same as other pages */
    .success-hero {
      background-image: url('images/bg_1.jpg');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      background-repeat: no-repeat;
      padding: 140px 0 100px;
      color: #fff;
      text-align: center;
      position: relative;
      overflow: hidden;
      margin-bottom: 60px;
      min-height: 500px;
      display: flex;
      align-items: center;
    }
    .success-hero::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: linear-gradient(135deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.5) 100%);
      z-index: 0;
    }
    .success-hero::after {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: url('data:image/svg+xml,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="grid" width="50" height="50" patternUnits="userSpaceOnUse"><path d="M 50 0 L 0 0 0 50" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="1"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
      opacity: 0.3;
      z-index: 1;
    }
    .success-hero .container {
      position: relative;
      z-index: 2;
    }
    .success-hero h1 {
      font-size: 48px;
      font-weight: 700;
      margin-bottom: 20px;
      color: #ffffff !important;
      text-shadow: 0 2px 10px rgba(0,0,0,0.3);
      animation: fadeInDown 1s ease;
    }
    .success-hero p {
      font-size: 20px;
      color: #ffffff !important;
      opacity: 0.95;
      text-shadow: 0 2px 8px rgba(0,0,0,0.2);
      animation: fadeInUp 1.2s ease;
    }
    
    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .success-icon{
      width:140px;
      height:140px;
      background:#fff;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      margin:0 auto 35px;
      font-size:70px;
      animation:successPulse 2s infinite;
      box-shadow:0 15px 50px rgba(0,0,0,0.25);
      position:relative;
      z-index:1
    }
    .success-icon::after{
      content:'';
      position:absolute;
      width:100%;
      height:100%;
      border-radius:50%;
      border:3px solid rgba(200,169,126,0.3);
      animation:ripple 2s infinite
    }
    
    .booking-details-card{
      background:#fff;
      padding:50px;
      border-radius:24px;
      box-shadow:0 20px 60px rgba(0,0,0,0.12);
      margin-top:-70px;
      position:relative;
      z-index:10;
      animation:slideUp 0.8s ease;
      max-width:900px;
      margin-left:auto;
      margin-right:auto
    }
    .detail-row{
      display:flex;
      align-items:center;
      padding:20px 0;
      border-bottom:2px solid #f0f0f0;
      gap:20px
    }
    .detail-row:last-child{border-bottom:none}
    .detail-icon{
      width:50px;
      height:50px;
      background:linear-gradient(135deg,#c8a97e 0%,#b89968 100%);
      border-radius:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:24px;
      flex-shrink:0;
      box-shadow:0 4px 12px rgba(200,169,126,0.25)
    }
    .detail-content{
      flex:1;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:20px
    }
    .detail-label{
      color:#666;
      font-weight:500;
      font-size:15px
    }
    .detail-value{
      color:#1a1a1a;
      font-weight:700;
      font-size:16px;
      text-align:right
    }
    .detail-value.badge{
      padding:8px 16px;
      font-size:14px;
      font-weight:600;
      border-radius:8px
    }
    .detail-value.amount{
      color:#c8a97e;
      font-size:20px;
      font-weight:700
    }
    
    .action-buttons{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:15px;
      margin-top:40px;
      padding-top:30px;
      border-top:2px solid #f0f0f0
    }
    .btn-action{
      padding:16px 28px;
      border-radius:12px;
      font-weight:600;
      font-size:16px;
      transition:all 0.3s;
      text-decoration:none;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      border:2px solid transparent
    }
    .btn-action:hover{
      transform:translateY(-2px);
      box-shadow:0 8px 20px rgba(0,0,0,0.15)
    }
    .btn-primary-action{
      background:linear-gradient(135deg,#c8a97e 0%,#b89968 100%);
      color:#fff;
      border:none
    }
    .btn-primary-action:hover{
      background:linear-gradient(135deg,#b89968 0%,#c8a97e 100%);
      color:#fff
    }
    .btn-outline-action{
      background:#fff;
      color:#c8a97e;
      border-color:#c8a97e
    }
    .btn-outline-action:hover{
      background:#c8a97e;
      color:#fff;
      border-color:#c8a97e
    }
    
    .special-requests-box{
      background:#f8f9fa;
      border-radius:12px;
      padding:20px;
      margin-top:10px;
      border-left:4px solid #c8a97e
    }
    .special-requests-box pre{
      margin:0;
      font-family:'Poppins',sans-serif;
      font-size:14px;
      color:#555;
      white-space:pre-wrap;
      word-wrap:break-word
    }
    
    
    @keyframes successPulse{
      0%,100%{transform:scale(1);box-shadow:0 15px 50px rgba(0,0,0,0.25)}
      50%{transform:scale(1.05);box-shadow:0 20px 60px rgba(0,0,0,0.35)}
    }
    @keyframes ripple{
      0%{transform:scale(1);opacity:1}
      100%{transform:scale(1.3);opacity:0}
    }
    @keyframes slideUp{
      from{opacity:0;transform:translateY(50px)}
      to{opacity:1;transform:translateY(0)}
    }
    
    @media(max-width:768px){
      .booking-details-card{padding:30px 20px;margin-top:-50px}
      .detail-row{flex-direction:column;align-items:flex-start;gap:15px}
      .detail-content{flex-direction:column;align-items:flex-start;width:100%}
      .detail-value{text-align:left;width:100%}
      .action-buttons{grid-template-columns:1fr}
      .success-hero{
        padding: 100px 0 60px;
        min-height: 400px;
      }
      .success-hero h1 {
        font-size: 32px;
      }
      .success-hero p {
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
  <!-- Header placeholder - will be loaded by load-header.js -->
  <div id="header-placeholder"></div>
  
  <!-- Load header component -->
  <script src="js/load-header.js"></script>

  <div class="success-hero">
    <div class="container">
      <h1 class="display-4 mb-3" style="font-weight:700;font-size:48px;text-shadow:0 2px 10px rgba(0,0,0,0.2)">ƒê·∫∑t ph√≤ng th√†nh c√¥ng!</h1>
      <p class="lead" style="font-size:20px;font-weight:400;opacity:0.95">C·∫£m ∆°n b·∫°n ƒë√£ ch·ªçn RESORT DELUXE. Ch√∫ng t√¥i ƒë√£ ghi nh·∫≠n y√™u c·∫ßu ƒë·∫∑t ph√≤ng c·ªßa b·∫°n.</p>
    </div>
  </div>

  <div class="container mb-5">
    <div class="booking-details-card">
      <h3 class="mb-4 text-center" style="font-size:28px;font-weight:700;color:#1a1a1a;margin-bottom:35px">
        üìã Th√¥ng tin ƒë·∫∑t ph√≤ng
      </h3>
      <div id="bookingDetails">
        <div class="text-center py-5">
          <div class="spinner-border text-primary" role="status" style="width:3rem;height:3rem;border-width:4px">
            <span class="sr-only">Loading...</span>
          </div>
          <p class="mt-4 text-muted" style="font-size:16px">ƒêang t·∫£i th√¥ng tin...</p>
        </div>
      </div>
      
      <div class="action-buttons">
        <a href="my-bookings.html" class="btn btn-primary-action">
          <span class="oi oi-list"></span> Xem ƒë·∫∑t ph√≤ng c·ªßa t√¥i
        </a>
        <a href="index.html" class="btn btn-outline-action">
          <span class="oi oi-home"></span> V·ªÅ trang ch·ªß
        </a>
      </div>
    </div>
  </div>

  <footer class="ftco-footer ftco-bg-dark ftco-section">
    <div class="container">
      <div class="row mb-5">
        <div class="col-md">
          <div class="ftco-footer-widget mb-4">
            <h2 class="ftco-heading-2">RESORT DELUXE</h2>
            <p>Khu ngh·ªâ d∆∞·ª°ng cao c·∫•p v·ªõi ƒë·∫ßy ƒë·ªß ti·ªán nghi hi·ªán ƒë·∫°i, ph·ª•c v·ª• chu ƒë√°o v√† kh√¥ng gian tuy·ªát ƒë·∫πp.</p>
            <ul class="ftco-footer-social list-unstyled float-md-left float-lft mt-5">
              <li class="ftco-animate"><a href="https://www.twitter.com/resortdeluxe" target="_blank" rel="noopener noreferrer"><span class="icon-twitter"></span></a></li>
              <li class="ftco-animate"><a href="https://www.facebook.com/resortdeluxe" target="_blank" rel="noopener noreferrer"><span class="icon-facebook"></span></a></li>
              <li class="ftco-animate"><a href="https://www.youtube.com/resortdeluxe" target="_blank" rel="noopener noreferrer"><span class="icon-google-plus"></span></a></li>
              <li class="ftco-animate"><a href="https://www.instagram.com/resortdeluxe" target="_blank" rel="noopener noreferrer"><span class="icon-instagram"></span></a></li>
            </ul>
          </div>
        </div>
        <div class="col-md">
          <div class="ftco-footer-widget mb-4 ml-md-5">
            <h2 class="ftco-heading-2">Li√™n k·∫øt h·ªØu √≠ch</h2>
            <ul class="list-unstyled">
              <li><a href="blog.html" class="py-2 d-block">Blog</a></li>
              <li><a href="rooms.html" class="py-2 d-block">Ph√≤ng ngh·ªâ</a></li>
              <li><a href="restaurant.html" class="py-2 d-block">Nh√† h√†ng</a></li>
              <li><a href="about.html" class="py-2 d-block">Gi·ªõi thi·ªáu</a></li>
            </ul>
          </div>
        </div>
        <div class="col-md">
          <div class="ftco-footer-widget mb-4">
            <h2 class="ftco-heading-2">Th√¥ng tin</h2>
            <ul class="list-unstyled">
              <li><a href="about.html" class="py-2 d-block">V·ªÅ ch√∫ng t√¥i</a></li>
              <li><a href="contact.html" class="py-2 d-block">Li√™n h·ªá</a></li>
              <li><a href="#" class="py-2 d-block">D·ªãch v·ª•</a></li>
              <li><a href="#" class="py-2 d-block">Ch√≠nh s√°ch</a></li>
            </ul>
          </div>
        </div>
        <div class="col-md">
          <div class="ftco-footer-widget mb-4">
            <h2 class="ftco-heading-2">B·∫°n c·∫ßn h·ªó tr·ª£?</h2>
            <div class="block-23 mb-3">
              <ul>
                <li><span class="icon icon-map-marker"></span><span class="text">123 ƒê∆∞·ªùng Bi·ªÉn Xanh, Th√†nh ph·ªë Bi·ªÉn, Vi·ªát Nam</span></li>
                <li><a href="#"><span class="icon icon-phone"></span><span class="text">+84 901 329 227</span></a></li>
                <li><a href="#"><span class="icon icon-envelope"></span><span class="text">support@resortdeluxe.vn</span></a></li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-12 text-center">
          <p>Copyright &copy;<script>document.write(new Date().getFullYear());</script> All rights reserved | Resort Deluxe</p>
        </div>
      </div>
    </div>
  </footer>

  <script src="js/jquery.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/popper.min.js"></script>
  <script src="../js/api.js"></script>
  <script src="js/navbar-auth.js"></script>
  <script src="js/coupons.js"></script>
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const bookingId = urlParams.get('bookingId');
    
    // Load room types cache for price calculation
    // IMPORTANT: Always reload to get latest prices (admin may have updated)
    async function loadRoomTypesCache() {
      try {
        const token = localStorage.getItem('token');
        if (!token) {
          console.warn('‚ö†Ô∏è [loadRoomTypesCache] No token, skipping');
          return;
        }
        
        // Force reload by adding timestamp and clearing cache
        const roomTypesResp = await fetch(`${location.origin}/api/room-types?_=${Date.now()}`, {
          cache: 'no-store',
          headers: { 
            'Authorization': `Bearer ${token}`,
            'Cache-Control': 'no-cache',
            'Pragma': 'no-cache'
          }
        });
        
        if (roomTypesResp.ok) {
          const roomTypes = await roomTypesResp.json();
          window._roomTypesCache = roomTypes;
          console.log('‚úÖ [loadRoomTypesCache] Room types cached:', roomTypes.length, 'types');
          
          // Log Standard Room price for debugging
          const standardRoom = roomTypes.find(rt => 
            rt.typeName?.toLowerCase().includes('standard') || 
            rt.typeCode?.toLowerCase().includes('standard')
          );
          if (standardRoom) {
            console.log('üí∞ [loadRoomTypesCache] Standard Room price from API:', {
              typeName: standardRoom.typeName,
              basePrice: standardRoom.basePrice,
              formatted: vnd(standardRoom.basePrice)
            });
          }
        } else {
          console.warn('‚ö†Ô∏è [loadRoomTypesCache] Failed to load room types:', roomTypesResp.status);
        }
      } catch(e) {
        console.warn('‚ö†Ô∏è [loadRoomTypesCache] Error:', e);
      }
    }
    
    // Load room types cache on page load (force reload to get latest prices)
    loadRoomTypesCache();

    function vnd(n) {
      try {
        // IMPORTANT: VND has no minor units (no cents), so we must set minimumFractionDigits: 0
        // to prevent automatic division by 100
        return new Intl.NumberFormat('vi-VN', {
          style: 'currency', 
          currency: 'VND',
          minimumFractionDigits: 0,
          maximumFractionDigits: 0
        }).format(n || 0);
      } catch(_) {
        return (n || 0).toLocaleString('vi-VN') + ' ‚Ç´';
      }
    }
    

    async function loadBookingDetails() {
      if (!bookingId) {
        document.getElementById('bookingDetails').innerHTML = `
          <div class="alert alert-warning" style="padding:25px;border-radius:12px;border-left:4px solid #ffc107">
            <h5 style="font-weight:700;margin-bottom:15px">‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y m√£ ƒë·∫∑t ph√≤ng</h5>
            <p style="margin:0;font-size:15px">Vui l√≤ng ki·ªÉm tra l·∫°i email ho·∫∑c li√™n h·ªá v·ªõi ch√∫ng t√¥i qua s·ªë ƒëi·ªán tho·∫°i: <strong>+84 901 329 227</strong></p>
          </div>
        `;
        return;
      }

      try {
        const token = localStorage.getItem('token');
        if (!token) {
          document.getElementById('bookingDetails').innerHTML = `
            <div class="alert alert-info" style="padding:25px;border-radius:12px;border-left:4px solid #0dcaf0">
              <h5 style="font-weight:700;margin-bottom:15px">üîê Vui l√≤ng ƒëƒÉng nh·∫≠p</h5>
              <p style="margin:0;font-size:15px">ƒê·ªÉ xem chi ti·∫øt ƒë·∫∑t ph√≤ng, vui l√≤ng <a href="login.html" style="font-weight:600;color:#0dcaf0">ƒëƒÉng nh·∫≠p</a>.</p>
            </div>
          `;
          return;
        }

        const API_BOOKINGS = `${location.origin}/api/bookings/${bookingId}?_=${Date.now()}`;
        const resp = await fetch(API_BOOKINGS, {
          headers: {
            'Authorization': `Bearer ${token}`
          },
          cache: 'no-store'
        });

        if (!resp.ok) {
          throw new Error('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin ƒë·∫∑t ph√≤ng');
        }

        const booking = await resp.json();
        renderBookingDetails(booking);
      } catch(e) {
        console.error('Error loading booking:', e);
        document.getElementById('bookingDetails').innerHTML = `
          <div class="alert alert-success" style="padding:25px;border-radius:12px;border-left:4px solid #198754">
            <h5 style="font-weight:700;margin-bottom:15px">‚úÖ ƒê·∫∑t ph√≤ng ƒë√£ ƒë∆∞·ª£c ghi nh·∫≠n</h5>
            <p style="margin-bottom:10px"><strong>M√£ ƒë·∫∑t ph√≤ng:</strong> <span style="color:#198754;font-size:18px">${bookingId}</span></p>
            <p style="margin:0;font-size:15px">Ch√∫ng t√¥i s·∫Ω li√™n h·ªá v·ªõi b·∫°n trong th·ªùi gian s·ªõm nh·∫•t ƒë·ªÉ x√°c nh·∫≠n. Vui l√≤ng ki·ªÉm tra email ho·∫∑c ƒëi·ªán tho·∫°i c·ªßa b·∫°n.</p>
          </div>
        `;
      }
    }

    async function renderBookingDetails(booking) {
      const checkin = new Date(booking.checkInDate).toLocaleDateString('vi-VN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
      const checkout = new Date(booking.checkOutDate).toLocaleDateString('vi-VN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
      const bookingCode = booking.bookingCode || `BKG${bookingId}`;
      const roomInfo = booking.room ? `${booking.room.roomNumber} - ${booking.room.roomTypeNavigation?.typeName || booking.requestedRoomType || 'N/A'}` : (booking.requestedRoomType || 'N/A');
      
      // Calculate base price and check for coupon
      let baseAmount = Number(booking.estimatedTotalAmount || booking.totalAmount || 0);
      let discount = 0;
      let couponInfo = null;
      let couponCode = booking.couponCode || null;
      
      // Try to get couponCode from specialRequests if not in booking
      if (!couponCode && booking.specialRequests) {
        try {
          const parsed = JSON.parse(booking.specialRequests);
          if (typeof parsed === 'object' && parsed !== null && parsed.couponCode) {
            couponCode = parsed.couponCode;
          }
        } catch(_) {}
      }
      
      // If we have couponCode, try to fetch coupon and calculate discount
      // If validation fails (403), use estimatedTotalAmount from backend (already includes discount)
      if (couponCode && window.coupons) {
        try {
          const coupon = await window.coupons.validateCoupon(couponCode);
          couponInfo = coupon;
          
          // Calculate base amount if not available
          // IMPORTANT: Use estimatedTotalAmount from backend as primary source
          if (baseAmount <= 0 && booking.checkInDate && booking.checkOutDate) {
            const nights = Math.ceil((new Date(booking.checkOutDate) - new Date(booking.checkInDate)) / (1000 * 60 * 60 * 24));
            let roomPrice = 0;
            
            // Try to get room price - prioritize BasePrice over pricePerNight
            if (booking.room?.roomTypeNavigation?.basePrice) {
              roomPrice = Number(booking.room.roomTypeNavigation.basePrice);
              console.log('üîµ [renderBookingDetails] Using roomTypeNavigation.basePrice:', roomPrice);
            } else if (booking.room?.pricePerNight) {
              roomPrice = Number(booking.room.pricePerNight);
              console.log('üîµ [renderBookingDetails] Using room.pricePerNight:', roomPrice);
            } else if (booking.room?.roomTypeNavigation?.pricePerNight) {
              roomPrice = Number(booking.room.roomTypeNavigation.pricePerNight);
              console.log('üîµ [renderBookingDetails] Using roomTypeNavigation.pricePerNight:', roomPrice);
            }
            
            if (nights > 0 && roomPrice > 0) {
              baseAmount = nights * roomPrice;
              console.log('üîµ [renderBookingDetails] Calculated baseAmount:', baseAmount, `(${nights} nights √ó ${roomPrice})`);
              
              // If backend has estimatedTotalAmount, use it as authoritative source
              const backendAmount = Number(booking.estimatedTotalAmount || booking.totalAmount || 0);
              if (backendAmount > 0 && baseAmount !== backendAmount) {
                console.warn('‚ö†Ô∏è [renderBookingDetails] Calculated amount differs from backend. Using backend amount:', backendAmount);
                baseAmount = backendAmount;
              }
            }
          }
          
          // Calculate discount
          if (baseAmount > 0) {
            const result = window.coupons.calculateDiscountedTotal(baseAmount, coupon);
            discount = result.discount;
          }
        } catch(e) {
          // If validation fails (403, 401, etc.), assume backend already calculated discount
          // Use estimatedTotalAmount as final amount (it may already include discount)
          console.warn('Could not validate coupon (using backend calculated amount):', e);
          
          // If baseAmount is 0, try to estimate from dates to show breakdown
          // IMPORTANT: Use estimatedTotalAmount from backend as primary source
          // Only recalculate if it's missing or invalid
          if (baseAmount <= 0 && booking.checkInDate && booking.checkOutDate) {
            const nights = Math.ceil((new Date(booking.checkOutDate) - new Date(booking.checkInDate)) / (1000 * 60 * 60 * 24));
            let roomPrice = 0;
            
            // Try to get room price - prioritize BasePrice over pricePerNight
            if (booking.room?.roomTypeNavigation?.basePrice) {
              roomPrice = Number(booking.room.roomTypeNavigation.basePrice);
              console.log('üîµ [renderBookingDetails] Using roomTypeNavigation.basePrice:', roomPrice);
            } else if (booking.room?.pricePerNight) {
              roomPrice = Number(booking.room.pricePerNight);
              console.log('üîµ [renderBookingDetails] Using room.pricePerNight:', roomPrice);
            } else if (booking.room?.roomTypeNavigation?.pricePerNight) {
              roomPrice = Number(booking.room.roomTypeNavigation.pricePerNight);
              console.log('üîµ [renderBookingDetails] Using roomTypeNavigation.pricePerNight:', roomPrice);
            }
            
            if (nights > 0 && roomPrice > 0) {
              baseAmount = nights * roomPrice;
              console.log('üîµ [renderBookingDetails] Calculated baseAmount:', baseAmount, `(${nights} nights √ó ${roomPrice})`);
              
              // Estimate discount as difference between base and final
              const finalAmount = Number(booking.estimatedTotalAmount || booking.totalAmount || 0);
              if (finalAmount > 0 && baseAmount > finalAmount) {
                discount = baseAmount - finalAmount;
                couponInfo = { code: couponCode }; // Mark as applied but not validated
              } else if (finalAmount > 0 && baseAmount !== finalAmount) {
                // If calculated amount differs from backend, use backend amount (it's authoritative)
                console.warn('‚ö†Ô∏è [renderBookingDetails] Calculated amount differs from backend. Using backend amount:', finalAmount);
                baseAmount = finalAmount;
              }
            }
          } else if (baseAmount > 0) {
            // Calculate discount as difference
            const finalAmount = Number(booking.estimatedTotalAmount || booking.totalAmount || 0);
            if (finalAmount > 0 && baseAmount > finalAmount) {
              discount = baseAmount - finalAmount;
              couponInfo = { code: couponCode }; // Mark as applied but not validated
            }
          }
        }
      }
      
      let specialRequestsHtml = '';
      if (booking.specialRequests) {
        try {
          const parsed = JSON.parse(booking.specialRequests);
          if (typeof parsed === 'object' && parsed !== null) {
            specialRequestsHtml = Object.entries(parsed).map(([key, value]) => {
              // Skip couponCode from display
              if (key === 'couponCode') return '';
              const labels = {
                guestName: 'H·ªç t√™n',
                guestEmail: 'Email',
                guestPhone: 'S·ªë ƒëi·ªán tho·∫°i',
                nationality: 'Qu·ªëc t·ªãch',
                idCard: 'CMND/CCCD',
                passport: 'H·ªô chi·∫øu',
                address: 'ƒê·ªãa ch·ªâ',
                arrivalTime: 'Gi·ªù ƒë·∫øn',
                flightNumber: 'S·ªë chuy·∫øn bay',
                paymentMethod: 'Ph∆∞∆°ng th·ª©c thanh to√°n',
                note: 'Ghi ch√∫'
              };
              return `<div style="margin-bottom:8px"><strong>${labels[key] || key}:</strong> ${value || '-'}</div>`;
            }).join('');
          } else {
            specialRequestsHtml = booking.specialRequests;
          }
        } catch(_) {
          specialRequestsHtml = booking.specialRequests;
        }
      }
      
      
      // Build price breakdown HTML
      let priceBreakdownHtml = '';
      if (couponInfo && discount > 0 && baseAmount > 0) {
        const finalAmount = baseAmount - discount;
        priceBreakdownHtml = `
        <div class="detail-row">
          <div class="detail-icon">üéüÔ∏è</div>
          <div class="detail-content">
            <span class="detail-label">M√£ gi·∫£m gi√°</span>
            <span class="detail-value"><strong style="color:#c8a97e">${couponCode}</strong></span>
          </div>
        </div>
        <div class="detail-row">
          <div class="detail-icon">üíµ</div>
          <div class="detail-content">
            <span class="detail-label">Gi√° g·ªëc</span>
            <span class="detail-value" style="color:#6b7280;text-decoration:line-through">${vnd(baseAmount)}</span>
          </div>
        </div>
        <div class="detail-row">
          <div class="detail-icon">üí∏</div>
          <div class="detail-content">
            <span class="detail-label">Gi·∫£m gi√°</span>
            <span class="detail-value" style="color:#10b981;font-weight:700">-${vnd(discount)}</span>
          </div>
        </div>
        `;
      }
      
      document.getElementById('bookingDetails').innerHTML = `
        <div class="detail-row">
          <div class="detail-icon">üé´</div>
          <div class="detail-content">
            <span class="detail-label">M√£ ƒë·∫∑t ph√≤ng</span>
            <span class="detail-value">${bookingCode}</span>
          </div>
        </div>
        <div class="detail-row">
          <div class="detail-icon">üìä</div>
          <div class="detail-content">
            <span class="detail-label">Tr·∫°ng th√°i</span>
            <span class="detail-value"><span class="badge bg-${getStatusColor(booking.status)}">${getStatusText(booking.status)}</span></span>
          </div>
        </div>
        <div class="detail-row">
          <div class="detail-icon">üìÖ</div>
          <div class="detail-content">
            <span class="detail-label">Ng√†y nh·∫≠n ph√≤ng</span>
            <span class="detail-value">${checkin}</span>
          </div>
        </div>
        <div class="detail-row">
          <div class="detail-icon">üìÖ</div>
          <div class="detail-content">
            <span class="detail-label">Ng√†y tr·∫£ ph√≤ng</span>
            <span class="detail-value">${checkout}</span>
          </div>
        </div>
        <div class="detail-row">
          <div class="detail-icon">üë•</div>
          <div class="detail-content">
            <span class="detail-label">S·ªë kh√°ch</span>
            <span class="detail-value">${booking.numberOfGuests || '-'} kh√°ch</span>
          </div>
        </div>
        <div class="detail-row">
          <div class="detail-icon">üè®</div>
          <div class="detail-content">
            <span class="detail-label">Ph√≤ng</span>
            <span class="detail-value">${roomInfo}</span>
          </div>
        </div>
        ${priceBreakdownHtml}
        <div class="detail-row">
          <div class="detail-icon">üí∞</div>
          <div class="detail-content">
            <span class="detail-label">${couponInfo && discount > 0 ? 'T·ªïng ti·ªÅn sau gi·∫£m gi√°' : 'T·ªïng ti·ªÅn'}</span>
            <span class="detail-value amount">${vnd(couponInfo && discount > 0 ? (baseAmount - discount) : (booking.estimatedTotalAmount || booking.totalAmount || 0))}</span>
          </div>
        </div>
        ${specialRequestsHtml ? `
        <div class="detail-row" style="flex-direction:column;align-items:flex-start">
          <div style="display:flex;align-items:center;gap:15px;margin-bottom:15px;width:100%">
            <div class="detail-icon">üìù</div>
            <span class="detail-label">Th√¥ng tin kh√°ch h√†ng & Y√™u c·∫ßu ƒë·∫∑c bi·ªát</span>
          </div>
          <div class="special-requests-box" style="width:100%;margin-left:70px">
            ${specialRequestsHtml}
          </div>
        </div>
        ` : ''}
      `;
      
      // Update action buttons to include booking details link if bookingId exists
      const actionButtons = document.querySelector('.action-buttons');
      if (bookingId && actionButtons) {
        actionButtons.innerHTML = `
          <a href="booking-details.html?id=${bookingId}" class="btn btn-primary-action">
            <span class="oi oi-eye"></span> Xem chi ti·∫øt
          </a>
          <a href="my-bookings.html" class="btn btn-outline-action">
            <span class="oi oi-list"></span> ƒê·∫∑t ph√≤ng c·ªßa t√¥i
          </a>
          <a href="index.html" class="btn btn-outline-action">
            <span class="oi oi-home"></span> V·ªÅ trang ch·ªß
          </a>
        `;
      }
    }

    function getStatusColor(status) {
      const colors = {
        'Pending': 'warning',
        'Confirmed': 'info',
        'Paid': 'success',
        'Assigned': 'primary',
        'CheckedIn': 'success',
        'CheckedOut': 'secondary',
        'Cancelled': 'danger'
      };
      return colors[status] || 'secondary';
    }

    function getStatusText(status) {
      const texts = {
        'Pending': 'Ch·ªù x√°c nh·∫≠n',
        'Confirmed': 'ƒê√£ x√°c nh·∫≠n',
        'Paid': 'ƒê√£ thanh to√°n',
        'Assigned': 'ƒê√£ ph√¢n ph√≤ng',
        'CheckedIn': 'ƒê√£ nh·∫≠n ph√≤ng',
        'CheckedOut': 'ƒê√£ tr·∫£ ph√≤ng',
        'Cancelled': 'ƒê√£ h·ªßy'
      };
      return texts[status] || status;
    }

    // Load on page load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadBookingDetails);
    } else {
      loadBookingDetails();
    }

    // Also load on pageshow (back/forward navigation)
    window.addEventListener('pageshow', function(event) {
      if (event.persisted || (performance.navigation && performance.navigation.type === 2)) {
        loadBookingDetails();
      }
    });
  </script>
</body>
</html>