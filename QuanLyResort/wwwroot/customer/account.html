<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>T√†i kho·∫£n c·ªßa t√¥i | Resort Deluxe</title>
  <link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="/css/tokens.css">
  <link rel="stylesheet" href="/css/globals.css">
  <link rel="stylesheet" href="/css/grid.css">
  <link rel="stylesheet" href="css/navbar-auth.css">
  <link rel="stylesheet" href="css/open-iconic-bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="/js/toast-notification.js"></script>
  <script src="/js/form-validation.js"></script>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      padding-top: 0;
      overflow-x: hidden;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
    }
    .ftco-navbar {
      position: sticky !important;
      top: 0 !important;
      z-index: 1030 !important;
      background-color: #1a1a1a !important;
      width: 100% !important;
      margin: 0 !important;
    }
    
    .profile-header {
      background: linear-gradient(135deg, #C8A97E 0%, #B89968 100%);
      padding: 80px 0 60px;
      color: #fff;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    .profile-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="grid" width="100" height="100" patternUnits="userSpaceOnUse"><path d="M 100 0 L 0 0 0 100" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="1"/></pattern></defs><rect width="100%" height="100%" fill="url(%23grid)"/></svg>');
      opacity: 0.3;
    }
    .profile-avatar-container {
      position: relative;
      display: inline-block;
      margin: 0 auto 25px;
    }
    .profile-avatar {
      width: 140px;
      height: 140px;
      background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 70px;
      box-shadow: 0 15px 50px rgba(0,0,0,0.3);
      position: relative;
      z-index: 1;
      border: 5px solid rgba(255,255,255,0.3);
      transition: transform 0.3s ease;
    }
    .profile-avatar:hover {
      transform: scale(1.05);
    }
    .profile-avatar-img {
      width: 140px;
      height: 140px;
      border-radius: 50%;
      object-fit: cover;
      border: 5px solid rgba(255,255,255,0.3);
      box-shadow: 0 15px 50px rgba(0,0,0,0.3);
      transition: transform 0.3s ease;
    }
    .profile-avatar-img:hover {
      transform: scale(1.05);
    }
    .avatar-upload-btn {
      position: absolute;
      bottom: 5px;
      right: 5px;
      width: 45px;
      height: 45px;
      background: linear-gradient(135deg, #C8A97E 0%, #B89968 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      transition: all 0.3s ease;
      z-index: 2;
      border: 3px solid white;
    }
    .avatar-upload-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(0,0,0,0.4);
    }
    .avatar-upload-btn i {
      font-size: 18px;
    }
    
    .profile-card {
      background: #fff;
      padding: 50px;
      border-radius: 25px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.15);
      margin-top: -60px;
      position: relative;
      z-index: 10;
      animation: slideUp 0.8s ease;
    }
    
    .action-buttons {
      position: absolute;
      top: 30px;
      right: 30px;
      display: flex;
      gap: 10px;
    }
    .action-buttons .btn {
      border-radius: 12px;
      padding: 10px 20px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .action-buttons .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 25px;
      margin: 40px 0;
    }
    .stat-card {
      background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
      padding: 30px;
      border-radius: 20px;
      text-align: center;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      border: 1px solid rgba(200,169,126,0.2);
      position: relative;
      overflow: hidden;
    }
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #C8A97E 0%, #B89968 100%);
    }
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 35px rgba(0,0,0,0.15);
    }
    .stat-icon {
      font-size: 32px;
      color: #C8A97E;
      margin-bottom: 15px;
      display: block;
    }
    .stat-number {
      font-size: 42px;
      font-weight: 700;
      color: #1a1a1a;
      display: block;
      margin-bottom: 10px;
      background: linear-gradient(135deg, #C8A97E 0%, #B89968 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .stat-label {
      color: #666;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
    }
    
    .section-title {
      font-size: 28px;
      font-weight: 700;
      color: #1a1a1a;
      margin: 50px 0 30px;
      padding-bottom: 15px;
      border-bottom: 3px solid #C8A97E;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .section-title i {
      color: #C8A97E;
    }
    
    .info-row {
      display: flex;
      padding: 25px 0;
      border-bottom: 1px solid #e9ecef;
      align-items: center;
      transition: all 0.3s ease;
    }
    .info-row:last-child {
      border-bottom: none;
    }
    .info-row:hover {
      background: rgba(200,169,126,0.05);
      margin: 0 -20px;
      padding-left: 20px;
      padding-right: 20px;
      border-radius: 10px;
    }
    .info-label {
      flex: 0 0 220px;
      color: #666;
      font-weight: 600;
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .info-label i {
      color: #C8A97E;
      width: 20px;
    }
    .info-value {
      flex: 1;
      color: #1a1a1a;
      font-weight: 500;
    }
    .info-value input,
    .info-value select,
    .info-value textarea {
      width: 100%;
      border: none;
      background: transparent;
      color: #1a1a1a;
      font-weight: 500;
      padding: 8px 0;
      font-size: 15px;
      transition: all 0.3s ease;
    }
    .info-value input:focus,
    .info-value select:focus,
    .info-value textarea:focus {
      outline: none;
      border-bottom: 2px solid #C8A97E;
      padding-bottom: 6px;
    }
    .info-value input:read-only,
    .info-value textarea:read-only {
      color: #666;
      cursor: default;
    }
    .info-value input:not(:read-only),
    .info-value textarea:not(:read-only) {
      border-bottom: 2px solid #C8A97E;
      background: rgba(200,169,126,0.05);
      padding: 8px 12px;
      border-radius: 8px;
    }
    
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @media (max-width: 768px) {
      .profile-card {
        padding: 30px 20px;
        margin-top: -40px;
      }
      .action-buttons {
        position: static;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }
      .info-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
      .info-label {
        flex: none;
        width: 100%;
      }
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
      }
    }
  </style>
</head>
<body>
  <!-- Header placeholder - will be loaded by load-header.js -->
  <div id="header-placeholder"></div>
  
  <!-- Load header component -->
  <script src="js/load-header.js"></script>

  <div class="profile-header">
    <div class="container">
      <div class="profile-avatar-container">
        <img id="profileAvatarImg" src="" alt="Avatar" class="profile-avatar-img" style="display: none; width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.2);">
        <div id="profileAvatarPlaceholder" class="profile-avatar">üë§</div>
        <label for="avatarUpload" class="avatar-upload-btn" title="T·∫£i ·∫£nh ƒë·∫°i di·ªán">
          <i class="fas fa-camera"></i>
        </label>
        <input type="file" id="avatarUpload" accept="image/*" style="display: none;" onchange="handleAvatarUpload(event)">
      </div>
      <h1 class="display-5 mb-2" id="profileName" style="position: relative; z-index: 1;">ƒêang t·∫£i...</h1>
      <p class="lead mb-0" id="profileEmail" style="position: relative; z-index: 1;">ƒêang t·∫£i...</p>
    </div>
  </div>

  <div class="container mb-5">
    <div class="profile-card position-relative">
      <div class="action-buttons">
        <button class="btn btn-outline-primary" id="btnEdit" onclick="toggleEdit()">
          <i class="fas fa-edit"></i> Ch·ªânh s·ª≠a
        </button>
        <button class="btn btn-primary" id="btnSave" onclick="saveProfile()" style="display:none">
          <i class="fas fa-save"></i> L∆∞u thay ƒë·ªïi
        </button>
        <button class="btn btn-outline-secondary" id="btnCancel" onclick="cancelEdit()" style="display:none">
          <i class="fas fa-times"></i> H·ªßy
        </button>
      </div>
      
      <div class="stats-grid">
        <div class="stat-card">
          <i class="fas fa-calendar-check stat-icon"></i>
          <span class="stat-number" id="totalBookings">0</span>
          <span class="stat-label">ƒê·∫∑t ph√≤ng</span>
        </div>
        <div class="stat-card">
          <i class="fas fa-wallet stat-icon"></i>
          <span class="stat-number" id="totalSpent">0 ‚Ç´</span>
          <span class="stat-label">T·ªïng chi ti√™u</span>
        </div>
        <div class="stat-card">
          <i class="fas fa-star stat-icon"></i>
          <span class="stat-number" id="loyaltyPoints">0</span>
          <span class="stat-label">ƒêi·ªÉm th∆∞·ªüng</span>
        </div>
        <div class="stat-card">
          <i class="fas fa-crown stat-icon"></i>
          <span class="stat-number" id="customerType">-</span>
          <span class="stat-label">Lo·∫°i kh√°ch h√†ng</span>
        </div>
      </div>

      <h3 class="section-title">
        <i class="fas fa-user-circle"></i>
        Th√¥ng tin c√° nh√¢n
      </h3>
      
      <div class="info-row">
        <span class="info-label">
          <i class="fas fa-user"></i>
          H·ªç v√† t√™n:
        </span>
        <span class="info-value">
          <input type="text" id="fullName" value="" readonly required />
        </span>
      </div>
      <div class="info-row">
        <span class="info-label">
          <i class="fas fa-envelope"></i>
          Email:
        </span>
        <span class="info-value">
          <input type="email" id="email" value="" readonly required />
        </span>
      </div>
      <div class="info-row">
        <span class="info-label">
          <i class="fas fa-phone"></i>
          S·ªë ƒëi·ªán tho·∫°i:
        </span>
        <span class="info-value">
          <input type="tel" id="phoneNumber" value="" readonly />
        </span>
      </div>
      <div class="info-row">
        <span class="info-label">
          <i class="fas fa-birthday-cake"></i>
          Ng√†y sinh:
        </span>
        <span class="info-value">
          <input type="date" id="dateOfBirth" value="" readonly />
        </span>
      </div>
      <div class="info-row">
        <span class="info-label">
          <i class="fas fa-flag"></i>
          Qu·ªëc t·ªãch:
        </span>
        <span class="info-value">
          <input type="text" id="nationality" value="" readonly />
        </span>
      </div>
      <div class="info-row">
        <span class="info-label">
          <i class="fas fa-map-marker-alt"></i>
          ƒê·ªãa ch·ªâ:
        </span>
        <span class="info-value">
          <textarea id="address" rows="2" readonly></textarea>
        </span>
      </div>
      <div class="info-row">
        <span class="info-label">
          <i class="fas fa-id-card"></i>
          CMND/CCCD:
        </span>
        <span class="info-value">
          <input type="text" id="idCardNumber" value="" readonly />
        </span>
      </div>
      <div class="info-row">
        <span class="info-label">
          <i class="fas fa-passport"></i>
          H·ªô chi·∫øu:
        </span>
        <span class="info-value">
          <input type="text" id="passportNumber" value="" readonly />
        </span>
      </div>
    </div>
  </div>

  <script src="js/jquery.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/popper.min.js"></script>
  <script src="../js/api.js"></script>
  <script src="js/navbar-auth.js"></script>
  <script>
    let originalData = {};
    let customerId = null;
    let isEditing = false;

    function vnd(n) {
      try {
        return new Intl.NumberFormat('vi-VN', {style:'currency', currency:'VND'}).format(n || 0);
      } catch(_) {
        return (n || 0) + '‚Ç´';
      }
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      const d = new Date(dateStr);
      return d.toISOString().split('T')[0];
    }

    function showPageLoading(message) {
      // Simple loading indicator
      if (!document.getElementById('pageLoader')) {
        const loader = document.createElement('div');
        loader.id = 'pageLoader';
        loader.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0,0,0,0.5);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 9999;
          color: white;
          font-size: 18px;
        `;
        loader.innerHTML = `<div style="text-align:center;"><div class="spinner-border" role="status"></div><div style="margin-top:15px;">${message || 'ƒêang t·∫£i...'}</div></div>`;
        document.body.appendChild(loader);
      }
    }

    function hidePageLoading() {
      const loader = document.getElementById('pageLoader');
      if (loader) loader.remove();
    }

    async function loadProfile() {
      try {
        const token = localStorage.getItem('token');
        const userStr = localStorage.getItem('user');
        
        if (!token || !userStr) {
          if (window.showToast) {
            showToast('Vui l√≤ng ƒëƒÉng nh·∫≠p', 'warning');
          } else {
            alert('Vui l√≤ng ƒëƒÉng nh·∫≠p');
          }
          setTimeout(() => window.location.href = 'login.html', 2000);
          return;
        }

        function getCustomerIdFromToken(token) {
          try {
            const parts = token.split('.');
            if (parts.length >= 2) {
              const payload = JSON.parse(atob(parts[1]));
              return payload.CustomerId || payload.customerId || null;
            }
          } catch(e) {
            console.warn('Error decoding token:', e);
          }
          return null;
        }
        
        let customerIdFromToken = getCustomerIdFromToken(token);
        const user = JSON.parse(userStr);
        customerId = customerIdFromToken || user.customerId || user.userId || user.CustomerId;
        
        console.log('üîµ [loadProfile] CustomerId from token:', customerIdFromToken);
        console.log('üîµ [loadProfile] CustomerId from user:', user.customerId || user.userId || user.CustomerId);
        console.log('üîµ [loadProfile] Final CustomerId:', customerId);
        
        if (!customerId) {
          const msg = 'Kh√¥ng t√¨m th·∫•y th√¥ng tin kh√°ch h√†ng. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i';
          if (window.showToast) {
            showToast(msg, 'error');
          } else {
            alert(msg);
          }
          setTimeout(() => window.location.href = 'login.html', 2000);
          return;
        }

        showPageLoading('ƒêang t·∫£i th√¥ng tin...');
        
        // ∆Øu ti√™n d√πng endpoint /my ƒë·ªÉ l·∫•y th√¥ng tin t·ª´ JWT token
        // Fallback v·ªÅ endpoint /{id} n·∫øu c·∫ßn
        let API_CUSTOMERS = location.origin + '/api/customermanagement/my?_=' + Date.now();
        let resp = await fetch(API_CUSTOMERS, {
          cache: 'no-store',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        // N·∫øu endpoint /my kh√¥ng ho·∫°t ƒë·ªông (403 ho·∫∑c 404), th·ª≠ endpoint /{id}
        if (!resp.ok && customerId) {
          console.log('‚ö†Ô∏è [loadProfile] /my endpoint failed, trying /{id} endpoint');
          API_CUSTOMERS = location.origin + '/api/customermanagement/' + customerId + '?_=' + Date.now();
          resp = await fetch(API_CUSTOMERS, {
            cache: 'no-store',
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });
        }

        if (!resp.ok) {
          const errorText = await resp.text();
          console.error('API Error:', resp.status, errorText);
          let errorMsg = 'Kh√¥ng th·ªÉ t·∫£i th√¥ng tin';
          try {
            const errorData = JSON.parse(errorText);
            errorMsg = errorData.message || errorMsg;
          } catch(e) {
            // Keep default errorMsg
          }
          throw new Error(errorMsg);
        }

        const customer = await resp.json();
        originalData = {...customer};
        // C·∫≠p nh·∫≠t customerId t·ª´ response n·∫øu c√≥
        if (customer.customerId && !customerId) {
          customerId = customer.customerId;
        }
        renderProfile(customer);
        
      } catch(e) {
        console.error('Error loading profile:', e);
        const msg = 'L·ªói t·∫£i th√¥ng tin: ' + e.message;
        if (window.showToast) {
          showToast(msg, 'error');
        } else {
          alert(msg);
        }
      } finally {
        hidePageLoading();
      }
    }

    function renderProfile(customer) {
      // Normalize field names t·ª´ API response (c√≥ th·ªÉ l√† CustomerId ho·∫∑c customerId)
      const normalized = {
        fullName: customer.fullName || customer.FullName || '',
        email: customer.email || customer.Email || '',
        phoneNumber: customer.phoneNumber || customer.PhoneNumber || '',
        dateOfBirth: customer.dateOfBirth || customer.DateOfBirth,
        nationality: customer.nationality || customer.Nationality || 'Vietnam',
        address: customer.address || customer.Address || '',
        idCardNumber: customer.idCardNumber || customer.IdCardNumber || '',
        passportNumber: customer.passportNumber || customer.PassportNumber || '',
        totalSpent: customer.totalSpent || customer.TotalSpent || 0,
        loyaltyPoints: customer.loyaltyPoints || customer.LoyaltyPoints || 0,
        customerType: customer.customerType || customer.CustomerType || 'Regular',
        customerId: customer.customerId || customer.CustomerId,
        avatarUrl: customer.avatarUrl || customer.AvatarUrl || null
      };
      
      document.getElementById('profileName').textContent = normalized.fullName || normalized.email || 'Kh√°ch h√†ng';
      document.getElementById('profileEmail').textContent = normalized.email || '';
      
      document.getElementById('fullName').value = normalized.fullName;
      document.getElementById('email').value = normalized.email;
      document.getElementById('phoneNumber').value = normalized.phoneNumber;
      document.getElementById('dateOfBirth').value = formatDate(normalized.dateOfBirth);
      document.getElementById('nationality').value = normalized.nationality;
      document.getElementById('address').value = normalized.address;
      document.getElementById('idCardNumber').value = normalized.idCardNumber;
      document.getElementById('passportNumber').value = normalized.passportNumber;
      
      document.getElementById('totalSpent').textContent = vnd(normalized.totalSpent);
      document.getElementById('loyaltyPoints').textContent = normalized.loyaltyPoints;
      document.getElementById('customerType').textContent = normalized.customerType === 'VIP' ? 'VIP' : 'Th∆∞·ªùng';
      
      // Update avatar display
      const avatarImg = document.getElementById('profileAvatarImg');
      const avatarPlaceholder = document.getElementById('profileAvatarPlaceholder');
      if (normalized.avatarUrl) {
        avatarImg.src = normalized.avatarUrl;
        avatarImg.style.display = 'block';
        avatarPlaceholder.style.display = 'none';
      } else {
        avatarImg.style.display = 'none';
        avatarPlaceholder.style.display = 'flex';
      }
      
      // ƒê·∫£m b·∫£o email lu√¥n readonly
      document.getElementById('email').readOnly = true;
      document.getElementById('email').style.cursor = 'not-allowed';
      
      // C·∫≠p nh·∫≠t customerId n·∫øu c√≥
      if (normalized.customerId && !customerId) {
        customerId = normalized.customerId;
      }
      
      // Load booking count
      loadBookingCount();
    }

    async function loadBookingCount() {
      try {
        const token = localStorage.getItem('token');
        const API_BOOKINGS = location.origin + '/api/bookings/customer/' + customerId + '?_=' + Date.now();
        const resp = await fetch(API_BOOKINGS, {
          cache: 'no-store',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (resp.ok) {
          const bookings = await resp.json();
          document.getElementById('totalBookings').textContent = Array.isArray(bookings) ? bookings.length : 0;
        }
      } catch(e) {
        console.warn('Could not load booking count:', e);
      }
    }

    function toggleEdit() {
      isEditing = !isEditing;
      const inputs = document.querySelectorAll('.info-value input, .info-value textarea, .info-value select');
      inputs.forEach(input => {
        // Email lu√¥n readonly, kh√¥ng cho s·ª≠a
        if (input.id === 'email') {
          input.readOnly = true;
          input.style.cursor = 'not-allowed';
          input.style.opacity = '0.7';
        } else {
          input.readOnly = !isEditing;
        }
        
        if (isEditing && input.id !== 'email') { // Email kh√¥ng cho s·ª≠a
          input.style.borderBottom = '2px solid #C8A97E';
          input.style.padding = '8px 12px';
          input.style.background = 'rgba(200,169,126,0.05)';
          input.style.borderRadius = '8px';
        } else if (input.id !== 'email') {
          input.style.borderBottom = 'none';
          input.style.padding = '8px 0';
          input.style.background = 'transparent';
          input.style.borderRadius = '0';
        }
      });
      
      document.getElementById('btnEdit').style.display = isEditing ? 'none' : 'inline-block';
      document.getElementById('btnSave').style.display = isEditing ? 'inline-block' : 'none';
      document.getElementById('btnCancel').style.display = isEditing ? 'inline-block' : 'none';
    }

    function cancelEdit() {
      renderProfile(originalData);
      toggleEdit();
    }

    async function saveProfile() {
      try {
        const token = localStorage.getItem('token');
        if (!token) {
          const msg = 'Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i';
          if (window.showToast) {
            showToast(msg, 'warning');
          } else {
            alert(msg);
          }
          return;
        }

        // Validate form
        const fullName = document.getElementById('fullName').value.trim();
        if (!fullName) {
          const msg = 'Vui l√≤ng nh·∫≠p h·ªç v√† t√™n';
          if (window.showToast) {
            showToast(msg, 'error');
          } else {
            alert(msg);
          }
          return;
        }

        // Email kh√¥ng th·ªÉ thay ƒë·ªïi, l·∫•y t·ª´ originalData
        const email = originalData.email || originalData.Email || document.getElementById('email').value.trim();
        
        const updateData = {
          fullName: fullName,
          email: email, // Email kh√¥ng thay ƒë·ªïi ƒë∆∞·ª£c, l·∫•y t·ª´ d·ªØ li·ªáu g·ªëc
          phoneNumber: document.getElementById('phoneNumber').value.trim(),
          dateOfBirth: document.getElementById('dateOfBirth').value || null,
          nationality: document.getElementById('nationality').value.trim() || 'Vietnam',
          address: document.getElementById('address').value.trim(),
          idCardNumber: document.getElementById('idCardNumber').value.trim(),
          passportNumber: document.getElementById('passportNumber').value.trim(),
          customerType: originalData.customerType || originalData.CustomerType || 'Regular',
          notes: originalData.notes || originalData.Notes || ''
        };
        
        console.log('üì§ [saveProfile] Sending update data:', updateData);

        showPageLoading('ƒêang l∆∞u th√¥ng tin...');
        
        const API_CUSTOMERS = location.origin + '/api/customermanagement/' + customerId;
        const resp = await fetch(API_CUSTOMERS, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(updateData)
        });

        if (!resp.ok) {
          const errorData = await resp.json().catch(() => ({message: 'L·ªói c·∫≠p nh·∫≠t'}));
          console.error('API Error:', resp.status, errorData);
          throw new Error(errorData.message || 'L·ªói c·∫≠p nh·∫≠t');
        }

        const response = await resp.json();
        console.log('‚úÖ [saveProfile] API Response:', response);
        
        // API tr·∫£ v·ªÅ { message: "...", customer: {...} } ho·∫∑c tr·ª±c ti·∫øp customer object
        let updated = response.customer || response;
        
        // ƒê·∫£m b·∫£o customerId ƒë∆∞·ª£c l·∫•y ƒë√∫ng t·ª´ response
        if (updated.customerId && !customerId) {
          customerId = updated.customerId;
        } else if (updated.CustomerId && !customerId) {
          customerId = updated.CustomerId;
        }
        
        // Normalize field names (API c√≥ th·ªÉ tr·∫£ v·ªÅ CustomerId ho·∫∑c customerId)
        if (updated.CustomerId && !updated.customerId) {
          updated.customerId = updated.CustomerId;
        }
        if (updated.FullName && !updated.fullName) {
          updated.fullName = updated.FullName;
        }
        if (updated.Email && !updated.email) {
          updated.email = updated.Email;
        }
        if (updated.PhoneNumber && !updated.phoneNumber) {
          updated.phoneNumber = updated.PhoneNumber;
        }
        if (updated.DateOfBirth && !updated.dateOfBirth) {
          updated.dateOfBirth = updated.DateOfBirth;
        }
        if (updated.Nationality && !updated.nationality) {
          updated.nationality = updated.Nationality;
        }
        if (updated.Address && !updated.address) {
          updated.address = updated.Address;
        }
        if (updated.IdCardNumber && !updated.idCardNumber) {
          updated.idCardNumber = updated.IdCardNumber;
        }
        if (updated.PassportNumber && !updated.passportNumber) {
          updated.passportNumber = updated.PassportNumber;
        }
        if (updated.CustomerType && !updated.customerType) {
          updated.customerType = updated.CustomerType;
        }
        
        originalData = {...updated};
        
        const successMsg = 'C·∫≠p nh·∫≠t th√¥ng tin th√†nh c√¥ng!';
        if (window.showToast) {
          showToast(successMsg, 'success');
        } else {
          alert(successMsg);
        }
        
        // Reload profile ƒë·ªÉ ƒë·∫£m b·∫£o d·ªØ li·ªáu m·ªõi nh·∫•t t·ª´ server
        await loadProfile();
        toggleEdit();
        
      } catch(e) {
        console.error('Error saving profile:', e);
        const msg = 'L·ªói: ' + e.message;
        if (window.showToast) {
          showToast(msg, 'error');
        } else {
          alert(msg);
        }
      } finally {
        hidePageLoading();
      }
    }

    // Handle avatar upload
    async function handleAvatarUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      // Validate file type
      const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
      if (!allowedTypes.includes(file.type)) {
        const msg = 'Ch·ªâ ch·∫•p nh·∫≠n file ·∫£nh: JPG, PNG, GIF, WEBP';
        if (window.showToast) {
          showToast(msg, 'error');
        } else {
          alert(msg);
        }
        event.target.value = '';
        return;
      }

      // Validate file size (max 10MB)
      const maxSize = 10 * 1024 * 1024; // 10MB
      if (file.size > maxSize) {
        const msg = 'K√≠ch th∆∞·ªõc file kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 10MB';
        if (window.showToast) {
          showToast(msg, 'error');
        } else {
          alert(msg);
        }
        event.target.value = '';
        return;
      }

      try {
        const token = localStorage.getItem('token');
        if (!token) {
          const msg = 'Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i';
          if (window.showToast) {
            showToast(msg, 'warning');
          } else {
            alert(msg);
          }
          return;
        }

        if (!customerId) {
          const msg = 'Kh√¥ng t√¨m th·∫•y th√¥ng tin kh√°ch h√†ng';
          if (window.showToast) {
            showToast(msg, 'error');
          } else {
            alert(msg);
          }
          return;
        }

        showPageLoading('ƒêang t·∫£i ·∫£nh ƒë·∫°i di·ªán...');

        // Create FormData
        const formData = new FormData();
        formData.append('file', file);

        // Upload avatar
        const API_UPLOAD = location.origin + '/api/customermanagement/' + customerId + '/upload-avatar';
        const resp = await fetch(API_UPLOAD, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          },
          body: formData
        });

        if (!resp.ok) {
          const errorData = await resp.json().catch(() => ({message: 'L·ªói t·∫£i ·∫£nh'}));
          throw new Error(errorData.message || 'L·ªói t·∫£i ·∫£nh');
        }

        const response = await resp.json();
        console.log('‚úÖ [handleAvatarUpload] Avatar uploaded:', response);

        // Update avatar display
        if (response.avatarUrl) {
          const avatarImg = document.getElementById('profileAvatarImg');
          const avatarPlaceholder = document.getElementById('profileAvatarPlaceholder');
          avatarImg.src = response.avatarUrl;
          avatarImg.style.display = 'block';
          avatarPlaceholder.style.display = 'none';
          
          // Update originalData
          originalData.avatarUrl = response.avatarUrl;
          originalData.AvatarUrl = response.avatarUrl;
        } else {
          // Avatar removed
          const avatarImg = document.getElementById('profileAvatarImg');
          const avatarPlaceholder = document.getElementById('profileAvatarPlaceholder');
          avatarImg.style.display = 'none';
          avatarPlaceholder.style.display = 'flex';
          
          originalData.avatarUrl = null;
          originalData.AvatarUrl = null;
        }

        const successMsg = response.message || 'C·∫≠p nh·∫≠t ·∫£nh ƒë·∫°i di·ªán th√†nh c√¥ng!';
        if (window.showToast) {
          showToast(successMsg, 'success');
        } else {
          alert(successMsg);
        }

      } catch(e) {
        console.error('Error uploading avatar:', e);
        const msg = 'L·ªói: ' + e.message;
        if (window.showToast) {
          showToast(msg, 'error');
        } else {
          alert(msg);
        }
      } finally {
        hidePageLoading();
        // Reset file input
        event.target.value = '';
      }
    }

    // Load profile on page load
    document.addEventListener('DOMContentLoaded', function() {
      loadProfile();
    });
  </script>

  <!-- Footer -->
      <footer class="ftco-footer ftco-bg-dark ftco-section">
      <div class="container">
        <div class="row mb-5">
          <div class="col-md">
            <div class="ftco-footer-widget mb-4">
              <h2 class="ftco-heading-2">RESORT DELUXE</h2>
              <p>Khu ngh·ªâ d∆∞·ª°ng cao c·∫•p v·ªõi kh√¥ng gian sang tr·ªçng, d·ªãch v·ª• chu ƒë√°o v√† ti·ªán nghi hi·ªán ƒë·∫°i, mang ƒë·∫øn cho b·∫°n k·ª≥ ngh·ªâ tr·ªçn v·∫πn.</p>
              <ul class="ftco-footer-social list-unstyled float-md-left float-lft mt-5">
                <li class="ftco-animate"><a href="#" style="display: block !important; visibility: visible !important; opacity: 1 !important;"><span class="icon-twitter"></span></a></li>
                <li class="ftco-animate"><a href="#" style="display: block !important; visibility: visible !important; opacity: 1 !important;"><span class="icon-facebook"></span></a></li>
                <li class="ftco-animate"><a href="#" style="display: block !important; visibility: visible !important; opacity: 1 !important;"><span class="icon-instagram"></span></a></li>
              </ul>
            </div>
          </div>
          <div class="col-md">
            <div class="ftco-footer-widget mb-4 ml-md-5">
              <h2 class="ftco-heading-2">Li√™n k·∫øt h·ªØu √≠ch</h2>
              <ul class="list-unstyled">
                <li><a href="#" class="py-2 d-block">Blog</a></li>
                <li><a href="#" class="py-2 d-block">Ph√≤ng</a></li>
                <li><a href="#" class="py-2 d-block">Ti·ªán √≠ch</a></li>
                <li><a href="#" class="py-2 d-block">Th·∫ª qu√† t·∫∑ng</a></li>
              </ul>
            </div>
          </div>
          <div class="col-md">
             <div class="ftco-footer-widget mb-4">
              <h2 class="ftco-heading-2">Ch√≠nh s√°ch</h2>
              <ul class="list-unstyled">
                <li><a href="#" class="py-2 d-block">Tuy·ªÉn d·ª•ng</a></li>
                <li><a href="#" class="py-2 d-block">V·ªÅ ch√∫ng t√¥i</a></li>
                <li><a href="#" class="py-2 d-block">Li√™n h·ªá</a></li>
                <li><a href="#" class="py-2 d-block">D·ªãch v·ª•</a></li>
              </ul>
            </div>
          </div>
          <div class="col-md">
            <div class="ftco-footer-widget mb-4">
                <h2 class="ftco-heading-2">B·∫°n c·∫ßn h·ªó tr·ª£?</h2>
            	<div class="block-23 mb-3">
	              <ul>
                <li><span class="icon icon-map-marker"></span><span class="text">Huflit H·ªëc M√¥n, H·ªì Ch√≠ Minh</span></li>
                <li><a href="#"><span class="icon icon-phone"></span><span class="text">+84 901 329 227</span></a></li>
                <li><a href="#"><span class="icon icon-envelope"></span><span class="text">support@resortdeluxe.vn</span></a></li>
	              </ul>
	            </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-12 text-center">
            <p>Copyright ¬©<script>document.write(new Date().getFullYear());</script>2025 All rights reserved</p>
          </div>
        </div>
      </div>
    </footer>
  
  <!-- AI Chat Widget -->
  <script src="js/ai-chat.js"></script>
</body>
</html>
