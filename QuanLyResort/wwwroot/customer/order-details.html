<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chi ti·∫øt ƒë∆°n ƒë·∫∑t m√≥n - Resort Deluxe</title>
  
  <!-- NO CACHE -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  
  <!-- CSS -->
  <link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/open-iconic-bootstrap.min.css">
  
  <!-- Design System CSS -->
  <link rel="stylesheet" href="/css/tokens.css">
  <link rel="stylesheet" href="/css/globals.css">
  <link rel="stylesheet" href="/css/grid.css">
  <link rel="stylesheet" href="/css/components/navbar.css">
  <link rel="stylesheet" href="css/navbar-auth.css">
</head>
<body>
  <!-- Header placeholder - will be loaded by load-header.js -->
  <div id="header-placeholder"></div>
  
  <!-- Load header component -->
  <script src="js/load-header.js"></script>
  
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      padding-top: 0;
      overflow-x: hidden;
      background: #f8f9fa;
    }
    .ftco-navbar {
      position: sticky !important;
      top: 0 !important;
      z-index: 1030 !important;
      background-color: #1a1a1a !important;
      width: 100% !important;
      margin: 0 !important;
    }
  </style>

  <!-- Hero Section -->
  <section class="hero-wrap" style="background-image: url('images/bg_1.jpg');">
    <div class="overlay"></div>
    <div class="container">
      <div class="row no-gutters slider-text d-flex align-itemd-end justify-content-center">
        <div class="col-md-9 ftco-animate text-center d-flex align-items-end justify-content-center">
          <div class="text">
            <p class="breadcrumbs mb-2"><span class="mr-2"><a href="index.html">Trang ch·ªß</a></span> <span>Chi ti·∫øt ƒë∆°n ƒë·∫∑t m√≥n</span></p>
            <h1 class="mb-4 bread">Chi ti·∫øt ƒë∆°n ƒë·∫∑t m√≥n</h1>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Order Details Section -->
  <section class="ftco-section ftco-degree-bg">
    <div class="container">
      <div class="row">
        <div class="col-lg-12">
          
          <!-- Loading State -->
          <div id="loadingState" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
              <span class="sr-only">ƒêang t·∫£i...</span>
            </div>
            <p class="mt-3">ƒêang t·∫£i th√¥ng tin ƒë∆°n h√†ng...</p>
          </div>

          <!-- Error State -->
          <div id="errorState" class="alert alert-danger" style="display: none;">
            <h4 class="alert-heading">L·ªói!</h4>
            <p id="errorMessage">Kh√¥ng th·ªÉ t·∫£i th√¥ng tin ƒë∆°n h√†ng.</p>
            <hr>
            <button class="btn btn-primary" onclick="location.reload()">T·∫£i l·∫°i</button>
            <a href="restaurant.html" class="btn btn-secondary">Quay l·∫°i nh√† h√†ng</a>
          </div>

          <!-- Order Details Card -->
          <div id="orderDetailsCard" class="card shadow-lg border-0" style="display: none; border-radius: 16px; overflow: hidden;">
            
            <!-- Header -->
            <div class="card-header bg-gradient-primary text-white" style="background: linear-gradient(135deg, var(--color-primary-main, #C8A97E) 0%, var(--color-primary-dark, #B89968) 100%); padding: 2rem;">
              <div class="row align-items-center">
                <div class="col-md-8">
                  <h2 class="mb-2" style="font-size: 28px; font-weight: 700;">
                    <i class="icon-shopping-cart me-2"></i>
                    ƒê∆°n ƒë·∫∑t m√≥n <span id="orderNumber">#ORD0000000</span>
                  </h2>
                  <p class="mb-0" style="opacity: 0.9;" id="orderDate">Ng√†y ƒë·∫∑t: --</p>
                </div>
                <div class="col-md-4 text-md-end">
                  <div id="statusBadge" class="badge badge-lg" style="font-size: 16px; padding: 0.75rem 1.5rem;">
                    Ch·ªù x·ª≠ l√Ω
                  </div>
                  <div id="paymentBadge" class="badge badge-lg mt-2" style="font-size: 14px; padding: 0.5rem 1rem;">
                    Ch∆∞a thanh to√°n
                  </div>
                </div>
              </div>
            </div>

            <!-- Body -->
            <div class="card-body p-4">
              
              <!-- Customer Info -->
              <div class="row mb-4">
                <div class="col-md-6 mb-3">
                  <div class="info-box p-3" style="background: #f8f9fa; border-radius: 8px;">
                    <h5 class="mb-3" style="color: var(--color-primary-main, #C8A97E); font-weight: 600;">
                      <i class="icon-user me-2"></i>Th√¥ng tin kh√°ch h√†ng
                    </h5>
                    <p class="mb-1"><strong>T√™n:</strong> <span id="customerName">--</span></p>
                    <p class="mb-1"><strong>Email:</strong> <span id="customerEmail">--</span></p>
                    <p class="mb-0"><strong>ƒêi·ªán tho·∫°i:</strong> <span id="customerPhone">--</span></p>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <div class="info-box p-3" style="background: #f8f9fa; border-radius: 8px;">
                    <h5 class="mb-3" style="color: var(--color-primary-main, #C8A97E); font-weight: 600;">
                      <i class="icon-location-pin me-2"></i>Th√¥ng tin giao h√†ng
                    </h5>
                    <p class="mb-1"><strong>ƒê·ªãa ch·ªâ:</strong> <span id="deliveryAddress">--</span></p>
                    <p class="mb-1"><strong>Th·ªùi gian mong mu·ªën:</strong> <span id="deliveryTime">--</span></p>
                    <p class="mb-0"><strong>Ph∆∞∆°ng th·ª©c thanh to√°n:</strong> <span id="paymentMethod">--</span></p>
                  </div>
                </div>
              </div>

              <!-- Order Items -->
              <div class="mb-4">
                <h5 class="mb-3" style="color: var(--color-primary-main, #C8A97E); font-weight: 600;">
                  <i class="icon-list me-2"></i>Danh s√°ch m√≥n ƒë√£ ƒë·∫∑t
                </h5>
                <div class="table-responsive">
                  <table class="table table-hover" id="orderItemsTable">
                    <thead style="background: var(--color-primary-main, #C8A97E); color: white;">
                      <tr>
                        <th style="border: none;">M√≥n ƒÉn</th>
                        <th style="border: none;" class="text-center">ƒê∆°n gi√°</th>
                        <th style="border: none;" class="text-center">S·ªë l∆∞·ª£ng</th>
                        <th style="border: none;" class="text-end">Th√†nh ti·ªÅn</th>
                      </tr>
                    </thead>
                    <tbody id="orderItemsBody">
                      <!-- Items will be loaded here -->
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- Special Requests -->
              <div id="specialRequestsSection" class="mb-4" style="display: none;">
                <div class="alert alert-info" style="border-radius: 8px;">
                  <h6 class="mb-2"><i class="icon-info me-2"></i>Ghi ch√∫ ƒë·∫∑c bi·ªát:</h6>
                  <p class="mb-0" id="specialRequests">--</p>
                </div>
              </div>

              <!-- Total Amount -->
              <div class="row">
                <div class="col-md-6 offset-md-6">
                  <div class="p-3" style="background: #f8f9fa; border-radius: 8px;">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <span class="text-muted">T·∫°m t√≠nh:</span>
                      <span id="subTotal">0 ‚Ç´</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <span class="text-muted">VAT (10%):</span>
                      <span id="vatAmount">0 ‚Ç´</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center">
                      <strong style="font-size: 20px;">T·ªïng ti·ªÅn:</strong>
                      <strong id="totalAmount" style="font-size: 24px; color: var(--color-primary-main, #C8A97E);">0 ‚Ç´</strong>
                    </div>
                  </div>
                </div>
              </div>

            </div>

            <!-- Footer Actions -->
            <div class="card-footer bg-light p-4" style="border-top: 1px solid #dee2e6;">
              <div class="row">
                <div class="col-md-6 mb-2">
                  <a href="restaurant.html" class="btn btn-outline-secondary w-100">
                    <i class="icon-arrow-left me-2"></i>Quay l·∫°i nh√† h√†ng
                  </a>
                </div>
                <div class="col-md-6 mb-2">
                  <button id="btnPayNow" class="btn btn-primary w-100" onclick="openRestaurantPaymentFromDetails()" style="display: none;">
                    <i class="icon-credit-card me-2"></i>Thanh to√°n ngay
                  </button>
                  <button id="btnViewOrders" class="btn btn-primary w-100" onclick="window.location.href='restaurant.html#my-orders'" style="display: none;">
                    <i class="icon-list me-2"></i>Xem t·∫•t c·∫£ ƒë∆°n h√†ng
                  </button>
                </div>
              </div>
            </div>

          </div>

        </div>
      </div>
    </div>
  </section>

  <!-- Restaurant Payment Modal (PayOs) -->
  <div class="modal fade" id="restaurantPaymentModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content" style="border-radius: 20px;">
        <div class="modal-header" style="background: linear-gradient(135deg, #c8a97e 0%, #b89968 100%); color: white;">
          <h5 class="modal-title" style="font-size: 24px; font-weight: 700;">üí≥ Thanh To√°n ƒê∆°n H√†ng</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" style="padding: 30px;">
          <div class="text-center mb-4">
            <h6>M√£ ƒë∆°n h√†ng: <strong id="rpOrderNumber">-</strong></h6>
            <h4 class="text-primary">S·ªë ti·ªÅn: <span id="rpAmount">0 ‚Ç´</span></h4>
          </div>

          <div id="rpQRSection">
            <p class="text-center mb-3">
              <strong>N·ªôi dung chuy·ªÉn kho·∫£n:</strong><br>
              <code id="rpContent" style="background: #f8f9fa; padding: 8px 12px; border-radius: 8px; font-size: 16px; font-weight: 600;">ORDER-</code>
            </p>
            <div class="text-center mb-4">
              <img id="rpQRImage" alt="QR Code" style="max-width: 300px; border: 4px solid #e9ecef; border-radius: 15px; padding: 15px; display: none;">
            </div>
            <div class="card" style="background: #f8f9fa; padding: 20px; border-radius: 12px;">
              <p class="mb-2"><strong>Ng√¢n h√†ng:</strong> MBBank</p>
              <p class="mb-2"><strong>S·ªë t√†i kho·∫£n:</strong> <span id="rpBankAccount">0901329227</span></p>
              <p class="mb-0"><strong>Ch·ªß t√†i kho·∫£n:</strong> <span id="rpBankName">PHAM THANH LAM</span></p>
            </div>
          </div>

          <div id="rpWaiting" class="text-center mt-4" style="display: block;">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2">ƒêang ch·ªù thanh to√°n...</p>
          </div>

          <div id="rpSuccess" class="text-center mt-4" style="display: none;">
            <div class="alert alert-success">
              <h5>‚úÖ Thanh to√°n th√†nh c√¥ng!</h5>
              <p>ƒêang c·∫≠p nh·∫≠t th√¥ng tin...</p>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Payment Modal (Old - kept for compatibility) -->
  <div class="modal fade" id="paymentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header" style="background: linear-gradient(135deg, var(--color-primary-main, #C8A97E) 0%, var(--color-primary-dark, #B89968) 100%); color: white;">
          <h5 class="modal-title" style="font-size: 20px; font-weight: 600;">
            <i class="icon-credit-card me-2"></i>Thanh to√°n ƒë∆°n h√†ng
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-4">
          <div class="mb-3">
            <label class="form-label" style="font-weight: 600;">M√£ ƒë∆°n h√†ng</label>
            <input type="text" class="form-control" id="modalOrderNumber" readonly style="font-size: 18px; font-weight: 600;">
          </div>
          <div class="mb-3">
            <label class="form-label" style="font-weight: 600;">S·ªë ti·ªÅn c·∫ßn thanh to√°n</label>
            <input type="text" class="form-control" id="modalTotalAmount" readonly style="font-size: 20px; font-weight: 700; color: var(--color-primary-main, #C8A97E);">
          </div>
          <div class="mb-3">
            <label class="form-label" style="font-weight: 600;">Ph∆∞∆°ng th·ª©c thanh to√°n</label>
            <select id="paymentMethodSelect" class="form-select" style="font-size: 16px; padding: 0.75rem;">
              <option value="QR">üí≥ Chuy·ªÉn kho·∫£n QR (VietQR)</option>
              <option value="Cash">üíµ Thanh to√°n t·∫°i nh√† h√†ng</option>
            </select>
          </div>

          <!-- Cash Payment Confirmation Section -->
          <div id="cashSection" style="display: none; padding: 20px; background: #f8f9fa; border-radius: 12px; text-align: center;">
            <div style="font-size: 48px; margin-bottom: 16px;">üíµ</div>
            <h5 style="color: #1a1a1a; margin-bottom: 12px;">Thanh to√°n t·∫°i nh√† h√†ng</h5>
            <p style="color: #6b7280; margin-bottom: 20px;">Vui l√≤ng thanh to√°n tr·ª±c ti·∫øp t·∫°i qu·∫ßy thanh to√°n c·ªßa nh√† h√†ng khi nh·∫≠n m√≥n.</p>
            <div style="background: white; padding: 16px; border-radius: 8px; border: 2px solid #c8a97e;">
              <p class="mb-1"><strong>M√£ ƒë∆°n h√†ng:</strong> <span id="cashOrderNumber">-</span></p>
              <p class="mb-0"><strong>S·ªë ti·ªÅn:</strong> <span id="cashTotalAmount" style="color: #c8a97e; font-size: 18px; font-weight: 700;">0 ‚Ç´</span></p>
            </div>
          </div>
          
          <!-- QR Code Section -->
          <div id="qrSection" class="text-center p-4" style="background: #f8f9fa; border-radius: 8px; display: none;">
            <h6 class="mb-3">Qu√©t m√£ QR ƒë·ªÉ thanh to√°n</h6>
            <div id="qrCodeContainer" style="display: inline-block; padding: 1rem; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
              <img id="qrCodeImage" src="" alt="QR Code" style="max-width: 250px; height: auto;">
            </div>
            <div class="mt-3" style="font-size: 14px;">
              <p class="mb-1"><strong>Ng√¢n h√†ng:</strong> MBBank</p>
              <p class="mb-1"><strong>STK:</strong> 0901329227</p>
              <p class="mb-0"><strong>Ch·ªß TK:</strong> Resort Deluxe</p>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
          <button type="button" class="btn btn-primary" id="confirmPaymentBtn" onclick="window.confirmPayment()">
            <i class="icon-check me-2"></i>X√°c nh·∫≠n ƒë√£ thanh to√°n
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="ftco-footer ftco-bg-dark ftco-section">
    <div class="container">
      <div class="row mb-5">
        <div class="col-md">
          <div class="ftco-footer-widget mb-4">
            <h2 class="ftco-heading-2">RESORT DELUXE</h2>
            <p>Khu ngh·ªâ d∆∞·ª°ng cao c·∫•p v·ªõi ƒë·∫ßy ƒë·ªß ti·ªán nghi hi·ªán ƒë·∫°i, ph·ª•c v·ª• chu ƒë√°o v√† kh√¥ng gian tuy·ªát ƒë·∫πp.</p>
            <ul class="ftco-footer-social list-unstyled float-md-left float-lft mt-5">
              <li class="ftco-animate"><a href="#"><span class="icon-twitter"></span></a></li>
              <li class="ftco-animate"><a href="#"><span class="icon-facebook"></span></a></li>
              <li class="ftco-animate"><a href="#"><span class="icon-instagram"></span></a></li>
            </ul>
          </div>
        </div>
        <div class="col-md">
          <div class="ftco-footer-widget mb-4 ml-md-5">
            <h2 class="ftco-heading-2">Li√™n k·∫øt h·ªØu √≠ch</h2>
            <ul class="list-unstyled">
              <li><a href="blog.html" class="py-2 d-block">Blog</a></li>
              <li><a href="rooms.html" class="py-2 d-block">Ph√≤ng</a></li>
              <li><a href="restaurant.html" class="py-2 d-block">Nh√† h√†ng</a></li>
              <li><a href="#" class="py-2 d-block">Ti·ªán √≠ch</a></li>
            </ul>
          </div>
        </div>
        <div class="col-md">
          <div class="ftco-footer-widget mb-4">
            <h2 class="ftco-heading-2">Ch√≠nh s√°ch</h2>
            <ul class="list-unstyled">
              <li><a href="#" class="py-2 d-block">Tuy·ªÉn d·ª•ng</a></li>
              <li><a href="about.html" class="py-2 d-block">V·ªÅ ch√∫ng t√¥i</a></li>
              <li><a href="contact.html" class="py-2 d-block">Li√™n h·ªá</a></li>
              <li><a href="#" class="py-2 d-block">D·ªãch v·ª•</a></li>
            </ul>
          </div>
        </div>
        <div class="col-md">
          <div class="ftco-footer-widget mb-4">
            <h2 class="ftco-heading-2">B·∫°n c·∫ßn h·ªó tr·ª£?</h2>
            <div class="block-23 mb-3">
              <ul>
                <li><span class="icon icon-map-marker"></span><span class="text">123 ƒê∆∞·ªùng Bi·ªÉn Xanh, Th√†nh ph·ªë Bi·ªÉn, Vi·ªát Nam</span></li>
                <li><a href="#"><span class="icon icon-phone"></span><span class="text">+84 901 329 227</span></a></li>
                <li><a href="#"><span class="icon icon-envelope"></span><span class="text">support@resortdeluxe.vn</span></a></li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-12 text-center">
          <p><!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
Copyright &copy;<script>document.write(new Date().getFullYear());</script> All rights reserved | This template is made with <i class="icon-heart color-danger" aria-hidden="true"></i> by <a href="https://colorlib.com" target="_blank">Colorlib</a>
<!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. --></p>
        </div>
      </div>
    </div>
  </footer>

  <!-- Scripts -->
  <script src="js/jquery.min.js"></script>
  <script src="js/jquery-migrate-3.0.1.min.js"></script>
  <script src="js/popper.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/jquery.easing.1.3.js"></script>
  <script src="js/jquery.waypoints.min.js"></script>
  <script src="js/jquery.stellar.min.js"></script>
  <script src="js/owl.carousel.min.js"></script>
  <script src="js/jquery.magnific-popup.min.js"></script>
  <script src="js/aos.js"></script>
  <script src="js/jquery.animateNumber.min.js"></script>
  <script src="js/bootstrap-datepicker.js"></script>
  <script src="js/jquery.timepicker.min.js"></script>
  <script src="js/main.js"></script>
  <script src="../js/api.js"></script>
  <script src="js/navbar-auth.js"></script>
  <!-- QRCode.js for generating QR from EMV data -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <!-- Restaurant Payment (PayOs) -->
  <script src="js/restaurant-payment.js"></script>

  <script>
    // Get orderId from URL
    const urlParams = new URLSearchParams(window.location.search);
    const orderId = urlParams.get('orderId');
    
    // Helper function to open restaurant payment from order details page
    window.openRestaurantPaymentFromDetails = function() {
      if (!orderId) {
        showError('Kh√¥ng t√¨m th·∫•y m√£ ƒë∆°n h√†ng');
        return;
      }
      if (typeof openRestaurantPayment === 'function') {
        openRestaurantPayment(parseInt(orderId));
      } else {
        console.error('[OrderDetails] openRestaurantPayment function not found');
        showError('H·ªá th·ªëng thanh to√°n ch∆∞a s·∫µn s√†ng. Vui l√≤ng th·ª≠ l·∫°i sau.');
      }
    };
    
    if (!orderId) {
      showError('Kh√¥ng t√¨m th·∫•y m√£ ƒë∆°n h√†ng. Vui l√≤ng quay l·∫°i trang ƒë·∫∑t m√≥n.');
    } else {
      loadOrderDetails(orderId);
    }

    async function loadOrderDetails(orderId) {
      try {
        console.log('[OrderDetails] Loading order:', orderId);
        showPageLoading();
        
        const token = localStorage.getItem('token');
        const headers = {
          'Content-Type': 'application/json'
        };
        if (token) {
          headers['Authorization'] = `Bearer ${token}`;
        }

        const response = await fetch(`${location.origin}/api/restaurant-orders/${orderId}`, {
          method: 'GET',
          headers: headers,
          cache: 'no-store'
        });

        console.log('[OrderDetails] Response status:', response.status);

        if (!response.ok) {
          if (response.status === 401) {
            throw new Error('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem chi ti·∫øt ƒë∆°n h√†ng');
          } else if (response.status === 404) {
            throw new Error('Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng');
          } else {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.message || `L·ªói ${response.status}: ${response.statusText}`);
          }
        }

        const order = await response.json();
        console.log('[OrderDetails] Order loaded:', order);

        // Hide loading, show order details
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('orderDetailsCard').style.display = 'block';
        
        renderOrderDetails(order);

      } catch (error) {
        console.error('[OrderDetails] Error:', error);
        showError(error.message || 'Kh√¥ng th·ªÉ t·∫£i th√¥ng tin ƒë∆°n h√†ng');
      } finally {
        hidePageLoading();
      }
    }

    function renderOrderDetails(order) {
      // Order Number & Date
      document.getElementById('orderNumber').textContent = order.orderNumber || `#${order.orderId}`;
      if (order.createdAt) {
        const date = new Date(order.createdAt);
        document.getElementById('orderDate').textContent = `Ng√†y ƒë·∫∑t: ${date.toLocaleString('vi-VN')}`;
      }

      // Status Badges
      const statusBadge = document.getElementById('statusBadge');
      const status = order.status || 'Pending';
      statusBadge.className = `badge badge-lg ${getStatusClass(status)}`;
      statusBadge.textContent = getStatusText(status);

      const paymentBadge = document.getElementById('paymentBadge');
      const paymentStatus = order.paymentStatus || 'Unpaid';
      paymentBadge.className = `badge badge-lg ${getPaymentStatusClass(paymentStatus)}`;
      paymentBadge.textContent = getPaymentStatusText(paymentStatus);

      // Customer Info
      if (order.customer) {
        document.getElementById('customerName').textContent = order.customer.fullName || '--';
        document.getElementById('customerEmail').textContent = order.customer.email || '--';
        document.getElementById('customerPhone').textContent = order.customer.phoneNumber || '--';
      } else {
        document.getElementById('customerName').textContent = 'Kh√°ch v√£ng lai';
        document.getElementById('customerEmail').textContent = '--';
        document.getElementById('customerPhone').textContent = '--';
      }

      // Delivery Info
      document.getElementById('deliveryAddress').textContent = order.deliveryAddress || 'Ch∆∞a c√≥';
      if (order.requestedDeliveryTime) {
        const deliveryDate = new Date(order.requestedDeliveryTime);
        document.getElementById('deliveryTime').textContent = deliveryDate.toLocaleString('vi-VN');
      } else {
        document.getElementById('deliveryTime').textContent = 'Kh√¥ng ch·ªâ ƒë·ªãnh';
      }
      document.getElementById('paymentMethod').textContent = getPaymentMethodText(order.paymentMethod || 'Cash');

      // Order Items
      const itemsBody = document.getElementById('orderItemsBody');
      itemsBody.innerHTML = '';

      if (order.orderItems && order.orderItems.length > 0) {
        let subTotal = 0;
        order.orderItems.forEach(item => {
          const itemTotal = (item.unitPrice || 0) * (item.quantity || 0);
          subTotal += itemTotal;
          
          const row = `
            <tr>
              <td>
                <strong>${item.service?.serviceName || 'M√≥n ƒÉn'}</strong>
                ${item.specialNote ? `<br><small class="text-muted">Ghi ch√∫: ${item.specialNote}</small>` : ''}
              </td>
              <td class="text-center">${formatCurrency(item.unitPrice || 0)}</td>
              <td class="text-center">${item.quantity || 0}</td>
              <td class="text-end"><strong>${formatCurrency(itemTotal)}</strong></td>
            </tr>
          `;
          itemsBody.innerHTML += row;
        });
      } else {
        itemsBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Kh√¥ng c√≥ m√≥n n√†o</td></tr>';
      }

      // Calculate totals
      const totalAmount = order.totalAmount || 0;
      const vatRate = 0.10; // 10%
      const subTotalCalc = totalAmount / (1 + vatRate);
      const vatAmount = totalAmount - subTotalCalc;

      document.getElementById('subTotal').textContent = formatCurrency(subTotalCalc);
      document.getElementById('vatAmount').textContent = formatCurrency(vatAmount);
      document.getElementById('totalAmount').textContent = formatCurrency(totalAmount);

      // Special Requests
      if (order.specialRequests) {
        document.getElementById('specialRequests').textContent = order.specialRequests;
        document.getElementById('specialRequestsSection').style.display = 'block';
      }

      // Payment Button - ch·ªâ hi·ªÉn th·ªã n√∫t thanh to√°n n·∫øu ch∆∞a thanh to√°n
      const btnPayNow = document.getElementById('btnPayNow');
      const btnViewOrders = document.getElementById('btnViewOrders');
      
      console.log('[renderOrderDetails] Payment status:', paymentStatus, 'Order status:', status);
      
      // Ch·ªâ hi·ªÉn th·ªã n√∫t "Thanh to√°n" n·∫øu:
      // 1. Ch∆∞a thanh to√°n (Unpaid)
      // 2. Status h·ª£p l·ªá ƒë·ªÉ thanh to√°n (Pending, Confirmed, Preparing, Ready)
      // 3. Kh√¥ng ph·∫£i ƒë∆°n h√†ng ƒë√£ h·ªßy
      const canPay = paymentStatus === 'Unpaid' && 
                     (status === 'Pending' || status === 'Confirmed' || status === 'Preparing' || status === 'Ready') &&
                     status !== 'Cancelled';
      
      if (canPay) {
        btnPayNow.style.display = 'block';
        btnViewOrders.style.display = 'none';
      } else {
        btnPayNow.style.display = 'none';
        btnViewOrders.style.display = 'block';
        
        // N·∫øu ƒë√£ thanh to√°n, hi·ªÉn th·ªã message
        if (paymentStatus === 'Paid') {
          console.log('[renderOrderDetails] Order already paid, hiding payment button');
        }
      }

      // Store order data for payment
      window.currentOrder = order;
    }

    function showPaymentModal() {
      if (!window.currentOrder) {
        alert('Kh√¥ng t√¨m th·∫•y th√¥ng tin ƒë∆°n h√†ng');
        return;
      }

      const order = window.currentOrder;
      document.getElementById('modalOrderNumber').value = order.orderNumber;
      document.getElementById('modalTotalAmount').value = formatCurrency(order.totalAmount || 0);

      // Set payment method and update UI
      const paymentMethodSelect = document.getElementById('paymentMethodSelect');
      paymentMethodSelect.value = order.paymentMethod || 'QR';
      updatePaymentMethod();

      // Use jQuery modal (Bootstrap 4) - more compatible
      const modalEl = document.getElementById('paymentModal');
      if (modalEl) {
        try {
          if (typeof $ !== 'undefined' && $.fn.modal) {
            $(modalEl).modal('show');
          } else if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
            // Try Bootstrap 5
            try {
              const modal = new bootstrap.Modal(modalEl);
              modal.show();
            } catch (e) {
              console.warn('[showPaymentModal] Bootstrap modal error:', e);
              // Fallback: manual show
              modalEl.classList.add('show');
              modalEl.style.display = 'block';
              document.body.classList.add('modal-open');
              const backdrop = document.createElement('div');
              backdrop.className = 'modal-backdrop fade show';
              document.body.appendChild(backdrop);
            }
          } else {
            // Fallback: manual show
            modalEl.classList.add('show');
            modalEl.style.display = 'block';
            document.body.classList.add('modal-open');
            const backdrop = document.createElement('div');
            backdrop.className = 'modal-backdrop fade show';
            document.body.appendChild(backdrop);
          }
        } catch (e) {
          console.error('[showPaymentModal] Error showing modal:', e);
        }
      }
    }

    function updatePaymentMethod() {
      const paymentMethod = document.getElementById('paymentMethodSelect').value;
      const qrSection = document.getElementById('qrSection');
      const cashSection = document.getElementById('cashSection');
      
      if (paymentMethod === 'QR') {
        generateQRCode();
        if (qrSection) qrSection.style.display = 'block';
        if (cashSection) cashSection.style.display = 'none';
      } else if (paymentMethod === 'Cash') {
        if (qrSection) qrSection.style.display = 'none';
        if (cashSection) cashSection.style.display = 'block';
        
        // Update cash section info
        if (window.currentOrder) {
          const cashOrderNumber = document.getElementById('cashOrderNumber');
          const cashTotalAmount = document.getElementById('cashTotalAmount');
          if (cashOrderNumber) cashOrderNumber.textContent = window.currentOrder.orderNumber || '-';
          if (cashTotalAmount) cashTotalAmount.textContent = formatCurrency(window.currentOrder.totalAmount || 0);
        }
      }
    }

    // Add event listener for payment method change
    document.addEventListener('DOMContentLoaded', () => {
      const paymentMethodSelect = document.getElementById('paymentMethodSelect');
      if (paymentMethodSelect) {
        paymentMethodSelect.addEventListener('change', updatePaymentMethod);
        
        // Ensure QR is hidden on initial load if Cash is selected
        if (paymentMethodSelect.value !== 'QR') {
          const qrSection = document.getElementById('qrSection');
          if (qrSection) qrSection.style.display = 'none';
        }
      }
    });

    function generateQRCode() {
      if (!window.currentOrder) return;

      const order = window.currentOrder;
      const amount = order.totalAmount || 0;
      const BANK_CODE = 'MB';
      const BANK_ACCOUNT = '0901329227';
      const BANK_ACCOUNT_NAME = 'Resort Deluxe';
      const bookingInfo = `Thanh toan don hang ${order.orderNumber}`;

      // Generate VietQR URL
      const qrUrl = `https://img.vietqr.io/image/${BANK_CODE}-${BANK_ACCOUNT}-compact2.png?amount=${amount}&addInfo=${encodeURIComponent(bookingInfo)}&accountName=${encodeURIComponent(BANK_ACCOUNT_NAME)}`;
      
      const qrImg = document.getElementById('qrCodeImage');
      qrImg.src = qrUrl;
      qrImg.onerror = function() {
        console.error('[QR] Failed to load QR code image');
        qrImg.alt = 'Kh√¥ng th·ªÉ t·∫£i m√£ QR';
      };
    }

    async function confirmPayment() {
      console.log('[confirmPayment] Function called');
      
      if (!window.currentOrder) {
        console.error('[confirmPayment] No currentOrder found');
        alert('Kh√¥ng t√¨m th·∫•y th√¥ng tin ƒë∆°n h√†ng');
        return;
      }

      try {
        const btn = document.getElementById('confirmPaymentBtn');
        if (!btn) {
          console.error('[confirmPayment] Confirm button not found');
          alert('Kh√¥ng t√¨m th·∫•y n√∫t x√°c nh·∫≠n');
          return;
        }
        
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>ƒêang x·ª≠ l√Ω...';

        const orderId = window.currentOrder.orderId;
        const paymentMethod = document.getElementById('paymentMethodSelect')?.value || 'Cash';
        
        console.log('[confirmPayment] OrderId:', orderId);
        console.log('[confirmPayment] PaymentMethod:', paymentMethod);

        const token = localStorage.getItem('token');
        const headers = {
          'Content-Type': 'application/json'
        };
        if (token) {
          headers['Authorization'] = `Bearer ${token}`;
          console.log('[confirmPayment] Token present:', !!token);
        } else {
          console.warn('[confirmPayment] No token found');
        }

        const apiUrl = `${location.origin}/api/restaurant-orders/${orderId}/pay`;
        console.log('[confirmPayment] Calling API:', apiUrl);
        console.log('[confirmPayment] Request body:', { paymentMethod });

        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: headers,
          body: JSON.stringify({
            paymentMethod: paymentMethod
          })
        });

        console.log('[confirmPayment] Response status:', response.status, response.statusText);
        console.log('[confirmPayment] Response ok:', response.ok);

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          console.error('[confirmPayment] Error response:', errorData);
          
          // X·ª≠ l√Ω tr∆∞·ªùng h·ª£p ƒë∆°n h√†ng ƒë√£ ƒë∆∞·ª£c thanh to√°n - reload ƒë·ªÉ c·∫≠p nh·∫≠t UI
          if (response.status === 400 && errorData.message && 
              (errorData.message.includes('ƒë√£ ƒë∆∞·ª£c thanh to√°n') || errorData.message.includes('already paid'))) {
            console.log('[confirmPayment] Order already paid, reloading order details...');
            
            // Close modal first - use jQuery modal (more compatible)
            const modalEl = document.getElementById('paymentModal');
            if (modalEl) {
              try {
                if (typeof $ !== 'undefined' && $.fn.modal) {
                  $(modalEl).modal('hide');
                } else if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                  // Try Bootstrap 5
                  try {
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    if (modal) {
                      modal.hide();
                    } else {
                      // Create new instance and hide
                      const newModal = new bootstrap.Modal(modalEl);
                      newModal.hide();
                    }
                  } catch (e) {
                    console.warn('[confirmPayment] Bootstrap modal error:', e);
                  }
                } else {
                  // Fallback: manual close
                  modalEl.classList.remove('show');
                  modalEl.style.display = 'none';
                  document.body.classList.remove('modal-open');
                  const backdrop = document.querySelector('.modal-backdrop');
                  if (backdrop) backdrop.remove();
                }
              } catch (e) {
                console.warn('[confirmPayment] Error closing modal:', e);
              }
            }
            
            // Show info message v√† reload
            if (typeof showToast === 'function') {
              showToast('ƒê∆°n h√†ng n√†y ƒë√£ ƒë∆∞·ª£c thanh to√°n. ƒêang c·∫≠p nh·∫≠t th√¥ng tin...', 'info');
            }
            
            // Reload order details ƒë·ªÉ c·∫≠p nh·∫≠t UI (·∫©n n√∫t thanh to√°n, hi·ªÉn th·ªã status "ƒê√£ thanh to√°n")
            setTimeout(() => {
              loadOrderDetails(orderId);
            }, 500);
            
            // Reset button state before returning
            const btn = document.getElementById('confirmPaymentBtn');
            if (btn) {
              btn.disabled = false;
              btn.innerHTML = '<i class="icon-check me-2"></i>X√°c nh·∫≠n ƒë√£ thanh to√°n';
            }
            
            return; // Kh√¥ng throw error, ch·ªâ reload - kh√¥ng ch·∫°y v√†o catch block
          }
          
          if (response.status === 401) {
            throw new Error('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ thanh to√°n');
          } else if (response.status === 403) {
            throw new Error('B·∫°n kh√¥ng c√≥ quy·ªÅn thanh to√°n ƒë∆°n h√†ng n√†y');
          } else if (response.status === 404) {
            throw new Error('Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng');
          } else {
            throw new Error(errorData.message || `L·ªói ${response.status}: ${response.statusText}`);
          }
        }

        const result = await response.json();
        console.log('[confirmPayment] ‚úÖ Payment confirmed:', result);

        // Show thank you message in modal instead of closing immediately
        const modalEl = document.getElementById('paymentModal');
        if (modalEl) {
          const modalBody = modalEl.querySelector('.modal-body');
          const modalFooter = modalEl.querySelector('.modal-footer');
          const modalHeader = modalEl.querySelector('.modal-header');
          
          if (modalBody && modalFooter && modalHeader) {
            // Update header
            const headerTitle = modalHeader.querySelector('.modal-title');
            const headerCloseBtn = modalHeader.querySelector('.btn-close');
            if (headerTitle) {
              headerTitle.innerHTML = '‚úÖ C·∫£m ∆°n b·∫°n ƒë√£ thanh to√°n!';
              headerTitle.style.color = '#059669';
            }
            // Ensure close button in header works
            if (headerCloseBtn) {
              headerCloseBtn.setAttribute('onclick', 'closeRestaurantPaymentModal()');
              headerCloseBtn.setAttribute('data-bs-dismiss', 'modal');
            }
            
            // Update body with thank you message
            const orderNumber = window.currentOrder?.orderNumber || result.order?.orderNumber || `ORD${orderId}`;
            modalBody.innerHTML = `
              <div style="text-align: center; padding: 40px 20px;">
                <div style="font-size: 80px; margin-bottom: 24px;">üéâ</div>
                <h3 style="color: #059669; margin-bottom: 16px; font-weight: 700;">C·∫£m ∆°n b·∫°n ƒë√£ thanh to√°n!</h3>
                <p style="color: #6b7280; margin-bottom: 24px; font-size: 16px; line-height: 1.6;">
                  Thanh to√°n c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n th√†nh c√¥ng.
                </p>
                <div style="background: #f0fdf4; padding: 20px; border-radius: 12px; border: 2px solid #86efac; margin-bottom: 24px;">
                  <div style="margin-bottom: 12px;">
                    <strong style="color: #1a1a1a; font-size: 16px;">M√£ ƒë∆°n h√†ng:</strong>
                    <span style="color: #059669; font-size: 18px; font-weight: 700; margin-left: 8px;">${orderNumber}</span>
                  </div>
                  <div style="margin-bottom: 12px;">
                    <strong style="color: #1a1a1a; font-size: 16px;">Ph∆∞∆°ng th·ª©c thanh to√°n:</strong>
                    <span style="color: #059669; font-size: 18px; font-weight: 700; margin-left: 8px;">${paymentMethod === 'Cash' ? 'üíµ Ti·ªÅn m·∫∑t' : paymentMethod === 'QR' ? 'üí≥ QR Code' : paymentMethod}</span>
                  </div>
                  <div>
                    <strong style="color: #1a1a1a; font-size: 16px;">Tr·∫°ng th√°i:</strong>
                    <span style="color: #059669; font-size: 18px; font-weight: 700; margin-left: 8px;">ƒê√£ thanh to√°n</span>
                  </div>
                </div>
                <div style="background: #fef3c7; padding: 16px; border-radius: 8px; border: 1px solid #fbbf24;">
                  <p style="margin: 0; color: #92400e; font-size: 14px; line-height: 1.6;">
                    <strong>üí° L∆∞u √Ω:</strong> ƒê∆°n h√†ng c·ªßa b·∫°n s·∫Ω ƒë∆∞·ª£c chu·∫©n b·ªã v√† giao ƒë·∫øn ƒë·ªãa ch·ªâ ƒë√£ ƒëƒÉng k√Ω.
                  </p>
                </div>
              </div>
            `;
            
            // Update footer - only show close button
            modalFooter.innerHTML = `
              <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="closeRestaurantPaymentModal()" style="padding: 12px 28px; font-size: 16px; font-weight: 600; border-radius: 10px; background: #c8a97e; border: none; width: 100%;">
                <i class="icon-check"></i> ƒê√≥ng
              </button>
            `;
          }
        }
        
        // Show toast notification
        if (typeof showToast === 'function') {
          showToast('X√°c nh·∫≠n thanh to√°n th√†nh c√¥ng! C·∫£m ∆°n b·∫°n!', 'success');
        } else {
          alert('X√°c nh·∫≠n thanh to√°n th√†nh c√¥ng! C·∫£m ∆°n b·∫°n!');
        }

        // Reload order details after a delay
        setTimeout(() => {
          if (window.loadOrderDetails) {
            window.loadOrderDetails(orderId);
          } else {
            window.location.reload();
          }
        }, 1000);

      } catch (error) {
        console.error('[confirmPayment] ‚ùå Payment error:', error);
        console.error('[confirmPayment] Error stack:', error.stack);
        
        if (typeof showToast === 'function') {
          showToast('L·ªói khi thanh to√°n: ' + error.message, 'danger');
        } else {
          alert('L·ªói khi thanh to√°n: ' + error.message);
        }
      } finally {
        const btn = document.getElementById('confirmPaymentBtn');
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = '<i class="icon-check me-2"></i>X√°c nh·∫≠n ƒë√£ thanh to√°n';
        }
      }
    }
    
    /**
     * Close restaurant payment modal
     */
    function closeRestaurantPaymentModal() {
      const modal = document.getElementById('paymentModal');
      if (!modal) {
        console.warn('[closeRestaurantPaymentModal] Modal not found');
        return;
      }
      
      console.log('[closeRestaurantPaymentModal] Closing restaurant payment modal');
      
      // Try multiple methods to close modal
      let closed = false;
      
      // Method 1: Bootstrap 5 - try getInstance first
      if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
        try {
          if (typeof bootstrap.Modal.getInstance === 'function') {
            const bsModal = bootstrap.Modal.getInstance(modal);
            if (bsModal) {
              bsModal.hide();
              closed = true;
              console.log('[closeRestaurantPaymentModal] Closed using Bootstrap 5 Modal.getInstance');
            } else {
              const newModal = new bootstrap.Modal(modal);
              newModal.hide();
              closed = true;
              console.log('[closeRestaurantPaymentModal] Closed using Bootstrap 5 new Modal instance');
            }
          }
        } catch (e) {
          console.warn('[closeRestaurantPaymentModal] Bootstrap method failed:', e);
        }
      }
      
      // Method 2: jQuery
      if (!closed && typeof $ !== 'undefined' && $.fn.modal) {
        try {
          $(modal).modal('hide');
          closed = true;
          console.log('[closeRestaurantPaymentModal] Closed using jQuery');
        } catch (e) {
          console.warn('[closeRestaurantPaymentModal] jQuery method failed:', e);
        }
      }
      
      // Method 3: Direct DOM manipulation
      if (!closed) {
        modal.classList.remove('show');
        modal.style.display = 'none';
        document.body.classList.remove('modal-open');
        const backdrop = document.querySelector('.modal-backdrop');
        if (backdrop) backdrop.remove();
        closed = true;
        console.log('[closeRestaurantPaymentModal] Closed using direct DOM manipulation');
      }
      
      // Reload order details after modal is closed
      setTimeout(() => {
        if (window.loadOrderDetails && window.currentOrder?.orderId) {
          window.loadOrderDetails(window.currentOrder.orderId);
        } else {
          window.location.reload();
        }
      }, 300);
    }

    // Make functions globally accessible
    window.confirmPayment = confirmPayment;
    window.closeRestaurantPaymentModal = closeRestaurantPaymentModal;

    function showError(message) {
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('errorState').style.display = 'block';
      document.getElementById('errorMessage').textContent = message;
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount || 0);
    }

    function getStatusClass(status) {
      const classes = {
        'Pending': 'bg-warning',
        'Confirmed': 'bg-info',
        'Preparing': 'bg-primary',
        'Ready': 'bg-success',
        'Delivered': 'bg-secondary',
        'Cancelled': 'bg-danger'
      };
      return classes[status] || 'bg-secondary';
    }

    function getStatusText(status) {
      const texts = {
        'Pending': 'Ch·ªù x·ª≠ l√Ω',
        'Confirmed': 'ƒê√£ x√°c nh·∫≠n',
        'Preparing': 'ƒêang chu·∫©n b·ªã',
        'Ready': 'S·∫µn s√†ng',
        'Delivered': 'ƒê√£ giao',
        'Cancelled': 'ƒê√£ h·ªßy'
      };
      return texts[status] || status;
    }

    function getPaymentStatusClass(status) {
      const classes = {
        'Unpaid': 'bg-danger',
        'Paid': 'bg-success',
        'Refunded': 'bg-warning'
      };
      return classes[status] || 'bg-secondary';
    }

    function getPaymentStatusText(status) {
      const texts = {
        'Unpaid': 'Ch∆∞a thanh to√°n',
        'Paid': 'ƒê√£ thanh to√°n',
        'Refunded': 'ƒê√£ ho√†n ti·ªÅn'
      };
      return texts[status] || status;
    }

    function getPaymentMethodText(method) {
      const texts = {
        'QR': 'üí≥ Chuy·ªÉn kho·∫£n QR (VietQR)',
        'Cash': 'üíµ Thanh to√°n t·∫°i nh√† h√†ng'
      };
      return texts[method] || method;
    }

    // Helper functions from api.js if not available
    if (typeof showPageLoading === 'undefined') {
      function showPageLoading() {
        // Loading already shown by loadingState
      }
    }
    if (typeof hidePageLoading === 'undefined') {
      function hidePageLoading() {
        // Loading hidden when order details shown
      }
    }
    
    // Background polling ƒë·ªÉ check payment status khi admin approve cash payment
    // Ch·∫°y ngay c·∫£ khi modal ƒë√≥ng
    let backgroundPollingInterval = null;
    
    function startBackgroundPolling() {
      // D·ª´ng polling c≈© n·∫øu c√≥
      if (backgroundPollingInterval) {
        clearInterval(backgroundPollingInterval);
      }
      
      // L·∫•y order ID t·ª´ URL
      const urlParams = new URLSearchParams(window.location.search);
      const orderId = urlParams.get('id');
      
      if (!orderId) {
        return;
      }
      
      console.log('üîÑ [BackgroundPolling] Starting background polling for order:', orderId);
      
      // Poll m·ªói 10 gi√¢y ƒë·ªÉ check payment status
      backgroundPollingInterval = setInterval(async () => {
        try {
          const token = localStorage.getItem('token');
          if (!token) {
            return;
          }
          
          // Check order status
          const url = `${location.origin}/api/restaurant-orders/${orderId}?_=${Date.now()}`;
          const resp = await fetch(url, {
            headers: { 'Authorization': `Bearer ${token}` },
            cache: 'no-store'
          });
          
          if (resp.ok) {
            const order = await resp.json();
            const paymentStatus = order.paymentStatus || '';
            
            // Ch·ªâ check n·∫øu order ch∆∞a thanh to√°n
            if (paymentStatus !== 'Paid') {
              // Check l·∫°i sau
              return;
            }
            
            // N·∫øu ƒë√£ thanh to√°n, reload order
            console.log('‚úÖ [BackgroundPolling] Payment detected for order', orderId);
            
            // Show toast n·∫øu c√≥ function
            if (typeof showToast === 'function') {
              showToast('‚úÖ Thanh to√°n th√†nh c√¥ng! Tr·∫°ng th√°i ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t.', 'success');
            }
            
            // Reload order
            setTimeout(() => {
              if (window.loadOrderDetails) {
                window.loadOrderDetails(orderId);
              } else {
                window.location.reload();
              }
            }, 1000);
            
            // D·ª´ng polling
            if (backgroundPollingInterval) {
              clearInterval(backgroundPollingInterval);
              backgroundPollingInterval = null;
            }
          }
        } catch (e) {
          console.warn('‚ö†Ô∏è [BackgroundPolling] Error:', e);
        }
      }, 10000); // Poll m·ªói 10 gi√¢y
    }
    
    // B·∫Øt ƒë·∫ßu background polling sau khi load order
    setTimeout(() => {
      startBackgroundPolling();
    }, 2000);
    
    // D·ª´ng background polling khi trang ƒë√≥ng
    window.addEventListener('beforeunload', () => {
      if (backgroundPollingInterval) {
        clearInterval(backgroundPollingInterval);
      }
    });
  </script>

</body>
</html>

