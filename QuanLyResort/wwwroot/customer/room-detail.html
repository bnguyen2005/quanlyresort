<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chi ti·∫øt ph√≤ng | Resort</title>
  <link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="/css/tokens.css">
  <link rel="stylesheet" href="/css/globals.css">
  <link rel="stylesheet" href="/css/grid.css">
  <link rel="stylesheet" href="/css/components/navbar.css">
  <link rel="stylesheet" href="css/navbar-auth.css">
  <link rel="stylesheet" href="css/open-iconic-bootstrap.min.css">
  <style>
    body{font-family:'Poppins',sans-serif;padding-top:0;overflow-x:hidden;background:linear-gradient(135deg, #f5ede0 0%, #fff8f0 50%, #ffffff 100%);min-height:100vh}
    .ftco-navbar{position:sticky!important;top:0!important;z-index:1030!important;background-color:#1a1a1a!important;transition:all 0.3s ease;width:100%!important;margin:0!important}
    .ftco-navbar.scrolled{box-shadow:0 2px 10px rgba(0,0,0,0.1);background-color:#1a1a1a!important}
    
    /* Hero gallery v·ªõi fade effect */
    .hero-gallery{position:relative;height:600px;overflow:hidden;animation:fadeIn 0.8s ease;border-radius:0 0 30px 30px}
    .hero-gallery img{width:100%;height:100%;object-fit:cover;transition:transform 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94)}
    .hero-gallery:hover img{transform:scale(1.1)}
    .gallery-overlay{position:absolute;inset:0;background:linear-gradient(180deg,transparent 0%,rgba(0,0,0,0.3) 100%);z-index:1}
    .gallery-thumbs{display:flex;gap:15px;margin-top:20px;overflow-x:auto;padding:15px 0;scroll-behavior:smooth}
    .gallery-thumbs::-webkit-scrollbar{height:8px}
    .gallery-thumbs::-webkit-scrollbar-track{background:#f1f1f1;border-radius:10px}
    .gallery-thumbs::-webkit-scrollbar-thumb{background:#c8a97e;border-radius:10px}
    .thumb{width:120px;height:90px;object-fit:cover;border-radius:12px;cursor:pointer;opacity:0.7;transition:all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);border:3px solid transparent;flex-shrink:0}
    .thumb:hover,.thumb.active{opacity:1;border-color:#c8a97e;transform:scale(1.15) translateY(-5px);box-shadow:0 8px 20px rgba(200,169,126,0.4)}
    
    /* Room info v·ªõi slide animation */
    .room-info{animation:slideUp 1s ease;padding:50px 0}
    .room-header{position:relative;margin-bottom:40px}
    .price-badge{background:linear-gradient(135deg,#c8a97e 0%,#b89968 100%);color:#fff;padding:20px 40px;border-radius:20px;display:inline-block;box-shadow:0 8px 30px rgba(200,169,126,0.4);animation:pulse 2s infinite;font-size:28px;font-weight:700}
    .price-badge small{display:block;font-size:14px;opacity:0.9;margin-top:5px}
    .room-title{font-size:48px;font-weight:700;color:#1a1a1a;margin-bottom:20px;animation:slideInLeft 1s ease;background:linear-gradient(135deg,#1a1a1a 0%,#c8a97e 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .room-subtitle{font-size:20px;color:#666;margin-bottom:30px;animation:slideInRight 1s ease}
    
    /* Amenities grid v·ªõi stagger animation */
    .amenities-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px;margin:40px 0}
    .amenity-item{background:linear-gradient(135deg,#fff 0%,#f8f9fa 100%);padding:30px;border-radius:15px;text-align:center;transition:all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);border:2px solid transparent;opacity:0;animation:fadeInUp 0.6s ease forwards;box-shadow:0 5px 15px rgba(0,0,0,0.05)}
    .amenity-item:nth-child(1){animation-delay:0.1s}
    .amenity-item:nth-child(2){animation-delay:0.2s}
    .amenity-item:nth-child(3){animation-delay:0.3s}
    .amenity-item:nth-child(4){animation-delay:0.4s}
    .amenity-item:nth-child(5){animation-delay:0.5s}
    .amenity-item:nth-child(6){animation-delay:0.6s}
    .amenity-item:hover{background:linear-gradient(135deg,#fff 0%,#fff5e6 100%);border-color:#c8a97e;transform:translateY(-10px) scale(1.05);box-shadow:0 15px 40px rgba(200,169,126,0.2)}
    .amenity-item i{font-size:40px;color:#c8a97e;margin-bottom:15px;display:block;transition:transform 0.3s}
    .amenity-item:hover i{transform:scale(1.2) rotate(5deg)}
    .amenity-item h6{font-weight:600;color:#1a1a1a;margin-top:10px}
    
    /* Booking card v·ªõi slide in animation */
    .booking-card{background:#fff;padding:40px;border-radius:25px;box-shadow:0 15px 50px rgba(0,0,0,0.15);position:sticky;top:120px;animation:slideInRight 1.2s ease;border:1px solid #e9ecef}
    .booking-card::before{content:'';position:absolute;top:0;left:0;right:0;height:5px;background:linear-gradient(90deg,#c8a97e,#b89968);border-radius:25px 25px 0 0}
    .booking-card .form-control,.booking-card .form-select{
      border-radius:12px;
      border:2px solid #e9ecef;
      padding:15px 40px 15px 15px !important;
      transition:all 0.3s;
      font-size:16px !important;
      min-height:52px !important;
      width:100% !important;
      background-color:#fff !important;
      background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e") !important;
      background-repeat:no-repeat !important;
      background-position:right 12px center !important;
      background-size:16px 12px !important;
      appearance:none !important;
      -webkit-appearance:none !important;
      -moz-appearance:none !important;
      overflow:visible !important;
      text-overflow:ellipsis !important;
      white-space:nowrap !important;
    }
    .booking-card .form-select option{
      padding:12px 15px !important;
      font-size:16px !important;
      white-space:normal !important;
      word-wrap:break-word !important;
    }
    .booking-card .form-control:focus,.booking-card .form-select:focus{
      border-color:#c8a97e;
      box-shadow:0 0 0 0.3rem rgba(200,169,126,0.2);
      transform:translateY(-2px);
      outline:none !important;
    }
    .btn-book{background:linear-gradient(135deg,#c8a97e 0%,#b89968 100%);border:none;padding:18px 50px;border-radius:15px;color:#fff;font-weight:700;font-size:20px;width:100%;transition:all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);box-shadow:0 8px 25px rgba(200,169,126,0.4);position:relative;overflow:hidden}
    .btn-book::before{content:'';position:absolute;top:50%;left:50%;width:0;height:0;border-radius:50%;background:rgba(255,255,255,0.3);transform:translate(-50%,-50%);transition:width 0.6s,height 0.6s}
    .btn-book:hover::before{width:400px;height:400px}
    .btn-book:hover{background:linear-gradient(135deg,#b89968 0%,#a88958 100%);transform:translateY(-3px);box-shadow:0 12px 35px rgba(200,169,126,0.5)}
    .btn-book:active{transform:translateY(-1px)}
    
    /* Feature sections v·ªõi fade in */
    .feature-section{padding:80px 0;animation:fadeIn 1.2s ease;position:relative}
    .feature-section::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:url('data:image/svg+xml,<svg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><g fill="%23f8f9fa" fill-opacity="0.4"><circle cx="30" cy="30" r="2"/></g></svg>');opacity:0.3}
    .feature-section:nth-child(even){background:linear-gradient(135deg,#f8f9fa 0%,#fff 100%)}
    .section-title{position:relative;display:inline-block;padding-bottom:20px;margin-bottom:40px;font-size:42px;font-weight:700;color:#1a1a1a}
    .section-title::after{content:'';position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:100px;height:4px;background:linear-gradient(90deg,#c8a97e,#b89968);border-radius:2px;animation:expandWidth 1s ease}
    .section-title::before{content:'';position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);width:60px;height:4px;background:linear-gradient(90deg,#b89968,#c8a97e);border-radius:2px}
    
    /* Description v·ªõi typing effect simulation */
    .room-description{font-size:18px;line-height:1.8;color:#555;animation:fadeIn 1.5s ease;background:#fff;padding:30px;border-radius:15px;box-shadow:0 5px 20px rgba(0,0,0,0.08);border-left:5px solid #c8a97e}
    
    /* Stats v·ªõi counter animation */
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:30px;margin:50px 0}
    .stat-item{text-align:center;padding:30px;background:#fff;border-radius:15px;box-shadow:0 5px 20px rgba(0,0,0,0.1);transition:all 0.3s;opacity:0;animation:fadeInUp 0.6s ease forwards}
    .stat-item:nth-child(1){animation-delay:0.2s}
    .stat-item:nth-child(2){animation-delay:0.4s}
    .stat-item:nth-child(3){animation-delay:0.6s}
    .stat-item:nth-child(4){animation-delay:0.8s}
    .stat-item:hover{transform:translateY(-10px);box-shadow:0 10px 30px rgba(200,169,126,0.2)}
    .stat-number{font-size:36px;font-weight:700;color:#c8a97e;display:block;margin-bottom:8px;line-height:1.2}
    .stat-label{color:#666;font-size:14px;text-transform:uppercase;letter-spacing:0.5px;font-weight:500}
    
    /* Loading skeleton */
    .loading-skeleton{background:linear-gradient(90deg,#f0f0f0 25%,#e0e0e0 50%,#f0f0f0 75%);background-size:200% 100%;animation:loading 1.5s infinite;border-radius:10px;height:200px}
    
    /* Animations */
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes fadeInUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
    @keyframes slideUp{from{opacity:0;transform:translateY(60px)}to{opacity:1;transform:translateY(0)}}
    @keyframes slideInLeft{from{opacity:0;transform:translateX(-50px)}to{opacity:1;transform:translateX(0)}}
    @keyframes slideInRight{from{opacity:0;transform:translateX(50px)}to{opacity:1;transform:translateX(0)}}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.08)}}
    @keyframes expandWidth{from{width:0}to{width:100px}}
    @keyframes loading{0%{background-position:200% 0}100%{background-position:-200% 0}}
    
    /* Smooth scroll */
    html{scroll-behavior:smooth}
    
    /* Back button */
    .back-btn{position:absolute;top:100px;left:30px;z-index:1040;background:rgba(255,255,255,0.95);padding:12px 20px;border-radius:50px;text-decoration:none;color:#1a1a1a;font-weight:600;transition:all 0.3s;box-shadow:0 5px 15px rgba(0,0,0,0.2);display:flex;align-items:center;gap:10px;backdrop-filter:blur(10px)}
    .back-btn:hover{background:#fff;transform:translateX(-5px);box-shadow:0 8px 25px rgba(0,0,0,0.3);color:#c8a97e}
    @media(max-width:768px){
      .back-btn{top:80px;left:15px;padding:10px 16px;font-size:14px}
    }
    
    /* Responsive */
    @media(max-width:768px){
      .hero-gallery{height:400px}
      .room-title{font-size:32px}
      .price-badge{font-size:20px;padding:15px 25px}
      .booking-card{position:relative;top:0;margin-top:30px}
      .amenities-grid{grid-template-columns:repeat(2,1fr);gap:15px}
      .stats-grid{grid-template-columns:repeat(2,1fr)}
    }
  </style>
</head>
<body>
  <!-- Header placeholder - will be loaded by load-header.js -->
  <div id="header-placeholder"></div>
  
  <!-- Load header component -->
  <script src="js/load-header.js"></script>

  <a href="rooms.html" class="back-btn">
          <span class="oi oi-arrow-left"></span> Quay l·∫°i
        </a>

  <div class="hero-gallery" id="heroGallery">
    <div class="loading-skeleton"></div>
    <div class="gallery-overlay"></div>
      </div>

  <div class="container mt-4 mb-4">
    <div class="gallery-thumbs" id="galleryThumbs"></div>
    </div>
    
  <div class="container">
      <div class="row">
        <div class="col-lg-8">
        <div class="room-info">
          <div class="room-header">
            <h1 class="room-title" id="roomTitle">ƒêang t·∫£i...</h1>
            <p class="room-subtitle" id="roomSubtitle">ƒêang t·∫£i th√¥ng tin ph√≤ng...</p>
            <div class="price-badge" id="priceBadge">
              <span id="roomPrice">0</span>
              <small>/ ƒë√™m</small>
            </div>
                </div>
          <div class="room-description" id="roomDescription">
            <p>ƒêang t·∫£i m√¥ t·∫£...</p>
              </div>
          <div class="amenities-grid" id="amenitiesGrid">
            <!-- Dynamic amenities -->
                </div>
          <div class="stats-grid">
            <div class="stat-item">
              <span class="stat-number" id="maxOccupancy">-</span>
              <span class="stat-label">S·ª©c ch·ª©a</span>
              </div>
            <div class="stat-item">
              <span class="stat-number" id="roomSize">-</span>
              <span class="stat-label">Di·ªán t√≠ch (m¬≤)</span>
            </div>
            <div class="stat-item">
              <span class="stat-number">24/7</span>
              <span class="stat-label">H·ªó tr·ª£</span>
            </div>
            <div class="stat-item">
              <span class="stat-number">‚≠ê 5.0</span>
              <span class="stat-label">ƒê√°nh gi√°</span>
            </div>
          </div>
        </div>
      </div>
        <div class="col-lg-4">
          <div class="booking-card">
          <div class="text-center mb-4">
            <h3 style="font-weight:700;color:#1a1a1a;margin-bottom:10px">üìÖ ƒê·∫∑t ph√≤ng ngay</h3>
            <p class="text-muted small mb-0">ƒêi·ªÅn th√¥ng tin v√† x√°c nh·∫≠n ƒë·∫∑t ph√≤ng</p>
          </div>
          
          <form id="quickBookingForm" data-validate="on">
              <div class="mb-3">
            <label class="form-label fw-semibold d-flex align-items-center gap-2">
              <span>üìÖ</span> Ng√†y nh·∫≠n ph√≤ng <span style="color:#dc3545">*</span>
            </label>
            <input type="date" class="form-control" id="checkinDate" name="checkinDate" required data-label="Ng√†y nh·∫≠n ph√≤ng" />
            <small class="text-muted">Th·ªùi gian nh·∫≠n ph√≤ng: 14:00</small>
              </div>
          
              <div class="mb-3">
            <label class="form-label fw-semibold d-flex align-items-center gap-2">
              <span>üìÖ</span> Ng√†y tr·∫£ ph√≤ng <span style="color:#dc3545">*</span>
            </label>
            <input type="date" class="form-control" id="checkoutDate" name="checkoutDate" required data-label="Ng√†y tr·∫£ ph√≤ng" />
            <small class="text-muted">Th·ªùi gian tr·∫£ ph√≤ng: 12:00</small>
              </div>
          
              <div class="mb-3">
            <label class="form-label fw-semibold d-flex align-items-center gap-2">
              <span>üë•</span> S·ªë kh√°ch
            </label>
            <select class="form-select" id="numGuests" name="numGuests">
                  <option value="1">1 kh√°ch</option>
              <option value="2" selected>2 kh√°ch</option>
                  <option value="3">3 kh√°ch</option>
                  <option value="4">4 kh√°ch</option>
              <option value="5">5+ kh√°ch</option>
                </select>
            <small class="text-muted" id="maxGuestsNote"></small>
            <div id="guestLimitWarning" style="display:none;margin-top:8px;padding:10px;background:#fff3cd;border:1px solid #ffc107;border-radius:8px;font-size:13px;"></div>
          </div>
          
          <div class="mb-3">
            <label class="form-label fw-semibold d-flex align-items-center gap-2">
              <span>üí¨</span> Y√™u c·∫ßu ƒë·∫∑c bi·ªát (t√πy ch·ªçn)
            </label>
            <textarea class="form-control" id="specialRequests" name="specialRequests" rows="3" placeholder="V√≠ d·ª•: Ph√≤ng t·∫ßng cao, view bi·ªÉn, gi∆∞·ªùng ƒë√¥i..."></textarea>
              </div>
            <div class="mb-3">
              <label class="form-label fw-semibold d-flex align-items-center gap-2">
                <span>üéüÔ∏è</span> M√£ gi·∫£m gi√° (t√πy ch·ªçn)
              </label>
              <div class="d-flex gap-2" style="display:flex;gap:8px;align-items:center">
                <input type="text" id="couponCode" class="form-control" placeholder="Nh·∫≠p m√£ (v√≠ d·ª•: SUMMER2024)" style="flex:1;min-height:48px;font-size:16px;padding:12px 16px;text-transform:uppercase">
                <button type="button" id="applyCouponBtn" class="btn btn-outline-primary" style="white-space:nowrap;min-height:48px;padding:12px 20px;font-size:15px;font-weight:600">√Åp d·ª•ng</button>
              </div>
              <div id="couponMessage" class="small" style="margin-top:8px;min-height:24px;color:#6b7280;font-size:14px;line-height:1.4"></div>
              <div id="couponAppliedBadge" style="display:none;margin-top:10px;padding:10px 14px;background:#f0fdf4;border:1px solid #86efac;border-radius:8px;">
                <span style="font-size:14px;">üéüÔ∏è M√£ ƒë√£ √°p d·ª•ng: <strong id="appliedCouponCode" style="color:#059669;font-size:16px;">-</strong></span>
              </div>
            </div>
          </form>
          
          <div class="mb-4 p-3 bg-light rounded">
                <div class="d-flex justify-content-between mb-2">
              <span>Gi√°/ƒë√™m:</span>
              <strong id="nightPrice">0 ‚Ç´</strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
              <span>S·ªë ƒë√™m:</span>
              <strong id="numNights">0</strong>
                </div>
            <hr>
                <div id="couponRow" class="d-flex justify-content-between mb-2" style="display:none">
                  <span>Gi·∫£m gi√°:</span>
                  <strong id="couponDiscount">-0 ‚Ç´</strong>
                </div>
                <div class="d-flex justify-content-between">
              <span class="fw-bold">T·ªïng c·ªông:</span>
              <strong class="text-primary fs-5" id="totalPrice">0 ‚Ç´</strong>
            </div>
          </div>
          <button type="button" class="btn btn-book" id="btnBookNow" data-action="submit">
            üìÖ ƒê·∫∑t ph√≤ng ngay
          </button>
          <p class="text-center text-muted small mt-3">Mi·ªÖn ph√≠ h·ªßy trong 24h</p>
        </div>
      </div>
    </div>

    <!-- Reviews Statistics & Reviews Section -->
    <div class="room-section">
      <div class="container">
        <!-- Reviews Statistics -->
        <div class="row mb-4">
          <div class="col-12">
            <div style="background:#fff;padding:30px;border-radius:20px;box-shadow:0 4px 20px rgba(0,0,0,0.08);">
              <div class="row align-items-center">
                <div class="col-md-6">
                  <h3 style="font-weight:700;color:#1a1a1a;margin-bottom:16px;display:flex;align-items:center;gap:12px">
                    ‚≠ê ƒê√°nh gi√° & Nh·∫≠n x√©t
                  </h3>
                  <div id="reviewsStats" style="display:flex;align-items:center;gap:20px;flex-wrap:wrap">
                    <div>
                      <div style="font-size:36px;font-weight:700;color:#c8a97e" id="averageRatingDisplay">0.0</div>
                      <div class="rating-stars" id="averageRatingStarsDisplay" style="display:flex;gap:4px;margin-top:8px">
                        <span class="star empty">‚≠ê</span>
                        <span class="star empty">‚≠ê</span>
                        <span class="star empty">‚≠ê</span>
                        <span class="star empty">‚≠ê</span>
                        <span class="star empty">‚≠ê</span>
                      </div>
                    </div>
                    <div>
                      <div style="font-size:20px;font-weight:600;color:#374151" id="totalReviewsDisplay">0</div>
                      <div style="font-size:14px;color:#6b7280">l∆∞·ª£t ƒë√°nh gi√°</div>
                    </div>
                  </div>
                </div>
                <div class="col-md-6 text-md-end">
                  <!-- Button removed - form is always visible -->
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Add Review Form -->
        <div class="row mb-4" id="reviewFormSection" style="display: block;">
          <div class="col-lg-8 mx-auto">
            <div style="background:#fff;padding:40px;border-radius:20px;box-shadow:0 4px 20px rgba(0,0,0,0.08);">
              <h4 style="font-weight:700;color:#1a1a1a;margin-bottom:24px">‚úçÔ∏è Vi·∫øt ƒë√°nh gi√° c·ªßa b·∫°n</h4>
              
              <form id="roomReviewForm" data-validate="on">
                <div class="mb-3">
                  <label class="form-label fw-semibold">ƒê√°nh gi√° c·ªßa b·∫°n</label>
                  <div class="star-rating-input" id="roomStarRating" style="display:flex;gap:8px;cursor:pointer;margin-bottom:12px">
                    <span class="star-input" data-rating="1" style="font-size:32px;color:#e5e7eb;transition:all 0.2s;cursor:pointer;pointer-events:auto;user-select:none">‚≠ê</span>
                    <span class="star-input" data-rating="2" style="font-size:32px;color:#e5e7eb;transition:all 0.2s;cursor:pointer;pointer-events:auto;user-select:none">‚≠ê</span>
                    <span class="star-input" data-rating="3" style="font-size:32px;color:#e5e7eb;transition:all 0.2s;cursor:pointer;pointer-events:auto;user-select:none">‚≠ê</span>
                    <span class="star-input" data-rating="4" style="font-size:32px;color:#e5e7eb;transition:all 0.2s;cursor:pointer;pointer-events:auto;user-select:none">‚≠ê</span>
                    <span class="star-input" data-rating="5" style="font-size:32px;color:#e5e7eb;transition:all 0.2s;cursor:pointer;pointer-events:auto;user-select:none">‚≠ê</span>
                  </div>
                  <input type="hidden" id="roomSelectedRating" name="rating" value="0" required data-label="ƒê√°nh gi√°">
                </div>
                <div class="mb-3">
                  <label class="form-label fw-semibold">N·ªôi dung ƒë√°nh gi√°</label>
                  <textarea class="form-control" id="roomReviewComment" name="comment" rows="4" placeholder="Chia s·∫ª tr·∫£i nghi·ªám c·ªßa b·∫°n v·ªõi ph√≤ng n√†y..." required data-label="N·ªôi dung ƒë√°nh gi√°" minlength="10" style="font-size:15px;padding:12px"></textarea>
                </div>
                <div style="display:flex;gap:12px">
                  <button type="submit" class="btn" data-action="submit" style="background:linear-gradient(135deg,#c8a97e 0%,#b89968 100%);color:#fff;padding:12px 32px;border-radius:12px;font-weight:600;border:none">
                    G·ª≠i ƒë√°nh gi√°
                  </button>
                  <button type="button" class="btn btn-outline-secondary" id="btnCancelReview" data-action="cancel" style="padding:12px 32px;border-radius:12px;font-weight:600">
                    H·ªßy
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- Reviews List -->
        <div class="row">
          <div class="col-12">
            <div id="reviewsListContainer" style="display:flex;flex-direction:column;gap:20px">
              <!-- Reviews will be loaded here -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Th√¥ng tin kh√°ch h√†ng & x√°c nh·∫≠n ƒë·∫∑t ph√≤ng -->
  <div class="modal fade" id="bookingInfoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content" style="border-radius:20px;overflow:hidden">
        <div class="modal-header" style="background:linear-gradient(135deg,#c8a97e 0%,#b89968 100%);color:#fff;border:none;padding:25px 30px">
          <h5 class="modal-title" style="font-size:22px;font-weight:700;margin:0">üìã Th√¥ng tin ƒë·∫∑t ph√≤ng</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" style="opacity:1"></button>
        </div>
        <div class="modal-body" style="padding:30px">
          <form id="bookingInfoForm" data-validate="on">
          <div class="row g-4">
            <div class="col-md-6">
              <label class="form-label" style="font-size:15px;font-weight:600;margin-bottom:10px">H·ªç v√† t√™n <span style="color:#dc3545">*</span></label>
              <input type="text" class="form-control" id="bf_fullName" name="fullName" placeholder="Nguy·ªÖn VƒÉn A" autocomplete="name" required data-label="H·ªç v√† t√™n" minlength="2" maxlength="100" pattern="[a-zA-Z√Ä-·ªπ\s]+" style="min-height:50px;font-size:16px;padding:12px 15px">
              <small class="text-muted" style="font-size:12px;margin-top:4px;display:block">Ch·ªâ nh·∫≠p ch·ªØ c√°i v√† kho·∫£ng tr·∫Øng (t·ªëi thi·ªÉu 2 k√Ω t·ª±)</small>
            </div>
            <div class="col-md-6">
              <label class="form-label" style="font-size:15px;font-weight:600;margin-bottom:10px">Qu·ªëc t·ªãch</label>
              <input type="text" class="form-control" id="bf_nationality" name="nationality" placeholder="Vietnam" autocomplete="country-name" data-label="Qu·ªëc t·ªãch" maxlength="50" pattern="[a-zA-Z√Ä-·ªπ\s]+" style="min-height:50px;font-size:16px;padding:12px 15px">
              <small class="text-muted" style="font-size:12px;margin-top:4px;display:block">Ch·ªâ nh·∫≠p ch·ªØ c√°i v√† kho·∫£ng tr·∫Øng</small>
            </div>
            <div class="col-md-6">
              <label class="form-label" style="font-size:15px;font-weight:600;margin-bottom:10px">Email <span style="color:#dc3545">*</span></label>
              <input type="email" class="form-control" id="bf_email" name="email" placeholder="you@example.com" autocomplete="email" required data-label="Email" style="min-height:50px;font-size:16px;padding:12px 15px">
            </div>
            <div class="col-md-6">
              <label class="form-label" style="font-size:15px;font-weight:600;margin-bottom:10px">S·ªë ƒëi·ªán tho·∫°i <span style="color:#dc3545">*</span></label>
              <input type="tel" class="form-control" id="bf_phone" name="phone" placeholder="090xxx" autocomplete="tel" required data-label="S·ªë ƒëi·ªán tho·∫°i" pattern="[0-9]{9,11}" style="min-height:50px;font-size:16px;padding:12px 15px">
            </div>
            <div class="col-md-6">
              <label class="form-label" style="font-size:15px;font-weight:600;margin-bottom:10px">CMND/CCCD</label>
              <input type="text" class="form-control" id="bf_idCard" name="idCard" placeholder="0123456789" autocomplete="off" data-label="CMND/CCCD" pattern="[0-9]{9,12}" maxlength="12" style="min-height:50px;font-size:16px;padding:12px 15px">
              <small class="text-muted" style="font-size:12px;margin-top:4px;display:block">Ch·ªâ nh·∫≠p s·ªë (9-12 ch·ªØ s·ªë)</small>
            </div>
            <div class="col-12">
              <label class="form-label" style="font-size:15px;font-weight:600;margin-bottom:10px">ƒê·ªãa ch·ªâ</label>
              <input type="text" class="form-control" id="bf_address" name="address" placeholder="S·ªë nh√†, ƒë∆∞·ªùng, th√†nh ph·ªë" autocomplete="street-address" data-label="ƒê·ªãa ch·ªâ" maxlength="200" style="min-height:50px;font-size:16px;padding:12px 15px">
            </div>
            <div class="col-md-6">
              <label class="form-label" style="font-size:15px;font-weight:600;margin-bottom:10px">Gi·ªù ƒë·∫øn d·ª± ki·∫øn</label>
              <input type="time" class="form-control" id="bf_eta" style="min-height:50px;font-size:16px;padding:12px 15px">
            </div>
            <div class="col-12">
              <label class="form-label" style="font-size:16px;font-weight:600;margin-bottom:10px">Ph∆∞∆°ng th·ª©c thanh to√°n</label>
              <select id="bf_payment" class="form-select" style="min-height:56px;font-size:16px;padding:16px 45px 16px 18px">
                <option value="PayAtHotel">üíµ Thanh to√°n t·∫°i kh√°ch s·∫°n</option>
                <option value="BankTransfer" selected>üí≥ Chuy·ªÉn kho·∫£n qua QR (VietQR)</option>
                <option value="OnlineVNPAY">üåê Thanh to√°n online (VNPAY - demo)</option>
              </select>
              <small class="text-muted" style="font-size:14px;margin-top:8px;display:block">
                üí° M√£ QR thanh to√°n s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã sau khi ƒë·∫∑t ph√≤ng th√†nh c√¥ng
              </small>
            </div>
            <div class="col-12">
              <label class="form-label" style="font-size:15px;font-weight:600;margin-bottom:10px">Ghi ch√∫/Y√™u c·∫ßu ƒë·∫∑c bi·ªát</label>
              <textarea class="form-control" id="bf_notes" name="notes" rows="3" placeholder="V√≠ d·ª•: Check-in s·ªõm, t·∫ßng cao, view bi·ªÉn..." maxlength="500" style="font-size:16px;padding:12px 15px;line-height:1.6"></textarea>
              <small class="text-muted" style="font-size:12px;margin-top:4px;display:block">T·ªëi ƒëa 500 k√Ω t·ª±</small>
                </div>
            <div class="col-12">
              <div class="form-check" style="padding:20px;background:linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);border-radius:16px;border:2px solid rgba(200,169,126,0.2);box-shadow:0 4px 15px rgba(200,169,126,0.1);transition:all 0.3s ease">
                <div style="display:flex;align-items:flex-start;gap:12px">
                  <input class="form-check-input" type="checkbox" id="bf_terms" name="terms" required style="width:22px;height:22px;margin-top:2px;margin-right:0;cursor:pointer;accent-color:#c8a97e;flex-shrink:0">
                  <label class="form-check-label" for="bf_terms" style="font-size:15px;font-weight:500;line-height:1.7;cursor:pointer;display:block;word-wrap:break-word;white-space:normal;color:#1a1a1a;flex:1">
                    T√¥i ƒë√£ ƒë·ªçc v√† ƒë·ªìng √Ω v·ªõi 
                    <a href="#" onclick="event.preventDefault();alert('ƒêi·ªÅu kho·∫£n & Ch√≠nh s√°ch s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t s·ªõm');" style="color:#c8a97e;font-weight:600;text-decoration:underline;transition:color 0.3s" onmouseover="this.style.color='#b89968'" onmouseout="this.style.color='#c8a97e'">ƒëi·ªÅu kho·∫£n & ch√≠nh s√°ch</a>
                    <span style="color:#dc3545;font-weight:700">*</span>
                  </label>
                </div>
              </div>
            </div>
          </div>
          </form>
          <div class="alert alert-info mt-4" id="bf_summary" role="status" style="font-size:15px;padding:15px;border-radius:12px"></div>
        </div>
        <div class="modal-footer" style="border-top:2px solid #f0f0f0;padding:20px 30px">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" data-action="cancel" style="padding:12px 28px;font-size:16px;font-weight:600;border-radius:10px">ƒê√≥ng</button>
          <button type="button" class="btn btn-primary" id="confirmBookingBtn" data-action="submit" style="padding:12px 28px;font-size:16px;font-weight:600;border-radius:10px;background:linear-gradient(135deg,#c8a97e 0%,#b89968 100%);border:none">
            ‚úÖ X√°c nh·∫≠n ƒë·∫∑t ph√≤ng
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="js/jquery.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/popper.min.js"></script>
  <script src="../js/api.js"></script>
  <script src="js/navbar-auth.js"></script>
  <script src="js/coupons.js"></script>
  <script src="js/form-validation.js"></script>
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const roomId = urlParams.get('id');
    const API_ROOMS = location.origin + '/api/rooms';
    
    let currentRoom = null; // Store room data
    let lastLoadedRoomId = null; // Track room changes to clear coupon
    
    // CRITICAL: Clear any existing coupon when page loads (fresh start)
    // Coupons should only apply to the current booking session
    (function() {
      console.log('üîÑ [Page Load] Clearing any existing coupon from previous session');
      window.coupons?.clearAppliedCoupon && window.coupons.clearAppliedCoupon();
    })();

    function vnd(n) {
      try {
        return new Intl.NumberFormat('vi-VN', {style:'currency', currency:'VND'}).format(n || 0);
      } catch(_) {
        return (n || 0) + '‚Ç´';
      }
    }

    function pickImage(room) {
      console.log('üñºÔ∏è [pickImage] Room data:', room);
      console.log('üñºÔ∏è [pickImage] Room keys:', Object.keys(room));
      
      // Priority 1: Room.ImageUrl (h√¨nh ·∫£nh ri√™ng c·ªßa ph√≤ng n√†y, do admin upload)
      // Handle both camelCase and PascalCase
      const roomImageUrl = room.imageUrl || room.ImageUrl;
      if (roomImageUrl && typeof roomImageUrl === 'string' && roomImageUrl.trim().length > 0) {
        console.log('‚úÖ [pickImage] Found Room.ImageUrl:', roomImageUrl);
        return formatImageUrl(roomImageUrl);
      }
      
      // Priority 2: RoomTypeImageUrl from API (from RoomTypeNavigation.MainImageUrl)
      // Handle both camelCase and PascalCase
      const roomTypeImageUrl = room.roomTypeImageUrl || room.RoomTypeImageUrl;
      if (roomTypeImageUrl && typeof roomTypeImageUrl === 'string' && roomTypeImageUrl.trim().length > 0) {
        console.log('‚úÖ [pickImage] Found RoomTypeImageUrl:', roomTypeImageUrl);
        return formatImageUrl(roomTypeImageUrl);
      }
      
      // Priority 3: Try other image fields from API
      const fields = [room.image, room.thumbnailUrl, room.thumbnail, room.photoUrl, room.roomImageUrl, room.roomImage];
      const found = fields.find(u => typeof u === 'string' && u.trim().length > 0);
      if (found) {
        console.log('‚úÖ [pickImage] Found in other fields:', found);
        return formatImageUrl(found);
      }
      
      // Priority 4: Try to parse ImageGallery JSON
      const imageGallery = room.roomTypeImageGallery || room.RoomTypeImageGallery;
      if (imageGallery && typeof imageGallery === 'string') {
        try {
          const gallery = JSON.parse(imageGallery);
          if (Array.isArray(gallery) && gallery.length > 0 && gallery[0]) {
            console.log('‚úÖ [pickImage] Found in ImageGallery:', gallery[0]);
            return formatImageUrl(gallery[0]);
          }
        } catch (e) {
          console.warn('‚ö†Ô∏è [pickImage] Error parsing ImageGallery:', e);
        }
      }
      
      // Fallback to default image based on roomId
      const idx = Math.max(1, (room.roomId || 1) % 6);
      const fallbackUrl = `images/room-${idx}.jpg`;
      console.log('‚ö†Ô∏è [pickImage] Using fallback:', fallbackUrl);
      return fallbackUrl;
    }
    
    function formatImageUrl(url) {
      if (!url || typeof url !== 'string') return null;
      url = url.trim();
      if (url.length === 0) return null;
      
      // If it's already a full URL, return as is
      if (url.startsWith('http://') || url.startsWith('https://')) {
        return url;
      }
      
      // If it starts with /, it's an absolute path from root
      if (url.startsWith('/')) {
        return url;
      }
      
      // Otherwise, treat as relative to images/ folder
      return url.startsWith('images/') ? url : `images/${url}`;
    }

    async function loadRoomReviews() {
      try {
        const url = `${location.origin}/api/reviews?roomId=${roomId}&_=${Date.now()}`;
        const resp = await fetch(url, { cache: 'no-store' });
        
        if (!resp.ok) {
          console.error('Error loading reviews:', resp.status);
          return;
        }
        
        const data = await resp.json();
        const reviews = data.reviews || [];
        const stats = data.statistics || {};
        
        // Display statistics
        const avgRating = stats.averageRating || 0;
        const totalReviews = stats.totalReviews || 0;
        
        document.getElementById('averageRatingDisplay').textContent = avgRating.toFixed(1);
        document.getElementById('totalReviewsDisplay').textContent = totalReviews;
        
        // Display stars
        const avgRounded = Math.round(avgRating);
        const starsContainer = document.getElementById('averageRatingStarsDisplay');
        starsContainer.innerHTML = '';
        for (let i = 1; i <= 5; i++) {
          const star = document.createElement('span');
          star.className = 'star';
          star.textContent = '‚≠ê';
          star.style.color = i <= avgRounded ? '#fbbf24' : '#e5e7eb';
          starsContainer.appendChild(star);
        }
        
        // Render reviews list
        renderReviewsList(reviews);
        
        // Check if user can review (is logged in)
        checkCanReviewRoom();
      } catch (e) {
        console.error('Error loading room reviews:', e);
      }
    }

    function renderReviewsList(reviews) {
      const container = document.getElementById('reviewsListContainer');
      if (!container) return;
      
      container.innerHTML = '';
      
      if (!Array.isArray(reviews) || reviews.length === 0) {
        container.innerHTML = `
          <div style="background:#fff;padding:40px;border-radius:20px;text-align:center;box-shadow:0 2px 10px rgba(0,0,0,0.05)">
            <div style="font-size:48px;margin-bottom:16px">üìù</div>
            <h5 style="color:#6b7280;font-weight:600">Ch∆∞a c√≥ ƒë√°nh gi√° n√†o</h5>
            <p style="color:#9ca3af;margin:0">H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n chia s·∫ª tr·∫£i nghi·ªám!</p>
          </div>
        `;
        return;
      }
      
      reviews.forEach(review => {
        const reviewCard = document.createElement('div');
        reviewCard.style.cssText = 'background:#fff;padding:24px;border-radius:16px;box-shadow:0 2px 10px rgba(0,0,0,0.05);border-left:4px solid #c8a97e';
        reviewCard.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:16px">
            <div style="display:flex;align-items:center;gap:12px">
              <div style="width:45px;height:45px;border-radius:50%;background:linear-gradient(135deg,#c8a97e 0%,#b89968 100%);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:16px">
                ${review.customerInitials || 'K'}
              </div>
              <div>
                <div style="font-weight:600;color:#1a1a1a;font-size:15px">${review.customerName || 'Kh√°ch h√†ng'}</div>
                <div style="font-size:12px;color:#9ca3af">${formatDate(review.createdAt)}</div>
              </div>
            </div>
            <div style="display:flex;gap:4px">
              ${Array.from({length: 5}, (_, i) => 
                `<span style="font-size:18px;color:${i < review.rating ? '#fbbf24' : '#e5e7eb'}">‚≠ê</span>`
              ).join('')}
            </div>
          </div>
          <div style="color:#374151;line-height:1.6;margin-bottom:16px;font-size:15px">
            ${escapeHtml(review.comment)}
          </div>
          ${review.response ? `
            <div style="margin-top:16px;padding:16px;background:#f9fafb;border-radius:12px;border-left:3px solid #c8a97e">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
                <strong style="color:#c8a97e;font-size:14px">üì¢ Ph·∫£n h·ªìi t·ª´ Resort Deluxe:</strong>
              </div>
              <div style="font-size:14px;color:#6b7280;margin:0">${escapeHtml(review.response)}</div>
            </div>
          ` : ''}
        `;
        container.appendChild(reviewCard);
      });
    }

    function formatDate(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      return new Intl.DateTimeFormat('vi-VN', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      }).format(date);
    }

    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    async function checkCanReviewRoom() {
      const token = localStorage.getItem('token');
      const user = localStorage.getItem('user');
      const formSection = document.getElementById('reviewFormSection');
      
      // Always show form, but check if user can review
      if (token && user) {
        try {
          const userObj = JSON.parse(user);
          if (userObj.role === 'Customer') {
            // Enable form elements for logged in users
            const form = document.getElementById('roomReviewForm');
            if (form) {
              // Remove login message if exists
              const loginMsg = form.querySelector('.login-prompt-message');
              if (loginMsg) {
                loginMsg.remove();
              }
              
              // Enable all inputs
              form.querySelectorAll('textarea, button[type="submit"]').forEach(el => {
                el.style.pointerEvents = 'auto';
                el.style.opacity = '1';
                el.style.cursor = 'pointer';
              });
              
              const submitBtn = form.querySelector('button[type="submit"]');
              if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'G·ª≠i ƒë√°nh gi√°';
              }
              
              // Setup stars after enabling (with delay to ensure DOM is ready)
              setTimeout(() => {
                setupRoomReviewStars();
              }, 150);
            }
            
            // Check if already reviewed
            try {
              const resp = await fetch(`${location.origin}/api/reviews/can-review/${roomId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
              });
              
              if (resp.ok) {
                const data = await resp.json();
                if (!data.canReview && data.existingReview) {
                  // Already reviewed - disable form
                  const form = document.getElementById('roomReviewForm');
                  if (form) {
                    const submitBtn = form.querySelector('button[type="submit"]');
                    if (submitBtn) {
                      submitBtn.disabled = true;
                      submitBtn.textContent = '‚úèÔ∏è B·∫°n ƒë√£ ƒë√°nh gi√° ph√≤ng n√†y';
                    }
                    // Disable all inputs except stars stay enabled (but won't submit if already reviewed)
                    form.querySelectorAll('textarea, button[type="submit"]').forEach(el => {
                      el.style.pointerEvents = 'none';
                      el.style.opacity = '0.6';
                    });
                  }
                }
              }
            } catch (e) {
              console.error('Error checking review status:', e);
            }
          }
        } catch (e) {
          console.error('Error parsing user:', e);
        }
      } else {
        // Not logged in - disable form and show login prompt
        const form = document.getElementById('roomReviewForm');
        if (form) {
          // Disable submit button and textarea
          form.querySelectorAll('textarea, button[type="submit"]').forEach(el => {
            el.style.pointerEvents = 'none';
            el.style.opacity = '0.5';
          });
          
          // Disable star clicks (but keep visual) - do this after setup
          setTimeout(() => {
            form.querySelectorAll('.star-input').forEach(el => {
              el.style.pointerEvents = 'none';
              el.style.cursor = 'not-allowed';
            });
          }, 200);
          
          // Setup stars anyway (they will be disabled after)
          setupRoomReviewStars();
          
          // Remove existing login message first
          const existingMsg = form.querySelector('.login-prompt-message');
          if (existingMsg) {
            existingMsg.remove();
          }
          
          // Add login message above form
          const loginMsg = document.createElement('div');
          loginMsg.className = 'login-prompt-message';
          loginMsg.style.cssText = 'background:#fff3cd;border:1px solid #ffc107;border-radius:12px;padding:16px;margin-bottom:20px;text-align:center';
          loginMsg.innerHTML = `
            <p style="font-size:15px;color:#856404;margin-bottom:12px">
              <strong>üîí Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ vi·∫øt ƒë√°nh gi√°</strong>
            </p>
            <a href="login.html?redirect=${encodeURIComponent(window.location.href)}" class="btn btn-warning" style="color:#fff;padding:8px 24px;border-radius:8px;font-weight:600;text-decoration:none;display:inline-block">
              ƒêƒÉng nh·∫≠p ngay
            </a>
          `;
          form.insertBefore(loginMsg, form.firstChild);
        }
      }
    }

    function setupRoomReviewStars() {
      // Wait a bit to ensure DOM is ready
      setTimeout(() => {
        const starsContainer = document.getElementById('roomStarRating');
        if (!starsContainer) {
          console.warn('‚ö†Ô∏è [setupRoomReviewStars] roomStarRating container not found, retrying...');
          setTimeout(setupRoomReviewStars, 100);
          return;
        }
        
        const stars = starsContainer.querySelectorAll('.star-input');
        if (stars.length === 0) {
          console.warn('‚ö†Ô∏è [setupRoomReviewStars] No stars found, retrying...');
          setTimeout(setupRoomReviewStars, 100);
          return;
        }
        
        console.log('‚úÖ [setupRoomReviewStars] Setting up', stars.length, 'stars');
        
        // Remove old event listeners by cloning container
        const containerParent = starsContainer.parentNode;
        const newContainer = starsContainer.cloneNode(true);
        containerParent.replaceChild(newContainer, starsContainer);
        
        // Get fresh references
        const freshContainer = document.getElementById('roomStarRating');
        const freshStars = freshContainer.querySelectorAll('.star-input');
        
        // Make sure stars are clickable
        freshStars.forEach((star) => {
          star.style.pointerEvents = 'auto';
          star.style.cursor = 'pointer';
          star.style.userSelect = 'none';
        });
        
        freshStars.forEach((star, index) => {
          const rating = index + 1;
          
          // Click handler
          star.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('‚≠ê [setupRoomReviewStars] Star clicked:', rating);
            
            const hiddenInput = document.getElementById('roomSelectedRating');
            if (hiddenInput) {
              hiddenInput.value = rating;
              console.log('‚úÖ [setupRoomReviewStars] Rating set to:', rating);
            }
            
            // Update visual state
            freshStars.forEach((s, i) => {
              if (i < rating) {
                s.style.color = '#fbbf24';
                s.classList.add('active');
              } else {
                s.style.color = '#e5e7eb';
                s.classList.remove('active');
              }
            });
          });
          
          // Hover effect
          star.addEventListener('mouseenter', function() {
            freshStars.forEach((s, i) => {
              s.style.color = i < rating ? '#fbbf24' : '#e5e7eb';
            });
          });
        });
        
        // Mouse leave handler
        freshContainer.addEventListener('mouseleave', function() {
          const hiddenInput = document.getElementById('roomSelectedRating');
          const selected = hiddenInput ? parseInt(hiddenInput.value) || 0 : 0;
          freshStars.forEach((s, i) => {
            s.style.color = i < selected ? '#fbbf24' : '#e5e7eb';
          });
        });
        
        console.log('‚úÖ [setupRoomReviewStars] Stars setup complete, stars are clickable');
      }, 50);
    }

    async function submitRoomReview(e) {
      e.preventDefault();
      
      const rating = parseInt(document.getElementById('roomSelectedRating').value);
      const comment = document.getElementById('roomReviewComment').value.trim();
      
      if (!rating || rating === 0) {
        if (typeof showToast === 'function') {
          showToast('Vui l√≤ng ch·ªçn s·ªë sao ƒë√°nh gi√°', 'warning');
        } else {
          alert('Vui l√≤ng ch·ªçn s·ªë sao ƒë√°nh gi√°');
        }
        return;
      }
      
      if (!comment || comment.length < 10) {
        if (typeof showToast === 'function') {
          showToast('Vui l√≤ng nh·∫≠p n·ªôi dung ƒë√°nh gi√° (√≠t nh·∫•t 10 k√Ω t·ª±)', 'warning');
        } else {
          alert('Vui l√≤ng nh·∫≠p n·ªôi dung ƒë√°nh gi√° (√≠t nh·∫•t 10 k√Ω t·ª±)');
        }
        return;
      }
      
      const token = localStorage.getItem('token');
      if (!token) {
        if (typeof showToast === 'function') {
          showToast('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ g·ª≠i ƒë√°nh gi√°', 'warning');
        } else {
          alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ g·ª≠i ƒë√°nh gi√°');
        }
        return;
      }
      
      try {
        const btn = e.target.querySelector('button[type="submit"]') || e.target;
        btn.disabled = true;
        btn.textContent = 'ƒêang g·ª≠i...';
        
        const resp = await fetch(`${location.origin}/api/reviews`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            roomId: roomId,
            rating: rating,
            comment: comment
          })
        });
        
        if (!resp.ok) {
          const error = await resp.json();
          throw new Error(error.message || 'L·ªói g·ª≠i ƒë√°nh gi√°');
        }
        
        if (typeof showToast === 'function') {
          showToast('ƒê√°nh gi√° c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng! C·∫£m ∆°n b·∫°n ƒë√£ chia s·∫ª.', 'success');
        } else {
          alert('ƒê√°nh gi√° c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng! C·∫£m ∆°n b·∫°n ƒë√£ chia s·∫ª.');
        }
        
        document.getElementById('roomReviewForm').reset();
        document.getElementById('roomSelectedRating').value = 0;
        document.querySelectorAll('#roomStarRating .star-input').forEach(s => {
          s.style.color = '#e5e7eb';
          s.classList.remove('active');
        });
        
        // Reload reviews to show new review
        await loadRoomReviews();
        
        // Re-setup stars after reset
        setupRoomReviewStars();
        
        // Update checkCanReviewRoom to disable form if already reviewed
        await checkCanReviewRoom();
      } catch (error) {
        if (typeof showToast === 'function') {
          showToast('L·ªói: ' + error.message, 'danger');
        } else {
          alert('L·ªói: ' + error.message);
        }
      } finally {
        const btn = e.target.querySelector('button[type="submit"]') || e.target;
        btn.disabled = false;
        btn.textContent = 'G·ª≠i ƒë√°nh gi√°';
      }
    }

    async function loadRoomDetail() {
      if (!roomId) {
        console.error('‚ùå [loadRoomDetail] No roomId provided');
        showToast('Kh√¥ng t√¨m th·∫•y ph√≤ng', 'danger');
        setTimeout(() => window.location.href = 'rooms.html', 2000);
        return;
      }

      try {
        console.log('üîµ [loadRoomDetail] Loading room ID:', roomId);
        showPageLoading('ƒêang t·∫£i chi ti·∫øt ph√≤ng...');

        const url = `${API_ROOMS}/${roomId}?_=${Date.now()}`;
        console.log('üîµ [loadRoomDetail] Fetching:', url);

        const resp = await fetch(url, {cache: 'no-store'});
        console.log('üîµ [loadRoomDetail] Response status:', resp.status, resp.statusText);

        if (!resp.ok) {
          const errorText = await resp.text();
          console.error('‚ùå [loadRoomDetail] API Error:', errorText);
          throw new Error('HTTP ' + resp.status + ': ' + errorText);
        }

        const room = await resp.json();
        console.log('‚úÖ [loadRoomDetail] Room data received:', room);
        
        // ALWAYS clear coupon when loading a room (fresh booking for this room)
        // This ensures coupon from previous room/session doesn't persist
        if (lastLoadedRoomId !== roomId) {
          console.log('üîÑ [loadRoomDetail] Loading room, clearing any previous coupon');
          window.coupons?.clearAppliedCoupon && window.coupons.clearAppliedCoupon();
          const couponInput = document.getElementById('couponCode');
          const couponMsg = document.getElementById('couponMessage');
          const badge = document.getElementById('couponAppliedBadge');
          if (couponInput) couponInput.value = '';
          if (couponMsg) {
            couponMsg.textContent = '';
            couponMsg.style.color = '#6b7280';
          }
          if (badge) badge.style.display = 'none';
        }
        lastLoadedRoomId = roomId;
        
        // Store room data for QR calculation
        currentRoom = room;
        
        // Load reviews and statistics
        await loadRoomReviews();

        // H√åNH ·∫¢NH ƒê·∫†I DI·ªÜN (Hero Gallery) - Ri√™ng bi·ªát v·ªõi gallery
        // Priority: Room.ImageUrl > RoomTypeImageUrl > Fallback
        let heroImageUrl = null;
        
        // Priority 1: Room.ImageUrl (h√¨nh ƒë·∫°i di·ªán ri√™ng c·ªßa ph√≤ng n√†y)
        const roomImageUrl = room.imageUrl || room.ImageUrl;
        if (roomImageUrl && typeof roomImageUrl === 'string' && roomImageUrl.trim().length > 0) {
          heroImageUrl = formatImageUrl(roomImageUrl);
          console.log('‚úÖ [loadRoomDetail] Using Room.ImageUrl as hero:', heroImageUrl);
        }
        
        // Priority 2: RoomTypeImageUrl (h√¨nh ƒë·∫°i di·ªán t·ª´ RoomType)
        if (!heroImageUrl) {
          const roomTypeImageUrl = room.roomTypeImageUrl || room.RoomTypeImageUrl;
          if (roomTypeImageUrl && typeof roomTypeImageUrl === 'string' && roomTypeImageUrl.trim().length > 0) {
            heroImageUrl = formatImageUrl(roomTypeImageUrl);
            console.log('‚úÖ [loadRoomDetail] Using RoomTypeImageUrl as hero:', heroImageUrl);
          }
        }
        
        // Priority 3: Fallback
        if (!heroImageUrl) {
          const idx = Math.max(1, (room.roomId || 1) % 6);
          heroImageUrl = `images/room-${idx}.jpg`;
          console.log('‚ö†Ô∏è [loadRoomDetail] Using fallback hero image:', heroImageUrl);
        }
        
        // Set hero image
        document.getElementById('heroGallery').innerHTML = `<img src="${heroImageUrl}" alt="${room.roomTypeName || 'Ph√≤ng'}" />`;
        
        // GALLERY 5 ·∫¢NH (Thumbnails) - Ri√™ng bi·ªát v·ªõi h√¨nh ƒë·∫°i di·ªán
        const thumbsContainer = document.getElementById('galleryThumbs');
        thumbsContainer.innerHTML = ''; // Clear existing thumbs
        
        let galleryImages = [];
        
        // Priority 1: Use Room.ImageGallery (gallery 5 ·∫£nh ri√™ng c·ªßa ph√≤ng n√†y)
        const roomImageGallery = room.imageGallery || room.ImageGallery;
        if (roomImageGallery && typeof roomImageGallery === 'string') {
          try {
            galleryImages = JSON.parse(roomImageGallery);
            if (!Array.isArray(galleryImages)) galleryImages = [];
            console.log('‚úÖ [loadRoomDetail] Using Room.ImageGallery:', galleryImages.length, 'images');
          } catch (e) {
            console.warn('‚ö†Ô∏è [loadRoomDetail] Error parsing Room.ImageGallery:', e);
          }
        }
        
        // Priority 2: Use RoomTypeImageGallery if Room gallery is empty
        if (galleryImages.length === 0) {
          const roomTypeImageGallery = room.roomTypeImageGallery || room.RoomTypeImageGallery;
          if (roomTypeImageGallery && typeof roomTypeImageGallery === 'string') {
            try {
              galleryImages = JSON.parse(roomTypeImageGallery);
              if (!Array.isArray(galleryImages)) galleryImages = [];
              console.log('‚úÖ [loadRoomDetail] Using RoomTypeImageGallery:', galleryImages.length, 'images');
            } catch (e) {
              console.warn('‚ö†Ô∏è [loadRoomDetail] Error parsing RoomTypeImageGallery:', e);
            }
          }
        }
        
        // Priority 3: If no gallery, use hero image for first thumb, then fallback images
        if (galleryImages.length === 0) {
          galleryImages = [heroImageUrl]; // Use hero as first thumb
          // Add fallback images for remaining slots
          for (let i = 1; i < 5; i++) {
            const idx = Math.max(1, ((room.roomId || 1) + i) % 6);
            galleryImages.push(`images/room-${idx}.jpg`);
          }
          console.log('‚ö†Ô∏è [loadRoomDetail] Using fallback gallery images');
        }
        
        // Create thumbnails (max 5)
        const maxThumbs = Math.min(5, Math.max(1, galleryImages.length));
        for (let i = 0; i < maxThumbs; i++) {
          const thumb = document.createElement('img');
          thumb.src = formatImageUrl(galleryImages[i]) || imgUrl; // Fallback to main image
          thumb.className = `thumb ${i === 0 ? 'active' : ''}`;
          thumb.onclick = () => {
            document.querySelectorAll('.thumb').forEach(t => t.classList.remove('active'));
            thumb.classList.add('active');
            document.querySelector('#heroGallery img').src = thumb.src;
          };
          thumbsContainer.appendChild(thumb);
        }

        // Update room info
        document.getElementById('roomTitle').textContent = room.roomTypeName || room.roomType || 'Ph√≤ng';
        document.getElementById('roomSubtitle').textContent = `${room.roomNumber || ''} - S·ª©c ch·ª©a: ${room.maxOccupancy || '-'} kh√°ch`;
        document.getElementById('roomPrice').textContent = vnd(room.pricePerNight || room.basePrice || 0);
        document.getElementById('nightPrice').textContent = vnd(room.pricePerNight || room.basePrice || 0);
        
        document.getElementById('roomDescription').innerHTML = `<p>${room.description || 'Ph√≤ng ngh·ªâ sang tr·ªçng v·ªõi ƒë·∫ßy ƒë·ªß ti·ªán nghi hi·ªán ƒë·∫°i, kh√¥ng gian tho√°ng ƒë√£ng v√† d·ªãch v·ª• chuy√™n nghi·ªáp.'}</p>`;
        
        // Update stats
        document.getElementById('maxOccupancy').textContent = room.maxOccupancy || '-';
        document.getElementById('roomSize').textContent = room.roomSize || room.size || '25';

        const maxGuestsNote = document.getElementById('maxGuestsNote');
        const maxOccupancy = room.maxOccupancy || 4;
        if (maxGuestsNote) {
          maxGuestsNote.textContent = `T·ªëi ƒëa ${maxOccupancy} kh√°ch`;
        }
        
        // Update guests dropdown - remove/disable options that exceed max occupancy
        const numGuestsSelect = document.getElementById('numGuests');
        if (numGuestsSelect) {
          const options = numGuestsSelect.querySelectorAll('option');
          let hasValidSelection = false;
          
          options.forEach(option => {
            const value = parseInt(option.value);
            const optionText = option.textContent.toLowerCase();
            // "5+ kh√°ch" means 5 or more, so treat it as 5 for comparison
            const actualValue = optionText.includes('+') ? value : value;
            
            if (actualValue > maxOccupancy) {
              option.style.display = 'none';
              option.disabled = true;
            } else {
              option.style.display = '';
              option.disabled = false;
              if (option.selected) hasValidSelection = true;
            }
          });
          
          // If current selection exceeds max, reset to max or first valid option
          const currentValue = parseInt(numGuestsSelect.value);
          if (currentValue > maxOccupancy) {
            // Find highest valid option
            let bestOption = null;
            options.forEach(option => {
              const val = parseInt(option.value);
              if (val <= maxOccupancy && (!bestOption || val > parseInt(bestOption.value))) {
                bestOption = option;
              }
            });
            if (bestOption) {
              bestOption.selected = true;
              hasValidSelection = true;
            }
          }
        }

        // Update amenities (simulate)
        const amenities = [
          {icon: 'üèñÔ∏è', name: 'Ban c√¥ng ri√™ng'},
          {icon: 'üåä', name: 'View bi·ªÉn'},
          {icon: 'üì∫', name: 'TV m√†n h√¨nh ph·∫≥ng'},
          {icon: '‚ùÑÔ∏è', name: 'ƒêi·ªÅu h√≤a'},
          {icon: 'üõÅ', name: 'Ph√≤ng t·∫Øm sang tr·ªçng'},
          {icon: '‚òï', name: 'Minibar'},
          {icon: 'üîí', name: 'K√©t an to√†n'},
          {icon: 'üì∂', name: 'Wifi mi·ªÖn ph√≠'}
        ];

        const amenitiesGrid = document.getElementById('amenitiesGrid');
        amenities.forEach((amenity, idx) => {
          const item = document.createElement('div');
          item.className = 'amenity-item';
          item.style.animationDelay = `${0.1 * idx}s`;
          item.innerHTML = `<div style="font-size:40px">${amenity.icon}</div><h6>${amenity.name}</h6>`;
          amenitiesGrid.appendChild(item);
        });

        // Setup booking form
        setupBookingForm(room);
        
      } catch(e) {
        console.error('Error loading room:', e);
        showToast('L·ªói t·∫£i th√¥ng tin ph√≤ng: ' + e.message, 'danger');
      } finally {
        hidePageLoading();
      }
    }
    
    function setupBookingForm(room) {
      const price = room.pricePerNight || room.basePrice || 0;
      const maxOccupancy = room.maxOccupancy || 4;
      const checkin = document.getElementById('checkinDate');
      const checkout = document.getElementById('checkoutDate');
      const numGuests = document.getElementById('numGuests');
      const btnBook = document.getElementById('btnBookNow');
      const guestLimitWarning = document.getElementById('guestLimitWarning');
      let isSubmitting = false;
      
      // Set min date to today
      const today = new Date().toISOString().split('T')[0];
      checkin.min = today;
      checkout.min = today;
      
      // Validate guests selection
      function validateGuests() {
        const selectedValue = parseInt(numGuests.value) || 1;
        const selectedOption = numGuests.options[numGuests.selectedIndex];
        const optionText = selectedOption ? selectedOption.textContent.toLowerCase() : '';
        // If option is "5+ kh√°ch", we need to check if it exceeds max
        // Since "5+" means 5 or more, we treat it as potentially exceeding if max < 5
        const actualGuestCount = selectedValue; // Use the numeric value
        
        if (guestLimitWarning) {
          if (actualGuestCount > maxOccupancy) {
            guestLimitWarning.style.display = 'block';
            const guestText = optionText.includes('+') ? `${selectedValue}+ kh√°ch` : `${selectedValue} kh√°ch`;
            guestLimitWarning.innerHTML = `
              <div style="color:#856404;font-weight:600;margin-bottom:6px;">‚ö†Ô∏è S·ªë kh√°ch v∆∞·ª£t qu√° s·ª©c ch·ª©a ph√≤ng</div>
              <div style="color:#856404;margin-bottom:8px;">Ph√≤ng n√†y ch·ªâ c√≥ th·ªÉ ch·ª©a t·ªëi ƒëa <strong>${maxOccupancy} kh√°ch</strong>. B·∫°n ƒë√£ ch·ªçn <strong>${guestText}</strong>.</div>
              <div style="color:#856404;">
                <a href="rooms.html?maxOccupancy=${selectedValue}" style="color:#856404;text-decoration:underline;font-weight:600;display:inline-block;margin-top:4px;">üëâ Xem c√°c ph√≤ng ph√π h·ª£p cho ${selectedValue} kh√°ch tr·ªü l√™n</a>
              </div>
            `;
            numGuests.classList.add('is-invalid');
            return false;
          } else {
            guestLimitWarning.style.display = 'none';
            numGuests.classList.remove('is-invalid');
            // Clear any inline error
            if (window.formValidation?.clearInlineError) {
              window.formValidation.clearInlineError(numGuests);
            }
            return true;
          }
        }
        return true;
      }
      
      // Initial validation
      validateGuests();
      
      // Note: numGuests change listener is added later with coupon clearing logic
      
      // Coupon: apply with full validation
      const couponInput = document.getElementById('couponCode');
      const applyCouponBtn = document.getElementById('applyCouponBtn');
      const couponMsg = document.getElementById('couponMessage');
      
      // Validate coupon code format
      function validateCouponFormat(code) {
        if (!code || !code.trim()) {
          return { valid: false, message: 'Vui l√≤ng nh·∫≠p m√£ gi·∫£m gi√°' };
        }
        // M√£ gi·∫£m gi√°: ch·ªâ ch·ªØ c√°i, s·ªë, kh√¥ng c√≥ kho·∫£ng tr·∫Øng, 3-50 k√Ω t·ª±
        const codeRegex = /^[A-Z0-9]{3,50}$/i;
        const cleanCode = code.trim().toUpperCase();
        if (!codeRegex.test(cleanCode)) {
          return { valid: false, message: 'M√£ gi·∫£m gi√° kh√¥ng h·ª£p l·ªá. M√£ ch·ªâ ch·ª©a ch·ªØ c√°i v√† s·ªë (3-50 k√Ω t·ª±)' };
        }
        return { valid: true, code: cleanCode };
      }
      
      // Check prerequisites before applying coupon
      function canApplyCoupon() {
        const checkinVal = checkin.value;
        const checkoutVal = checkout.value;
        const guestsVal = parseInt(numGuests.value) || 0;
        
        if (!checkinVal || !checkoutVal) {
          return { canApply: false, message: 'Vui l√≤ng ch·ªçn ng√†y nh·∫≠n ph√≤ng v√† ng√†y tr·∫£ ph√≤ng tr∆∞·ªõc khi √°p d·ª•ng m√£ gi·∫£m gi√°' };
        }
        
        const checkinDate = new Date(checkinVal);
        const checkoutDate = new Date(checkoutVal);
        
        if (checkoutDate <= checkinDate) {
          return { canApply: false, message: 'Ng√†y tr·∫£ ph√≤ng ph·∫£i sau ng√†y nh·∫≠n ph√≤ng' };
        }
        
        if (guestsVal <= 0) {
          return { canApply: false, message: 'Vui l√≤ng ch·ªçn s·ªë kh√°ch tr∆∞·ªõc khi √°p d·ª•ng m√£ gi·∫£m gi√°' };
        }
        
        if (guestsVal > maxOccupancy) {
          return { canApply: false, message: `S·ªë kh√°ch (${guestsVal}) v∆∞·ª£t qu√° s·ª©c ch·ª©a ph√≤ng (${maxOccupancy}). Vui l√≤ng ch·ªçn ph√≤ng kh√°c ho·∫∑c gi·∫£m s·ªë kh√°ch.` };
        }
        
        return { canApply: true };
      }
      
      if (applyCouponBtn && couponInput) {
        // Format coupon code on input (uppercase, remove spaces)
        couponInput.addEventListener('input', (e) => {
          let value = e.target.value.toUpperCase().replace(/\s+/g, '');
          // Only allow alphanumeric
          value = value.replace(/[^A-Z0-9]/g, '');
          if (value !== e.target.value) {
            e.target.value = value;
          }
        });
        
        applyCouponBtn.addEventListener('click', async () => {
          let code = (couponInput.value || '').trim();
          
          // 1. Validate format
          const formatCheck = validateCouponFormat(code);
          if (!formatCheck.valid) {
            if (couponMsg) {
              couponMsg.style.color = '#ef4444';
              couponMsg.textContent = formatCheck.message;
            }
            couponInput.classList.add('is-invalid');
            return;
          }
          code = formatCheck.code;
          
          // 2. Check prerequisites
          const prereqCheck = canApplyCoupon();
          if (!prereqCheck.canApply) {
            if (couponMsg) {
              couponMsg.style.color = '#ef4444';
              couponMsg.textContent = prereqCheck.message;
            }
            // Highlight the missing fields
            if (!checkin.value) checkin.classList.add('is-invalid');
            if (!checkout.value) checkout.classList.add('is-invalid');
            const guestsVal = parseInt(numGuests.value) || 0;
            if (guestsVal <= 0 || guestsVal > maxOccupancy) numGuests.classList.add('is-invalid');
            return;
          }
          
          // Clear any previous errors
          couponInput.classList.remove('is-invalid');
          checkin.classList.remove('is-invalid');
          checkout.classList.remove('is-invalid');
          numGuests.classList.remove('is-invalid');
          
          // Check if another coupon is already applied
          const existingCoupon = window.coupons?.getAppliedCoupon ? window.coupons.getAppliedCoupon() : null;
          if (existingCoupon && existingCoupon.code && existingCoupon.code.toUpperCase() !== code) {
            if (couponMsg) {
              couponMsg.style.color = '#ef4444';
              couponMsg.textContent = `M√£ "${existingCoupon.code.toUpperCase()}" ƒë√£ ƒë∆∞·ª£c √°p d·ª•ng. Vui l√≤ng x√≥a m√£ c≈© tr∆∞·ªõc khi √°p d·ª•ng m√£ m·ªõi.`;
            }
            return;
          }
          
          // If same coupon, no need to re-validate
          if (existingCoupon && existingCoupon.code && existingCoupon.code.toUpperCase() === code && !existingCoupon.pending) {
            if (couponMsg) {
              couponMsg.style.color = '#10b981';
              couponMsg.textContent = `‚úÖ M√£ "${code}" ƒë√£ ƒë∆∞·ª£c √°p d·ª•ng`;
            }
            return;
          }
          
          applyCouponBtn.disabled = true;
          applyCouponBtn.textContent = 'ƒêang ki·ªÉm tra...';
          
          try {
            // 3. Validate with backend
            const result = await (window.coupons?.validateCoupon ? window.coupons.validateCoupon(code) : Promise.reject(new Error('Kh√¥ng th·ªÉ ki·ªÉm tra m√£')));
            
            // 4. Save validated coupon with booking metadata
            // Store metadata to ensure coupon only applies to current booking
            const couponWithMetadata = {
              ...result,
              appliedForRoomId: roomId,
              appliedForCheckin: checkin.value,
              appliedForCheckout: checkout.value,
              appliedForGuests: parseInt(numGuests.value) || 0,
              appliedAt: Date.now()
            };
            window.coupons?.saveAppliedCoupon && window.coupons.saveAppliedCoupon(couponWithMetadata);
            
            if (couponMsg) {
              couponMsg.style.color = '#10b981';
              const discountText = result.type === 'percent' 
                ? `${result.value}%` 
                : vnd(result.value);
              couponMsg.textContent = `‚úÖ M√£ "${code}" ƒë√£ ƒë∆∞·ª£c √°p d·ª•ng th√†nh c√¥ng (Gi·∫£m ${discountText})`;
            }
            
            // Hide pending badge if successful
            const badge = document.getElementById('couponAppliedBadge');
            if (badge) badge.style.display = 'none';
            
            // 5. Update total with validated coupon
            updateTotal();
            
          } catch (e) {
            // If 403 Forbidden: save pending coupon code to send with booking, but don't change totals
            if (e && e.status === 403) {
              // Save pending coupon with metadata
              const pendingCouponWithMetadata = {
                code,
                pending: true,
                appliedForRoomId: roomId,
                appliedForCheckin: checkin.value,
                appliedForCheckout: checkout.value,
                appliedForGuests: parseInt(numGuests.value) || 0,
                appliedAt: Date.now()
              };
              window.coupons?.saveAppliedCoupon && window.coupons.saveAppliedCoupon(pendingCouponWithMetadata);
              if (couponMsg) {
                couponMsg.style.color = '#f59e0b';
                couponMsg.textContent = `‚ö†Ô∏è M√£ "${code}" s·∫Ω ƒë∆∞·ª£c ki·ªÉm tra khi x√°c nh·∫≠n ƒë·∫∑t ph√≤ng. T·ªïng ti·ªÅn hi·ªán t·∫°i ch∆∞a √°p d·ª•ng gi·∫£m.`;
              }
              // Show badge with applied coupon code
              const badge = document.getElementById('couponAppliedBadge');
              const codeDisplay = document.getElementById('appliedCouponCode');
              if (badge && codeDisplay) {
                codeDisplay.textContent = code;
                badge.style.display = 'block';
              }
              // Don't update total for pending coupons
              updateTotal(); // This will show base price
            } else {
              window.coupons?.clearAppliedCoupon && window.coupons.clearAppliedCoupon();
              const badge = document.getElementById('couponAppliedBadge');
              if (badge) badge.style.display = 'none';
              if (couponMsg) {
                couponMsg.style.color = '#ef4444';
                couponMsg.textContent = (e && e.message) ? e.message : `M√£ "${code}" kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n`;
              }
              couponInput.classList.add('is-invalid');
              updateTotal();
            }
          } finally {
            applyCouponBtn.disabled = false;
            applyCouponBtn.textContent = '√Åp d·ª•ng';
          }
        });
        
        // Clear coupon button removed - to save space for coupon input field
        // Users can clear by entering a new coupon code or clearing the input field directly
      }

      // Track booking details to detect changes
      let lastBookingDetails = {
        checkin: null,
        checkout: null,
        guests: null,
        roomId: null
      };
      
      // Clear applied coupon function
      window.clearAppliedCoupon = function() {
        try {
          const couponInput = document.getElementById('couponCode');
          const couponMsg = document.getElementById('couponMessage');
          const badge = document.getElementById('couponAppliedBadge');
          const codeDisplay = document.getElementById('appliedCouponCode');
          
          if (couponInput) couponInput.value = '';
          if (couponMsg) {
            couponMsg.textContent = '';
            couponMsg.style.color = '#6b7280';
          }
          if (badge) badge.style.display = 'none';
          if (codeDisplay) codeDisplay.textContent = '-';
          
          // Clear from localStorage if using coupons.js
          if (window.coupons?.clearAppliedCoupon) {
            window.coupons.clearAppliedCoupon();
          }
          
          console.log('‚úÖ [clearAppliedCoupon] Coupon cleared');
        } catch (e) {
          console.error('‚ùå [clearAppliedCoupon] Error:', e);
        }
      };

      function clearCouponIfBookingChanged() {
        const currentCheckin = checkin.value;
        const currentCheckout = checkout.value;
        const currentGuests = parseInt(numGuests.value) || 0;
        
        // Only clear coupon if we have tracking data and something changed
        // Skip on initial load (when all tracking values are null)
        const hasTracking = lastBookingDetails.checkin !== null || 
                           lastBookingDetails.checkout !== null || 
                           lastBookingDetails.guests !== null;
        
        if (!hasTracking) {
          // First time, just track - don't clear
          lastBookingDetails.checkin = currentCheckin;
          lastBookingDetails.checkout = currentCheckout;
          lastBookingDetails.guests = currentGuests;
          lastBookingDetails.roomId = roomId;
          return;
        }
        
        // If dates or guests changed, clear coupon
        // (user is making a new booking, not just adjusting current booking)
        const datesChanged = (
          (lastBookingDetails.checkin && lastBookingDetails.checkin !== currentCheckin) ||
          (lastBookingDetails.checkout && lastBookingDetails.checkout !== currentCheckout)
        );
        
        const guestsChanged = (
          lastBookingDetails.guests !== null &&
          lastBookingDetails.guests !== currentGuests
        );
        
        const roomChanged = (
          lastBookingDetails.roomId !== null &&
          lastBookingDetails.roomId !== roomId
        );
        
        // Clear coupon if booking parameters changed
        if (datesChanged || guestsChanged || roomChanged) {
          const applied = window.coupons?.getAppliedCoupon ? window.coupons.getAppliedCoupon() : null;
          if (applied) {
            console.log('üîÑ [updateTotal] Booking details changed, clearing coupon', {
              datesChanged, guestsChanged, roomChanged,
              old: lastBookingDetails,
              new: { checkin: currentCheckin, checkout: currentCheckout, guests: currentGuests, roomId }
            });
            window.coupons?.clearAppliedCoupon && window.coupons.clearAppliedCoupon();
            const couponInput = document.getElementById('couponCode');
            const couponMsg = document.getElementById('couponMessage');
            const badge = document.getElementById('couponAppliedBadge');
            if (couponInput) couponInput.value = '';
            if (couponMsg) {
              couponMsg.textContent = 'üí° M√£ gi·∫£m gi√° ƒë√£ ƒë∆∞·ª£c x√≥a do thay ƒë·ªïi th√¥ng tin ƒë·∫∑t ph√≤ng';
              couponMsg.style.color = '#6b7280';
            }
            if (badge) badge.style.display = 'none';
          }
        }
        
        // Update tracking
        lastBookingDetails.checkin = currentCheckin;
        lastBookingDetails.checkout = currentCheckout;
        lastBookingDetails.guests = currentGuests;
        lastBookingDetails.roomId = roomId;
      }
      
      function updateTotal() {
        const checkinVal = checkin.value ? new Date(checkin.value) : null;
        const checkoutVal = checkout.value ? new Date(checkout.value) : null;
        
        // Clear coupon if booking details changed (new booking scenario)
        if (checkin.value || checkout.value) {
          clearCouponIfBookingChanged();
        }
        
        if (checkin.value && checkout.value && checkoutVal > checkinVal) {
          const nights = Math.ceil((checkoutVal - checkinVal) / (1000 * 60 * 60 * 24));
          document.getElementById('numNights').textContent = nights;
          const base = price * nights;
          
          // Get applied coupon
          const applied = window.coupons?.getAppliedCoupon ? window.coupons.getAppliedCoupon() : null;
          
          // CRITICAL: Only apply discount if:
          // 1. Coupon exists
          // 2. Coupon is validated (not pending)
          // 3. Coupon was applied for THIS specific booking (same room, dates, guests)
          let result = { total: base, discount: 0 };
          
          if (applied && !applied.pending) {
            // Check if coupon was applied for current booking
            const isForCurrentBooking = (
              applied.appliedForRoomId === roomId &&
              applied.appliedForCheckin === checkin.value &&
              applied.appliedForCheckout === checkout.value &&
              applied.appliedForGuests === (parseInt(numGuests.value) || 0)
            );
            
            if (isForCurrentBooking) {
              // Only calculate discount for validated coupons that match current booking
              result = window.coupons?.calculateDiscountedTotal ? window.coupons.calculateDiscountedTotal(base, applied) : { total: base, discount: 0 };
            } else {
              // Coupon doesn't match current booking - clear it
              console.log('üîÑ [updateTotal] Coupon was for different booking, clearing it');
              window.coupons?.clearAppliedCoupon && window.coupons.clearAppliedCoupon();
              const couponRow = document.getElementById('couponRow');
              if (couponRow) couponRow.style.display = 'none';
              const couponInput = document.getElementById('couponCode');
              const couponMsg = document.getElementById('couponMessage');
              const badge = document.getElementById('couponAppliedBadge');
              if (couponInput) couponInput.value = '';
              if (couponMsg) {
                couponMsg.textContent = '';
                couponMsg.style.color = '#6b7280';
              }
              if (badge) badge.style.display = 'none';
            }
          }
          
          const couponRow = document.getElementById('couponRow');
          const couponDiscount = document.getElementById('couponDiscount');
          
          // Show discount row only if:
          // 1. Coupon exists
          // 2. Coupon is validated (not pending)
          // 3. Discount > 0
          if (applied && !applied.pending && result.discount > 0) {
            couponRow.style.display = 'flex';
            couponDiscount.textContent = '-' + vnd(result.discount);
          } else {
            couponRow.style.display = 'none';
          }
          
          document.getElementById('totalPrice').textContent = vnd(result.total);
        } else {
          document.getElementById('numNights').textContent = '0';
          document.getElementById('totalPrice').textContent = vnd(0);
          const couponRow = document.getElementById('couponRow');
          if (couponRow) couponRow.style.display = 'none';
        }
        
        if (checkin.value) checkout.min = checkin.value;
      }

      checkin.addEventListener('change', () => {
        // Clear coupon when dates change (new booking)
        const applied = window.coupons?.getAppliedCoupon ? window.coupons.getAppliedCoupon() : null;
        if (applied && lastBookingDetails.checkin !== checkin.value) {
          console.log('üîÑ [checkin change] Date changed, will clear coupon in updateTotal');
        }
        updateTotal();
        // Clear error when user selects date
        if (window.formValidation?.clearInlineError) {
          window.formValidation.clearInlineError(checkin);
        }
      });
      checkout.addEventListener('change', () => {
        // Clear coupon when dates change (new booking)
        const applied = window.coupons?.getAppliedCoupon ? window.coupons.getAppliedCoupon() : null;
        if (applied && lastBookingDetails.checkout !== checkout.value) {
          console.log('üîÑ [checkout change] Date changed, will clear coupon in updateTotal');
        }
        updateTotal();
        // Clear error when user selects date
        if (window.formValidation?.clearInlineError) {
          window.formValidation.clearInlineError(checkout);
        }
      });
      
      // Clear coupon when number of guests changes
      numGuests.addEventListener('change', () => {
        const applied = window.coupons?.getAppliedCoupon ? window.coupons.getAppliedCoupon() : null;
        const currentGuests = parseInt(numGuests.value) || 0;
        if (applied && lastBookingDetails.guests !== currentGuests) {
          console.log('üîÑ [guests change] Guest count changed, will clear coupon in updateTotal');
        }
        updateTotal();
        validateGuests();
      });

      // Review form submit
      document.getElementById('roomReviewForm')?.addEventListener('submit', submitRoomReview);
      
      // Cancel button
      document.getElementById('btnCancelReview')?.addEventListener('click', () => {
        document.getElementById('roomReviewForm').reset();
        document.getElementById('roomSelectedRating').value = 0;
        document.querySelectorAll('#roomStarRating .star-input').forEach(s => {
          s.style.color = '#e5e7eb';
          s.classList.remove('active');
        });
      });
      
      // Khi b·∫•m "ƒê·∫∑t ph√≤ng ngay" -> validate v√† m·ªü modal nh·∫≠p th√¥ng tin
      const bookingModal = new bootstrap.Modal(document.getElementById('bookingInfoModal'));
      document.getElementById('btnBookNow').addEventListener('click', async () => {
        // Trigger form validation
        const quickForm = document.getElementById('quickBookingForm');
        if (quickForm) {
          // Get validation functions from global scope
          const validateInput = window.formValidation?.validateInput || function(input) {
            const label = (input.getAttribute('data-label') || input.name || 'Tr∆∞·ªùng n√†y').trim();
            const required = input.hasAttribute('required');
            const value = (input.value || '').trim();
            if (required && !value) return `${label} l√† b·∫Øt bu·ªôc`;
            return '';
          };
          const createInlineError = window.formValidation?.createInlineError || function(input, message) {
            let holder = input.closest('.mb-3') || input.parentElement;
            if (!holder) holder = input;
            let err = holder.querySelector('.fv-error');
            if (!err) {
              err = document.createElement('div');
              err.className = 'fv-error';
              err.style.cssText = 'color:#dc3545;font-size:12px;margin-top:4px;';
              holder.appendChild(err);
            }
            err.textContent = message || '';
            input.classList.add('is-invalid');
          };
          const clearInlineError = window.formValidation?.clearInlineError || function(input) {
            input.classList.remove('is-invalid');
            const holder = input.closest('.mb-3') || input.parentElement;
            const err = holder && holder.querySelector('.fv-error');
            if (err) err.textContent = '';
          };
          
          // Check validation
          const checkin = document.getElementById('checkinDate');
          const checkout = document.getElementById('checkoutDate');
          
          let hasError = false;
          
          // Validate check-in
          if (!checkin.value) {
            const msg = validateInput(checkin);
            if (msg) {
              createInlineError(checkin, msg);
              hasError = true;
            }
          } else {
            clearInlineError(checkin);
          }
          
          // Validate check-out
          if (!checkout.value) {
            const msg = validateInput(checkout);
            if (msg) {
              createInlineError(checkout, msg);
              hasError = true;
            }
          } else {
            clearInlineError(checkout);
          }
          
          // Validate date logic
          if (checkin.value && checkout.value) {
            const checkinDate = new Date(checkin.value);
            const checkoutDate = new Date(checkout.value);
            if (checkoutDate <= checkinDate) {
              createInlineError(checkout, 'Ng√†y tr·∫£ ph√≤ng ph·∫£i sau ng√†y nh·∫≠n ph√≤ng');
              hasError = true;
            } else {
              // Clear error if dates are valid
              clearInlineError(checkout);
            }
          }
          
          // Validate guests count
          const selectedGuests = parseInt(numGuests.value) || 1;
          const maxOccupancy = room.maxOccupancy || 4;
          if (selectedGuests > maxOccupancy) {
            const guestWarning = document.getElementById('guestLimitWarning');
            if (guestWarning) {
              guestWarning.style.display = 'block';
              guestWarning.innerHTML = `
                <div style="color:#856404;font-weight:600;margin-bottom:6px;">‚ö†Ô∏è S·ªë kh√°ch v∆∞·ª£t qu√° s·ª©c ch·ª©a ph√≤ng</div>
                <div style="color:#856404;margin-bottom:8px;">Ph√≤ng n√†y ch·ªâ c√≥ th·ªÉ ch·ª©a t·ªëi ƒëa <strong>${maxOccupancy} kh√°ch</strong>.</div>
                <div style="color:#856404;">
                  <a href="rooms.html?maxOccupancy=${selectedGuests}" style="color:#856404;text-decoration:underline;font-weight:600;">üëâ Xem c√°c ph√≤ng ph√π h·ª£p cho ${selectedGuests} kh√°ch</a>
                </div>
              `;
              guestWarning.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            numGuests.classList.add('is-invalid');
            if (window.formValidation?.createInlineError) {
              window.formValidation.createInlineError(numGuests, `S·ªë kh√°ch v∆∞·ª£t qu√° s·ª©c ch·ª©a (t·ªëi ƒëa ${maxOccupancy} kh√°ch)`);
            }
            return;
          } else {
            const guestWarning = document.getElementById('guestLimitWarning');
            if (guestWarning) guestWarning.style.display = 'none';
            numGuests.classList.remove('is-invalid');
          }
          
          if (hasError) {
            const firstInvalid = quickForm.querySelector('.is-invalid');
            if (firstInvalid) {
              firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
              firstInvalid.focus();
            }
            return;
          }
          
          // Clear any previous errors if all valid
          clearInlineError(checkin);
          clearInlineError(checkout);
        }
        
        // Hi·ªÉn th·ªã t√≥m t·∫Øt ƒë·∫∑t ph√≤ng (ng√†y, s·ªë ƒë√™m, kh√°ch)
        const checkinVal = document.getElementById('checkinDate').value;
        const checkoutVal = document.getElementById('checkoutDate').value;
        const guestsVal = document.getElementById('numGuests').value;

        // Function to update summary in modal
        const updateBookingSummary = async () => {
          let summary = 'Vui l√≤ng ch·ªçn ng√†y nh·∫≠n tr·∫£ ph√≤ng';
          if (checkinVal && checkoutVal) {
            const nights = Math.ceil((new Date(checkoutVal) - new Date(checkinVal)) / (1000*60*60*24));
            const basePrice = (room.pricePerNight || room.basePrice || 0) * nights;
            let appliedCoupon = window.coupons?.getAppliedCoupon ? window.coupons.getAppliedCoupon() : null;
            
            // If coupon is pending, try to validate it now
            if (appliedCoupon && appliedCoupon.pending && appliedCoupon.code) {
              try {
                const summaryEl = document.getElementById('bf_summary');
                if (summaryEl) {
                  summaryEl.innerHTML = '<div style="padding:20px;text-align:center"><div class="spinner-border spinner-border-sm text-primary" role="status"></div><div style="margin-top:10px;color:#6b7280">ƒêang ki·ªÉm tra m√£ gi·∫£m gi√°...</div></div>';
                }
                
                const validatedCoupon = await window.coupons.validateCoupon(appliedCoupon.code);
                window.coupons.saveAppliedCoupon(validatedCoupon);
                appliedCoupon = validatedCoupon;
                
                // Update badge
                const badge = document.getElementById('couponAppliedBadge');
                if (badge) badge.style.display = 'none';
                const couponMsg = document.getElementById('couponMessage');
                if (couponMsg) {
                  couponMsg.style.color = '#10b981';
                  couponMsg.textContent = '‚úÖ M√£ ƒë√£ ƒë∆∞·ª£c x√°c th·ª±c';
                }
              } catch (e) {
                // Validation failed - keep pending status
                console.warn('Coupon validation failed in modal:', e);
              }
            }
            
            const { total, discount } = window.coupons?.calculateDiscountedTotal 
              ? window.coupons.calculateDiscountedTotal(basePrice, appliedCoupon) 
              : { total: basePrice, discount: 0 };
            
            summary = `üìÖ ${new Date(checkinVal).toLocaleDateString('vi-VN')} ‚Üí ${new Date(checkoutVal).toLocaleDateString('vi-VN')} ¬∑ üåô ${nights} ƒë√™m ¬∑ üë• ${guestsVal} kh√°ch`;
            
            if (appliedCoupon) {
              const couponCode = appliedCoupon.code || appliedCoupon.Code || appliedCoupon.code;
              if (appliedCoupon.pending) {
                // Pending coupon (403 case) - still show it
                summary += `\nüéüÔ∏è M√£: <strong style="color:#f59e0b">${couponCode}</strong> <span style="color:#f59e0b;font-size:12px">(S·∫Ω ƒë∆∞·ª£c ki·ªÉm tra khi ƒë·∫∑t ph√≤ng)</span>`;
                summary += `\nüí∞ T·ªïng c·ªông: <strong style="color:#c8a97e;font-size:18px">${vnd(basePrice)}</strong> <span style="color:#6b7280;font-size:13px">(Ch∆∞a √°p d·ª•ng gi·∫£m)</span>`;
              } else if (discount > 0) {
                // Validated coupon with discount
                summary += `\nüéüÔ∏è M√£: <strong>${couponCode}</strong> ¬∑ Gi·∫£m: <strong style="color:#10b981">-${vnd(discount)}</strong>`;
                summary += `\nüí∞ T·ªïng c·ªông: <strong style="color:#c8a97e;font-size:18px">${vnd(total)}</strong>`;
              } else {
                summary += `\nüí∞ T·ªïng c·ªông: <strong style="color:#c8a97e;font-size:18px">${vnd(basePrice)}</strong>`;
              }
            } else {
              summary += `\nüí∞ T·ªïng c·ªông: <strong style="color:#c8a97e;font-size:18px">${vnd(basePrice)}</strong>`;
            }
          }

          document.getElementById('bf_summary').innerHTML = summary;
        };
        
        // Update summary (will auto-validate pending coupon)
        await updateBookingSummary();

        // T·ª± ƒëi·ªÅn s·∫µn th√¥ng tin t·ª´ localStorage n·∫øu c√≥
        try {
          const u = JSON.parse(localStorage.getItem('user')||'{}');
          document.getElementById('bf_fullName').value = u.fullName || '';
          document.getElementById('bf_email').value = u.email || '';
          document.getElementById('bf_phone').value = u.phoneNumber || '';
        } catch(_){}

        bookingModal.show();
      });

      // X√°c nh·∫≠n trong modal -> g·ªçi submitBooking k√®m th√¥ng tin
      document.getElementById('confirmBookingBtn').addEventListener('click', async () => {
        if (isSubmitting) return;

        // Trigger form validation
        const form = document.getElementById('bookingInfoForm');
        if (form) {
          const submitEvent = new Event('submit', { bubbles: true, cancelable: true });
          form.dispatchEvent(submitEvent);
          if (submitEvent.defaultPrevented) {
            return; // Validation failed, stop here
          }
        }

        const fullName = (document.getElementById('bf_fullName')?.value||'').trim();
        const email = (document.getElementById('bf_email')?.value||'').trim();
        const phone = (document.getElementById('bf_phone')?.value||'').trim();
        const nationality = (document.getElementById('bf_nationality')?.value||'').trim();
        const idCard = (document.getElementById('bf_idCard')?.value||'').trim();
        const address = (document.getElementById('bf_address')?.value||'').trim();
        const eta = (document.getElementById('bf_eta')?.value||'').trim();
        const payment = (document.getElementById('bf_payment')?.value||'').trim();
        const extraNotes = (document.getElementById('bf_notes')?.value||'').trim();
        const terms = document.getElementById('bf_terms')?.checked || false;

        // Ki·ªÉm tra t·ªëi thi·ªÉu (backup validation)
        if (!fullName || !email || !phone) {
          showToast('Vui l√≤ng nh·∫≠p H·ªç t√™n, Email v√† SƒêT', 'warning');
          return;
        }

        if (!terms){
          showToast('Vui l√≤ng ƒë·ªìng √Ω ƒëi·ªÅu kho·∫£n & ch√≠nh s√°ch', 'warning');
          return;
        }

        // L∆∞u structured JSON v√†o SpecialRequests ƒë·ªÉ Admin ƒë·ªçc ƒë∆∞·ª£c r√µ r√†ng
        const payload = {
          guestName: fullName,
          guestEmail: email,
          guestPhone: phone,
          nationality,
          idCard,
          address,
          arrivalTime: eta,
          paymentMethod: payment,
          note: extraNotes
        };

        document.getElementById('specialRequests').value = JSON.stringify(payload);
        bookingModal.hide();

        isSubmitting = true; btnBook.disabled = true; btnBook.textContent = 'ƒêang x·ª≠ l√Ω...';
        await submitBooking(room).finally(()=>{ isSubmitting = false; btnBook.disabled = false; btnBook.textContent = 'üìÖ ƒê·∫∑t ph√≤ng ngay'; });
      });
    }

    async function submitBooking(room) {
      const checkin = document.getElementById('checkinDate');
      const checkout = document.getElementById('checkoutDate');
      const numGuests = document.getElementById('numGuests');
      
      // Validation
      if (!checkin.value || !checkout.value) {
        showToast('Vui l√≤ng ch·ªçn ng√†y nh·∫≠n v√† tr·∫£ ph√≤ng', 'warning');
        checkin.focus();
        return;
      }
      
      const checkinDate = new Date(checkin.value);
      const checkoutDate = new Date(checkout.value);
      const today = new Date();
      today.setHours(0,0,0,0);
      
      if (checkinDate < today) {
        showToast('Ng√†y nh·∫≠n ph√≤ng kh√¥ng th·ªÉ l√† qu√° kh·ª©', 'warning');
        checkin.focus();
        return;
      }
      
      if (checkoutDate <= checkinDate) {
        showToast('Ng√†y tr·∫£ ph√≤ng ph·∫£i sau ng√†y nh·∫≠n ph√≤ng', 'warning');
        checkout.focus();
        return;
      }
      
      const nights = Math.ceil((checkoutDate - checkinDate) / (1000 * 60 * 60 * 24));
      if (nights < 1) {
        showToast('Ph·∫£i ƒë·∫∑t t·ªëi thi·ªÉu 1 ƒë√™m', 'warning');
        return;
      }
      
      const guests = parseInt(numGuests.value) || 1;
      if (guests > (room.maxOccupancy || 4)) {
        showToast(`S·ªë kh√°ch v∆∞·ª£t qu√° s·ª©c ch·ª©a (t·ªëi ƒëa ${room.maxOccupancy || 4} kh√°ch)`, 'warning');
        return;
      }

      if (guests <= 0) {
        showToast('S·ªë kh√°ch kh√¥ng h·ª£p l·ªá', 'warning');
        return;
      }
      
      // Get applied coupon
      const appliedCoupon = window.coupons?.getAppliedCoupon ? window.coupons.getAppliedCoupon() : null;

      // Ki·ªÉm tra tr·∫°ng th√°i ph√≤ng c√≤n kh·∫£ d·ª•ng
      try {
        const recheck = await fetch(`${API_ROOMS}/${room.roomId}?_=${Date.now()}`, {cache:'no-store'});
        if (recheck.ok) {
          const latest = await recheck.json();
          if (latest && latest.isAvailable === false) {
            showToast('Ph√≤ng hi·ªán kh√¥ng c√≤n kh·∫£ d·ª•ng, vui l√≤ng ch·ªçn ph√≤ng kh√°c', 'warning');
            return;
          }
        }
      } catch(_) { /* b·ªè qua n·∫øu l·ªói m·∫°ng nh·∫π */ }
      
      // Check authentication
      const token = localStorage.getItem('token');
      const userStr = localStorage.getItem('user');
      if (!token || !userStr) {
        showToast('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒë·∫∑t ph√≤ng', 'warning');
        // L∆∞u URL hi·ªán t·∫°i ƒë·ªÉ redirect l·∫°i sau khi login
        const currentUrl = window.location.href;
        setTimeout(() => {
          window.location.href = `login.html?redirect=${encodeURIComponent(currentUrl)}`;
        }, 1500);
        return;
      }
      
      let user;
      try {
        user = JSON.parse(userStr);
        if (!user || !user.customerId) {
          throw new Error('Invalid user data');
        }
      } catch(e) {
        showToast('Th√¥ng tin ng∆∞·ªùi d√πng kh√¥ng h·ª£p l·ªá. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i', 'danger');
        setTimeout(() => {
          window.location.href = 'login.html';
        }, 1500);
        return;
      }

      // L·∫•y CustomerId ∆∞u ti√™n t·ª´ JWT claims, fallback sang user object
      function getCustomerIdFromToken(tok){
        try{ const parts = tok.split('.'); if(parts.length>=2){ const payload = JSON.parse(atob(parts[1])); return payload.CustomerId || payload.customerId || null; } }catch(_){ }
        return null;
      }

      const cidFromToken = getCustomerIdFromToken(token);
      const finalCustomerId = cidFromToken || user.customerId || user.CustomerId || user.userId;

      if (!finalCustomerId) {
        showToast('Kh√¥ng t√¨m th·∫•y th√¥ng tin kh√°ch h√†ng. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i', 'warning');
        setTimeout(() => window.location.href = '../admin/html/login.html', 2000);
        return;
      }
      
      const basePrice = (room.pricePerNight || room.basePrice || 0) * nights;
      const { total: totalPrice, discount } = window.coupons?.calculateDiscountedTotal 
        ? window.coupons.calculateDiscountedTotal(basePrice, appliedCoupon) 
        : { total: basePrice, discount: 0 };
      
      let confirmMessage = `X√°c nh·∫≠n ƒë·∫∑t ph√≤ng?\n\n` +
        `üìÖ Ng√†y nh·∫≠n: ${checkinDate.toLocaleDateString('vi-VN')}\n` +
        `üìÖ Ng√†y tr·∫£: ${checkoutDate.toLocaleDateString('vi-VN')}\n` +
        `üåô S·ªë ƒë√™m: ${nights} ƒë√™m\n` +
        `üë• S·ªë kh√°ch: ${guests} kh√°ch\n`;
      
      if (appliedCoupon) {
        const couponCode = appliedCoupon.code || appliedCoupon.Code || appliedCoupon.code;
        if (appliedCoupon.pending) {
          confirmMessage += `üéüÔ∏è M√£ gi·∫£m gi√°: ${couponCode} (S·∫Ω ƒë∆∞·ª£c ki·ªÉm tra khi ƒë·∫∑t ph√≤ng)\n`;
        } else if (discount > 0) {
          confirmMessage += `üéüÔ∏è M√£ gi·∫£m gi√°: ${couponCode}\n` +
            `üí∏ Gi·∫£m: -${vnd(discount)}\n`;
        }
      }
      
      confirmMessage += `üí∞ T·ªïng ti·ªÅn: ${vnd(totalPrice)}`;
      
      const ok = await showConfirm('X√°c nh·∫≠n ƒë·∫∑t ph√≤ng', confirmMessage, 'ƒê·∫∑t ngay', 'H·ªßy');
      if (!ok) return;
      
      try {
        showPageLoading('ƒêang x·ª≠ l√Ω ƒë·∫∑t ph√≤ng...');

        let specialRequestsObj = {};
        const specialRequestsText = document.getElementById('specialRequests')?.value || '';
        
        // Try to parse existing specialRequests if it's JSON
        if (specialRequestsText) {
          try {
            const parsed = JSON.parse(specialRequestsText);
            if (typeof parsed === 'object' && parsed !== null) {
              specialRequestsObj = parsed;
            } else {
              // If it's plain text, store as 'note'
              specialRequestsObj.note = specialRequestsText;
            }
          } catch(_) {
            // If not JSON, store as 'note'
            specialRequestsObj.note = specialRequestsText;
          }
        }
        
        // Add form fields to specialRequests
        const formFields = {
          guestName: document.getElementById('bf_fullName')?.value || '',
          guestEmail: document.getElementById('bf_email')?.value || '',
          guestPhone: document.getElementById('bf_phone')?.value || '',
          nationality: document.getElementById('bf_nationality')?.value || '',
          idCard: document.getElementById('bf_idCard')?.value || '',
          address: document.getElementById('bf_address')?.value || '',
          arrivalTime: document.getElementById('bf_eta')?.value || '',
          paymentMethod: document.getElementById('bf_payment')?.value || '',
        };
        Object.assign(specialRequestsObj, formFields);
        
        // Add note if exists
        const note = document.getElementById('bf_notes')?.value || '';
        if (note) {
          specialRequestsObj.note = (specialRequestsObj.note ? specialRequestsObj.note + '\n' : '') + note;
        }
        
        // Add coupon code if applied (pending or validated)
        if (appliedCoupon) {
          const couponCode = appliedCoupon.code || appliedCoupon.Code || appliedCoupon.code;
          if (couponCode) {
            specialRequestsObj.couponCode = couponCode;
          }
        }
        
        const bookingData = {
          customerId: finalCustomerId,
          requestedRoomType: room.roomTypeName || room.roomType || 'Standard',
          checkInDate: checkinDate.toISOString(),
          checkOutDate: checkoutDate.toISOString(),
          numberOfGuests: guests,
          specialRequests: JSON.stringify(specialRequestsObj),
          source: 'Website'
        };
        
        console.log('üîµ [submitBooking] Submitting:', bookingData);

        const API_BOOKINGS = location.origin + '/api/bookings';
        const bookingResp = await fetch(API_BOOKINGS, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(bookingData)
        });
        
        console.log('üîµ [submitBooking] Response status:', bookingResp.status);

        if (!bookingResp.ok) {
          let errorMessage = `HTTP ${bookingResp.status}: ${bookingResp.statusText}`;
          try {
            const errorData = await bookingResp.json();
            errorMessage = errorData.message || errorMessage;
          } catch(e) {
            const errorText = await bookingResp.text();
            errorMessage = errorText || errorMessage;
          }
          console.error('‚ùå [submitBooking] API Error:', errorMessage);
          throw new Error(errorMessage);
        }
        
        const bookingResult = await bookingResp.json();
        console.log('‚úÖ [submitBooking] Booking created:', bookingResult);
        
        showToast('ƒê·∫∑t ph√≤ng th√†nh c√¥ng! M√£ ƒë·∫∑t ph√≤ng: ' + (bookingResult.bookingCode || bookingResult.bookingId), 'success');
        setTimeout(() => {
          window.location.href = `booking-success.html?bookingId=${bookingResult.bookingId || bookingResult.bookingCode}`;
        }, 2000);
        
      } catch(e) {
        console.error('‚ùå [submitBooking] Error:', e);
        showToast('L·ªói ƒë·∫∑t ph√≤ng: ' + e.message, 'danger');
      } finally {
        hidePageLoading();
      }
    }
    
    // Navbar scroll effect
    window.addEventListener('scroll', () => {
      const navbar = document.querySelector('.ftco-navbar');
      if (window.scrollY > 50) navbar?.classList.add('scrolled');
      else navbar?.classList.remove('scrolled');
    });

    // Input validation - Ch·∫∑n k√Ω t·ª± ƒë·∫∑c bi·ªát v√† validate real-time
    document.addEventListener('DOMContentLoaded', function() {
      // H·ªç v√† t√™n: ch·ªâ ch·ªØ c√°i, kho·∫£ng tr·∫Øng, d·∫•u ti·∫øng Vi·ªát
      const fullNameInput = document.getElementById('bf_fullName');
      if (fullNameInput) {
        fullNameInput.addEventListener('input', function(e) {
          // Ch·ªâ cho ph√©p ch·ªØ c√°i, kho·∫£ng tr·∫Øng, d·∫•u ti·∫øng Vi·ªát
          let value = e.target.value;
          value = value.replace(/[^a-zA-Z√Ä-·ªπ\s]/g, '');
          if (value !== e.target.value) {
            e.target.value = value;
          }
        });
        fullNameInput.addEventListener('blur', function(e) {
          const value = e.target.value.trim();
          if (value && value.length < 2) {
            e.target.setCustomValidity('H·ªç v√† t√™n ph·∫£i c√≥ √≠t nh·∫•t 2 k√Ω t·ª±');
            e.target.classList.add('is-invalid');
          } else {
            e.target.setCustomValidity('');
            e.target.classList.remove('is-invalid');
          }
        });
      }

      // Qu·ªëc t·ªãch: ch·ªâ ch·ªØ c√°i v√† kho·∫£ng tr·∫Øng
      const nationalityInput = document.getElementById('bf_nationality');
      if (nationalityInput) {
        nationalityInput.addEventListener('input', function(e) {
          let value = e.target.value;
          value = value.replace(/[^a-zA-Z√Ä-·ªπ\s]/g, '');
          if (value !== e.target.value) {
            e.target.value = value;
          }
        });
      }

      // CMND/CCCD: ch·ªâ s·ªë
      const idCardInput = document.getElementById('bf_idCard');
      if (idCardInput) {
        idCardInput.addEventListener('input', function(e) {
          let value = e.target.value;
          value = value.replace(/[^0-9]/g, '');
          if (value !== e.target.value) {
            e.target.value = value;
          }
        });
        idCardInput.addEventListener('blur', function(e) {
          const value = e.target.value.trim();
          if (value && (value.length < 9 || value.length > 12)) {
            e.target.setCustomValidity('CMND/CCCD ph·∫£i c√≥ 9-12 ch·ªØ s·ªë');
            e.target.classList.add('is-invalid');
          } else {
            e.target.setCustomValidity('');
            e.target.classList.remove('is-invalid');
          }
        });
      }

      // ƒê·ªãa ch·ªâ: ch·ªØ c√°i, s·ªë, kho·∫£ng tr·∫Øng, d·∫•u c√¢u c∆° b·∫£n
      const addressInput = document.getElementById('bf_address');
      if (addressInput) {
        addressInput.addEventListener('input', function(e) {
          // Cho ph√©p ch·ªØ c√°i, s·ªë, kho·∫£ng tr·∫Øng, d·∫•u ph·∫©y, d·∫•u ch·∫•m, d·∫•u g·∫°ch ngang, d·∫•u g·∫°ch ch√©o
          let value = e.target.value;
          value = value.replace(/[^a-zA-Z√Ä-·ªπ0-9\s,.\-\/]/g, '');
          if (value !== e.target.value) {
            e.target.value = value;
          }
        });
      }

      // Ghi ch√∫: t∆∞∆°ng t·ª± ƒë·ªãa ch·ªâ
      const notesInput = document.getElementById('bf_notes');
      if (notesInput) {
        notesInput.addEventListener('input', function(e) {
          // Cho ph√©p ch·ªØ c√°i, s·ªë, kho·∫£ng tr·∫Øng, d·∫•u c√¢u c∆° b·∫£n
          let value = e.target.value;
          value = value.replace(/[^a-zA-Z√Ä-·ªπ0-9\s,.\-!?]/g, '');
          if (value !== e.target.value) {
            e.target.value = value;
          }
          // Hi·ªÉn th·ªã s·ªë k√Ω t·ª± c√≤n l·∫°i
          const maxLength = 500;
          const remaining = maxLength - value.length;
          let counter = e.target.parentElement.querySelector('.char-counter');
          if (!counter) {
            counter = document.createElement('small');
            counter.className = 'char-counter text-muted';
            counter.style.cssText = 'font-size:12px;margin-top:4px;display:block';
            e.target.parentElement.appendChild(counter);
          }
          counter.textContent = `C√≤n l·∫°i: ${remaining} k√Ω t·ª±`;
          if (remaining < 50) {
            counter.style.color = '#dc3545';
          } else {
            counter.style.color = '#6b7280';
          }
        });
      }

      // S·ªë ƒëi·ªán tho·∫°i: ƒë√£ c√≥ pattern, ch·ªâ c·∫ßn validate th√™m
      const phoneInput = document.getElementById('bf_phone');
      if (phoneInput) {
        phoneInput.addEventListener('input', function(e) {
          let value = e.target.value;
          value = value.replace(/[^0-9]/g, '');
          if (value !== e.target.value) {
            e.target.value = value;
          }
        });
        phoneInput.addEventListener('blur', function(e) {
          const value = e.target.value.trim();
          if (value && (value.length < 9 || value.length > 11)) {
            e.target.setCustomValidity('S·ªë ƒëi·ªán tho·∫°i ph·∫£i c√≥ 9-11 ch·ªØ s·ªë');
            e.target.classList.add('is-invalid');
          } else {
            e.target.setCustomValidity('');
            e.target.classList.remove('is-invalid');
          }
        });
      }
    });
    
    loadRoomDetail();
  </script>
</body>
</html>